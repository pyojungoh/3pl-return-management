<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  
  <!-- PWA ì„¤ì • -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ë°˜í’ˆêµí™˜">
  <meta name="theme-color" content="#4CAF50">
  
  <!-- ì•„ì´ì½˜ ì„¤ì • -->
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSIjNENBRjUwIiByeD0iMjAiLz4KPHN2ZyB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHA+CjxwYXRoIGQ9Ik0xOSA3SDE4VjZhMSAxIDAgMDAtMS0xSDdhMSAxIDAgMDAtMSAxdjFINWMtMS4xIDAtMiAuOS0yIDJ2MTBjMCAxLjEuOSAyIDIgMmgxNGMxLjEgMCAyLS45IDItMlY5YzAtMS4xLS45LTItMi0yem0tMiAwSDdWNmgxMHYxeiIvPgo8L3N2Zz4KPHA+Cjx0ZXh0IHg9IjkwIiB5PSIxNTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7rsJXtkpE8L3RleHQ+Cjwvc3ZnPgo=">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSIjNENBRjUwIiByeD0iMjAiLz4KPHN2ZyB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHA+CjxwYXRoIGQ9Ik0xOSA3SDE4VjZhMSAxIDAgMDAtMS0xSDdhMSAxIDAgMDAtMSAxdjFINWMtMS4xIDAtMiAuOS0yIDJ2MTBjMCAxLjEuOSAyIDIgMmgxNGMxLjEgMCAyLS45IDItMlY5YzAtMS4xLS45LTItMi0yem0tMiAwSDdWNmgxMHYxeiIvPgo8L3N2Zz4KPHA+Cjx0ZXh0IHg9IjkwIiB5PSIxNTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7rsJXtkpE8L3RleHQ+Cjwvc3ZnPgo=">
  
  <title>ë°˜í’ˆêµí™˜ ë“±ë¡</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5;
      font-size: 16px;
      line-height: 1.4;
      -webkit-text-size-adjust: 100%;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #333;
      font-size: 18px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      background-color: #fff;
      transition: border-color 0.3s ease;
      -webkit-appearance: none;
      appearance: none;
      min-height: 48px;
    }
    
    /* ìˆ«ì ì…ë ¥ í•„ë“œëŠ” ë” ì‘ê²Œ */
    input[type="number"] {
      padding: 12px 16px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      min-height: 48px;
    }
    
    /* ì½ê¸° ì „ìš© í•„ë“œëŠ” ì‘ê²Œ */
    input[readonly] {
      background-color: #f8f9fa;
      color: #6c757d;
      padding: 10px 12px;
      font-size: 16px;
      min-height: 40px;
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      width: 100%;
      margin: 8px 0;
      transition: all 0.3s ease;
      min-height: 50px;
      -webkit-tap-highlight-color: transparent;
    }
    
    button:hover, button:active {
      background-color: #45a049;
      transform: translateY(-1px);
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .scan-btn {
      background-color: #2196F3;
      margin-top: 8px;
    }
    
    .scan-btn:hover, .scan-btn:active {
      background-color: #1976D2;
    }
    
    .photo-btn {
      background-color: #FF9800;
      margin-top: 8px;
    }
    
    .photo-btn:hover, .photo-btn:active {
      background-color: #F57C00;
    }
    
    .test-btn {
      background-color: #9C27B0;
      margin-top: 10px;
      font-size: 14px;
      padding: 12px 16px;
    }
    
    .test-btn:hover, .test-btn:active {
      background-color: #7B1FA2;
    }
    
    .refresh-btn {
      background-color: #607D8B;
      font-size: 14px;
      padding: 8px 12px;
      min-height: 40px;
      margin-top: 5px;
    }
    
    .refresh-btn:hover, .refresh-btn:active {
      background-color: #455A64;
    }
    
    .preview {
      margin-top: 15px;
      display: none;
      text-align: center;
    }
    
    .preview .photo-item {
      display: inline-block;
      margin: 8px;
      text-align: center;
      vertical-align: top;
    }
    
    .preview img {
      max-width: 120px;
      max-height: 120px;
      border-radius: 8px;
      border: 2px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: block;
      margin-bottom: 5px;
    }
    
    .photo-label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }
    
    .delete-btn {
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 5px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .status {
      padding: 16px;
      margin: 15px 0;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      font-size: 16px;
    }
    
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .month-selector {
      background-color: #e3f2fd;
      border: 2px solid #2196F3;
      color: #1976D2;
      font-weight: 600;
    }
    
    .month-selector:focus {
      border-color: #1976D2;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }
    
    /* ëª¨ë°”ì¼ íŠ¹í™” ìŠ¤íƒ€ì¼ */
    @media (max-width: 768px) {
      body {
        padding: 5px;
        font-size: 18px;
      }
      
      .container {
        padding: 15px;
        border-radius: 0;
        margin: 0;
        min-height: 100vh;
      }
      
      h2 {
        font-size: 22px;
        margin-bottom: 20px;
      }
      
      .form-group {
        margin-bottom: 18px;
      }
      
      label {
        font-size: 19px;
        margin-bottom: 8px;
      }
      
      input, select, textarea {
        font-size: 18px;
        padding: 12px 14px;
        min-height: 48px;
      }
      
      input[type="number"] {
        font-size: 22px;
        font-weight: bold;
        text-align: center;
        padding: 12px;
        min-height: 50px;
      }
      
      input[readonly] {
        font-size: 16px;
        padding: 10px 12px;
        min-height: 42px;
      }
      
      button {
        font-size: 18px;
        padding: 14px 16px;
        min-height: 52px;
      }
      
      textarea {
        min-height: 70px;
        font-size: 17px;
      }
      
      .status {
        font-size: 17px;
        padding: 14px;
      }
    }
    
    /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
    @media (hover: none) and (pointer: coarse) {
      button:hover {
        transform: none;
      }
      
      button:active {
        transform: scale(0.98);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ë°˜í’ˆêµí™˜ ë“±ë¡</h2>
    
    <form id="returnForm">
      <!-- ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
      <div class="form-group">
        <label>ğŸ“… ê²€ìƒ‰í•  ì›”</label>
        <select id="monthSelector" class="month-selector" required>
          <option value="">ì›” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
        </select>
        <button type="button" class="refresh-btn" onclick="loadAvailableSheets()">ğŸ”„ ì›” ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      
      <!-- ê³ ê°ëª…ê³¼ ì†¡ì¥ë²ˆí˜¸ ë’¤4ìë¦¬ ê²€ìƒ‰ (ë¶„ë¦¬) -->
      <div class="form-group">
        <label>ê³ ê°ëª…</label>
        <input type="text" id="customerName" placeholder="ê³ ê°ëª… ì…ë ¥" required>
      </div>

      <div class="form-group">
        <label>ì†¡ì¥ë²ˆí˜¸ ë’¤4ìë¦¬</label>
        <input type="number" id="last4Digits" placeholder="1234" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" required>
        <button type="button" class="scan-btn" onclick="searchData()">ğŸ” ê²€ìƒ‰</button>
      </div>

      <!-- ìë™ì™„ì„± í•„ë“œë“¤ -->
      <div class="form-group">
        <label>í™”ì£¼ëª…</label>
        <input type="text" id="company" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>

      <div class="form-group">
        <label>ì œí’ˆ</label>
        <input type="text" id="product" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>

      <div class="form-group">
        <label>ê³ ê°ëª… (í™•ì¸)</label>
        <input type="text" id="customer" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>

      <div class="form-group">
        <label>ì†¡ì¥ë²ˆí˜¸</label>
        <input type="text" id="trackingNumber" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>

      <!-- ì„ íƒ í•„ë“œë“¤ -->
      <div class="form-group">
        <label>êµ¬ë¶„</label>
        <select id="returnType" required>
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ë°˜í’ˆ">ë°˜í’ˆ</option>
          <option value="êµí™˜">êµí™˜</option>
          <option value="ì˜¤ë°°ì†¡">ì˜¤ë°°ì†¡</option>
        </select>
      </div>

      <div class="form-group">
        <label>ì¬ê³ ìƒíƒœ</label>
        <select id="stockStatus" required>
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ì •ìƒ">ì •ìƒ</option>
          <option value="ë¶ˆëŸ‰">ë¶ˆëŸ‰</option>
        </select>
      </div>

      <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
      <div class="form-group">
        <label>ì‚¬ì§„ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</label>
        <input type="file" id="photos" accept="image/*" multiple capture="camera" style="display: none;">
        <button type="button" class="photo-btn" onclick="document.getElementById('photos').click()">ğŸ“· ì‚¬ì§„ ì°ê¸°</button>
        <div id="photoPreview" class="preview"></div>
        <div id="photoCount" style="margin-top: 10px; font-size: 16px; color: #666; text-align: center;"></div>
      </div>

      <!-- ë©”ëª¨ -->
      <div class="form-group">
        <label>ë¹„ê³ </label>
        <textarea id="memo" rows="3" placeholder="ì¶”ê°€ ë©”ëª¨ì‚¬í•­"></textarea>
      </div>

      <!-- ì œì¶œ ë²„íŠ¼ -->
      <button type="submit" id="submitBtn">ë“±ë¡í•˜ê¸°</button>
      
      <!-- í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€ -->
      <button type="button" onclick="testConnection()" class="test-btn">ğŸ”§ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    </form>

    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div id="statusMessage" style="display: none;"></div>
  </div>

  <script>
    let selectedImages = [];
    let availableSheets = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      console.log('í˜ì´ì§€ ë¡œë“œë¨ - ì›” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘');
      
      // ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ
      loadAvailableSheets();
      
      // ì‚¬ì§„ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
      document.getElementById('photos').addEventListener('change', function(e) {
        handleImageSelection(e.target.files);
      });

      // ë’¤4ìë¦¬ ì…ë ¥ ì œí•œ
      document.getElementById('last4Digits').addEventListener('input', function(e) {
        // ìˆ«ìë§Œ ì…ë ¥ë˜ë„ë¡ í•„í„°ë§
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // 4ìë¦¬ ì œí•œ
        if (this.value.length > 4) {
          this.value = this.value.slice(0, 4);
        }
      });

      // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
      document.getElementById('customerName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('last4Digits').focus();
        }
      });

      document.getElementById('last4Digits').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchData();
        }
      });

      // í¼ ì œì¶œ
      document.getElementById('returnForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm();
      });
    });

    // ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ
    function loadAvailableSheets() {
      console.log('ì›” ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ ì‹œì‘');
      showStatus('ì›” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');
      
      google.script.run
        .withSuccessHandler(function(sheets) {
          console.log('ì„œë²„ì—ì„œ ë°›ì€ ì‹œíŠ¸ ëª©ë¡:', sheets);
          
          availableSheets = sheets;
          const monthSelector = document.getElementById('monthSelector');
          
          // ëª¨ë“  ê¸°ì¡´ ì˜µì…˜ë“¤ ì œê±°
          monthSelector.innerHTML = '';
          
          if (!sheets || sheets.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ì›”ì´ ì—†ìŠµë‹ˆë‹¤';
            monthSelector.appendChild(option);
            showStatus('ì‚¬ìš© ê°€ëŠ¥í•œ ì›” ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
          }
          
          console.log('ì‹œíŠ¸ ëª©ë¡ì„ ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€ ì¤‘...');
          
          // ì‹œíŠ¸ ëª©ë¡ì„ ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€
          sheets.forEach((sheetName, index) => {
            console.log(`ì˜µì…˜ ì¶”ê°€: ${index + 1}. ${sheetName}`);
            const option = document.createElement('option');
            option.value = sheetName;
            option.textContent = sheetName;
            monthSelector.appendChild(option);
          });
          
          // í˜„ì¬ ì›”ë¡œ ê¸°ë³¸ ì„ íƒ (7ì›”ì´ë©´ 2025ë…„7ì›” ì°¾ê¸°)
          const today = new Date();
          const currentYear = today.getFullYear();
          const currentMonth = today.getMonth() + 1;
          const currentSheetName = `${currentYear}ë…„${currentMonth}ì›”`;
          
          console.log('í˜„ì¬ ì›” ì‹œíŠ¸ëª… ì°¾ê¸°:', currentSheetName);
          
          // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì‹œíŠ¸ ì°¾ê¸°
          let foundSheet = sheets.find(sheet => sheet === currentSheetName);
          
          // ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ìœ ì‚¬í•œ ì‹œíŠ¸ ì°¾ê¸° (ë„ì–´ì“°ê¸° ë“± ê³ ë ¤)
          if (!foundSheet) {
            foundSheet = sheets.find(sheet => 
              sheet.replace(/\s/g, '').toLowerCase() === currentSheetName.replace(/\s/g, '').toLowerCase()
            );
          }
          
          if (foundSheet) {
            monthSelector.value = foundSheet;
            console.log('í˜„ì¬ ì›” ì‹œíŠ¸ë¡œ ì„¤ì •ë¨:', foundSheet);
            showStatus(`í˜„ì¬ ì›” ${foundSheet}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
          } else {
            console.log('í˜„ì¬ ì›” ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ. ì²« ë²ˆì§¸ ì‹œíŠ¸ë¡œ ì„¤ì •');
            // ì²« ë²ˆì§¸ ì‹œíŠ¸ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            monthSelector.value = sheets[0];
            showStatus(`í˜„ì¬ ì›”ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ${sheets[0]}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
          }
          
          console.log('ì›” ëª©ë¡ ë¡œë“œ ì™„ë£Œ');
        })
        .withFailureHandler(function(error) {
          console.error('ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
          showStatus('ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
          
          // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ì˜µì…˜ ì¶”ê°€
          const monthSelector = document.getElementById('monthSelector');
          monthSelector.innerHTML = '';
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ - ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”';
          monthSelector.appendChild(option);
        })
        .getAvailableSheets();
    }

    // ê³ ê°ëª… + ë’¤4ìë¦¬ë¡œ ë°ì´í„° ê²€ìƒ‰
    function searchData() {
      const customerName = document.getElementById('customerName').value.trim();
      const last4Digits = document.getElementById('last4Digits').value.trim();
      const selectedMonth = document.getElementById('monthSelector').value;
      
      console.log('ê²€ìƒ‰ ì‹œì‘:', {customerName, last4Digits, selectedMonth});
      
      if (!selectedMonth) {
        showStatus('ì›”ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      if (!customerName) {
        showStatus('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      const searchText = customerName + ' ' + last4Digits;
      
      showStatus(`${selectedMonth}ì—ì„œ ê²€ìƒ‰ ì¤‘...`, 'loading');
      
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('ê²€ìƒ‰ ê²°ê³¼:', data);
          
          if (data) {
            document.getElementById('company').value = data.company || '';
            document.getElementById('product').value = data.product || '';
            document.getElementById('customer').value = data.customer || '';
            // ê²€ìƒ‰ëœ ë°ì´í„°ì˜ ì†¡ì¥ë²ˆí˜¸ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì¤‘ìš”!)
            document.getElementById('trackingNumber').value = data.trackingNumber || '';
            
            // ê¸°ì¡´ ì„ íƒê°’ì´ ìˆìœ¼ë©´ ìœ ì§€
            if (data.returnType) {
              document.getElementById('returnType').value = data.returnType;
            }
            if (data.stockStatus) {
              document.getElementById('stockStatus').value = data.stockStatus;
            }
            
            showStatus(`${selectedMonth}ì—ì„œ ê²€ìƒ‰ ì™„ë£Œ! ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'success');
            
            // ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€
            console.log('í¼ì— ì„¤ì •ëœ ë°ì´í„°:');
            console.log('- ê³ ê°ëª…:', document.getElementById('customer').value);
            console.log('- ì†¡ì¥ë²ˆí˜¸:', document.getElementById('trackingNumber').value);
            console.log('- ì†¡ì¥ë²ˆí˜¸ íƒ€ì…:', typeof document.getElementById('trackingNumber').value);
          } else {
            showStatus(`${selectedMonth}ì—ì„œ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³ ê°ëª…ê³¼ ì†¡ì¥ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
          showStatus('ê²€ìƒ‰ ì‹¤íŒ¨: ' + error, 'error');
        })
        .findDataByCustomerAndLast4(searchText, selectedMonth);
    }

    // ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬ (ëˆ„ì  ì¶”ê°€ ë°©ì‹)
    function handleImageSelection(files) {
      if (files.length > 0) {
        Array.from(files).forEach((file, index) => {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              selectedImages.push(e.target.result); // ê¸°ì¡´ ë°°ì—´ì— ì¶”ê°€
              updatePhotoPreview(); // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }
    
    // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updatePhotoPreview() {
      const preview = document.getElementById('photoPreview');
      const photoCount = document.getElementById('photoCount');
      preview.innerHTML = '';
      
      if (selectedImages.length > 0) {
        preview.style.display = 'block';
        photoCount.textContent = `ì„ íƒëœ ì‚¬ì§„: ${selectedImages.length}ì¥`;
        
        selectedImages.forEach((imageData, index) => {
          const photoItem = document.createElement('div');
          photoItem.className = 'photo-item';
          
          const img = document.createElement('img');
          img.src = imageData;
          
          const label = document.createElement('div');
          label.className = 'photo-label';
          label.textContent = `ì‚¬ì§„ ${index + 1}`;
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.innerHTML = 'Ã—';
          deleteBtn.type = 'button';
          deleteBtn.onclick = function() {
            removePhoto(index);
          };
          
          photoItem.appendChild(img);
          photoItem.appendChild(label);
          photoItem.appendChild(deleteBtn);
          preview.appendChild(photoItem);
        });
      } else {
        preview.style.display = 'none';
        photoCount.textContent = '';
      }
    }
    
    // ì‚¬ì§„ ì‚­ì œ í•¨ìˆ˜ (ë‹¨ìˆœí™”)
    function removePhoto(index) {
      selectedImages.splice(index, 1);
      updatePhotoPreview(); // ë¯¸ë¦¬ë³´ê¸° ë‹¤ì‹œ ì—…ë°ì´íŠ¸
    }

    // í¼ ì œì¶œ
    function submitForm() {
      const submitBtn = document.getElementById('submitBtn');
      const selectedMonth = document.getElementById('monthSelector').value;
      
      console.log('submitForm í•¨ìˆ˜ ì‹œì‘');
      
      // ì›” ì„ íƒ ê²€ì¦
      if (!selectedMonth) {
        showStatus('ì›”ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      // í•„ìˆ˜ í•„ë“œ ê²€ì¦
      const trackingNumber = document.getElementById('trackingNumber').value.trim();
      const returnType = document.getElementById('returnType').value;
      const stockStatus = document.getElementById('stockStatus').value;
      
      console.log('í•„ìˆ˜ í•„ë“œ ê°’:', {trackingNumber, returnType, stockStatus, selectedMonth});
      
      if (!trackingNumber) {
        showStatus('ë¨¼ì € ê³ ê° ì •ë³´ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      if (!returnType || !stockStatus) {
        showStatus('êµ¬ë¶„ê³¼ ì¬ê³ ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      // ë²„íŠ¼ ë¹„í™œì„±í™”
      submitBtn.disabled = true;
      showStatus('ë“±ë¡ ì¤‘...', 'loading');
      
      // ë°ì´í„° ì¤€ë¹„
      const formData = {
        trackingNumber: trackingNumber,
        company: document.getElementById('company').value.trim(),
        product: document.getElementById('product').value.trim(),
        customer: document.getElementById('customer').value.trim(),
        returnType: returnType,
        stockStatus: stockStatus,
        memo: document.getElementById('memo').value.trim(),
        selectedMonth: selectedMonth // ì„ íƒëœ ì›” ì •ë³´ ì¶”ê°€
      };
      
      console.log('ì¤€ë¹„ëœ í¼ ë°ì´í„°:', formData);
      console.log('í¼ ë°ì´í„° ìƒì„¸:');
      console.log('- ê³ ê°ëª…:', formData.customer, '(íƒ€ì…:', typeof formData.customer, ')');
      console.log('- ì†¡ì¥ë²ˆí˜¸:', formData.trackingNumber, '(íƒ€ì…:', typeof formData.trackingNumber, ')');
      console.log('ì„ íƒëœ ì´ë¯¸ì§€ ê°œìˆ˜:', selectedImages.length);
      
      // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë¡œë“œ
      if (selectedImages.length > 0) {
        console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘');
        google.script.run
          .withSuccessHandler(function(photoLinks) {
            console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ, ë°›ì€ ë§í¬:', photoLinks);
            formData.photoLinks = photoLinks;
            saveData(formData);
          })
          .withFailureHandler(function(error) {
            console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
            showStatus('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            submitBtn.disabled = false;
          })
          .uploadImages(selectedImages, trackingNumber);
      } else {
        console.log('ì´ë¯¸ì§€ ì—†ìŒ, ë°”ë¡œ ë°ì´í„° ì €ì¥');
        saveData(formData);
      }
    }

    // ë°ì´í„° ì €ì¥
    function saveData(formData) {
      console.log('saveData í•¨ìˆ˜ ì‹œì‘, ë°ì´í„°:', formData);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('ì„œë²„ ì‘ë‹µ ì„±ê³µ:', result);
          showStatus(result, 'success');
          document.getElementById('returnForm').reset();
          document.getElementById('photoPreview').style.display = 'none';
          selectedImages = [];
          document.getElementById('submitBtn').disabled = false;
          
          // ì›” ì„ íƒ ìœ ì§€
          if (formData.selectedMonth) {
            document.getElementById('monthSelector').value = formData.selectedMonth;
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨:', error);
          showStatus('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
          document.getElementById('submitBtn').disabled = false;
        })
        .addReturnData(formData);
        
      console.log('addReturnData í•¨ìˆ˜ í˜¸ì¶œ ì™„ë£Œ');
    }

    // í…ŒìŠ¤íŠ¸ ì—°ê²° í•¨ìˆ˜
    function testConnection() {
      google.script.run
        .withSuccessHandler(function(result) {
          alert('ì—°ê²° ì„±ê³µ: ' + result);
        })
        .withFailureHandler(function(error) {
          alert('ì—°ê²° ì‹¤íŒ¨: ' + error);
        })
        .simpleTest();
    }

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = 'status ' + type;
      statusDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }
  </script>
</body>
</html>