<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì •ì‚° ê´€ë¦¬</title>
  <style>
    /* ì •ì‚° ë©”ë‰´ ì „ìš© ìŠ¤íƒ€ì¼ */
    #stContainer {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ê´€ë¦¬ì ì „ìš© ì„¹ì…˜ (ê¸°ë³¸ ìˆ¨ê¹€) */
    .st-admin-only {
      display: none;
    }
    
    /* í™”ì£¼ì‚¬ ì „ìš© ì„¹ì…˜ (ê¸°ë³¸ ìˆ¨ê¹€) */
    .st-consignor-only {
      display: none;
    }
    
    /* ê³µí†µ ìŠ¤íƒ€ì¼ */
    .st-section {
      margin-bottom: 20px;
    }
    
    .st-toggle-btn {
      background: linear-gradient(135deg, #ffffff 0%, #fffef9 100%);
      width: 100%;
      text-align: left;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 14px;
      border: 2px solid #ffeaa7;
      color: #ff6b35;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.1);
    }
    
    .st-toggle-btn:hover {
      background: linear-gradient(135deg, #fffef9 0%, #ffffff 100%);
      box-shadow: 0 6px 16px rgba(255, 152, 0, 0.15);
    }
    
    .st-toggle-content {
      display: none;
      background: #ffffff;
      padding: 24px;
      border-radius: 0 0 14px 14px;
      border: 2px solid #ffeaa7;
      border-top: none;
      margin-top: -2px;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1);
    }
    
    .st-filters {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .st-filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .st-filter-group label {
      color: #2d3436;
      font-weight: 600;
      font-size: 14px;
    }
    
    .st-filter-group input,
    .st-filter-group select {
      padding: 10px 14px;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      font-size: 14px;
      background: #ffffff;
      color: #2d3436;
    }
    
    .st-filter-group input:focus,
    .st-filter-group select:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    
    .st-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #ff6b35 0%, #feca57 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
    }
    
    .st-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 107, 53, 0.35);
    }
    
    .st-table-container {
      margin-top: 20px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1);
      border: 2px solid #ffeaa7;
      overflow: hidden;
    }
    
    .st-table-header {
      padding: 15px 20px 10px 20px;
      border-bottom: 2px solid #ffeaa7;
      background: linear-gradient(135deg, #fffef9 0%, #ffffff 100%);
    }
    
    .st-table-header h3 {
      margin: 0;
      color: #ff6b35;
      font-weight: 700;
      font-size: 18px;
    }
    
    .st-table-scroll-wrapper {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .st-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }
    
    .st-table thead {
      background: linear-gradient(135deg, #ff6b35 0%, #feca57 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .st-table th {
      padding: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }
    
    .st-table td {
      padding: 12px;
      text-align: center;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }
    
    .st-table tbody tr:hover {
      background: #fffef9;
    }
    
    .st-table .no-data {
      text-align: center;
      padding: 40px;
      color: #636e72;
    }
    
    .st-form-group {
      margin-bottom: 15px;
    }
    
    .st-form-label {
      color: #2d3436;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
      font-size: 14px;
    }
    
    .st-form-input,
    .st-form-select,
    .st-form-textarea {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      font-size: 14px;
      background: #ffffff;
      color: #2d3436;
      box-sizing: border-box;
    }
    
    .st-form-input:focus,
    .st-form-select:focus,
    .st-form-textarea:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    
    .st-form-textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .st-file-upload-area {
      border: 2px dashed #ffeaa7;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fffef9;
      margin-top: 8px;
    }
    
    .st-file-upload-area:hover {
      border-color: #ff6b35;
      background: #ffffff;
    }
    
    .st-file-link {
      color: #74b9ff;
      text-decoration: underline;
      cursor: pointer;
    }
    
    .st-file-link:hover {
      color: #0984e3;
    }
    
    .st-amount-display {
      font-size: 18px;
      font-weight: 700;
      color: #ff6b35;
      text-align: right;
    }
    
    .st-total-amount {
      font-size: 24px;
      font-weight: 800;
      color: #ff6b35;
      text-align: right;
      padding: 15px;
      background: #fffef9;
      border-radius: 8px;
      border: 2px solid #ffeaa7;
    }
    
    .st-btn-secondary {
      padding: 10px 20px;
      background: linear-gradient(135deg, #b2bec3 0%, #95a5a6 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .st-btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(178, 190, 195, 0.25);
    }
    
    .st-btn-danger {
      padding: 10px 20px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .st-btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.25);
    }
    
    .st-searchable-select {
      position: relative;
      width: 100%;
    }
    
    .st-dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-top: 4px;
    }
    
    .st-dropdown-list.show {
      display: block;
    }
    
    .st-dropdown-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .st-dropdown-item:last-child {
      border-bottom: none;
    }
    
    .st-dropdown-item:hover {
      background-color: #fff9e6;
    }
    
    .st-settlement-detail {
      background: #f8f9fa;
      border: 2px solid #ffeaa7;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
    }
    
    .st-settlement-detail-row {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 12px;
      align-items: center;
      padding: 8px 0;
    }
    
    .st-settlement-detail-label {
      font-weight: 600;
      color: #2d3436;
    }
    
    .st-settlement-detail-value {
      color: #636e72;
    }
  </style>
</head>
<body>
  <div id="stContainer">
    <!-- ì •ì‚° ë“±ë¡/ìˆ˜ì • ì„¹ì…˜ (ê´€ë¦¬ìë§Œ) -->
    <div id="stAdminSettlementSection" class="st-admin-only st-section">
      <button class="st-toggle-btn" onclick="stAdminToggleSettlementForm()">
        <span>â• ì •ì‚° ë“±ë¡</span>
        <span id="stAdminSettlementIcon">â–¼</span>
      </button>
      <div id="stAdminSettlementForm" class="st-toggle-content">
        <h3 style="margin: 0 0 20px 0; color: #ff6b35; font-weight: 700;">ì •ì‚° ë“±ë¡</h3>
        <form id="stSettlementForm" onsubmit="stAdminHandleSettlementSubmit(event)">
          <input type="hidden" id="stSettlementId">
          
          <!-- ìƒë‹¨: í™”ì£¼ì‚¬, ì •ì‚°ë…„ì›” -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="st-form-group">
              <label class="st-form-label">í™”ì£¼ì‚¬ *</label>
              <div class="st-searchable-select">
                <input type="text" id="stSettlementCompanyInput" class="st-form-input" placeholder="í™”ì£¼ì‚¬ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”" autocomplete="off" required>
                <input type="hidden" id="stSettlementCompanyName" required>
                <div id="stSettlementCompanyDropdown" class="st-dropdown-list"></div>
              </div>
            </div>
            <div class="st-form-group">
              <label class="st-form-label">ì •ì‚°ë…„ì›” *</label>
              <input type="month" id="stSettlementYearMonth" class="st-form-input" required>
            </div>
          </div>
          
          <!-- ì¢Œìš° 2ë‹¨ ë ˆì´ì•„ì›ƒ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- ì¢Œì¸¡: ê¸ˆì•¡ ì…ë ¥ í•„ë“œë“¤ -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <!-- ì‘ì—…ë¹„ -->
              <div class="st-settlement-detail-row">
                <div class="st-settlement-detail-label">ì‘ì—…ë¹„</div>
                <div>
                  <input type="number" id="stWorkFee" class="st-form-input" placeholder="ì‘ì—…ë¹„ ê¸ˆì•¡ ì…ë ¥" style="width: 180px; display: inline-block; margin-right: 8px;" onchange="stCalculateTotal()">
                  <span>ì›</span>
                </div>
              </div>
              
              <!-- ì…ì¶œê³ ë¹„ -->
              <div class="st-settlement-detail-row">
                <div class="st-settlement-detail-label">ì…ì¶œê³ ë¹„</div>
                <div>
                  <input type="number" id="stInoutFee" class="st-form-input" placeholder="ì…ì¶œê³ ë¹„ ê¸ˆì•¡ ì…ë ¥" style="width: 180px; display: inline-block; margin-right: 8px;" onchange="stCalculateTotal()">
                  <span>ì›</span>
                </div>
              </div>
              
              <!-- íƒë°°ë¹„ -->
              <div class="st-settlement-detail-row">
                <div class="st-settlement-detail-label">íƒë°°ë¹„</div>
                <div>
                  <input type="number" id="stShippingFee" class="st-form-input" placeholder="íƒë°°ë¹„ ê¸ˆì•¡ ì…ë ¥" style="width: 180px; display: inline-block; margin-right: 8px;" onchange="stCalculateTotal()">
                  <span>ì›</span>
                </div>
              </div>
              
              <!-- ë³´ê´€ë£Œ -->
              <div class="st-settlement-detail-row">
                <div class="st-settlement-detail-label">ë³´ê´€ë£Œ</div>
                <div>
                  <span id="stStorageFeeDisplay" class="st-amount-display">0</span>
                  <span>ì›</span>
                  <button type="button" class="st-btn" onclick="stLoadStorageFee()" style="margin-left: 10px; padding: 6px 12px; font-size: 12px;">ğŸ”„ íŒŒë ˆíŠ¸ì—ì„œ ê°€ì ¸ì˜¤ê¸°</button>
                </div>
              </div>
              <input type="hidden" id="stStorageFee" value="0">
              
              <!-- íŠ¹ìˆ˜ì‘ì—… -->
              <div class="st-settlement-detail-row">
                <div class="st-settlement-detail-label">íŠ¹ìˆ˜ì‘ì—…</div>
                <div>
                  <span id="stSpecialWorkFeeDisplay" class="st-amount-display">0</span>
                  <span>ì›</span>
                  <button type="button" class="st-btn" onclick="stLoadSpecialWorkFee()" style="margin-left: 10px; padding: 6px 12px; font-size: 12px;">ğŸ”„ íŠ¹ìˆ˜ì‘ì—…ì—ì„œ ê°€ì ¸ì˜¤ê¸°</button>
                </div>
              </div>
              <input type="hidden" id="stSpecialWorkFee" value="0">
              
              <!-- ì˜¤ë°°ì†¡/ëˆ„ë½ ì°¨ê° -->
              <div class="st-settlement-detail-row">
                <div class="st-settlement-detail-label">ì˜¤ë°°ì†¡/ëˆ„ë½ ì°¨ê°</div>
                <div>
                  <input type="number" id="stErrorDeduction" class="st-form-input" placeholder="ì°¨ê° ê¸ˆì•¡ ì…ë ¥" style="width: 180px; display: inline-block; margin-right: 8px;" onchange="stCalculateTotal()">
                  <span>ì›</span>
                  <button type="button" class="st-btn" onclick="stLoadErrorCounts()" style="margin-left: 10px; padding: 6px 12px; font-size: 12px;">ğŸ”„ ê±´ìˆ˜ í™•ì¸</button>
                </div>
              </div>
              <div style="margin-top: 4px; padding: 8px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
                <span id="stErrorCountsDisplay">ì˜¤ë°°ì†¡: 0ê±´, ëˆ„ë½: 0ê±´</span>
              </div>
            </div>
            
            <!-- ìš°ì¸¡: íŒŒì¼ ì—…ë¡œë“œ ë°•ìŠ¤ë“¤ -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <!-- ì‘ì—…ë¹„ íŒŒì¼ -->
              <div class="st-form-group" style="margin-bottom: 0;">
                <label class="st-form-label">ì‘ì—…ë¹„ íŒŒì¼</label>
                <div class="st-file-upload-area" id="stWorkFeeFileUploadArea" onclick="document.getElementById('stWorkFeeFileInput').click()">
                  <p id="stWorkFeeFileUploadText">ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ</p>
                  <input type="file" id="stWorkFeeFileInput" accept=".pdf,.xlsx,.xls,.csv" style="display: none;" onchange="stHandleFileSelect('work_fee', event)">
                </div>
                <div id="stWorkFeeFileDisplay"></div>
              </div>
              
              <!-- ì…ì¶œê³ ë¹„ íŒŒì¼ -->
              <div class="st-form-group" style="margin-bottom: 0;">
                <label class="st-form-label">ì…ì¶œê³ ë¹„ íŒŒì¼</label>
                <div class="st-file-upload-area" id="stInoutFeeFileUploadArea" onclick="document.getElementById('stInoutFeeFileInput').click()">
                  <p id="stInoutFeeFileUploadText">ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ</p>
                  <input type="file" id="stInoutFeeFileInput" accept=".pdf,.xlsx,.xls,.csv" style="display: none;" onchange="stHandleFileSelect('inout_fee', event)">
                </div>
                <div id="stInoutFeeFileDisplay"></div>
              </div>
              
              <!-- íƒë°°ë¹„ íŒŒì¼ -->
              <div class="st-form-group" style="margin-bottom: 0;">
                <label class="st-form-label">íƒë°°ë¹„ íŒŒì¼</label>
                <div class="st-file-upload-area" id="stShippingFeeFileUploadArea" onclick="document.getElementById('stShippingFeeFileInput').click()">
                  <p id="stShippingFeeFileUploadText">ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ</p>
                  <input type="file" id="stShippingFeeFileInput" accept=".pdf,.xlsx,.xls,.csv" style="display: none;" onchange="stHandleFileSelect('shipping_fee', event)">
                </div>
                <div id="stShippingFeeFileDisplay"></div>
              </div>
            </div>
          </div>
          
          <!-- ì´ì•¡ -->
          <div class="st-form-group" style="margin-top: 20px;">
            <div class="st-total-amount">
              <div style="font-size: 14px; color: #636e72; margin-bottom: 5px;">ì´ ì •ì‚° ê¸ˆì•¡</div>
              <div><span id="stTotalAmount">0</span>ì›</div>
            </div>
          </div>
          
          <div class="st-form-group">
            <label class="st-form-label">ë¹„ê³ </label>
            <textarea id="stSettlementMemo" class="st-form-textarea" placeholder="ì •ì‚° ê´€ë ¨ ë¹„ê³ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          </div>
          
          <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 2px solid #ffeaa7;">
            <button type="submit" class="st-btn">ğŸ’¾ ì €ì¥</button>
            <button type="button" class="st-btn-secondary" onclick="stAdminResetSettlementForm()">ğŸ”„ ì´ˆê¸°í™”</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- ê´€ë¦¬ì ì „ìš© í•„í„° ì„¹ì…˜ -->
    <div id="stAdminFilterSection" class="st-admin-only st-section">
      <div class="st-filters">
        <div class="st-filter-group">
          <label for="stAdminFilterYearMonth">ì •ì‚°ë…„ì›”</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="month" id="stAdminFilterYearMonth" style="flex: 1;">
            <button class="st-btn" onclick="stSelectYearMonthForDelivery()" style="padding: 8px 12px; font-size: 12px; white-space: nowrap;">ì „ë‹¬ ì¡°íšŒ</button>
          </div>
        </div>
        <div class="st-filter-group">
          <label for="stAdminFilterCompany">í™”ì£¼ì‚¬</label>
          <div class="st-searchable-select">
            <input type="text" id="stAdminFilterCompanyInput" class="st-form-input" placeholder="í™”ì£¼ì‚¬ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”" autocomplete="off">
            <input type="hidden" id="stAdminFilterCompanyName">
            <div id="stAdminFilterCompanyDropdown" class="st-dropdown-list"></div>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="st-btn" onclick="stAdminLoadSettlements()">ì¡°íšŒ</button>
        </div>
      </div>
    </div>
    
    <!-- í™”ì£¼ì‚¬ ì „ìš© í•„í„° ì„¹ì…˜ -->
    <div id="stConsignorFilterSection" class="st-consignor-only st-section">
      <div class="st-filters">
        <div class="st-filter-group">
          <label for="stConsignorFilterYearMonth">ì •ì‚°ë…„ì›”</label>
          <input type="month" id="stConsignorFilterYearMonth">
        </div>
        <button class="st-btn" onclick="stConsignorLoadSettlements()">ì¡°íšŒ</button>
      </div>
    </div>
    
    <!-- ì •ì‚° ëª©ë¡ í…Œì´ë¸” -->
    <div id="stCommonTableSection" class="st-section">
      <div class="st-table-container">
        <div class="st-table-header">
          <h3>ğŸ’° ì •ì‚° ëª©ë¡</h3>
        </div>
        <div class="st-table-scroll-wrapper">
          <table class="st-table">
            <thead>
              <tr>
                <th>ìˆœë²ˆ</th>
                <th>ì •ì‚°ë…„ì›”</th>
                <th class="st-admin-only">í™”ì£¼ì‚¬</th>
                <th>ì´ì•¡</th>
                <th>ì„¸ê¸ˆ</th>
                <th>ê²°ì œê¸ˆì•¡</th>
                <th>ìƒíƒœ</th>
                <th>ì„¸ê¸ˆê³„ì‚°ì„œ</th>
                <th class="st-admin-only">ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="stTableBody">
              <tr>
                <td colspan="9" class="no-data">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ì •ì‚° ìƒì„¸ ëª¨ë‹¬ -->
  <div id="stSettlementDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
    <div style="max-width: 900px; margin: 50px auto; background: white; border-radius: 14px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; color: #ff6b35; font-weight: 700;">ì •ì‚° ìƒì„¸</h2>
        <button onclick="stCloseDetailModal()" style="background: #e17055; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px;">Ã—</button>
      </div>
      <div id="stSettlementDetailContent"></div>
      <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
        <button class="st-btn" onclick="stDownloadStatement()">ğŸ“¥ ëª…ì„¸ì„œ ë‹¤ìš´ë¡œë“œ</button>
        <button class="st-btn-secondary" onclick="stCloseDetailModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    var stCurrentRole = '';
    var stCurrentCompany = '';
    var stCurrentUsername = '';
    var stInitialized = false;
    var stSelectedFiles = {}; // {file_type: {file: File}} (FormData ë°©ì‹ ì‚¬ìš©)
    var stCurrentSettlementId = null;

    // ê³µí†µ ì´ˆê¸°í™” í•¨ìˆ˜
    function stCommonInit() {
      if (stInitialized) {
        console.log('[ST] ì´ë¯¸ ì´ˆê¸°í™”ë¨, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
        return;
      }
      
      const container = document.getElementById('stContainer');
      if (!container) {
        console.error('[ST] stContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      // 1. ì—­í•  í™•ì¸ (í—¤ë” ìš°ì„ , ì—†ìœ¼ë©´ ì „ì—­ ë³€ìˆ˜/localStorage)
      const companyInfoEl = document.getElementById('companyInfo');
      if (companyInfoEl && companyInfoEl.textContent) {
        const headerText = companyInfoEl.textContent.trim();
        if (headerText.includes('[ê´€ë¦¬ì]')) {
          stCurrentRole = 'ê´€ë¦¬ì';
          const usernameMatch = headerText.match(/\(([^)]+)\)/);
          if (usernameMatch) {
            stCurrentUsername = usernameMatch[1].trim();
          }
          const companyMatch = headerText.match(/^([^[]+)/);
          if (companyMatch) {
            stCurrentCompany = companyMatch[1].trim();
          }
        } else {
          const usernameMatch = headerText.match(/\(([^)]+)\)/);
          if (usernameMatch) {
            stCurrentUsername = usernameMatch[1].trim();
          }
          const companyMatch = headerText.match(/^([^(]+)/);
          if (companyMatch) {
            stCurrentCompany = companyMatch[1].trim();
          }
          stCurrentRole = 'í™”ì£¼ì‚¬';
        }
      } else {
        stCurrentRole = (window.currentRole || localStorage.getItem('client_role') || '').toString().trim();
        stCurrentCompany = (window.currentCompany || localStorage.getItem('client_company') || '').toString().trim();
        stCurrentUsername = (window.currentUsername || localStorage.getItem('client_username') || '').toString().trim();
      }
      
      console.log('[ST] ì—­í•  í™•ì¸:', {
        role: stCurrentRole,
        company: stCurrentCompany,
        username: stCurrentUsername
      });
      
      // 2. ê°€ì‹œì„± ì œì–´
      stApplyVisibility();
      
      // 3. ëª¨ë“œë³„ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
      const roleNormalized = stCurrentRole.toString().trim();
      const isAdmin = (roleNormalized === 'ê´€ë¦¬ì');
      
      if (isAdmin) {
        stAdminInit();
      } else {
        stConsignorInit();
      }
      
      // 4. ê°€ì‹œì„± ì œì–´ ì¬ì‹¤í–‰
      setTimeout(() => {
        stApplyVisibility();
      }, 50);
      
      stInitialized = true;
      console.log('[ST] ì´ˆê¸°í™” ì™„ë£Œ');
    }
    window.stCommonInit = stCommonInit;

    // ê°€ì‹œì„± ì œì–´ í•¨ìˆ˜
    function stApplyVisibility() {
      const container = document.getElementById('stContainer');
      if (!container) return;
      
      const roleNormalized = (stCurrentRole || '').toString().trim();
      const isAdmin = (roleNormalized === 'ê´€ë¦¬ì');
      
      container.querySelectorAll('.st-admin-only').forEach(el => {
        el.style.display = isAdmin ? 'block' : 'none';
      });
      
      container.querySelectorAll('.st-consignor-only').forEach(el => {
        el.style.display = isAdmin ? 'none' : 'block';
      });
    }

    // ì‚¬ìš©ì í—¤ë” ìƒì„± í•¨ìˆ˜
    function stGetUserHeaders() {
      const encodeHeader = (value) => encodeURIComponent((value || '').toString().trim());
      return {
        'X-User-Role': encodeHeader(stCurrentRole),
        'X-User-Name': encodeHeader(stCurrentUsername),
        'X-Company-Name': encodeHeader(stCurrentCompany)
      };
    }

    // ê´€ë¦¬ì ì´ˆê¸°í™” í•¨ìˆ˜
    function stAdminInit() {
      console.log('[ST] stAdminInit ì‹œì‘');
      const container = document.getElementById('stContainer');
      if (!container) return;
      
      // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì •ì‚°ë…„ì›” ì´ˆê¸°í™”
      const today = new Date().toISOString().split('T')[0];
      const yearMonthInput = container.querySelector('#stAdminFilterYearMonth');
      if (yearMonthInput) yearMonthInput.value = today.slice(0, 7);
      
      // í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ
      stAdminLoadCompanies();
      
      // ì •ì‚° ëª©ë¡ ë¡œë“œ
      stAdminLoadSettlements();
    }

    // í™”ì£¼ì‚¬ ì´ˆê¸°í™” í•¨ìˆ˜
    function stConsignorInit() {
      console.log('[ST] stConsignorInit ì‹œì‘');
      const container = document.getElementById('stContainer');
      if (!container) return;
      
      // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì •ì‚°ë…„ì›” ì´ˆê¸°í™”
      const today = new Date().toISOString().split('T')[0];
      const yearMonthInput = container.querySelector('#stConsignorFilterYearMonth');
      if (yearMonthInput) yearMonthInput.value = today.slice(0, 7);
      
      // ì •ì‚° ëª©ë¡ ë¡œë“œ
      stConsignorLoadSettlements();
    }

    // ê´€ë¦¬ì ì •ì‚° ëª©ë¡ ë¡œë“œ
    function stAdminLoadSettlements() {
      const container = document.getElementById('stContainer');
      if (!container) return;
      
      const yearMonth = container.querySelector('#stAdminFilterYearMonth')?.value || '';
      const companyName = container.querySelector('#stAdminFilterCompanyName')?.value || '';
      
      let url = '/api/settlements/list?';
      if (yearMonth) url += `settlement_year_month=${yearMonth}&`;
      if (companyName) url += `company_name=${encodeURIComponent(companyName)}&`;
      
      const tbody = container.querySelector('#stTableBody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="no-data">ë¡œë”© ì¤‘...</td></tr>';
      
      fetch(url, {
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            let items = data.data || [];
            items.sort((a, b) => {
              if (b.settlement_year_month !== a.settlement_year_month) {
                return b.settlement_year_month.localeCompare(a.settlement_year_month);
              }
              return a.company_name.localeCompare(b.company_name);
            });
            stAdminRenderSettlements(items);
          } else {
            if (tbody) tbody.innerHTML = `<tr><td colspan="9" class="no-data">${data.message || 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</td></tr>`;
          }
        })
        .catch(error => {
          console.error('[ST] ê´€ë¦¬ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
          if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="no-data">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        });
    }
    
    // ì „ë‹¬ ì¡°íšŒ (statusê°€ 'ì „ë‹¬'ì¸ ì •ì‚°ë§Œ ì¡°íšŒ)
    function stAdminLoadDeliveredSettlements() {
      const container = document.getElementById('stContainer');
      if (!container) {
        console.error('[ST] stContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const yearMonth = container.querySelector('#stAdminFilterYearMonth')?.value || '';
      const companyName = container.querySelector('#stAdminFilterCompanyName')?.value || '';
      
      // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
      let urlParams = [];
      if (yearMonth) urlParams.push(`settlement_year_month=${yearMonth}`);
      if (companyName) urlParams.push(`company_name=${encodeURIComponent(companyName)}`);
      urlParams.push(`status=ì „ë‹¬`);
      const url = '/api/settlements/list?' + urlParams.join('&');
      
      console.log('[ST] ì „ë‹¬ ì¡°íšŒ URL:', url);
      
      const tbody = container.querySelector('#stTableBody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="no-data">ë¡œë”© ì¤‘...</td></tr>';
      
      fetch(url, {
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => {
          console.log('[ST] ì „ë‹¬ ì¡°íšŒ ì‘ë‹µ ìƒíƒœ:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('[ST] ì „ë‹¬ ì¡°íšŒ ì‘ë‹µ ë°ì´í„°:', data);
          if (data.success) {
            let items = data.data || [];
            console.log('[ST] ì „ë‹¬ ì •ì‚° ê°œìˆ˜:', items.length);
            items.sort((a, b) => {
              if (b.settlement_year_month !== a.settlement_year_month) {
                return b.settlement_year_month.localeCompare(a.settlement_year_month);
              }
              return a.company_name.localeCompare(b.company_name);
            });
            stAdminRenderSettlements(items);
          } else {
            console.error('[ST] ì „ë‹¬ ì¡°íšŒ ì‹¤íŒ¨:', data.message);
            const tbody = container.querySelector('#stTableBody');
            if (tbody) {
              tbody.innerHTML = `<tr><td colspan="9" class="no-data">${data.message || 'ì „ë‹¬ ì •ì‚° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</td></tr>`;
            }
          }
        })
        .catch(error => {
          console.error('[ST] ì „ë‹¬ ì •ì‚° ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
          const tbody = container.querySelector('#stTableBody');
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="9" class="no-data">ì „ë‹¬ ì •ì‚° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</td></tr>`;
          }
        });
    }
    
    // ì •ì‚°ë…„ì›” ì„ íƒ í›„ ë°”ë¡œ ì „ë‹¬ ì„ íƒ (ì´ì „ ë‹¬ì˜ ì •ì‚°ì„ ì „ë‹¬ ìƒíƒœë¡œ ë³€ê²½)
    function stSelectYearMonthForDelivery() {
      const yearMonth = document.getElementById('stAdminFilterYearMonth')?.value;
      if (!yearMonth) {
        alert('ì •ì‚°ë…„ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì„ íƒí•œ ì •ì‚°ë…„ì›”ì—ì„œ 1ê°œì›” ë¹¼ê¸° (ì˜ˆ: 2026-01 -> 2025-12)
      const [year, month] = yearMonth.split('-');
      const date = new Date(parseInt(year), parseInt(month) - 1, 1); // ì›”ì€ 0ë¶€í„° ì‹œì‘
      date.setMonth(date.getMonth() - 1); // 1ê°œì›” ë¹¼ê¸°
      
      const prevYear = date.getFullYear();
      const prevMonth = String(date.getMonth() + 1).padStart(2, '0');
      const prevYearMonth = `${prevYear}-${prevMonth}`;
      
      if (!confirm(`ì´ì „ ë‹¬(${prevYearMonth})ì˜ ëª¨ë“  ì •ì‚°ì„ ì „ë‹¬ ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      fetch(`/api/settlements/bulk-update-status?settlement_year_month=${prevYearMonth}&status=ì „ë‹¬`, {
        method: 'POST',
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`ì •ì‚°ë…„ì›” ${prevYearMonth}ì˜ ${data.updated_count || 0}ê°œ ì •ì‚°ì´ ì „ë‹¬ ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            // ì´ì „ ë‹¬ ì •ì‚° ëª©ë¡ ì¡°íšŒ
            document.getElementById('stAdminFilterYearMonth').value = prevYearMonth;
            stAdminLoadDeliveredSettlements();
          } else {
            alert(data.message || 'ì „ë‹¬ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[ST] ì „ë‹¬ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
          alert('ì „ë‹¬ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // í™”ì£¼ì‚¬ ì •ì‚° ëª©ë¡ ë¡œë“œ
    function stConsignorLoadSettlements() {
      const container = document.getElementById('stContainer');
      if (!container) return;
      
      const yearMonth = container.querySelector('#stConsignorFilterYearMonth')?.value || '';
      const companyName = stCurrentCompany;
      
      if (!companyName) {
        console.error('[ST] í™”ì£¼ì‚¬ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        alert('í™”ì£¼ì‚¬ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      let url = '/api/settlements/list?';
      if (yearMonth) url += `settlement_year_month=${yearMonth}&`;
      url += `company_name=${encodeURIComponent(companyName)}&`;
      
      const tbody = container.querySelector('#stTableBody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="no-data">ë¡œë”© ì¤‘...</td></tr>';
      
      fetch(url, {
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            let items = data.data || [];
            items.sort((a, b) => b.settlement_year_month.localeCompare(a.settlement_year_month));
            stConsignorRenderSettlements(items);
          } else {
            if (tbody) tbody.innerHTML = `<tr><td colspan="8" class="no-data">${data.message || 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</td></tr>`;
          }
        })
        .catch(error => {
          console.error('[ST] í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
          if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="no-data">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        });
    }

    // ê´€ë¦¬ì ì •ì‚° ëª©ë¡ ë Œë”ë§
    function stAdminRenderSettlements(items) {
      const tbody = document.getElementById('stTableBody');
      if (!tbody) return;
      
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="no-data">ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      tbody.innerHTML = items.map((item, index) => {
        const totalAmount = (item.work_fee || 0) + (item.inout_fee || 0) + (item.shipping_fee || 0) + 
                           (item.storage_fee || 0) + (item.special_work_fee || 0) - (item.error_deduction || 0);
        const tax = Math.floor(totalAmount * 0.1); // ì„¸ê¸ˆ (ë¶€ê°€ì„¸ 10%)
        const finalAmount = totalAmount + tax; // ê²°ì œê¸ˆì•¡ (ì´ì•¡ + ì„¸ê¸ˆ)
        const status = item.status || 'ëŒ€ê¸°';
        
        // ìƒíƒœë³„ ìƒ‰ìƒ
        let statusColor = '#2d3436';
        if (status === 'ì „ë‹¬') statusColor = '#0984e3';
        else if (status === 'ì •ì‚°í™•ì¸') statusColor = '#00b894';
        else if (status === 'ì…ê¸ˆì™„ë£Œ') statusColor = '#00a085';
        
        // ì„¸ê¸ˆê³„ì‚°ì„œ ì»¬ëŸ¼: ê´€ë¦¬ìê°€ ì—…ë¡œë“œ ë²„íŠ¼ ë˜ëŠ” ë‹¤ìš´ë¡œë“œ ë§í¬
        let taxInvoiceCell = '';
        if (item.tax_invoice_file_url) {
          taxInvoiceCell = `<a href="${item.tax_invoice_file_url}" target="_blank" class="st-file-link" download style="font-size: 12px;">ğŸ“„ ë‹¤ìš´ë¡œë“œ</a>`;
        } else if (status === 'ì •ì‚°í™•ì¸') {
          // ì •ì‚°í™•ì¸ ìƒíƒœì¼ ë•Œë§Œ ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œ ê°€ëŠ¥
          taxInvoiceCell = `<button class="st-btn" onclick="stUploadTaxInvoice(${item.id})" style="padding: 6px 12px; font-size: 12px;">ğŸ“„ ì—…ë¡œë“œ</button>`;
        } else {
          taxInvoiceCell = '<span style="color: #999;">-</span>';
        }
        
        // ìƒíƒœë³„ ì•¡ì…˜ ë²„íŠ¼ (í™•ì •, ì…ê¸ˆí™•ì¸)
        let actionButtons = '';
        if (status === 'ëŒ€ê¸°') {
          // ëŒ€ê¸° ìƒíƒœë©´ í™•ì • ë²„íŠ¼ í‘œì‹œ (ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œ ì „)
          actionButtons = `<button class="st-btn" onclick="stConfirmSettlement(${item.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px; background: linear-gradient(135deg, #00b894 0%, #00a085 100%);">âœ… í™•ì •</button>`;
        } else if (status === 'ì •ì‚°í™•ì¸' && item.tax_invoice_file_url) {
          // ì •ì‚°í™•ì¸ ìƒíƒœì´ê³  ì„¸ê¸ˆê³„ì‚°ì„œê°€ ì—…ë¡œë“œë˜ì–´ ìˆìœ¼ë©´ ì…ê¸ˆí™•ì¸ ë²„íŠ¼ í‘œì‹œ
          actionButtons = `<button class="st-btn" onclick="stCompletePayment(${item.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px; background: linear-gradient(135deg, #00a085 0%, #008874 100%);">ğŸ’° ì…ê¸ˆí™•ì¸</button>`;
        }
        
        return `
          <tr>
            <td>${index + 1}</td>
            <td>${item.settlement_year_month || ''}</td>
            <td>${item.company_name || ''}</td>
            <td style="font-weight: 600;">${totalAmount.toLocaleString()}ì›</td>
            <td style="color: #0984e3; font-weight: 600;">${tax.toLocaleString()}ì›</td>
            <td style="font-weight: 700; color: #ff6b35;">${finalAmount.toLocaleString()}ì›</td>
            <td style="color: ${statusColor}; font-weight: 600;">${status}</td>
            <td>${taxInvoiceCell}</td>
            <td>
              ${actionButtons}
              <button class="st-btn" onclick="stShowSettlementDetail(${item.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">ìƒì„¸</button>
              <button class="st-btn" onclick="stEditSettlement(${item.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">ìˆ˜ì •</button>
              <button class="st-btn-danger" onclick="stDeleteSettlement(${item.id})" style="padding: 6px 12px; font-size: 12px;">ì‚­ì œ</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // í™”ì£¼ì‚¬ ì •ì‚° ëª©ë¡ ë Œë”ë§
    function stConsignorRenderSettlements(items) {
      const tbody = document.getElementById('stTableBody');
      if (!tbody) return;
      
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      tbody.innerHTML = items.map((item, index) => {
        const totalAmount = (item.work_fee || 0) + (item.inout_fee || 0) + (item.shipping_fee || 0) + 
                           (item.storage_fee || 0) + (item.special_work_fee || 0) - (item.error_deduction || 0);
        const tax = Math.floor(totalAmount * 0.1); // ì„¸ê¸ˆ (ë¶€ê°€ì„¸ 10%)
        const finalAmount = totalAmount + tax; // ê²°ì œê¸ˆì•¡ (ì´ì•¡ + ì„¸ê¸ˆ)
        const status = item.status || 'ëŒ€ê¸°';
        
        // ìƒíƒœë³„ ìƒ‰ìƒ
        let statusColor = '#2d3436';
        if (status === 'ì „ë‹¬') statusColor = '#0984e3';
        else if (status === 'ì •ì‚°í™•ì¸') statusColor = '#00b894';
        else if (status === 'ì…ê¸ˆì™„ë£Œ') statusColor = '#00a085';
        
        // ì„¸ê¸ˆê³„ì‚°ì„œ ì»¬ëŸ¼: í™”ì£¼ì‚¬ëŠ” ë‹¤ìš´ë¡œë“œë§Œ ê°€ëŠ¥ (ì—…ë¡œë“œ ë²„íŠ¼ ì—†ìŒ)
        let taxInvoiceCell = '';
        if (item.tax_invoice_file_url) {
          taxInvoiceCell = `<a href="${item.tax_invoice_file_url}" target="_blank" class="st-file-link" download style="font-size: 12px;">ğŸ“„ ë‹¤ìš´ë¡œë“œ</a>`;
        } else {
          taxInvoiceCell = '<span style="color: #999;">-</span>';
        }
        
        // í™”ì£¼ì‚¬ ì•¡ì…˜ ë²„íŠ¼ (ì •ì‚°í™•ì¸)
        let actionButtons = '';
        if (status === 'ì „ë‹¬') {
          // ì „ë‹¬ ìƒíƒœë©´ ì •ì‚°í™•ì¸ ë²„íŠ¼ í‘œì‹œ
          actionButtons = `<button class="st-btn" onclick="stConfirmSettlementByConsignor(${item.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px; background: linear-gradient(135deg, #00b894 0%, #00a085 100%);">âœ… ì •ì‚°í™•ì¸</button>`;
        }
        
        return `
          <tr>
            <td>${index + 1}</td>
            <td>${item.settlement_year_month || ''}</td>
            <td style="font-weight: 600;">${totalAmount.toLocaleString()}ì›</td>
            <td style="color: #0984e3; font-weight: 600;">${tax.toLocaleString()}ì›</td>
            <td style="font-weight: 700; color: #ff6b35;">${finalAmount.toLocaleString()}ì›</td>
            <td style="color: ${statusColor}; font-weight: 600;">${status}</td>
            <td>${taxInvoiceCell}</td>
            <td>
              ${actionButtons}
              <button class="st-btn" onclick="stShowSettlementDetail(${item.id})" style="padding: 6px 12px; font-size: 12px;">ìƒì„¸</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ì •ì‚° ë“±ë¡ í¼ í† ê¸€
    function stAdminToggleSettlementForm() {
      const form = document.getElementById('stAdminSettlementForm');
      const icon = document.getElementById('stAdminSettlementIcon');
      if (form.style.display === 'none' || !form.style.display) {
        form.style.display = 'block';
        icon.textContent = 'â–²';
      } else {
        form.style.display = 'none';
        icon.textContent = 'â–¼';
      }
    }

    // ì´ì•¡ ê³„ì‚°
    function stCalculateTotal() {
      const workFee = parseInt(document.getElementById('stWorkFee')?.value || 0);
      const inoutFee = parseInt(document.getElementById('stInoutFee')?.value || 0);
      const shippingFee = parseInt(document.getElementById('stShippingFee')?.value || 0);
      const storageFee = parseInt(document.getElementById('stStorageFee')?.value || 0);
      const specialWorkFee = parseInt(document.getElementById('stSpecialWorkFee')?.value || 0);
      const errorDeduction = parseInt(document.getElementById('stErrorDeduction')?.value || 0);
      
      const total = workFee + inoutFee + shippingFee + storageFee + specialWorkFee - errorDeduction;
      document.getElementById('stTotalAmount').textContent = total.toLocaleString();
    }

    // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
    async function stHandleFileSelect(fileType, event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // fileTypeì„ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜: 'work_fee' -> 'WorkFee' (ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°, ê° ë‹¨ì–´ ì²« ê¸€ì ëŒ€ë¬¸ì)
      const fileTypeCapitalized = fileType.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
      const uploadTextEl = document.getElementById(`st${fileTypeCapitalized}FileUploadText`);
      const displayDiv = document.getElementById(`st${fileTypeCapitalized}FileDisplay`);
      const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
      
      // íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ë§Œ ì €ì¥í•˜ê³  í‘œì‹œë§Œ í•¨ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì—…ë¡œë“œ)
      stSelectedFiles[fileType] = { file: file };
      
      // ë°•ìŠ¤ ë°‘ í‘œì‹œ ì˜ì—­ì— íŒŒì¼ëª…(ìš©ëŸ‰) ë° ì €ì¥ í›„ ì—…ë¡œë“œ ì˜ˆì • í‘œì‹œ
      if (displayDiv) {
        displayDiv.innerHTML = `<div style="margin-top: 4px; padding: 4px 8px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 3px; display: flex; align-items: center; justify-content: space-between; font-size: 11px;">
          <span style="color: #856404; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; margin-right: 8px;">ğŸ“„ ${file.name} (${fileSizeMB}MB) - ì €ì¥ í›„ ì—…ë¡œë“œ ì˜ˆì •</span>
          <button type="button" onclick="stRemoveFile('${fileType}', event)" style="padding: 2px 6px; background: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px; white-space: nowrap;">âŒ ì·¨ì†Œ</button>
        </div>`;
      }
      
      // ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ëŠ” ì›ë˜ëŒ€ë¡œ ìœ ì§€
      if (uploadTextEl) {
        uploadTextEl.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
      }
    }
    
    // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜ (í…ŒìŠ¤íŠ¸ íŒŒì¼ê³¼ ë™ì¼)
    function stFileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1]; // data:xxx;base64, ë¶€ë¶„ ì œê±°
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ì—…ë¡œë“œ (í…ŒìŠ¤íŠ¸ íŒŒì¼ê³¼ ë™ì¼í•œ ë°©ì‹)
    async function stUploadInChunks(file, fileType, settlementId, uploadTextEl = null, displayDiv = null) {
      const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB ì²­í¬
      const fileData = await stFileToBase64(file);
      const totalChunks = Math.ceil(fileData.length / CHUNK_SIZE);
      
      console.log(`[ST] íŒŒì¼ í¬ê¸°: ${(fileData.length / 1024 / 1024).toFixed(2)} MB`);
      console.log(`[ST] ì²­í¬ ê°œìˆ˜: ${totalChunks}`);
      
      // ì—…ë¡œë“œ ì‹œì‘
      const startResponse = await fetch('/api/settlements/upload-file-start', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...stGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify({
          settlement_id: parseInt(settlementId),
          file_type: fileType,
          filename: file.name,
          file_size: fileData.length,
          total_chunks: totalChunks
        })
      });
      
      const startData = await startResponse.json();
      if (!startData.success) {
        throw new Error(startData.message || 'ì—…ë¡œë“œ ì‹œì‘ ì‹¤íŒ¨');
      }
      
      const uploadId = startData.upload_id;
      console.log(`[ST] ì—…ë¡œë“œ ID: ${uploadId}`);
      
      // ì²­í¬ ì—…ë¡œë“œ
      for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
        const start = chunkIndex * CHUNK_SIZE;
        const end = Math.min(start + CHUNK_SIZE, fileData.length);
        const chunk = fileData.substring(start, end);
        const isLastChunk = chunkIndex === totalChunks - 1;
        
        console.log(`[ST] ì²­í¬ ${chunkIndex + 1}/${totalChunks} ì—…ë¡œë“œ ì¤‘...`);
        
        // ì§„í–‰ ìƒí™© í‘œì‹œ (ë°•ìŠ¤ ë°‘ í‘œì‹œ ì˜ì—­ ì—…ë°ì´íŠ¸)
        if (displayDiv) {
          const progress = Math.round(((chunkIndex + 1) / totalChunks) * 100);
          const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
          displayDiv.innerHTML = `<div style="margin-top: 4px; padding: 4px 8px; background: #d1ecf1; border: 1px solid #0c5460; border-radius: 3px; display: flex; align-items: center; justify-content: space-between; font-size: 11px;">
            <span style="color: #0c5460; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">ğŸ“„ ${file.name} (${fileSizeMB}MB) - â³ ì²­í¬ ${chunkIndex + 1}/${totalChunks} (${progress}%)</span>
          </div>`;
        }
        // ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ë„ ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­)
        if (uploadTextEl) {
          const progress = Math.round(((chunkIndex + 1) / totalChunks) * 100);
          uploadTextEl.textContent = `â³ ì²­í¬ ${chunkIndex + 1}/${totalChunks} ì—…ë¡œë“œ ì¤‘... (${progress}%)`;
        }
        
        const chunkResponse = await fetch('/api/settlements/upload-file-chunk', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...stGetUserHeaders()
          },
          credentials: 'include',
          body: JSON.stringify({
            upload_id: uploadId,
            chunk_index: chunkIndex,
            chunk_data: chunk,
            is_last_chunk: isLastChunk
          })
        });
        
        const chunkData = await chunkResponse.json();
        if (!chunkData.success) {
          throw new Error(chunkData.message || `ì²­í¬ ${chunkIndex + 1} ì—…ë¡œë“œ ì‹¤íŒ¨`);
        }
      }
      
      // ì—…ë¡œë“œ ì™„ë£Œ
      const completeResponse = await fetch('/api/settlements/upload-file-complete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...stGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify({
          upload_id: uploadId
        })
      });
      
      const completeData = await completeResponse.json();
      if (!completeData.success) {
        throw new Error(completeData.message || 'ì—…ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨');
      }
      
      // ë°•ìŠ¤ ë°‘ í‘œì‹œ ì˜ì—­ì— ì—…ë¡œë“œ ì™„ë£Œ í‘œì‹œ (displayDivê°€ ì „ë‹¬ëœ ê²½ìš°)
      if (displayDiv) {
        const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
        displayDiv.innerHTML = `<div style="margin-top: 4px; padding: 4px 8px; background: #d4edda; border: 1px solid #28a745; border-radius: 3px; display: flex; align-items: center; justify-content: space-between; font-size: 11px;">
          <span style="color: #155724; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; margin-right: 8px;">âœ… ${file.name} (${fileSizeMB}MB) - ì—…ë¡œë“œ ì™„ë£Œ</span>
          <button type="button" onclick="stDeleteUploadedFile('${fileType}', event)" style="padding: 2px 6px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px; white-space: nowrap;">âŒ ì‚­ì œ</button>
        </div>`;
      }
      
      return completeData;
    }
    
    // íŒŒì¼ ì¦‰ì‹œ ì—…ë¡œë“œ (ìˆ˜ì • ëª¨ë“œ) - 4MB ì´ìƒì€ ì²­í¬ ì—…ë¡œë“œ, ë¯¸ë§Œì€ FormData
    async function stUploadFileImmediately(fileType, settlementId, file) {
      // fileTypeì„ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜: 'work_fee' -> 'WorkFee' (ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°, ê° ë‹¨ì–´ ì²« ê¸€ì ëŒ€ë¬¸ì)
      const fileTypeCapitalized = fileType.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
      const uploadTextEl = document.getElementById(`st${fileTypeCapitalized}FileUploadText`);
      const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
      
      const companyName = document.getElementById('stSettlementCompanyName')?.value;
      const yearMonth = document.getElementById('stSettlementYearMonth')?.value;
      
      if (!companyName || !yearMonth) {
        // ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ ë³€ê²½: ì˜¤ë¥˜
        if (uploadTextEl) {
          uploadTextEl.textContent = 'âŒ í™”ì£¼ì‚¬ì™€ ì •ì‚°ë…„ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.';
        }
        return;
      }
      
      try {
        // 4MB ì´ìƒì´ë©´ ì²­í¬ ì—…ë¡œë“œ, ë¯¸ë§Œì´ë©´ ì¼ë°˜ ì—…ë¡œë“œ (í…ŒìŠ¤íŠ¸ íŒŒì¼ê³¼ ë™ì¼)
        const FILE_SIZE_LIMIT = 4 * 1024 * 1024; // 4MB
        
        if (file.size >= FILE_SIZE_LIMIT) {
          // ì²­í¬ ì—…ë¡œë“œ
          console.log('[ST] ì²­í¬ ì—…ë¡œë“œ ëª¨ë“œ');
          // fileTypeì„ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜: 'work_fee' -> 'WorkFee' (ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°, ê° ë‹¨ì–´ ì²« ê¸€ì ëŒ€ë¬¸ì)
          const fileTypeCapitalized = fileType.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
          const displayDiv = document.getElementById(`st${fileTypeCapitalized}FileDisplay`);
          const data = await stUploadInChunks(file, fileType, settlementId, uploadTextEl, displayDiv);
          
          if (data.success) {
            // stSelectedFilesì—ì„œ ì œê±° (ì´ë¯¸ ì—…ë¡œë“œë¨)
            delete stSelectedFiles[fileType];
          } else {
            // ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë°•ìŠ¤ ë°‘ í‘œì‹œ ì˜ì—­ì— ì˜¤ë¥˜ í‘œì‹œ
            if (displayDiv) {
              displayDiv.innerHTML = `<div style="margin-top: 4px; padding: 4px 8px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 3px; color: #721c24; font-size: 11px;">
                âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}
              </div>`;
            }
            throw new Error(data.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
          }
        } else {
          // ì¼ë°˜ ì—…ë¡œë“œ (FormData)
          console.log('[ST] ì¼ë°˜ ì—…ë¡œë“œ ëª¨ë“œ');
          const formData = new FormData();
          formData.append('file', file);
          formData.append('settlement_id', settlementId);
          formData.append('file_type', fileType);
          
          const headers = stGetUserHeaders();
          
          const response = await fetch('/api/settlements/upload-file', {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            // ë°•ìŠ¤ ë°‘ í‘œì‹œ ì˜ì—­ì— ì—…ë¡œë“œ ì™„ë£Œ í‘œì‹œ
            // fileTypeì„ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜: 'work_fee' -> 'WorkFee' (ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°, ê° ë‹¨ì–´ ì²« ê¸€ì ëŒ€ë¬¸ì)
            const fileTypeCapitalized = fileType.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
            const displayDiv = document.getElementById(`st${fileTypeCapitalized}FileDisplay`);
            if (displayDiv) {
              const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
              displayDiv.innerHTML = `<div style="margin-top: 4px; padding: 4px 8px; background: #d4edda; border: 1px solid #28a745; border-radius: 3px; display: flex; align-items: center; justify-content: space-between; font-size: 11px;">
                <span style="color: #155724; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; margin-right: 8px;">âœ… ${file.name} (${fileSizeMB}MB) - ì—…ë¡œë“œ ì™„ë£Œ</span>
                <button type="button" onclick="stDeleteUploadedFile('${fileType}', event)" style="padding: 2px 6px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px; white-space: nowrap;">âŒ ì‚­ì œ</button>
              </div>`;
            }
            // stSelectedFilesì—ì„œ ì œê±° (ì´ë¯¸ ì—…ë¡œë“œë¨)
            delete stSelectedFiles[fileType];
          } else {
            throw new Error(result.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
          }
        }
      } catch (error) {
        console.error('[ST] íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        // ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ ë³€ê²½: ì—…ë¡œë“œ ì‹¤íŒ¨
        if (uploadTextEl) {
          uploadTextEl.textContent = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
        }
      }
    }
    
    // ì—…ë¡œë“œ ì™„ë£Œëœ íŒŒì¼ ì‚­ì œ
    async function stDeleteUploadedFile(fileType, event) {
      event.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
      
      if (!confirm('ì—…ë¡œë“œëœ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      // fileTypeì„ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜: 'work_fee' -> 'WorkFee' (ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°, ê° ë‹¨ì–´ ì²« ê¸€ì ëŒ€ë¬¸ì)
      const fileTypeCapitalized = fileType.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
      const uploadTextEl = document.getElementById(`st${fileTypeCapitalized}FileUploadText`);
      const displayDiv = document.getElementById(`st${fileTypeCapitalized}FileDisplay`);
      const settlementId = document.getElementById('stSettlementId')?.value;
      
      if (!settlementId) {
        alert('ì •ì‚° IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ë°•ìŠ¤ ë°‘ í‘œì‹œ ì˜ì—­ì— ì‚­ì œ ì¤‘ í‘œì‹œ
      if (displayDiv) {
        displayDiv.innerHTML = '<div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; color: #666;">â³ ì‚­ì œ ì¤‘...</div>';
      }
      
      try {
        const response = await fetch(`/api/settlements/${settlementId}/delete-file`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...stGetUserHeaders()
          },
          credentials: 'include',
          body: JSON.stringify({
            file_type: fileType
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // ë°•ìŠ¤ ë°‘ í‘œì‹œ ì˜ì—­ ë¹„ìš°ê¸°
          if (displayDiv) {
            displayDiv.innerHTML = '';
          }
          // ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ (ì´ë¯¸ "ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ" ìƒíƒœ)
        } else {
          throw new Error(result.message || 'íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('[ST] íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert(`íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        
        // ë°•ìŠ¤ ë°‘ í‘œì‹œ ì˜ì—­ì— ì˜¤ë¥˜ í‘œì‹œ
        if (displayDiv) {
          displayDiv.innerHTML = `<div style="margin-top: 8px; padding: 8px; background: #fee; border-radius: 4px; color: #c33;">âŒ ì‚­ì œ ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</div>`;
        }
      }
    }

    // íŒŒì¼ ì œê±°
    function stRemoveFile(fileType, event) {
      if (event) {
        event.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
      }
      
      delete stSelectedFiles[fileType];
      // fileTypeì„ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜: 'work_fee' -> 'WorkFee' (ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°, ê° ë‹¨ì–´ ì²« ê¸€ì ëŒ€ë¬¸ì)
      const fileTypeCapitalized = fileType.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
      const uploadTextEl = document.getElementById(`st${fileTypeCapitalized}FileUploadText`);
      const displayDiv = document.getElementById(`st${fileTypeCapitalized}FileDisplay`);
      
      // ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ ì›ë˜ëŒ€ë¡œ ë³µì›
      if (uploadTextEl) {
        uploadTextEl.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
      }
      
      if (displayDiv) {
        displayDiv.innerHTML = '';
      }
      const input = document.getElementById(`st${fileTypeCapitalized}FileInput`);
      if (input) {
        input.value = '';
      }
    }

    // íŒŒë ˆíŠ¸ ë³´ê´€ë£Œ ê°€ì ¸ì˜¤ê¸°
    function stLoadStorageFee() {
      const companyName = document.getElementById('stSettlementCompanyName')?.value || stCurrentCompany;
      const yearMonth = document.getElementById('stSettlementYearMonth')?.value;
      
      if (!companyName || !yearMonth) {
        alert('í™”ì£¼ì‚¬ì™€ ì •ì‚°ë…„ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      fetch(`/api/settlements/data-sources?settlement_year_month=${yearMonth}&company_name=${encodeURIComponent(companyName)}`, {
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.data) {
            const storageFee = data.data.storage_fee || 0;
            document.getElementById('stStorageFee').value = storageFee;
            document.getElementById('stStorageFeeDisplay').textContent = storageFee.toLocaleString();
            stCalculateTotal();
          }
        })
        .catch(error => {
          console.error('[ST] ë³´ê´€ë£Œ ë¡œë“œ ì˜¤ë¥˜:', error);
          alert('ë³´ê´€ë£Œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // íŠ¹ìˆ˜ì‘ì—… ë¹„ìš© ê°€ì ¸ì˜¤ê¸°
    function stLoadSpecialWorkFee() {
      // í™”ì£¼ì‚¬ëª… ê°€ì ¸ì˜¤ê¸° (ì—¬ëŸ¬ ë°©ë²• ì‹œë„, íŠ¹ìˆ˜ì‘ì—… ë©”ë‰´ì™€ ë™ì¼í•œ ë°©ì‹)
      const companyInput = document.getElementById('stSettlementCompanyInput')?.value?.trim();
      const companyNameHidden = document.getElementById('stSettlementCompanyName')?.value?.trim();
      const companyName = companyNameHidden || companyInput || stCurrentCompany;
      
      const yearMonth = document.getElementById('stSettlementYearMonth')?.value;
      
      if (!companyName || !yearMonth) {
        alert('í™”ì£¼ì‚¬ì™€ ì •ì‚°ë…„ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì •ì‚°ë…„ì›”ì„ ë‚ ì§œ ë²”ìœ„ë¡œ ë³€í™˜ (íŠ¹ìˆ˜ì‘ì—… ë©”ë‰´ì™€ ë™ì¼í•œ ë°©ì‹)
      const [yearStr, monthStr] = yearMonth.split('-');
      const year = parseInt(yearStr, 10);
      const month = parseInt(monthStr, 10);
      const lastDay = new Date(year, month, 0).getDate(); // í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ 
      const paddedMonth = monthStr.padStart(2, '0');
      const startDate = `${yearStr}-${paddedMonth}-01`;
      const endDate = `${yearStr}-${paddedMonth}-${String(lastDay).padStart(2, '0')}`;
      
      console.log('[ST] íŠ¹ìˆ˜ì‘ì—… ë¹„ìš© ì¡°íšŒ ì‹œì‘:', { 
        companyName, 
        yearMonth,
        startDate,
        endDate
      });
      
      // íŠ¹ìˆ˜ì‘ì—… ë©”ë‰´ì™€ ë™ì¼í•œ API í˜¸ì¶œ
      let url = '/api/special-works/works?';
      url += `start_date=${startDate}&`;
      url += `end_date=${endDate}&`;
      url += `company_name=${encodeURIComponent(companyName)}&`;
      
      fetch(url, {
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => {
          console.log('[ST] íŠ¹ìˆ˜ì‘ì—… ë¹„ìš© ì¡°íšŒ ì‘ë‹µ ìƒíƒœ:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('[ST] íŠ¹ìˆ˜ì‘ì—… ë¹„ìš© ì¡°íšŒ ì‘ë‹µ ë°ì´í„°:', data);
          if (data.success && data.data) {
            // íŠ¹ìˆ˜ì‘ì—… ë©”ë‰´ì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ í•©ì‚°
            const works = data.data || [];
            const specialWorkFee = works.reduce((sum, work) => {
              return sum + (parseFloat(work.total_price) || 0);
            }, 0);
            
            console.log('[ST] íŠ¹ìˆ˜ì‘ì—… ë¹„ìš© ê³„ì‚°:', { 
              worksCount: works.length, 
              specialWorkFee 
            });
            
            const feeInput = document.getElementById('stSpecialWorkFee');
            const feeDisplay = document.getElementById('stSpecialWorkFeeDisplay');
            
            if (feeInput) {
              feeInput.value = Math.round(specialWorkFee);
            }
            if (feeDisplay) {
              feeDisplay.textContent = Math.round(specialWorkFee).toLocaleString();
            }
            
            stCalculateTotal();
            
            if (specialWorkFee === 0) {
              alert('í•´ë‹¹ ê¸°ê°„ì˜ íŠ¹ìˆ˜ì‘ì—… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            } else {
              alert(`íŠ¹ìˆ˜ì‘ì—… ë¹„ìš© ${Math.round(specialWorkFee).toLocaleString()}ì›ì´ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.`);
            }
          } else {
            console.error('[ST] íŠ¹ìˆ˜ì‘ì—… ë¹„ìš© ì¡°íšŒ ì‹¤íŒ¨:', data.message);
            alert(data.message || 'íŠ¹ìˆ˜ì‘ì—… ë¹„ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[ST] íŠ¹ìˆ˜ì‘ì—… ë¹„ìš© ë¡œë“œ ì˜¤ë¥˜:', error);
          alert(`íŠ¹ìˆ˜ì‘ì—… ë¹„ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        });
    }

    // ì˜¤ë°°ì†¡/ëˆ„ë½ ê±´ìˆ˜ í™•ì¸
    function stLoadErrorCounts() {
      const companyName = document.getElementById('stSettlementCompanyName')?.value || stCurrentCompany;
      const yearMonth = document.getElementById('stSettlementYearMonth')?.value;
      
      if (!companyName || !yearMonth) {
        alert('í™”ì£¼ì‚¬ì™€ ì •ì‚°ë…„ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      fetch(`/api/settlements/data-sources?settlement_year_month=${yearMonth}&company_name=${encodeURIComponent(companyName)}`, {
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.data) {
            const wrongDeliveryCount = data.data.error_wrong_delivery_count || 0;
            const missingCount = data.data.error_missing_count || 0;
            document.getElementById('stErrorCountsDisplay').textContent = `ì˜¤ë°°ì†¡: ${wrongDeliveryCount}ê±´, ëˆ„ë½: ${missingCount}ê±´`;
          }
        })
        .catch(error => {
          console.error('[ST] ì˜¤ë°°ì†¡/ëˆ„ë½ ê±´ìˆ˜ í™•ì¸ ì˜¤ë¥˜:', error);
          alert('ì˜¤ë°°ì†¡/ëˆ„ë½ ê±´ìˆ˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ì •ì‚° ì €ì¥ ì²˜ë¦¬
    function stAdminHandleSettlementSubmit(event) {
      event.preventDefault();
      
      const companyName = document.getElementById('stSettlementCompanyName')?.value;
      const yearMonth = document.getElementById('stSettlementYearMonth')?.value;
      const workFee = parseInt(document.getElementById('stWorkFee')?.value || 0);
      const inoutFee = parseInt(document.getElementById('stInoutFee')?.value || 0);
      const shippingFee = parseInt(document.getElementById('stShippingFee')?.value || 0);
      const storageFee = parseInt(document.getElementById('stStorageFee')?.value || 0);
      const specialWorkFee = parseInt(document.getElementById('stSpecialWorkFee')?.value || 0);
      const errorDeduction = parseInt(document.getElementById('stErrorDeduction')?.value || 0);
      const memo = document.getElementById('stSettlementMemo')?.value || '';
      const settlementId = document.getElementById('stSettlementId')?.value;
      
      if (!companyName || !yearMonth) {
        alert('í™”ì£¼ì‚¬ì™€ ì •ì‚°ë…„ì›”ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }
      
      const totalAmount = workFee + inoutFee + shippingFee + storageFee + specialWorkFee - errorDeduction;
      
      const data = {
        company_name: companyName,
        settlement_year_month: yearMonth,
        work_fee: workFee,
        inout_fee: inoutFee,
        shipping_fee: shippingFee,
        storage_fee: storageFee,
        special_work_fee: specialWorkFee,
        error_deduction: errorDeduction,
        total_amount: totalAmount,
        memo: memo
      };
      
      const url = settlementId ? `/api/settlements/${settlementId}` : '/api/settlements/';
      const method = settlementId ? 'PUT' : 'POST';
      
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          ...stGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            alert(result.message || 'ì •ì‚°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ (4MB ì´ìƒì€ ì²­í¬ ì—…ë¡œë“œ, ë¯¸ë§Œì€ FormData)
            const finalSettlementId = result.id || settlementId;
            if (finalSettlementId && Object.keys(stSelectedFiles).length > 0) {
              const promises = [];
              const FILE_SIZE_LIMIT = 4 * 1024 * 1024; // 4MB
              
              for (const [fileType, fileData] of Object.entries(stSelectedFiles)) {
                if (fileData && fileData.file) {
                  const file = fileData.file;
                  // fileTypeì„ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜: 'work_fee' -> 'WorkFee' (ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°, ê° ë‹¨ì–´ ì²« ê¸€ì ëŒ€ë¬¸ì)
                  const fileTypeCapitalized = fileType.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
                  const uploadTextEl = document.getElementById(`st${fileTypeCapitalized}FileUploadText`);
                  
                  // ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ ë³€ê²½: ì—…ë¡œë“œ ì‹œì‘
                  if (uploadTextEl) {
                    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                    uploadTextEl.textContent = `â³ ì—…ë¡œë“œ ì¤‘... (${fileSizeMB} MB)`;
                  }
                  
                  if (file.size >= FILE_SIZE_LIMIT) {
                    // ì²­í¬ ì—…ë¡œë“œ (uploadTextEl, displayDiv ì „ë‹¬í•˜ì—¬ ì§„í–‰ ìƒí™© ë° ì™„ë£Œ í‘œì‹œ)
                    const displayDiv = document.getElementById(`st${fileTypeCapitalized}FileDisplay`);
                    promises.push(
                      stUploadInChunks(file, fileType, finalSettlementId, uploadTextEl, displayDiv)
                        .then(data => {
                          // ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ ì›ë˜ëŒ€ë¡œ ë³µì›
                          if (uploadTextEl) {
                            uploadTextEl.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
                          }
                          return data;
                        })
                    );
                  } else {
                    // FormData ì—…ë¡œë“œ
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('settlement_id', finalSettlementId);
                    formData.append('file_type', fileType);
                    
                    const headers = stGetUserHeaders();
                    
                    promises.push(
                      fetch('/api/settlements/upload-file', {
                        method: 'POST',
                        headers: headers,
                        credentials: 'include',
                        body: formData
                      }).then(async response => {
                        const result = await response.json();
                        
                        // ë°•ìŠ¤ ë°‘ í‘œì‹œ ì˜ì—­ì— ì—…ë¡œë“œ ê²°ê³¼ í‘œì‹œ
                        // fileTypeì„ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜: 'work_fee' -> 'WorkFee' (ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°, ê° ë‹¨ì–´ ì²« ê¸€ì ëŒ€ë¬¸ì)
                        const fileTypeCapitalizedForDisplay = fileType.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
                        const displayDiv = document.getElementById(`st${fileTypeCapitalizedForDisplay}FileDisplay`);
                        if (displayDiv) {
                          if (result.success) {
                            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                            displayDiv.innerHTML = `<div style="margin-top: 8px; padding: 8px; background: #d4edda; border: 1px solid #28a745; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                              <span style="color: #155724; font-weight: 600;">âœ… ${file.name} (${fileSizeMB} MB) - ì—…ë¡œë“œ ì™„ë£Œ</span>
                              <button type="button" onclick="stDeleteUploadedFile('${fileType}', event)" style="padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âŒ ì‚­ì œ</button>
                            </div>`;
                          } else {
                            displayDiv.innerHTML = `<div style="margin-top: 4px; padding: 4px 8px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 3px; color: #721c24; font-size: 11px;">
                              âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}
                            </div>`;
                          }
                        }
                        
                        return result;
                      }).catch(error => {
                        // ë°•ìŠ¤ ì•ˆ í…ìŠ¤íŠ¸ ë³€ê²½: ì—…ë¡œë“œ ì‹¤íŒ¨
                        if (uploadTextEl) {
                          uploadTextEl.textContent = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                        }
                        return { success: false, message: error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜' };
                      })
                    );
                  }
                }
              }
              
              Promise.all(promises).then(results => {
                // ëª¨ë“  ê²°ê³¼ í™•ì¸
                const failed = results.filter(r => !r || !r.success);
                if (failed.length > 0) {
                  console.error('[ST] ì¼ë¶€ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', failed);
                  // ê° íŒŒì¼ë³„ ë°•ìŠ¤ì— ì´ë¯¸ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ í‘œì‹œë˜ë¯€ë¡œ alertëŠ” ìƒëµ
                }
                stAdminLoadSettlements();
                // í¼ì€ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ (ì—…ë¡œë“œ ì™„ë£Œëœ íŒŒì¼ ì •ë³´ ìœ ì§€)
              }).catch(error => {
                console.error('[ST] íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì •ì‚°ì€ ì €ì¥ë˜ì—ˆì§€ë§Œ íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                stAdminLoadSettlements();
              });
            } else {
              stAdminResetSettlementForm();
              stAdminLoadSettlements();
            }
          } else {
            alert(result.message || 'ì •ì‚° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[ST] ì •ì‚° ì €ì¥ ì˜¤ë¥˜:', error);
          alert('ì •ì‚° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ì •ì‚° í¼ ì´ˆê¸°í™”
    function stAdminResetSettlementForm() {
      document.getElementById('stSettlementForm').reset();
      document.getElementById('stSettlementId').value = '';
      stSelectedFiles = {};
      document.getElementById('stWorkFeeFileDisplay').innerHTML = '';
      document.getElementById('stInoutFeeFileDisplay').innerHTML = '';
      document.getElementById('stShippingFeeFileDisplay').innerHTML = '';
      
      // íŒŒì¼ ì—…ë¡œë“œ ë°•ìŠ¤ í…ìŠ¤íŠ¸ ì›ë˜ëŒ€ë¡œ ë³µì›
      const workFeeUploadText = document.getElementById('stWorkFeeFileUploadText');
      if (workFeeUploadText) {
        workFeeUploadText.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
      }
      const inoutFeeUploadText = document.getElementById('stInoutFeeFileUploadText');
      if (inoutFeeUploadText) {
        inoutFeeUploadText.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
      }
      const shippingFeeUploadText = document.getElementById('stShippingFeeFileUploadText');
      if (shippingFeeUploadText) {
        shippingFeeUploadText.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
      }
      
      // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      const workFeeFileInput = document.getElementById('stWorkFeeFileInput');
      if (workFeeFileInput) {
        workFeeFileInput.value = '';
      }
      const inoutFeeFileInput = document.getElementById('stInoutFeeFileInput');
      if (inoutFeeFileInput) {
        inoutFeeFileInput.value = '';
      }
      const shippingFeeFileInput = document.getElementById('stShippingFeeFileInput');
      if (shippingFeeFileInput) {
        shippingFeeFileInput.value = '';
      }
      
      document.getElementById('stStorageFee').value = '0';
      document.getElementById('stStorageFeeDisplay').textContent = '0';
      document.getElementById('stSpecialWorkFee').value = '0';
      document.getElementById('stSpecialWorkFeeDisplay').textContent = '0';
      document.getElementById('stErrorDeduction').value = '0';
      document.getElementById('stErrorCountsDisplay').textContent = 'ì˜¤ë°°ì†¡: 0ê±´, ëˆ„ë½: 0ê±´';
      stCalculateTotal();
    }

    // ì •ì‚° ìƒì„¸ ë³´ê¸°
    function stShowSettlementDetail(settlementId) {
      fetch(`/api/settlements/${settlementId}`, {
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.data) {
            const settlement = data.data;
            const totalAmount = (settlement.work_fee || 0) + (settlement.inout_fee || 0) + 
                              (settlement.shipping_fee || 0) + (settlement.storage_fee || 0) + 
                              (settlement.special_work_fee || 0) - (settlement.error_deduction || 0);
            
            let content = `
              <div class="st-settlement-detail">
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">í™”ì£¼ì‚¬</div>
                  <div class="st-settlement-detail-value">${settlement.company_name || ''}</div>
                </div>
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">ì •ì‚°ë…„ì›”</div>
                  <div class="st-settlement-detail-value">${settlement.settlement_year_month || ''}</div>
                </div>
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">ì‘ì—…ë¹„</div>
                  <div class="st-settlement-detail-value">
                    ${(settlement.work_fee || 0).toLocaleString()}ì›
                    ${settlement.work_fee_file_url ? `
                      <div style="margin-top: 8px; display: flex; gap: 10px;">
                        <a href="${settlement.work_fee_file_url}" target="_blank" class="st-file-link" style="padding: 4px 8px; background: #74b9ff; color: white; border-radius: 4px; text-decoration: none; font-size: 13px;">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</a>
                        <a href="${settlement.work_fee_file_url}" target="_blank" class="st-file-link" download style="padding: 4px 8px; background: #00b894; color: white; border-radius: 4px; text-decoration: none; font-size: 13px;">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</a>
                      </div>
                    ` : ''}
                  </div>
                </div>
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">ì…ì¶œê³ ë¹„</div>
                  <div class="st-settlement-detail-value">
                    ${(settlement.inout_fee || 0).toLocaleString()}ì›
                    ${settlement.inout_fee_file_url ? `
                      <div style="margin-top: 8px; display: flex; gap: 10px;">
                        <a href="${settlement.inout_fee_file_url}" target="_blank" class="st-file-link" style="padding: 4px 8px; background: #74b9ff; color: white; border-radius: 4px; text-decoration: none; font-size: 13px;">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</a>
                        <a href="${settlement.inout_fee_file_url}" target="_blank" class="st-file-link" download style="padding: 4px 8px; background: #00b894; color: white; border-radius: 4px; text-decoration: none; font-size: 13px;">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</a>
                      </div>
                    ` : ''}
                  </div>
                </div>
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">íƒë°°ë¹„</div>
                  <div class="st-settlement-detail-value">
                    ${(settlement.shipping_fee || 0).toLocaleString()}ì›
                    ${settlement.shipping_fee_file_url ? `
                      <div style="margin-top: 8px; display: flex; gap: 10px;">
                        <a href="${settlement.shipping_fee_file_url}" target="_blank" class="st-file-link" style="padding: 4px 8px; background: #74b9ff; color: white; border-radius: 4px; text-decoration: none; font-size: 13px;">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</a>
                        <a href="${settlement.shipping_fee_file_url}" target="_blank" class="st-file-link" download style="padding: 4px 8px; background: #00b894; color: white; border-radius: 4px; text-decoration: none; font-size: 13px;">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</a>
                      </div>
                    ` : ''}
                  </div>
                </div>
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">ë³´ê´€ë£Œ</div>
                  <div class="st-settlement-detail-value">${(settlement.storage_fee || 0).toLocaleString()}ì›</div>
                </div>
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">íŠ¹ìˆ˜ì‘ì—…</div>
                  <div class="st-settlement-detail-value">${(settlement.special_work_fee || 0).toLocaleString()}ì›</div>
                </div>
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">ì˜¤ë°°ì†¡/ëˆ„ë½ ì°¨ê°</div>
                  <div class="st-settlement-detail-value" style="color: #e74c3c;">
                    -${(settlement.error_deduction || 0).toLocaleString()}ì›
                    <div id="stDetailErrorCounts" style="margin-top: 4px; font-size: 12px; color: #856404;"></div>
                  </div>
                </div>
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">ì´ì•¡</div>
                  <div class="st-settlement-detail-value" style="font-weight: 700; font-size: 18px; color: #ff6b35;">${totalAmount.toLocaleString()}ì›</div>
                </div>
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">ìƒíƒœ</div>
                  <div class="st-settlement-detail-value">${settlement.status || 'ëŒ€ê¸°'}</div>
                </div>
                ${settlement.memo ? `
                <div class="st-settlement-detail-row">
                  <div class="st-settlement-detail-label">ë¹„ê³ </div>
                  <div class="st-settlement-detail-value">${settlement.memo}</div>
                </div>
                ` : ''}
              </div>
            `;
            
            document.getElementById('stSettlementDetailContent').innerHTML = content;
            document.getElementById('stSettlementDetailModal').style.display = 'block';
            stCurrentSettlementId = settlementId;
            
            // ì˜¤ë°°ì†¡/ëˆ„ë½ ê±´ìˆ˜ ë¡œë“œ
            const companyName = settlement.company_name;
            const yearMonth = settlement.settlement_year_month;
            if (companyName && yearMonth) {
              fetch(`/api/settlements/data-sources?settlement_year_month=${yearMonth}&company_name=${encodeURIComponent(companyName)}`, {
                credentials: 'include',
                headers: stGetUserHeaders()
              })
                .then(response => response.json())
                .then(data => {
                  if (data.success && data.data) {
                    const wrongDeliveryCount = data.data.error_wrong_delivery_count || 0;
                    const missingCount = data.data.error_missing_count || 0;
                    const countsEl = document.getElementById('stDetailErrorCounts');
                    if (countsEl) {
                      countsEl.textContent = `(ì˜¤ë°°ì†¡: ${wrongDeliveryCount}ê±´, ëˆ„ë½: ${missingCount}ê±´)`;
                    }
                  }
                })
                .catch(error => {
                  console.error('[ST] ì˜¤ë°°ì†¡/ëˆ„ë½ ê±´ìˆ˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                });
            }
          } else {
            alert('ì •ì‚° ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[ST] ì •ì‚° ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
          alert('ì •ì‚° ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ì •ì‚° ìˆ˜ì •
    function stEditSettlement(settlementId) {
      fetch(`/api/settlements/${settlementId}`, {
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.data) {
            const settlement = data.data;
            document.getElementById('stSettlementId').value = settlement.id;
            document.getElementById('stSettlementCompanyName').value = settlement.company_name;
            document.getElementById('stSettlementCompanyInput').value = settlement.company_name;
            document.getElementById('stSettlementYearMonth').value = settlement.settlement_year_month;
            document.getElementById('stWorkFee').value = settlement.work_fee || 0;
            document.getElementById('stInoutFee').value = settlement.inout_fee || 0;
            document.getElementById('stShippingFee').value = settlement.shipping_fee || 0;
            document.getElementById('stStorageFee').value = settlement.storage_fee || 0;
            document.getElementById('stStorageFeeDisplay').textContent = (settlement.storage_fee || 0).toLocaleString();
            document.getElementById('stSpecialWorkFee').value = settlement.special_work_fee || 0;
            document.getElementById('stSpecialWorkFeeDisplay').textContent = (settlement.special_work_fee || 0).toLocaleString();
            document.getElementById('stErrorDeduction').value = settlement.error_deduction || 0;
            document.getElementById('stErrorCountsDisplay').textContent = 'ì˜¤ë°°ì†¡: 0ê±´, ëˆ„ë½: 0ê±´';
            document.getElementById('stSettlementMemo').value = settlement.memo || '';
            
            // ì˜¤ë°°ì†¡/ëˆ„ë½ ê±´ìˆ˜ ìë™ ë¡œë“œ
            stLoadErrorCounts();
            stCalculateTotal();
            
            // íŒŒì¼ ì •ë³´ í‘œì‹œ (ì´ë¯¸ ì—…ë¡œë“œëœ íŒŒì¼) - ë°•ìŠ¤ ì•ˆì€ ì›ë˜ëŒ€ë¡œ, ë°•ìŠ¤ ë°‘ì— íŒŒì¼ëª…(ìš©ëŸ‰) X ë²„íŠ¼ í‘œì‹œ
            if (settlement.work_fee_file_url) {
              const uploadTextEl = document.getElementById('stWorkFeeFileUploadText');
              const displayDiv = document.getElementById('stWorkFeeFileDisplay');
              if (uploadTextEl) {
                uploadTextEl.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
              }
              if (displayDiv) {
                const fileName = settlement.work_fee_file_url.split('/').pop() || 'íŒŒì¼';
                // íŒŒì¼ í¬ê¸°ëŠ” ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ íŒŒì¼ëª…ë§Œ í‘œì‹œ
                displayDiv.innerHTML = `<div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                  <span>ğŸ“„ ${fileName}</span>
                  <button type="button" onclick="stDeleteUploadedFile('work_fee', event)" style="padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âŒ ì‚­ì œ</button>
                </div>`;
              }
            } else {
              const uploadTextEl = document.getElementById('stWorkFeeFileUploadText');
              const displayDiv = document.getElementById('stWorkFeeFileDisplay');
              if (uploadTextEl) {
                uploadTextEl.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
              }
              if (displayDiv) {
                displayDiv.innerHTML = '';
              }
            }
            
            if (settlement.inout_fee_file_url) {
              const uploadTextEl = document.getElementById('stInoutFeeFileUploadText');
              const displayDiv = document.getElementById('stInoutFeeFileDisplay');
              if (uploadTextEl) {
                uploadTextEl.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
              }
              if (displayDiv) {
                const fileName = settlement.inout_fee_file_url.split('/').pop() || 'íŒŒì¼';
                displayDiv.innerHTML = `<div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                  <span>ğŸ“„ ${fileName}</span>
                  <button type="button" onclick="stDeleteUploadedFile('inout_fee', event)" style="padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âŒ ì‚­ì œ</button>
                </div>`;
              }
            } else {
              const uploadTextEl = document.getElementById('stInoutFeeFileUploadText');
              const displayDiv = document.getElementById('stInoutFeeFileDisplay');
              if (uploadTextEl) {
                uploadTextEl.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
              }
              if (displayDiv) {
                displayDiv.innerHTML = '';
              }
            }
            
            if (settlement.shipping_fee_file_url) {
              const uploadTextEl = document.getElementById('stShippingFeeFileUploadText');
              const displayDiv = document.getElementById('stShippingFeeFileDisplay');
              if (uploadTextEl) {
                uploadTextEl.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
              }
              if (displayDiv) {
                const fileName = settlement.shipping_fee_file_url.split('/').pop() || 'íŒŒì¼';
                displayDiv.innerHTML = `<div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                  <span>ğŸ“„ ${fileName}</span>
                  <button type="button" onclick="stDeleteUploadedFile('shipping_fee', event)" style="padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âŒ ì‚­ì œ</button>
                </div>`;
              }
            } else {
              const uploadTextEl = document.getElementById('stShippingFeeFileUploadText');
              const displayDiv = document.getElementById('stShippingFeeFileDisplay');
              if (uploadTextEl) {
                uploadTextEl.textContent = 'ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ';
              }
              if (displayDiv) {
                displayDiv.innerHTML = '';
              }
            }
            
            // ì„ íƒëœ íŒŒì¼ ì´ˆê¸°í™”
            stSelectedFiles = {};
            
            // í¼ ì—´ê¸°
            document.getElementById('stAdminSettlementForm').style.display = 'block';
            document.getElementById('stAdminSettlementIcon').textContent = 'â–²';
          }
        })
        .catch(error => {
          console.error('[ST] ì •ì‚° ìˆ˜ì • ë¡œë“œ ì˜¤ë¥˜:', error);
          alert('ì •ì‚° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ì •ì‚° ì‚­ì œ
    function stDeleteSettlement(settlementId) {
      if (!confirm('ì •ì‚°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      fetch(`/api/settlements/${settlementId}`, {
        method: 'DELETE',
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì •ì‚°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            stAdminLoadSettlements();
          } else {
            alert(data.message || 'ì •ì‚° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[ST] ì •ì‚° ì‚­ì œ ì˜¤ë¥˜:', error);
          alert('ì •ì‚° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
    function stCloseDetailModal() {
      document.getElementById('stSettlementDetailModal').style.display = 'none';
      stCurrentSettlementId = null;
    }

    // ëª…ì„¸ì„œ ë‹¤ìš´ë¡œë“œ
    function stDownloadStatement() {
      if (!stCurrentSettlementId) {
        alert('ì •ì‚° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // TODO: ëª…ì„¸ì„œ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ êµ¬í˜„ (PDF/Excel)
      alert('ëª…ì„¸ì„œ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
    }

    // í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ (ê´€ë¦¬ììš©)
    function stAdminLoadCompanies() {
      fetch('/api/auth/companies', {
        credentials: 'include',
        headers: stGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.companies) {
            const companies = data.companies.filter(c => c.role !== 'ê´€ë¦¬ì').map(c => c.company_name);
            
            // ê²€ìƒ‰ ê°€ëŠ¥í•œ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            stInitSearchableDropdown('stSettlementCompanyInput', 'stSettlementCompanyName', 'stSettlementCompanyDropdown', companies);
            stInitSearchableDropdown('stAdminFilterCompanyInput', 'stAdminFilterCompanyName', 'stAdminFilterCompanyDropdown', companies);
          }
        })
        .catch(error => {
          console.error('[ST] í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        });
    }

    // ê²€ìƒ‰ ê°€ëŠ¥í•œ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    function stInitSearchableDropdown(inputId, hiddenId, dropdownId, items) {
      const inputEl = document.getElementById(inputId);
      const hiddenEl = document.getElementById(hiddenId);
      const dropdownEl = document.getElementById(dropdownId);
      if (!inputEl || !hiddenEl || !dropdownEl) return;

      let isOpen = false;
      let closeTimeout = null;

      const renderList = (keyword = '') => {
        const filtered = items.filter(item =>
          item.toLowerCase().includes(keyword.toLowerCase())
        );
        dropdownEl.innerHTML = filtered.length
          ? filtered.map(name => `<div class="st-dropdown-item" data-value="${name}">${name}</div>`).join('')
          : '<div class="st-dropdown-item" style="color:#999;cursor:default;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      };

      const openDropdown = () => {
        clearTimeout(closeTimeout);
        renderList(inputEl.value);
        dropdownEl.classList.add('show');
        isOpen = true;
      };

      const scheduleClose = () => {
        clearTimeout(closeTimeout);
        closeTimeout = setTimeout(() => {
          dropdownEl.classList.remove('show');
          isOpen = false;
        }, 120);
      };

      inputEl.addEventListener('input', (e) => {
        hiddenEl.value = e.target.value;
        if (!isOpen) openDropdown();
        else renderList(e.target.value);
      });

      ['focus', 'click'].forEach(evt =>
        inputEl.addEventListener(evt, () => {
          clearTimeout(closeTimeout);
          openDropdown();
        })
      );

      dropdownEl.addEventListener('click', (e) => {
        const item = e.target.closest('.st-dropdown-item');
        if (!item || !item.dataset.value) return;
        inputEl.value = item.dataset.value;
        hiddenEl.value = item.dataset.value;
        dropdownEl.classList.remove('show');
        isOpen = false;
      });

      document.addEventListener('mousedown', (e) => {
        if (!inputEl.contains(e.target) && !dropdownEl.contains(e.target)) {
          scheduleClose();
        }
      });
    }

    // ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œ (ê´€ë¦¬ììš©)
    function stUploadTaxInvoice(settlementId) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.pdf,.xlsx,.xls,.csv,.jpg,.jpeg,.png,.gif,.bmp';
      input.onchange = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
          const response = await fetch(`/api/settlements/${settlementId}/upload-tax-invoice`, {
            method: 'POST',
            headers: stGetUserHeaders(),
            credentials: 'include',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('ì„¸ê¸ˆê³„ì‚°ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            const roleNormalized = stCurrentRole.toString().trim();
            if (roleNormalized === 'ê´€ë¦¬ì') {
              stAdminLoadSettlements();
            } else {
              stConsignorLoadSettlements();
            }
          } else {
            alert(result.message || 'ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('[ST] ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
          alert('ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      };
      input.click();
    }

    // í™•ì • (ê´€ë¦¬ì) - ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œ ì „
    function stConfirmSettlement(settlementId) {
      if (!confirm('ì •ì‚°ì„ í™•ì •í•˜ì—¬ í™”ì£¼ì‚¬ì—ê²Œ ê³µê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      fetch(`/api/settlements/${settlementId}/update-status`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...stGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify({
          status: 'ì „ë‹¬'
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì •ì‚°ì´ í™•ì •ë˜ì–´ í™”ì£¼ì‚¬ì—ê²Œ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤.');
            stAdminLoadSettlements();
          } else {
            alert(data.message || 'ì •ì‚° í™•ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[ST] ì •ì‚° í™•ì • ì˜¤ë¥˜:', error);
          alert('ì •ì‚° í™•ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ì •ì‚°í™•ì¸ (í™”ì£¼ì‚¬)
    function stConfirmSettlementByConsignor(settlementId) {
      if (!confirm('ì •ì‚° ë‚´ì—­ì„ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?')) return;
      
      fetch(`/api/settlements/${settlementId}/update-status`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...stGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify({
          status: 'ì •ì‚°í™•ì¸'
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì •ì‚°í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            stConsignorLoadSettlements();
          } else {
            alert(data.message || 'ì •ì‚°í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[ST] ì •ì‚°í™•ì¸ ì˜¤ë¥˜:', error);
          alert('ì •ì‚°í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ì…ê¸ˆí™•ì¸ (ê´€ë¦¬ì) - ì…ê¸ˆ ì™„ë£Œ í›„
    function stCompletePayment(settlementId) {
      if (!confirm('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆê¹Œ?')) return;
      
      fetch(`/api/settlements/${settlementId}/update-status`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...stGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify({
          status: 'ì…ê¸ˆì™„ë£Œ'
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì…ê¸ˆí™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            stAdminLoadSettlements();
          } else {
            alert(data.message || 'ì…ê¸ˆí™•ì¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[ST] ì…ê¸ˆí™•ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
          alert('ì…ê¸ˆí™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì´ˆê¸°í™”
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', stCommonInit);
    } else {
      stCommonInit();
    }
  </script>
</body>
</html>


