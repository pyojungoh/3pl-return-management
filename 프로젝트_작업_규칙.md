# 프로젝트 작업 규칙 및 주의사항

## ⛔ 하지 말아야 할 것들

1. **터미널 명령어 실행**
   - 이제부터 터미널 명령어를 직접 실행할 수 있음
   - 배포 작업 시 git 명령어를 직접 실행 가능
   - 필요시 사용자에게 확인 후 실행

2. **불필요한 .md 파일 생성 금지**
   - 설명 문서나 가이드 파일을 만들지 말 것
   - 사용자가 명시적으로 요청한 경우만 생성

3. **명령어를 하나의 코드 블록에 묶지 말 것**
   - 각 명령어를 개별 코드 블록으로 제공
   - 복사하기 편하도록 하나씩 따로 제공

4. **Railway 관련 작업 금지**
   - 이 프로젝트는 GitHub + Vercel을 사용
   - Railway 관련 파일이나 설정 제안하지 말 것

## ✅ 수정 시 주의사항

### 1. 파일 삭제 시 확인
- 실제 사용 중인 파일인지 반드시 확인
- `__init__.py` 파일들이 올바른 모듈을 import하는지 확인
- `app.py`에서 사용하는 파일인지 확인

### 2. 데이터베이스 호환성
- **로컬**: SQLite 사용 (`data.db`)
- **배포 (Vercel)**: PostgreSQL/Neon 사용
- 두 환경 모두 지원하도록 코드 작성

### 3. Import 에러 방지
- SQLite 모드: `from sqlite3 import OperationalError, IntegrityError`
- PostgreSQL 모드: `from psycopg2 import IntegrityError, OperationalError`
- `api/database/models.py`에서 두 가지 모두 import 필요

### 4. __init__.py 파일 확인
- `api/auth/__init__.py`: `from .routes_db import auth_bp` (routes.py 아님)
- `api/returns/__init__.py`: `from .routes_db import returns_bp` (routes.py 아님)
- 파일 삭제 후 반드시 확인 필요

### 5. 메인 파일
- **HTML**: `dashboard_server.html` (메인 파일)
- `dashboard.html`, `dashboard_simple.html` 등은 삭제됨
- `app.py`는 `dashboard_server.html`만 사용

### 6. 모바일 페이지 (매우 중요)
- **파일**: `index.html` (QR 모바일 페이지)
- **라우트**: `/qrmobile`, `/admin` (레거시 경로)
- **중요도**: ⭐⭐⭐⭐⭐ (최우선)
  - 실제 물류 현장에서 사용하는 핵심 페이지
  - 반품 등록 및 사진 업로드의 주요 진입점
  - 이 페이지가 작동하지 않으면 현장 업무가 중단됨
- **주요 기능**:
  1. **QR 코드 스캔**: jsQR 라이브러리 사용, 카메라로 송장번호 자동 인식
  2. **송장번호 검색**: `/api/uploads/find-by-tracking` API 사용
  3. **반품 등록**: `/api/returns/create` API로 데이터 저장
  4. **사진 업로드**: `/api/uploads/upload-images` API로 Cloudinary 업로드
  5. **화주사 등록**: `/api/auth/register` API 사용
  6. **비밀번호 변경**: `/api/auth/change-password` API 사용
  7. **월별 데이터 조회**: `/api/returns/available-months` API 사용
- **작동 방식**:
  - 모바일 최적화 (반응형 디자인, 터치 친화적)
  - QR 코드 스캔 → 송장번호 자동 입력 → 데이터 검색 → 사진 업로드 → 반품 등록
  - HTTPS 필수 (카메라 접근을 위해)
  - 월 선택 후 해당 월의 데이터에서만 검색 (없으면 모든 월에서 검색)
- **주의사항**:
  - **절대 삭제하면 안 됨** - 현장 업무 중단
  - 파일 수정 시 반드시 테스트 필요 (QR 스캔, 사진 업로드, 데이터 저장)
  - 카메라 권한 요청 처리 필수
  - 모바일 브라우저 호환성 확인 필요
  - API 엔드포인트 변경 시 이 페이지도 함께 수정 필요

## 📋 프로젝트 구조

### 주요 파일
- `app.py`: Flask 메인 서버
- `dashboard_server.html`: 메인 대시보드 (로그인 + 관리 화면)
- `index.html`: **QR 모바일 페이지** (매우 중요 - 현장 업무 핵심)
- `api/database/models.py`: 데이터베이스 모델 (SQLite/PostgreSQL 호환)
- `api/auth/routes_db.py`: 인증 API (로그인, 회원가입)
- `api/returns/routes_db.py`: 반품 데이터 API
- `api/admin/routes.py`: 관리자 API (CSV 마이그레이션 등)
- `api/uploads/routes.py`: 이미지 업로드 API

### 데이터베이스
- 로컬: SQLite (`data.db`)
- 배포: PostgreSQL/Neon (환경변수 `DATABASE_URL`)

### 배포
- GitHub에 푸시
- Vercel 자동 배포
- 환경변수: `DATABASE_URL` (PostgreSQL 연결 문자열)
- 도메인: `jjaysolution.com` (Vercel에서 구매 및 연결 완료)

## 🔧 일반적인 작업 흐름

### 코드 수정 후 배포
1. 수정 완료
2. 터미널 명령어 직접 실행 (git add, commit, push)
3. Vercel 자동 배포 대기

### 파일 삭제 시 체크리스트
- [ ] `app.py`에서 import하는지 확인
- [ ] `__init__.py`에서 import하는지 확인
- [ ] 다른 파일에서 사용하는지 확인 (grep으로 검색)
- [ ] 삭제 후 관련 import 경로 수정

### 데이터베이스 관련 수정 시
- [ ] SQLite와 PostgreSQL 모두 테스트
- [ ] `OperationalError`, `IntegrityError` import 확인
- [ ] 환경변수 `DATABASE_URL` 확인

## 🚨 자주 발생하는 오류

### 1. ModuleNotFoundError
- `__init__.py`에서 삭제된 파일을 import하는 경우
- 해결: `routes_db.py`로 변경

### 2. NameError: name 'OperationalError' is not defined
- SQLite 모드에서 `OperationalError` import 누락
- 해결: `from sqlite3 import OperationalError, IntegrityError` 추가

### 3. 화주사 등록 오류
- None 값에 `.strip()` 호출
- 해결: None 체크 후 처리

### 4. 화주사 데이터 필터링 문제
- 관리자는 모든 데이터, 화주사는 자신의 데이터만
- 해결: `company` 파라미터로 필터링

## 📝 기타 주의사항

1. **언어**: 항상 한국어로 응답
2. **터미널 명령어**: 필요시 직접 실행 가능 (git 배포 등)
3. **파일 삭제**: 신중하게 확인 후 삭제
4. **에러 처리**: 상세한 로그 추가하여 디버깅 용이하게
5. **코드 수정**: 기존 기능을 깨뜨리지 않도록 주의

## 🔄 작업 시 확인 사항

1. 로컬에서 테스트 가능한지
2. 배포 후에도 작동하는지
3. SQLite와 PostgreSQL 모두 지원하는지
4. 기존 기능이 깨지지 않았는지
5. 에러 처리가 적절한지

## 📌 중요 기능 규칙

### F5 새로고침 시 현재 메뉴/탭 유지
- **관리자 모드**: `localStorage.setItem('activeAdminTab', tabName)` - 현재 활성 탭 저장
- **화주사 모드**: `localStorage.setItem('activeConsignorMenu', menuName)` - 현재 활성 메뉴 저장
- **복원 로직**: 페이지 로드 시 `localStorage.getItem()`으로 저장된 값 복원
- **기본값**: 저장된 값이 없으면 관리자는 'returns', 화주사는 'returns' 메뉴로 이동
- **주의사항**: 어떤 메뉴가 추가되어도 반드시 이 규칙을 따라야 함
  - 메뉴/탭 전환 시 localStorage에 저장
  - 페이지 로드 시 저장된 값으로 복원
  - 새로고침(F5) 후에도 현재 메뉴/탭이 유지되어야 함

## 🖼️ 이미지 호스팅 정보

### Cloudinary 설정
- **서비스**: Cloudinary (이미지/파일 호스팅)
- **Cloud Name**: `dokk81rjh`
- **API Key**: `447577332396678`
- **API Secret**: `_fh-dOMoaFvOvCRkFk_AzqjOFA8`
- **설정 파일**: `api/uploads/cloudinary_upload.py`
- **환경 변수** (선택사항):
  - `CLOUDINARY_CLOUD_NAME`
  - `CLOUDINARY_API_KEY`
  - `CLOUDINARY_API_SECRET`

### 로고 URL
- **현재 사용 중인 로고 URL**: `https://res.cloudinary.com/dokk81rjh/image/upload/v1762922695/logo_srff9i.png`
- **위치**: `dashboard_server.html` (헤더 로고)
- **설정 위치**: `dashboard_server.html` 1393줄

### Cloudinary 업로드 폴더 구조
- **반품 내역 이미지**: `반품내역/년월/송장번호_타임스탬프_번호`
- **사업자 등록증**: `business_certificates/파일명_타임스탬프`
- **게시판 첨부파일**: `board_files/파일명`
- **팝업 이미지**: `board_files/파일명` (게시판 업로드 API 재사용)

### 주요 함수
- `upload_images_to_cloudinary()`: 반품 내역 이미지 업로드
- `upload_single_file_to_cloudinary()`: 단일 파일 업로드 (사업자 등록증 등)
- `upload_to_cloudinary()`: 일반 파일 업로드 (게시판, 팝업 등)

## 🚧 현재 미해결 문제

### 팝업 저장 오류 (2025-11-12)
- **문제**: 팝업 관리에서 저장 버튼 클릭 시 저장이 안 되는 문제
- **증상**: 
  - 콘솔 로그에서 `title` 필드가 빈 문자열로 표시됨
  - "모든 필드를 입력해주세요" 에러 메시지 표시
  - 실제로는 모든 필드가 입력되어 있음
- **원인 분석**:
  - `popupTitle` ID가 두 곳에서 사용됨:
    1. 팝업 레이어의 제목 표시용 `<h2 id="popupTitle">` (1424줄)
    2. 팝업 폼의 입력 필드 `<input type="text" id="popupTitle">` (2054줄 → 수정됨)
  - `getElementById('popupTitle')`이 레이어의 `<h2>` 요소를 먼저 반환
  - `<h2>` 요소는 `value` 속성이 없어 빈 문자열 반환
- **시도한 해결 방법**:
  - 폼의 input 필드 ID를 `popupTitleInput`으로 변경 (2054줄)
  - 관련 JavaScript 함수 모두 업데이트:
    - `savePopup()` - 저장 함수
    - `resetPopupForm()` - 폼 초기화 함수
    - `editPopup()` - 수정 함수
- **현재 상태**: 
  - 코드 수정 완료 및 푸시 완료 (커밋: `89de436`)
  - **아직 테스트 미완료** - 내일 다시 확인 필요
- **다음 단계**:
  1. 배포 후 실제로 저장이 되는지 확인
  2. 콘솔 로그에서 `title` 값이 제대로 읽히는지 확인
  3. 여전히 문제가 있으면 추가 디버깅 필요

## 📋 최근 추가된 기능 (2025-11-12)

### 1. 팝업 관리 기능
- **데이터베이스**: `popups` 테이블 추가
  - 필드: `id`, `title`, `content`, `image_url`, `width`, `height`, `start_date`, `end_date`, `is_active`, `created_at`, `updated_at`
- **API 라우트**: `/api/popups/`
  - `GET /` - 모든 팝업 조회 (관리자용)
  - `GET /active` - 현재 활성화된 팝업 조회 (사용자용)
  - `POST /` - 팝업 생성
  - `GET /<id>` - 팝업 상세 조회
  - `PUT /<id>` - 팝업 수정
  - `DELETE /<id>` - 팝업 삭제
- **관리자 모드**: "🔔 팝업 관리" 탭 추가
  - 팝업 등록/수정/삭제 기능
  - 이미지 업로드 기능
  - 팝업 사이즈 설정 (너비/높이)
- **사용자 모드**: 팝업 레이어 표시
  - 로그인 후 또는 페이지 로드 시 활성 팝업 자동 확인
  - 날짜 범위 내 활성화된 팝업만 표시
  - "닫기" 버튼: 일시적으로만 닫기
  - "하루 동안 보지 않기" 버튼: 오늘 하루 동안 표시하지 않음 (localStorage에 날짜와 함께 저장)

### 2. 화주사 정보 관리 기능
- **메뉴**: 화주사 모드 맨 왼쪽에 "👤 화주사 정보" 메뉴 추가
- **기능**:
  - 사업자 정보 조회/수정 (사업자번호, 대표명, 주소, 전화번호, 전자세금계산서 이메일)
  - 주소 검색: 우체국 Daum Postcode API 연동
  - 비밀번호 변경 기능
- **주소 저장 형식**: `우편번호|기본주소|상세주소`
- **API**: `/api/auth/my-info` (GET), `/api/auth/company-info` (PUT), `/api/auth/change-password` (POST)

### 3. 사업자 정보 미입력 배너
- **위치**: 화주사 모드 헤더 중앙 (고정 위치, 스크롤 따라감)
- **조건**: 사업자 정보가 모두 입력되지 않은 경우에만 표시
- **스타일**: 깜빡임 애니메이션, 오렌지 그라데이션 배경
- **메시지**: "⚠️ 화주사정보를 입력해주세요"

### 4. 게시판 기능
- **데이터베이스**: `board_categories`, `boards`, `board_files` 테이블
- **관리자 모드**: "📋 게시판 관리" 탭
  - 카테고리 관리 (접이식 메뉴)
  - 게시글 작성/수정/삭제
  - 파일 첨부 기능 (Cloudinary)
  - 공지사항 기능 (맨 위 고정, 굵은 글씨)
- **화주사 모드**: "📋 게시판" 메뉴
  - 카테고리별 필터링 (버튼 메뉴)
  - 테이블 형식 목록 표시
  - 게시글 상세 보기

### 5. 판매 스케쥴 기능
- **데이터베이스**: `schedules` 테이블
- **화주사 모드**: "📅 판매스케쥴" 메뉴
  - 스케쥴 등록/수정/삭제 (접이식 메뉴)
  - 스케쥴 목록 표시
  - 안내 설명 박스 (사전 신청 중요성)
- **관리자 모드**: "📅 스케쥴 관리" 탭
  - 달력 뷰 (화주사별 색상 구분)
  - 스케쥴 목록 표시
  - 관리자 스케쥴 등록 기능 (접이식 메뉴)
  - 스케쥴 삭제 기능

## 🔑 중요한 설정 정보

### 환경 변수
- **DATABASE_URL**: PostgreSQL 연결 문자열 (배포 시 필수)
- **CLOUDINARY_CLOUD_NAME**: `dokk81rjh` (기본값)
- **CLOUDINARY_API_KEY**: `447577332396678` (기본값)
- **CLOUDINARY_API_SECRET**: `_fh-dOMoaFvOvCRkFk_AzqjOFA8` (기본값)

### 도메인 및 배포
- **도메인**: `jjaysolution.com` (Vercel에서 구매 및 연결 완료)
- **배포 플랫폼**: Vercel
- **저장소**: GitHub (`pyojungoh/3pl-return-management`)
- **브랜치**: `main` (자동 배포)

### 데이터베이스
- **로컬**: SQLite (`data.db`)
- **배포**: PostgreSQL/Neon (환경변수 `DATABASE_URL`)
- **마이그레이션**: 자동 (테이블이 없으면 생성, 컬럼 추가는 `ALTER TABLE` 시도)

## ⚠️ 주의사항

### ID 중복 문제
- **HTML 요소 ID는 반드시 고유해야 함**
- 같은 ID가 여러 곳에서 사용되면 `getElementById()`가 예상과 다른 요소를 반환할 수 있음
- **예시**: `popupTitle` ID가 레이어의 `<h2>`와 폼의 `<input>`에서 중복 사용됨 → `popupTitleInput`으로 변경
- **체크리스트**:
  - 새 요소 추가 시 기존 ID와 중복되지 않는지 확인
  - `grep`으로 ID 검색하여 중복 확인
  - JavaScript에서 요소를 찾을 때 정확한 ID 사용

### 배포 후 테스트 필수
- 로컬에서만 테스트하면 안 됨
- PostgreSQL 환경에서도 테스트 필요
- 특히 데이터베이스 스키마 변경 시 배포 후 확인 필수

### qrmobile 페이지 테스트 체크리스트
- [ ] QR 코드 스캔 기능 작동 확인
- [ ] 송장번호 직접 입력 후 검색 작동 확인
- [ ] 월 선택 및 데이터 조회 작동 확인
- [ ] 사진 업로드 기능 작동 확인 (Cloudinary 연동)
- [ ] 반품 등록 기능 작동 확인 (데이터베이스 저장)
- [ ] 화주사 등록 탭 작동 확인
- [ ] 비밀번호 변경 탭 작동 확인
- [ ] 모바일 기기에서 실제 테스트 (카메라 권한 포함)
- [ ] HTTPS 환경에서 카메라 접근 확인


