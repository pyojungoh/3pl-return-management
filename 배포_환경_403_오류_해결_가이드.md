# 배포 환경 403 오류 해결 가이드

## ❌ 현재 문제

배포 환경에서 엑셀 파일 업로드 시:
- **403 오류**: `Service Accounts do not have storage quota`
- **원인**: OAuth 2.0이 작동하지 않고 서비스 계정을 사용하려고 시도

## 🔍 원인 분석

배포 환경에서 OAuth 2.0 환경 변수가 제대로 로드되지 않았을 가능성이 높습니다.

## ✅ 해결 방법

### 1단계: Vercel 환경 변수 확인

1. **Vercel 대시보드 접속**
   - https://vercel.com/
   - 프로젝트 선택

2. **Settings → Environment Variables 확인**
   - 다음 두 개가 모두 있는지 확인:
     - ✅ `GOOGLE_OAUTH_CREDENTIALS_JSON`
     - ✅ `GOOGLE_OAUTH_TOKEN_JSON`

3. **각 환경 변수 확인**
   - 클릭하여 내용 확인
   - JSON 형식이 올바른지 확인
   - 길이가 0이 아닌지 확인

### 2단계: 환경 변수 재설정 (필요 시)

#### GOOGLE_OAUTH_CREDENTIALS_JSON

1. **로컬에서 credentials.json 파일 열기**
   - 위치: `C:\3plsolution\credentials.json`
   - 전체 내용 복사 (한 줄 JSON)

2. **Vercel 환경 변수 업데이트**
   - Key: `GOOGLE_OAUTH_CREDENTIALS_JSON`
   - Value: credentials.json 전체 내용 붙여넣기
   - Environment: Production, Preview, Development 모두 선택
   - Save

#### GOOGLE_OAUTH_TOKEN_JSON

1. **로컬에서 토큰 파일 확인**
   - `oauth_token_for_vercel.json` 파일 열기
   - 또는 `python extract_oauth_token.py` 실행하여 출력 확인

2. **Vercel 환경 변수 업데이트**
   - Key: `GOOGLE_OAUTH_TOKEN_JSON`
   - Value: 토큰 JSON 전체 붙여넣기
   - Environment: Production, Preview, Development 모두 선택
   - Save

### 3단계: 재배포

1. **Deployments 탭으로 이동**
2. **최신 배포 항목의 "..." 메뉴 클릭**
3. **"Redeploy" 선택**
4. **배포 완료 대기**

### 4단계: Vercel 로그 확인

1. **Deployments → 최신 배포 클릭**
2. **Functions 탭 클릭**
3. **로그 확인**
   - 다음 메시지가 보여야 합니다:
     - `✅ 환경 변수에서 OAuth 토큰 로드 성공 (Vercel 배포 환경)`
   - 만약 다음 메시지가 보이면:
     - `⚠️ 환경 변수에서 토큰 로드 실패` → 환경 변수 재설정 필요
     - `Vercel 배포 환경에서 OAuth 2.0 환경 변수가 설정되지 않았습니다` → 환경 변수 추가 필요

## 🔍 디버깅 정보

코드에 디버깅 로그를 추가했습니다. Vercel 로그에서 다음 정보를 확인할 수 있습니다:

```
📄 엑셀 파일 업로드 시작: [파일명]
🔍 OAuth 2.0 인증 정보 확인 중...
   Vercel 환경: True/False
   GOOGLE_OAUTH_TOKEN_JSON 존재: True/False
   GOOGLE_OAUTH_CREDENTIALS_JSON 존재: True/False
   GOOGLE_OAUTH_TOKEN_JSON 길이: [숫자] 문자
   GOOGLE_OAUTH_CREDENTIALS_JSON 길이: [숫자] 문자
```

## 📋 체크리스트

- [ ] Vercel 환경 변수 확인:
  - [ ] `GOOGLE_OAUTH_CREDENTIALS_JSON` 존재 및 내용 확인
  - [ ] `GOOGLE_OAUTH_TOKEN_JSON` 존재 및 내용 확인
  - [ ] 각각의 Environment 모두 선택됨
- [ ] 환경 변수 재설정 (필요 시)
- [ ] 재배포 완료
- [ ] Vercel 로그 확인:
  - [ ] "✅ 환경 변수에서 OAuth 토큰 로드 성공" 메시지 확인
- [ ] 배포 환경에서 다시 테스트

## 💡 중요 사항

1. **환경 변수는 재배포 후에만 적용됩니다**
   - 환경 변수를 추가/수정한 후 반드시 재배포해야 합니다

2. **JSON 형식 확인**
   - 환경 변수에 저장된 JSON이 올바른 형식인지 확인
   - 따옴표가 올바르게 이스케이프되었는지 확인

3. **로그 확인**
   - Vercel 로그에서 디버깅 정보를 확인하여 문제 원인 파악

## 🚀 다음 단계

환경 변수를 확인하고 재배포한 후:
1. Vercel 로그에서 "✅ 환경 변수에서 OAuth 토큰 로드 성공" 메시지 확인
2. 배포 환경에서 엑셀 파일 업로드 테스트
3. 성공 확인

