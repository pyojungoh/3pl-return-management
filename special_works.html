<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŠ¹ìˆ˜ì‘ì—… ê´€ë¦¬</title>
  <style>
    /* íŠ¹ìˆ˜ì‘ì—… ë©”ë‰´ ì „ìš© ìŠ¤íƒ€ì¼ */
    #swContainer {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ê´€ë¦¬ì ì „ìš© ì„¹ì…˜ (ê¸°ë³¸ ìˆ¨ê¹€) */
    .sw-admin-only {
      display: none;
    }
    
    /* í™”ì£¼ì‚¬ ì „ìš© ì„¹ì…˜ (ê¸°ë³¸ ìˆ¨ê¹€) */
    .sw-consignor-only {
      display: none;
    }
    
    /* ê³µí†µ ìŠ¤íƒ€ì¼ */
    .sw-section {
      margin-bottom: 20px;
    }
    
    .sw-toggle-btn {
      background: linear-gradient(135deg, #ffffff 0%, #fffef9 100%);
      width: 100%;
      text-align: left;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 14px;
      border: 2px solid #ffeaa7;
      color: #ff6b35;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.1);
    }
    
    .sw-toggle-btn:hover {
      background: linear-gradient(135deg, #fffef9 0%, #ffffff 100%);
      box-shadow: 0 6px 16px rgba(255, 152, 0, 0.15);
    }
    
    .sw-toggle-content {
      display: none;
      background: #ffffff;
      padding: 24px;
      border-radius: 0 0 14px 14px;
      border: 2px solid #ffeaa7;
      border-top: none;
      margin-top: -2px;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1);
    }
    
    .sw-filters {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .sw-filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .sw-filter-group label {
      color: #2d3436;
      font-weight: 600;
      font-size: 14px;
    }
    
    .sw-filter-group input,
    .sw-filter-group select {
      padding: 10px 14px;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      font-size: 14px;
      background: #ffffff;
      color: #2d3436;
    }
    
    .sw-filter-group input:focus,
    .sw-filter-group select:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    
    .sw-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #ff6b35 0%, #feca57 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
    }
    
    .sw-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 107, 53, 0.35);
    }
    
    .sw-stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      max-width: 100%;
      overflow-y: auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1), 0 2px 6px rgba(0, 0, 0, 0.05);
      border: none;
      margin-bottom: 20px;
    }
    
    .sw-stat-box {
      text-align: center;
      padding: 12px 16px;
      border-radius: 10px;
      min-width: 120px;
      max-width: 140px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid #ffeaa7;
      background: linear-gradient(135deg, #fffef9 0%, #ffffff 100%);
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
    }
    
    .sw-stat-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.15);
      border-color: #ffa502;
    }
    
    .sw-stat-box.selected {
      background: linear-gradient(135deg, #ff6b35 0%, #feca57 100%);
      border-color: #ff6b35;
      box-shadow: 0 4px 14px rgba(255, 107, 53, 0.25);
      transform: translateY(-2px);
    }
    
    .sw-stat-box-name {
      font-size: 13px;
      font-weight: 700;
      color: #2d3436;
      margin-bottom: 6px;
      user-select: none;
      line-height: 1.3;
    }
    
    .sw-stat-box.selected .sw-stat-box-name {
      color: white;
    }
    
    .sw-stat-box-count {
      font-size: 18px;
      font-weight: 800;
      color: #ff6b35;
      margin-bottom: 3px;
      user-select: none;
    }
    
    .sw-stat-box.selected .sw-stat-box-count {
      color: white;
    }
    
    .sw-stat-box-total {
      font-size: 11px;
      color: #636e72;
      user-select: none;
    }
    
    .sw-stat-box.selected .sw-stat-box-total {
      color: white;
      font-weight: 600;
    }
    
    .sw-table-container {
      margin-top: 20px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1);
      border: 2px solid #ffeaa7;
      overflow: hidden;
    }
    
    .sw-table-header {
      padding: 15px 20px 10px 20px;
      border-bottom: 2px solid #ffeaa7;
      background: linear-gradient(135deg, #fffef9 0%, #ffffff 100%);
    }
    
    .sw-table-header h3 {
      margin: 0;
      color: #ff6b35;
      font-weight: 700;
      font-size: 18px;
    }
    
    .sw-table-scroll-wrapper {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .sw-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }
    
    .sw-table thead {
      background: linear-gradient(135deg, #ff6b35 0%, #feca57 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .sw-table th {
      padding: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }
    
    .sw-table td {
      padding: 12px;
      text-align: center;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }
    
    .sw-table td.sw-admin-only {
      min-width: 80px;
      width: 80px;
      padding: 12px;
      vertical-align: middle;
      text-align: center;
      box-sizing: border-box;
    }
    
    /* ì‚¬ì§„ ì¸ë„¤ì¼ ë†’ì´(80px) + border(4px) + ì…€ padding(24px) + ì—¬ìœ (2px) = 110pxì— ë§ì¶¤ */
    .sw-table tbody tr td.sw-admin-only {
      min-height: 110px;
      height: 110px;
    }
    
    .sw-table td.sw-admin-only > div {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
      height: 86px;
      box-sizing: border-box;
    }
    
    .sw-table tbody tr:hover {
      background: #fffef9;
    }
    
    .sw-table .no-data {
      text-align: center;
      padding: 40px;
      color: #636e72;
    }
    
    .sw-form-group {
      margin-bottom: 15px;
    }
    
    .sw-form-label {
      color: #2d3436;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
      font-size: 14px;
    }
    
    .sw-searchable-select {
      position: relative;
      width: 100%;
    }
    
    .sw-dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-top: 4px;
    }
    
    .sw-dropdown-list.show {
      display: block;
    }
    
    .sw-dropdown-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .sw-dropdown-item:last-child {
      border-bottom: none;
    }
    
    .sw-dropdown-item:hover {
      background-color: #fff9e6;
    }
    
    .sw-dropdown-item.highlight {
      background-color: #ffeaa7;
    }
    
    .sw-form-input,
    .sw-form-select,
    .sw-form-textarea {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      font-size: 14px;
      background: #ffffff;
      color: #2d3436;
      box-sizing: border-box;
    }
    
    .sw-form-input:focus,
    .sw-form-select:focus,
    .sw-form-textarea:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    
    .sw-form-textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .sw-photo-upload-area {
      border: 2px dashed #ffeaa7;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fffef9;
    }
    
    .sw-photo-upload-area:hover {
      border-color: #ff6b35;
      background: #ffffff;
    }
    
    .sw-photo-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .sw-photo-thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ffeaa7;
      cursor: pointer;
    }
    
    .sw-photo-thumbnail:hover {
      border-color: #ff6b35;
      transform: scale(1.05);
    }
    
    .sw-btn-secondary {
      padding: 10px 20px;
      background: linear-gradient(135deg, #b2bec3 0%, #95a5a6 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .sw-btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(178, 190, 195, 0.25);
    }
    
    .sw-work-type-item {
      background: #f8f9fa;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    
    .sw-work-type-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sw-work-type-name {
      font-weight: 600;
      color: #2d3436;
      margin-bottom: 5px;
    }
    
    .sw-work-type-price {
      font-size: 14px;
      color: #636e72;
    }
    
    .sw-btn-action {
      padding: 0;
      font-size: 11px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
      width: 65px;
      height: 35px;
      line-height: 35px;
      margin: 0;
      display: block;
      box-sizing: border-box;
      flex-shrink: 0;
      text-align: center;
    }
    
    .sw-btn-action-container {
      display: flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 0;
      margin: 0;
      box-sizing: border-box;
      vertical-align: middle;
    }
    
    .sw-btn-edit {
      background: #74b9ff;
      color: white;
    }
    
    .sw-btn-delete {
      background: #e17055;
      color: white;
    }
    
    /* ì‘ì—… í•­ëª© ìŠ¤íƒ€ì¼ */
    .sw-work-entry {
      background: #f8f9fa;
      border: 2px solid #ffeaa7;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      position: relative;
    }
    
    .sw-work-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ffeaa7;
    }
    
    .sw-work-entry-title {
      font-weight: 700;
      color: #ff6b35;
      font-size: 16px;
    }
    
    .sw-work-entry-remove {
      background: #e17055;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .sw-work-entry-remove:hover {
      background: #c0392b;
      transform: translateY(-1px);
    }
    
    .sw-work-entry-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    /* ë©”ëª¨ íˆ´íŒ ìŠ¤íƒ€ì¼ */
    .sw-memo-cell {
      position: relative !important;
      max-width: 200px;
      overflow: visible !important;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: help;
    }
    
    .sw-memo-cell > span {
      display: inline-block;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }
    
    .sw-memo-tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      z-index: 10000;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 14px;
      background: #2d3436;
      color: white;
      border-radius: 8px;
      font-size: 13px;
      white-space: normal;
      word-wrap: break-word;
      word-break: break-word;
      max-width: 400px;
      min-width: 200px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: opacity 0.2s ease, visibility 0.2s ease;
      pointer-events: none;
      line-height: 1.5;
    }
    
    .sw-memo-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #2d3436;
    }
    
    .sw-memo-cell:hover .sw-memo-tooltip {
      visibility: visible;
      opacity: 1;
    }
    
    /* í…Œì´ë¸” ì…€ overflow ì¡°ì • (íˆ´íŒì´ ì˜ë¦¬ì§€ ì•Šë„ë¡) */
    .sw-table td.sw-memo-cell {
      overflow: visible !important;
    }
    
    /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ ë˜í¼ì—ì„œ íˆ´íŒì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ */
    .sw-table-scroll-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      position: relative;
    }
    
    .sw-table-scroll-wrapper {
      overflow-x: auto;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="swContainer">
    <!-- ê³µí†µ ì„¹ì…˜: ì‘ì—… ì¢…ë¥˜ ê´€ë¦¬, ì‘ì—… ë“±ë¡ (ê´€ë¦¬ìë§Œ í‘œì‹œ) -->
    <div id="swCommonSection" class="sw-section">
      <!-- ì‘ì—… ì¢…ë¥˜ ê´€ë¦¬ (ê´€ë¦¬ìë§Œ) -->
      <div id="swAdminWorkTypeSection" class="sw-admin-only sw-section">
        <button class="sw-toggle-btn" onclick="swAdminToggleWorkTypeManagement()">
          <span>âš™ï¸ ì‘ì—… ì¢…ë¥˜ ê´€ë¦¬</span>
          <span id="swAdminWorkTypeIcon">â–¼</span>
        </button>
        <div id="swAdminWorkTypeManagement" class="sw-toggle-content">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #2d3436; font-weight: 600;">ì‘ì—… ì¢…ë¥˜ ëª©ë¡</h3>
            <button class="sw-btn" onclick="swAdminShowAddWorkTypeModal()">â• ì‘ì—… ì¢…ë¥˜ ì¶”ê°€</button>
          </div>
          <div id="swAdminWorkTypeList">
            <!-- ì‘ì—… ì¢…ë¥˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
      
      <!-- ì‘ì—… ë“±ë¡ (ê´€ë¦¬ìë§Œ) -->
      <div id="swAdminWorkRegistrationSection" class="sw-admin-only sw-section">
        <button class="sw-toggle-btn" onclick="swAdminToggleWorkRegistration()">
          <span>â• ì‘ì—… ë“±ë¡</span>
          <span id="swAdminWorkRegistrationIcon">â–¼</span>
        </button>
        <div id="swAdminWorkRegistration" class="sw-toggle-content">
          <div class="sw-form-group">
            <h3 style="margin: 0 0 20px 0; color: #ff6b35; font-weight: 700;">ì‘ì—… ë“±ë¡</h3>
          </div>
          <form id="swAdminWorkForm" onsubmit="swAdminHandleWorkSubmit(event)">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div class="sw-form-group">
                <label class="sw-form-label">í™”ì£¼ì‚¬ *</label>
                <div class="sw-searchable-select">
                  <input type="text" id="swAdminWorkCompanyInput" class="sw-form-input" placeholder="í™”ì£¼ì‚¬ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”" autocomplete="off" required>
                  <input type="hidden" id="swAdminWorkCompanySelect" required>
                  <div id="swAdminWorkCompanyDropdown" class="sw-dropdown-list"></div>
                </div>
              </div>
              <div class="sw-form-group">
                <label class="sw-form-label">ì‘ì—… ì¼ì *</label>
                <input type="date" id="swAdminWorkDate" class="sw-form-input" required>
              </div>
            </div>
            
            <!-- ì‘ì—… í•­ëª© ëª©ë¡ -->
            <div id="swAdminWorkEntriesContainer" style="margin-bottom: 20px;">
              <!-- ì‘ì—… í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            
            <!-- ì‘ì—… í•­ëª© ì¶”ê°€ ë²„íŠ¼ -->
            <div style="margin-bottom: 20px;">
              <button type="button" class="sw-btn" onclick="swAdminAddWorkEntry()" style="width: 100%;">
                â• ì‘ì—… í•­ëª© ì¶”ê°€
              </button>
            </div>
            
            <!-- ì „ì²´ ì´ì•¡ í‘œì‹œ -->
            <div class="sw-form-group" style="background: #fffef9; padding: 15px; border-radius: 8px; border: 2px solid #ffeaa7; margin-bottom: 20px;">
              <label class="sw-form-label" style="font-weight: 700; color: #ff6b35; font-size: 16px;">ì „ì²´ ì´ì•¡</label>
              <div style="font-size: 24px; font-weight: 800; color: #ff6b35; text-align: right;">
                <span id="swAdminTotalAllPrice">0</span>ì›
              </div>
            </div>
            <div class="sw-form-group">
              <label class="sw-form-label">ì‚¬ì§„ ì²¨ë¶€</label>
              <div class="sw-photo-upload-area" onclick="document.getElementById('swAdminPhotoInput').click()">
                <p>ğŸ“· í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì¶”ê°€</p>
                <input type="file" id="swAdminPhotoInput" multiple accept="image/*" style="display: none;" onchange="swAdminHandlePhotoSelect(event)">
              </div>
              <div id="swAdminPhotoPreviewContainer" class="sw-photo-preview-container"></div>
            </div>
            <div class="sw-form-group">
              <label class="sw-form-label">ë©”ëª¨</label>
              <textarea id="swAdminWorkMemo" class="sw-form-textarea" placeholder="ì‘ì—… ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 2px solid #ffeaa7;">
              <button type="submit" class="sw-btn">ğŸ’¾ ë“±ë¡</button>
              <button type="button" class="sw-btn-secondary" onclick="swAdminResetWorkForm()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- ê´€ë¦¬ì ì „ìš© í•„í„° ì„¹ì…˜ -->
    <div id="swAdminFilterSection" class="sw-admin-only sw-section">
      <div class="sw-filters">
        <div class="sw-filter-group">
          <label for="swAdminFilterMonth">ì¡°íšŒ ì›”</label>
          <input type="month" id="swAdminFilterMonth">
        </div>
        <div class="sw-filter-group">
          <label for="swAdminFilterWorkType">ì‘ì—… ì¢…ë¥˜</label>
          <select id="swAdminFilterWorkType">
            <option value="">ì „ì²´ ì‘ì—… ì¢…ë¥˜</option>
          </select>
        </div>
        <div class="sw-filter-group">
          <label for="swAdminFilterCompany">í™”ì£¼ì‚¬</label>
          <select id="swAdminFilterCompany">
            <option value="">ì „ì²´ í™”ì£¼ì‚¬</option>
          </select>
        </div>
        <button class="sw-btn" onclick="swAdminLoadWorks()">ì¡°íšŒ</button>
        <button class="sw-btn" onclick="swAdminLoadPreviousMonth()" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);">ğŸ“… ì „ë‹¬ì¡°íšŒ</button>
      </div>
    </div>
    
    <!-- í™”ì£¼ì‚¬ ì „ìš© í•„í„° ì„¹ì…˜ -->
    <div id="swConsignorFilterSection" class="sw-consignor-only sw-section">
      <div class="sw-filters">
        <div class="sw-filter-group">
          <label for="swConsignorFilterMonth">ì¡°íšŒ ì›”</label>
          <input type="month" id="swConsignorFilterMonth">
        </div>
        <button class="sw-btn" onclick="swConsignorLoadWorks()">ì¡°íšŒ</button>
        <button class="sw-btn" onclick="swConsignorLoadPreviousMonth()" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);">ğŸ“… ì „ë‹¬ì¡°íšŒ</button>
      </div>
    </div>
    
    <!-- ê´€ë¦¬ì ì „ìš© í™”ì£¼ì‚¬ë³„ í†µê³„ ì„¹ì…˜ -->
    <div id="swAdminCompanyStatsSection" class="sw-admin-only sw-section">
      <div class="sw-stats-container" id="swAdminCompanyStatsContainer"></div>
    </div>
    
    <!-- ê³µí†µ ì‘ì—… ì¢…ë¥˜ë³„ í†µê³„ ì„¹ì…˜ (ê´€ë¦¬ì/í™”ì£¼ì‚¬ ëª¨ë‘ ì‚¬ìš©) -->
    <div id="swCommonStatsSection" class="sw-section">
      <div class="sw-stats-container" id="swCommonStatsContainer"></div>
    </div>
    
    <!-- ê³µí†µ ì‘ì—… ëª©ë¡ í…Œì´ë¸” -->
    <div id="swCommonTableSection" class="sw-section">
      <div class="sw-table-container">
        <div class="sw-table-header">
          <h3>ğŸ“‹ ì‘ì—… ëª©ë¡</h3>
        </div>
        <div class="sw-table-scroll-wrapper">
          <table class="sw-table">
            <thead>
              <tr>
                <th>ìˆœë²ˆ</th>
                <th>ì‘ì—… ì¼ì</th>
                <th class="sw-admin-only">í™”ì£¼ì‚¬</th>
                <th>ì‘ì—… ì¢…ë¥˜</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ë‹¨ê°€</th>
                <th>ì´ì•¡</th>
                <th>ì‚¬ì§„</th>
                <th>ë©”ëª¨</th>
                <th class="sw-admin-only">ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="swTableBody">
              <tr>
                <td colspan="10" class="no-data">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‘ì—… ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="swEditWorkModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
    <div style="max-width: 800px; margin: 50px auto; background: white; border-radius: 14px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; color: #ff6b35; font-weight: 700;">ì‘ì—… ìˆ˜ì •</h2>
        <button onclick="swAdminCloseEditModal()" style="background: #e17055; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px;">Ã—</button>
      </div>
      <form id="swEditWorkForm" onsubmit="swAdminHandleEditWorkSubmit(event)">
        <input type="hidden" id="swEditWorkId">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
          <div class="sw-form-group">
            <label class="sw-form-label">í™”ì£¼ì‚¬ *</label>
            <div class="sw-searchable-select">
              <input type="text" id="swEditWorkCompanyInput" class="sw-form-input" placeholder="í™”ì£¼ì‚¬ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”" autocomplete="off" required>
              <input type="hidden" id="swEditWorkCompanySelect" required>
              <div id="swEditWorkCompanyDropdown" class="sw-dropdown-list"></div>
            </div>
          </div>
          <div class="sw-form-group">
            <label class="sw-form-label">ì‘ì—… ì¼ì *</label>
            <input type="date" id="swEditWorkDate" class="sw-form-input" required>
          </div>
        </div>
        
        <!-- ì‘ì—… í•­ëª© ëª©ë¡ -->
        <div id="swEditWorkEntriesContainer" style="margin-bottom: 20px;">
          <!-- ì‘ì—… í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        
        <!-- ì‘ì—… í•­ëª© ì¶”ê°€ ë²„íŠ¼ -->
        <div style="margin-bottom: 20px;">
          <button type="button" class="sw-btn" onclick="swAdminAddEditWorkEntry()" style="width: 100%;">
            â• ì‘ì—… í•­ëª© ì¶”ê°€
          </button>
        </div>
        
        <!-- ì „ì²´ ì´ì•¡ í‘œì‹œ -->
        <div class="sw-form-group" style="background: #fffef9; padding: 15px; border-radius: 8px; border: 2px solid #ffeaa7; margin-bottom: 20px;">
          <label class="sw-form-label" style="font-weight: 700; color: #ff6b35; font-size: 16px;">ì „ì²´ ì´ì•¡</label>
          <div style="font-size: 24px; font-weight: 800; color: #ff6b35; text-align: right;">
            <span id="swEditTotalAllPrice">0</span>ì›
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        </div>
        <div class="sw-form-group">
          <label class="sw-form-label">ì‚¬ì§„ ì²¨ë¶€</label>
          <div class="sw-photo-upload-area" onclick="document.getElementById('swEditPhotoInput').click()">
            <p>ğŸ“· í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì¶”ê°€</p>
            <input type="file" id="swEditPhotoInput" multiple accept="image/*" style="display: none;" onchange="swAdminHandleEditPhotoSelect(event)">
          </div>
          <div id="swEditPhotoPreviewContainer" class="sw-photo-preview-container"></div>
        </div>
        <div class="sw-form-group">
          <label class="sw-form-label">ë©”ëª¨</label>
          <textarea id="swEditWorkMemo" class="sw-form-textarea" placeholder="ì‘ì—… ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 2px solid #ffeaa7;">
          <button type="submit" class="sw-btn">ğŸ’¾ ìˆ˜ì •</button>
          <button type="button" class="sw-btn-secondary" onclick="swAdminCloseEditModal()">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    var swCurrentRole = '';
    var swCurrentCompany = '';
    var swCurrentUsername = '';
    var swWorkTypes = [];
    var swSelectedWorkType = null;
    var swSelectedCompany = null; // ì„ íƒëœ í™”ì£¼ì‚¬ í•„í„°
    var swSelectedPhotos = [];
    var swEditSelectedPhotos = []; // ìˆ˜ì • ëª¨ë‹¬ìš© ì‚¬ì§„
    var swEditExistingPhotos = []; // ìˆ˜ì • ëª¨ë‹¬ìš© ê¸°ì¡´ ì‚¬ì§„
    var swInitialized = false;
    var swWorkEntryCounter = 0; // ì‘ì—… í•­ëª© ì¹´ìš´í„°
    var swEditWorkEntryCounter = 0; // ìˆ˜ì • ëª¨ë‹¬ ì‘ì—… í•­ëª© ì¹´ìš´í„°
    
    /**
     * ìˆ˜ì • ëª¨ë‹¬ ì‘ì—… í•­ëª© ì¶”ê°€
     */
    function swAdminAddEditWorkEntry(workData = null) {
      const entriesContainer = document.getElementById('swEditWorkEntriesContainer');
      if (!entriesContainer) return;
      
      swEditWorkEntryCounter++;
      const entryId = `swEditWorkEntry_${swEditWorkEntryCounter}`;
      
      // ì‘ì—… ì¢…ë¥˜ ì˜µì…˜ ìƒì„±
      const workTypeOptions = swWorkTypes.map(type => 
        `<option value="${type.id}" data-price="${type.default_unit_price}">${swEscapeHtml(type.name)}</option>`
      ).join('');
      
      // workDataê°€ ìˆìœ¼ë©´ ê¸°ì¡´ ë°ì´í„°ë¡œ ì±„ìš°ê¸°
      const selectedWorkTypeId = workData ? workData.work_type_id : '';
      const quantity = workData ? workData.quantity : 1;
      const unitPrice = workData ? workData.unit_price : '';
      const totalPrice = workData ? workData.total_price : 0;
      
      const entryHtml = `
        <div class="sw-work-entry" id="${entryId}">
          <div class="sw-work-entry-header">
            <div class="sw-work-entry-title">ì‘ì—… í•­ëª© ${swEditWorkEntryCounter}</div>
            <button type="button" class="sw-work-entry-remove" onclick="swAdminRemoveEditWorkEntry('${entryId}')">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
          <div class="sw-work-entry-fields">
            <div class="sw-form-group">
              <label class="sw-form-label">ì‘ì—… ì¢…ë¥˜ *</label>
              <div style="display: flex; gap: 8px; align-items: flex-start;">
                <select class="sw-form-select sw-work-entry-type" required onchange="swAdminUpdateEditEntryPrice('${entryId}')" style="flex: 1;">
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  ${workTypeOptions}
                </select>
                <button type="button" class="sw-btn" onclick="swAdminShowAddWorkTypeModalFromForm()" style="white-space: nowrap; padding: 10px 16px; margin-top: 0;" title="ì‘ì—… ì¢…ë¥˜ ì¶”ê°€">â•</button>
              </div>
            </div>
            <div class="sw-form-group">
              <label class="sw-form-label">ìˆ˜ëŸ‰ *</label>
              <input type="number" class="sw-form-input sw-work-entry-quantity" value="${quantity}" min="0.01" step="0.01" required onchange="swAdminUpdateEditEntryTotal('${entryId}'); swAdminUpdateEditAllTotal();">
            </div>
            <div class="sw-form-group">
              <label class="sw-form-label">ë‹¨ê°€ (ì›) *</label>
              <input type="number" class="sw-form-input sw-work-entry-unit-price" value="${unitPrice}" min="0" step="1" required onchange="swAdminUpdateEditEntryTotal('${entryId}'); swAdminUpdateEditAllTotal();">
            </div>
            <div class="sw-form-group">
              <label class="sw-form-label">ì´ì•¡ (ì›)</label>
              <input type="number" class="sw-form-input sw-work-entry-total-price" value="${totalPrice}" readonly style="background: #f0f0f0;">
            </div>
          </div>
        </div>
      `;
      
      entriesContainer.insertAdjacentHTML('beforeend', entryHtml);
      
      // ì‘ì—… ì¢…ë¥˜ ì„ íƒ (workDataê°€ ìˆëŠ” ê²½ìš°)
      if (workData && selectedWorkTypeId) {
        const select = document.querySelector(`#${entryId} .sw-work-entry-type`);
        if (select) {
          select.value = selectedWorkTypeId;
        }
      }
      
      swAdminUpdateEditAllTotal();
    }
    
    /**
     * ìˆ˜ì • ëª¨ë‹¬ ì‘ì—… í•­ëª© ì œê±°
     */
    function swAdminRemoveEditWorkEntry(entryId) {
      const entry = document.getElementById(entryId);
      if (entry) {
        entry.remove();
        swAdminUpdateEditAllTotal();
      }
    }
    
    /**
     * ìˆ˜ì • ëª¨ë‹¬ ì‘ì—… í•­ëª© ë‹¨ê°€ ì—…ë°ì´íŠ¸
     */
    function swAdminUpdateEditEntryPrice(entryId) {
      const entry = document.getElementById(entryId);
      if (!entry) return;
      
      const typeSelect = entry.querySelector('.sw-work-entry-type');
      const unitPriceInput = entry.querySelector('.sw-work-entry-unit-price');
      
      if (typeSelect && unitPriceInput) {
        const selectedOption = typeSelect.options[typeSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
          const price = selectedOption.getAttribute('data-price') || '0';
          unitPriceInput.value = price;
          swAdminUpdateEditEntryTotal(entryId);
          swAdminUpdateEditAllTotal();
        }
      }
    }
    
    /**
     * ìˆ˜ì • ëª¨ë‹¬ ì‘ì—… í•­ëª© ì´ì•¡ ê³„ì‚°
     */
    function swAdminUpdateEditEntryTotal(entryId) {
      const entry = document.getElementById(entryId);
      if (!entry) return;
      
      const quantity = parseFloat(entry.querySelector('.sw-work-entry-quantity')?.value) || 0;
      const unitPrice = parseFloat(entry.querySelector('.sw-work-entry-unit-price')?.value) || 0;
      const totalPrice = quantity * unitPrice;
      
      const totalPriceInput = entry.querySelector('.sw-work-entry-total-price');
      if (totalPriceInput) {
        totalPriceInput.value = Math.round(totalPrice);
      }
    }
    
    /**
     * ìˆ˜ì • ëª¨ë‹¬ ì „ì²´ ì´ì•¡ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
     */
    function swAdminUpdateEditAllTotal() {
      const entriesContainer = document.getElementById('swEditWorkEntriesContainer');
      if (!entriesContainer) return;
      
      const entries = entriesContainer.querySelectorAll('.sw-work-entry');
      let totalAll = 0;
      
      entries.forEach(entry => {
        const totalPrice = parseFloat(entry.querySelector('.sw-work-entry-total-price')?.value) || 0;
        totalAll += totalPrice;
      });
      
      const totalAllElement = document.getElementById('swEditTotalAllPrice');
      if (totalAllElement) {
        totalAllElement.textContent = swFormatNumber(Math.round(totalAll));
      }
    }
    
    // ê³µí†µ ì´ˆê¸°í™” í•¨ìˆ˜
    function swCommonInit() {
      if (swInitialized) {
        console.log('[SW] ì´ë¯¸ ì´ˆê¸°í™”ë¨, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
        return;
      }
      
      console.log('[SW] swCommonInit ì‹œì‘');
      const container = document.getElementById('swContainer');
      if (!container) {
        console.error('[SW] swContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      // ì—­í•  í™•ì¸ (í—¤ë”ì˜ companyInfo ìš”ì†Œì—ì„œ í™•ì¸, ì—†ìœ¼ë©´ ì „ì—­ ë³€ìˆ˜, localStorage ìˆœì„œ)
      // í—¤ë”ì—ì„œ ì—­í•  ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
      const companyInfoEl = document.getElementById('companyInfo');
      if (companyInfoEl && companyInfoEl.textContent) {
        const headerText = companyInfoEl.textContent.trim();
        // "[ê´€ë¦¬ì]"ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê´€ë¦¬ì
        if (headerText.includes('[ê´€ë¦¬ì]')) {
          swCurrentRole = 'ê´€ë¦¬ì';
          // í—¤ë” í˜•ì‹: "ê´€ë¦¬ì [ê´€ë¦¬ì] (username)" ë˜ëŠ” "í™”ì£¼ì‚¬ëª… (username)"
          // ê´„í˜¸ ì•ˆì˜ username ì¶”ì¶œ
          const usernameMatch = headerText.match(/\(([^)]+)\)/);
          if (usernameMatch) {
            swCurrentUsername = usernameMatch[1].trim();
          }
          // "[ê´€ë¦¬ì]" ì•ì˜ í…ìŠ¤íŠ¸ê°€ íšŒì‚¬ëª…
          const companyMatch = headerText.match(/^([^[]+)/);
          if (companyMatch) {
            swCurrentCompany = companyMatch[1].trim();
          }
        } else {
          // í™”ì£¼ì‚¬ ëª¨ë“œ: "í™”ì£¼ì‚¬ëª… (username)"
          const usernameMatch = headerText.match(/\(([^)]+)\)/);
          if (usernameMatch) {
            swCurrentUsername = usernameMatch[1].trim();
          }
          const companyMatch = headerText.match(/^([^(]+)/);
          if (companyMatch) {
            swCurrentCompany = companyMatch[1].trim();
          }
          swCurrentRole = 'í™”ì£¼ì‚¬';
        }
        console.log('[SW] í—¤ë”ì—ì„œ ì—­í•  ì •ë³´ ì¶”ì¶œ:', {
          headerText: headerText,
          role: swCurrentRole,
          company: swCurrentCompany,
          username: swCurrentUsername
        });
      } else {
        // í—¤ë” ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
        swCurrentRole = (window.currentRole || localStorage.getItem('client_role') || '').toString().trim();
        swCurrentCompany = (window.currentCompany || localStorage.getItem('client_company') || '').toString().trim();
        swCurrentUsername = (window.currentUsername || localStorage.getItem('client_username') || '').toString().trim();
        
        console.log('[SW] ì „ì—­ ë³€ìˆ˜/LocalStorageì—ì„œ ì—­í•  í™•ì¸:', {
          role: swCurrentRole,
          company: swCurrentCompany,
          username: swCurrentUsername,
          windowRole: window.currentRole,
          localStorageRole: localStorage.getItem('client_role')
        });
      }
      
      // ëª¨ë“œë³„ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
      // ì—­í•  í™•ì¸ì„ ë” ì—„ê²©í•˜ê²Œ (ê³µë°± ì œê±°, ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
      const roleNormalized = swCurrentRole.toString().trim();
      const isAdmin = (roleNormalized === 'ê´€ë¦¬ì');
      
      console.log('[SW] ëª¨ë“œ í™•ì¸:', {
        originalRole: swCurrentRole,
        normalizedRole: roleNormalized,
        isAdmin: isAdmin
      });
      
      // ê°€ì‹œì„± ì œì–´ (ë¨¼ì € ì‹¤í–‰í•˜ì—¬ ì„¹ì…˜ í‘œì‹œ)
      swApplyVisibility();
      
      // ëª¨ë“œë³„ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
      if (isAdmin) {
        swAdminInit();
      } else {
        swConsignorInit();
      }
      
      // ê°€ì‹œì„± ì œì–´ ì¬ì‹¤í–‰ (ì´ˆê¸°í™” í›„ ë‹¤ì‹œ í™•ì¸)
      setTimeout(() => {
        swApplyVisibility();
      }, 50);
      
      swInitialized = true;
      console.log('[SW] ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ê°€ì‹œì„± ì œì–´ í•¨ìˆ˜
    function swApplyVisibility() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const roleNormalized = (swCurrentRole || '').toString().trim();
      const isAdmin = (roleNormalized === 'ê´€ë¦¬ì');
      
      console.log('[SW] swApplyVisibility ì‹¤í–‰:', { role: swCurrentRole, isAdmin });
      
      // ê´€ë¦¬ì ì„¹ì…˜
      container.querySelectorAll('.sw-admin-only').forEach(el => {
        el.style.display = isAdmin ? 'block' : 'none';
        console.log('[SW] ê´€ë¦¬ì ì„¹ì…˜ í‘œì‹œ:', el.id || el.className, isAdmin ? 'block' : 'none');
      });
      
      // í™”ì£¼ì‚¬ ì„¹ì…˜
      container.querySelectorAll('.sw-consignor-only').forEach(el => {
        el.style.display = isAdmin ? 'none' : 'block';
      });
    }
    
    // ì‚¬ìš©ì í—¤ë” ìƒì„± í•¨ìˆ˜
    function swGetUserHeaders() {
      const encodeHeader = (value) => encodeURIComponent((value || '').toString().trim());
      return {
        'X-User-Role': encodeHeader(swCurrentRole),
        'X-User-Name': encodeHeader(swCurrentUsername),
        'X-Company-Name': encodeHeader(swCurrentCompany)
      };
    }
    
    // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
    function swEscapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
    function swFormatNumber(num) {
      if (num === null || num === undefined || num === '') return '0';
      return new Intl.NumberFormat('ko-KR').format(parseFloat(num));
    }
    
    // ========== ê³µí†µ í•¨ìˆ˜ ==========
    
    /**
     * ì‘ì—… ì¢…ë¥˜ ëª©ë¡ ë¡œë“œ (ê³µí†µ)
     * ê´€ë¦¬ìì™€ í™”ì£¼ì‚¬ ëª¨ë‘ ì‚¬ìš©
     * Promiseë¥¼ ë°˜í™˜í•˜ì—¬ ì¶”ê°€ í›„ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ í•¨
     */
    function swCommonLoadWorkTypes() {
      return fetch('/api/special-works/types', {
        credentials: 'include',
        headers: swGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            swWorkTypes = data.data || [];
            // ê´€ë¦¬ì ëª¨ë“œë©´ ì‘ì—… ì¢…ë¥˜ ê´€ë¦¬ ëª©ë¡ ë° í•„í„° ì—…ë°ì´íŠ¸
            if (swCurrentRole === 'ê´€ë¦¬ì') {
              swAdminUpdateWorkTypeList(swWorkTypes);
              swAdminUpdateWorkTypeSelects(swWorkTypes);
            }
            // í™”ì£¼ì‚¬ ëª¨ë“œëŠ” í•„í„°ë§Œ ì—…ë°ì´íŠ¸ (ì—†ìŒ)
            return swWorkTypes;
          }
          return [];
        })
        .catch(error => {
          console.error('[SW] ì‘ì—… ì¢…ë¥˜ ë¡œë“œ ì˜¤ë¥˜:', error);
          return [];
        });
    }
    
    /**
     * ì‘ì—… ì¢…ë¥˜ í•„í„°ë§
     */
    /**
     * í™”ì£¼ì‚¬ë³„ í•„í„°ë§
     */
    function swFilterByCompany(companyName) {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      // ì„ íƒëœ í™”ì£¼ì‚¬ ì—…ë°ì´íŠ¸ (nullì´ë©´ ì „ì²´)
      swSelectedCompany = companyName;
      
      // í†µê³„ ë°•ìŠ¤ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
      const statsContainer = container.querySelector('#swAdminCompanyStatsContainer');
      if (statsContainer) {
        const boxes = statsContainer.querySelectorAll('.sw-stat-box');
        boxes.forEach(box => {
          const boxCompanyName = box.querySelector('.sw-stat-box-name')?.textContent?.trim();
          if (boxCompanyName === companyName) {
            box.classList.add('selected');
          } else {
            box.classList.remove('selected');
          }
        });
      }
      
      // ê´€ë¦¬ì ëª¨ë“œë©´ ê´€ë¦¬ì ì¡°íšŒ í•¨ìˆ˜ í˜¸ì¶œ, í™”ì£¼ì‚¬ ëª¨ë“œë©´ í™”ì£¼ì‚¬ ì¡°íšŒ í•¨ìˆ˜ í˜¸ì¶œ
      const roleNormalized = (swCurrentRole || '').toString().trim();
      const isAdmin = (roleNormalized === 'ê´€ë¦¬ì');
      
      if (isAdmin) {
        swAdminLoadWorks();
      } else {
        swConsignorLoadWorks();
      }
    }
    window.swFilterByCompany = swFilterByCompany;
    
    function swFilterByWorkType(workTypeName) {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      // nullì´ë©´ ì „ì²´ ì„ íƒ, ê°™ì€ ì‘ì—… ì¢…ë¥˜ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ í•„í„° í•´ì œ
      if (workTypeName === null) {
        swSelectedWorkType = null;
      } else if (swSelectedWorkType === workTypeName) {
        swSelectedWorkType = null;
      } else {
        swSelectedWorkType = workTypeName;
      }
      
      // ì‘ì—… ì¢…ë¥˜ í†µê³„ ë°•ìŠ¤ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‘ì—… ì¢…ë¥˜ í†µê³„ ì„¹ì…˜ë§Œ)
      const workTypeStatsContainer = container.querySelector('#swCommonStatsContainer');
      if (workTypeStatsContainer) {
        const statsBoxes = workTypeStatsContainer.querySelectorAll('.sw-stat-box');
        statsBoxes.forEach((box, index) => {
          // ì²« ë²ˆì§¸ ë°•ìŠ¤ëŠ” "ì „ì²´"
          if (index === 0) {
            if (swSelectedWorkType === null) {
              box.classList.add('selected');
            } else {
              box.classList.remove('selected');
            }
          } else {
            // ë‚˜ë¨¸ì§€ëŠ” ì‘ì—… ì¢…ë¥˜ë³„ ë°•ìŠ¤
            const boxTypeName = box.querySelector('.sw-stat-box-name')?.textContent || '';
            if (swSelectedWorkType === boxTypeName) {
              box.classList.add('selected');
            } else {
              box.classList.remove('selected');
            }
          }
        });
      }
      
      // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ë‹¤ì‹œ ë¡œë“œ
      if (swCurrentRole === 'ê´€ë¦¬ì') {
        swAdminLoadWorks();
      } else {
        swConsignorLoadWorks();
      }
    }
    
    // ========== ê´€ë¦¬ì í•¨ìˆ˜ ==========
    
    /**
     * ê´€ë¦¬ì ëª¨ë“œ ì´ˆê¸°í™” í•¨ìˆ˜
     * ê´€ë¦¬ì ì „ìš© ê¸°ëŠ¥ë§Œ ì´ˆê¸°í™”
     */
    function swAdminInit() {
      console.log('[SW] swAdminInit ì‹œì‘');
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      // 1. ì›” í•„í„° ì´ˆê¸°í™” (ì˜¤ëŠ˜ ì›”)
      const today = new Date().toISOString().split('T')[0];
      const monthInput = container.querySelector('#swAdminFilterMonth');
      if (monthInput) monthInput.value = today.slice(0, 7); // YYYY-MM
      
      // 2. ì‘ì—… ë“±ë¡ í¼ ë‚ ì§œ ì´ˆê¸°í™” (ì˜¤ëŠ˜ ë‚ ì§œ)
      const workDate = container.querySelector('#swAdminWorkDate');
      if (workDate) workDate.value = today;
      
      // 3. ê´€ë¦¬ì ì„¹ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì ‘í˜€ìˆê²Œ ìœ ì§€ (ì‚¬ìš©ìê°€ ì§ì ‘ í¼ì¹  ìˆ˜ ìˆìŒ)
      // ì‘ì—… ì¢…ë¥˜ ê´€ë¦¬ì™€ ì‘ì—… ë“±ë¡ ì„¹ì…˜ì€ ì ‘í˜€ìˆëŠ” ìƒíƒœë¡œ ì‹œì‘
      
      // 4. í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ
      swAdminLoadCompanies();
      
      // 5. ì‘ì—… ì¢…ë¥˜ ëª©ë¡ ë¡œë“œ
      swCommonLoadWorkTypes();
      
      // 6. ì‘ì—… ëª©ë¡ ë¡œë“œ
      swAdminLoadWorks();
    }
    
    /**
     * ê´€ë¦¬ì í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ
     */
    function swAdminLoadCompanies() {
      fetch('/api/auth/companies', {
        credentials: 'include'
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const container = document.getElementById('swContainer');
            if (!container) return;
            
            const workCompanyInput = container.querySelector('#swAdminWorkCompanyInput');
            const workCompanyHidden = container.querySelector('#swAdminWorkCompanySelect');
            const workCompanyDropdown = container.querySelector('#swAdminWorkCompanyDropdown');
            const filterCompanySelect = container.querySelector('#swAdminFilterCompany');
            
            // ê²€ìƒ‰ ê°€ëŠ¥í•œ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            if (workCompanyInput && workCompanyHidden && workCompanyDropdown) {
              const companies = data.companies || [];
              
              // ë“œë¡­ë‹¤ìš´ ì•„ì´í…œ ìƒì„± í•¨ìˆ˜
              function updateDropdown(filterText = '') {
                const filtered = companies.filter(company => 
                  company.company_name.toLowerCase().includes(filterText.toLowerCase())
                );
                
                if (filtered.length === 0) {
                  workCompanyDropdown.innerHTML = '<div class="sw-dropdown-item" style="color: #999; cursor: default;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                  workCompanyDropdown.innerHTML = filtered.map(company => 
                    `<div class="sw-dropdown-item" data-value="${swEscapeHtml(company.company_name)}">${swEscapeHtml(company.company_name)}</div>`
                  ).join('');
                }
              }
              
              // ì´ˆê¸° ë“œë¡­ë‹¤ìš´ ìƒì„±
              updateDropdown();
              
              // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
              const newInput = workCompanyInput.cloneNode(true);
              workCompanyInput.parentNode.replaceChild(newInput, workCompanyInput);
              const newHidden = workCompanyHidden.cloneNode(true);
              workCompanyHidden.parentNode.replaceChild(newHidden, workCompanyHidden);
              
              // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
              const currentInput = container.querySelector('#swAdminWorkCompanyInput');
              const currentHidden = container.querySelector('#swAdminWorkCompanySelect');
              const currentDropdown = container.querySelector('#swAdminWorkCompanyDropdown');
              
              // ë“œë¡­ë‹¤ìš´ ì—´ê¸°/ë‹«ê¸° ìƒíƒœ ì¶”ì 
              let isDropdownOpen = false;
              let dropdownTimeout = null;
              
              // ë“œë¡­ë‹¤ìš´ ì—´ê¸° í•¨ìˆ˜
              const openDropdown = () => {
                if (dropdownTimeout) {
                  clearTimeout(dropdownTimeout);
                  dropdownTimeout = null;
                }
                updateDropdown(currentInput.value);
                currentDropdown.classList.add('show');
                isDropdownOpen = true;
              };
              
              // ë“œë¡­ë‹¤ìš´ ë‹«ê¸° í•¨ìˆ˜
              const closeDropdown = () => {
                if (dropdownTimeout) {
                  clearTimeout(dropdownTimeout);
                  dropdownTimeout = null;
                }
                currentDropdown.classList.remove('show');
                isDropdownOpen = false;
              };
              
              currentInput.addEventListener('input', (e) => {
                const value = e.target.value;
                currentHidden.value = value; // ì…ë ¥ëœ ê°’ë„ hiddenì— ì €ì¥
                updateDropdown(value);
                if (!isDropdownOpen) {
                  openDropdown();
                }
              });
              
              currentInput.addEventListener('focus', (e) => {
                e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ë‹¤ë¥¸ ì´ë²¤íŠ¸ê°€ ë¨¼ì € ì²˜ë¦¬ë˜ë„ë¡
                if (dropdownTimeout) {
                  clearTimeout(dropdownTimeout);
                }
                dropdownTimeout = setTimeout(() => {
                  openDropdown();
                }, 100);
              });
              
              currentInput.addEventListener('click', (e) => {
                e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                if (dropdownTimeout) {
                  clearTimeout(dropdownTimeout);
                }
                dropdownTimeout = setTimeout(() => {
                  openDropdown();
                }, 100);
              });
              
              // ë“œë¡­ë‹¤ìš´ ì•„ì´í…œ í´ë¦­
              currentDropdown.addEventListener('click', (e) => {
                e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                const item = e.target.closest('.sw-dropdown-item');
                if (item && item.dataset.value) {
                  currentInput.value = item.dataset.value;
                  currentHidden.value = item.dataset.value;
                  closeDropdown();
                }
              });
              
              // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸° (mousedown ì´ë²¤íŠ¸ ì‚¬ìš©)
              const handleDocumentClick = (e) => {
                // inputì´ë‚˜ dropdown ë‚´ë¶€ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë‹«ê¸°
                if (!currentInput.contains(e.target) && !currentDropdown.contains(e.target)) {
                  // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ inputì˜ focus ì´ë²¤íŠ¸ê°€ ë¨¼ì € ì²˜ë¦¬ë˜ë„ë¡
                  setTimeout(() => {
                    if (!currentInput.contains(document.activeElement)) {
                      closeDropdown();
                    }
                  }, 150);
                }
              };
              
              // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ í•¨ìˆ˜ ì°¸ì¡° ì €ì¥
              if (window.swCompanyDropdownCloseHandler) {
                document.removeEventListener('mousedown', window.swCompanyDropdownCloseHandler);
              }
              window.swCompanyDropdownCloseHandler = handleDocumentClick;
              // mousedown ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë” ë¹ ë¥´ê²Œ ì²˜ë¦¬í•˜ë˜, capture phaseëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
              document.addEventListener('mousedown', handleDocumentClick);
            }
            
            if (filterCompanySelect) {
              filterCompanySelect.innerHTML = '<option value="">ì „ì²´ í™”ì£¼ì‚¬</option>' + 
                data.companies.map(company => 
                  `<option value="${swEscapeHtml(company.company_name)}">${swEscapeHtml(company.company_name)}</option>`
                ).join('');
            }
          }
        })
        .catch(error => {
          console.error('[SW] í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        });
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ì¢…ë¥˜ ëª©ë¡ ì—…ë°ì´íŠ¸
     */
    function swAdminUpdateWorkTypeList(workTypes) {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const workTypeList = container.querySelector('#swAdminWorkTypeList');
      if (!workTypeList) return;
      
      if (workTypes.length === 0) {
        workTypeList.innerHTML = '<div style="text-align: center; padding: 20px; color: #636e72;">ë“±ë¡ëœ ì‘ì—… ì¢…ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      workTypeList.innerHTML = workTypes.map(type => `
        <div class="sw-work-type-item">
          <div class="sw-work-type-item-header">
            <div>
              <div class="sw-work-type-name">${swEscapeHtml(type.name)}</div>
              <div class="sw-work-type-price">ê¸°ë³¸ ë‹¨ê°€: ${swFormatNumber(type.default_unit_price)}ì›</div>
            </div>
            <div>
              <button class="sw-btn-action sw-btn-edit" onclick="swAdminEditWorkType(${type.id})">ìˆ˜ì •</button>
              <button class="sw-btn-action sw-btn-delete" onclick="swAdminDeleteWorkType(${type.id})">ì‚­ì œ</button>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ì¢…ë¥˜ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
     */
    function swAdminUpdateWorkTypeSelects(workTypes) {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const workTypeSelect = container.querySelector('#swAdminWorkTypeSelect');
      const filterWorkTypeSelect = container.querySelector('#swAdminFilterWorkType');
      
      if (workTypeSelect) {
        workTypeSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + 
          workTypes.map(type => 
            `<option value="${type.id}" data-price="${type.default_unit_price}">${swEscapeHtml(type.name)}</option>`
          ).join('');
      }
      
      if (filterWorkTypeSelect) {
        filterWorkTypeSelect.innerHTML = '<option value="">ì „ì²´ ì‘ì—… ì¢…ë¥˜</option>' + 
          workTypes.map(type => 
            `<option value="${type.id}">${swEscapeHtml(type.name)}</option>`
          ).join('');
      }
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ì¢…ë¥˜ ê´€ë¦¬ í† ê¸€
     */
    function swAdminToggleWorkTypeManagement() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const management = container.querySelector('#swAdminWorkTypeManagement');
      const icon = container.querySelector('#swAdminWorkTypeIcon');
      
      if (management && icon) {
        const isHidden = management.style.display === 'none' || !management.style.display;
        management.style.display = isHidden ? 'block' : 'none';
        icon.textContent = isHidden ? 'â–²' : 'â–¼';
        
        if (isHidden) {
          swCommonLoadWorkTypes();
        }
      }
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ë“±ë¡ í† ê¸€
     */
    function swAdminToggleWorkRegistration() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const registration = container.querySelector('#swAdminWorkRegistration');
      const icon = container.querySelector('#swAdminWorkRegistrationIcon');
      
      if (registration && icon) {
        const isHidden = registration.style.display === 'none' || !registration.style.display;
        registration.style.display = isHidden ? 'block' : 'none';
        icon.textContent = isHidden ? 'â–²' : 'â–¼';
        
        if (isHidden) {
          swAdminResetWorkForm();
          swCommonLoadWorkTypes();
          swAdminLoadCompanies();
        }
      }
    }
    
    /**
     * ì‘ì—… í•­ëª© ì¶”ê°€
     */
    function swAdminAddWorkEntry() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const entriesContainer = container.querySelector('#swAdminWorkEntriesContainer');
      if (!entriesContainer) return;
      
      swWorkEntryCounter++;
      const entryId = `swWorkEntry_${swWorkEntryCounter}`;
      
      // ì‘ì—… ì¢…ë¥˜ ì˜µì…˜ ìƒì„±
      const workTypeOptions = swWorkTypes.map(type => 
        `<option value="${type.id}" data-price="${type.default_unit_price}">${swEscapeHtml(type.name)}</option>`
      ).join('');
      
      const entryHtml = `
        <div class="sw-work-entry" id="${entryId}">
          <div class="sw-work-entry-header">
            <div class="sw-work-entry-title">ì‘ì—… í•­ëª© ${swWorkEntryCounter}</div>
            <button type="button" class="sw-work-entry-remove" onclick="swAdminRemoveWorkEntry('${entryId}')">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
          <div class="sw-work-entry-fields">
            <div class="sw-form-group">
              <label class="sw-form-label">ì‘ì—… ì¢…ë¥˜ *</label>
              <div style="display: flex; gap: 8px; align-items: flex-start;">
                <select class="sw-form-select sw-work-entry-type" required onchange="swAdminUpdateEntryPrice('${entryId}')" style="flex: 1;">
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  ${workTypeOptions}
                </select>
                <button type="button" class="sw-btn" onclick="swAdminShowAddWorkTypeModalFromForm()" style="white-space: nowrap; padding: 10px 16px; margin-top: 0;" title="ì‘ì—… ì¢…ë¥˜ ì¶”ê°€">â•</button>
              </div>
            </div>
            <div class="sw-form-group">
              <label class="sw-form-label">ìˆ˜ëŸ‰ *</label>
              <input type="number" class="sw-form-input sw-work-entry-quantity" value="1" min="0.01" step="0.01" required onchange="swAdminUpdateEntryTotal('${entryId}'); swAdminUpdateAllTotal();">
            </div>
            <div class="sw-form-group">
              <label class="sw-form-label">ë‹¨ê°€ (ì›) *</label>
              <input type="number" class="sw-form-input sw-work-entry-unit-price" min="0" step="1" required onchange="swAdminUpdateEntryTotal('${entryId}'); swAdminUpdateAllTotal();">
            </div>
            <div class="sw-form-group">
              <label class="sw-form-label">ì´ì•¡ (ì›)</label>
              <input type="number" class="sw-form-input sw-work-entry-total-price" readonly style="background: #f0f0f0;">
            </div>
          </div>
        </div>
      `;
      
      entriesContainer.insertAdjacentHTML('beforeend', entryHtml);
      swAdminUpdateAllTotal();
    }
    
    /**
     * ì‘ì—… í•­ëª© ì œê±°
     */
    function swAdminRemoveWorkEntry(entryId) {
      const entry = document.getElementById(entryId);
      if (entry) {
        entry.remove();
        swAdminUpdateAllTotal();
      }
    }
    
    /**
     * ì‘ì—… í•­ëª© ë‹¨ê°€ ì—…ë°ì´íŠ¸ (ì‘ì—… ì¢…ë¥˜ ì„ íƒ ì‹œ)
     */
    function swAdminUpdateEntryPrice(entryId) {
      const entry = document.getElementById(entryId);
      if (!entry) return;
      
      const typeSelect = entry.querySelector('.sw-work-entry-type');
      const unitPriceInput = entry.querySelector('.sw-work-entry-unit-price');
      
      if (typeSelect && unitPriceInput) {
        const selectedOption = typeSelect.options[typeSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
          const price = selectedOption.getAttribute('data-price') || '0';
          unitPriceInput.value = price;
          swAdminUpdateEntryTotal(entryId);
          swAdminUpdateAllTotal();
        }
      }
    }
    
    /**
     * ì‘ì—… í•­ëª© ì´ì•¡ ê³„ì‚°
     */
    function swAdminUpdateEntryTotal(entryId) {
      const entry = document.getElementById(entryId);
      if (!entry) return;
      
      const quantity = parseFloat(entry.querySelector('.sw-work-entry-quantity')?.value) || 0;
      const unitPrice = parseFloat(entry.querySelector('.sw-work-entry-unit-price')?.value) || 0;
      const totalPrice = quantity * unitPrice;
      
      const totalPriceInput = entry.querySelector('.sw-work-entry-total-price');
      if (totalPriceInput) {
        totalPriceInput.value = Math.round(totalPrice);
      }
    }
    
    /**
     * ì „ì²´ ì´ì•¡ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
     */
    function swAdminUpdateAllTotal() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const entries = container.querySelectorAll('.sw-work-entry');
      let totalAll = 0;
      
      entries.forEach(entry => {
        const totalPrice = parseFloat(entry.querySelector('.sw-work-entry-total-price')?.value) || 0;
        totalAll += totalPrice;
      });
      
      const totalAllElement = container.querySelector('#swAdminTotalAllPrice');
      if (totalAllElement) {
        totalAllElement.textContent = swFormatNumber(Math.round(totalAll));
      }
    }
    
    /**
     * ê´€ë¦¬ì ë‹¨ê°€ ì—…ë°ì´íŠ¸ (ë ˆê±°ì‹œ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
     */
    function swAdminUpdateUnitPrice() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const select = container.querySelector('#swAdminWorkTypeSelect');
      if (!select) return;
      
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption && selectedOption.value) {
        const price = selectedOption.getAttribute('data-price') || '0';
        const unitPriceInput = container.querySelector('#swAdminWorkUnitPrice');
        if (unitPriceInput) {
          unitPriceInput.value = price;
          swAdminCalculateTotalPrice();
        }
      }
    }
    
    /**
     * ê´€ë¦¬ì ì´ì•¡ ê³„ì‚°
     */
    function swAdminCalculateTotalPrice() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const quantity = parseFloat(container.querySelector('#swAdminWorkQuantity')?.value) || 0;
      const unitPrice = parseFloat(container.querySelector('#swAdminWorkUnitPrice')?.value) || 0;
      const totalPrice = quantity * unitPrice;
      
      const totalPriceInput = container.querySelector('#swAdminWorkTotalPrice');
      if (totalPriceInput) {
        totalPriceInput.value = Math.round(totalPrice);
      }
    }
    
    /**
     * ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
     */
    function swCompressImage(file, maxWidth = 1920, maxHeight = 1920, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ í¬ê¸° ì¡°ì •
            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // JPEGë¡œ ë³€í™˜ (í’ˆì§ˆ ì„¤ì •)
            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedDataUrl);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    /**
     * ê´€ë¦¬ì ì‚¬ì§„ ì„ íƒ ì²˜ë¦¬
     */
    async function swAdminHandlePhotoSelect(event) {
      const files = Array.from(event.target.files);
      for (const file of files) {
        if (file.type.startsWith('image/')) {
          try {
            // ì´ë¯¸ì§€ ì••ì¶•
            const compressedUrl = await swCompressImage(file);
            swSelectedPhotos.push({
              file: file,
              url: compressedUrl
            });
            swAdminRenderPhotoPreviews();
          } catch (error) {
            console.error('[SW] ì´ë¯¸ì§€ ì••ì¶• ì˜¤ë¥˜:', error);
            // ì••ì¶• ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš©
            const reader = new FileReader();
            reader.onload = function(e) {
              swSelectedPhotos.push({
                file: file,
                url: e.target.result
              });
              swAdminRenderPhotoPreviews();
            };
            reader.readAsDataURL(file);
          }
        }
      }
      event.target.value = '';
    }
    
    /**
     * ê´€ë¦¬ì ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
     */
    function swAdminRenderPhotoPreviews() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const previewContainer = container.querySelector('#swAdminPhotoPreviewContainer');
      if (!previewContainer) return;
      
      previewContainer.innerHTML = swSelectedPhotos.map((photo, index) => `
        <div style="position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 2px solid #ffeaa7;">
          <img src="${photo.url}" alt="ë¯¸ë¦¬ë³´ê¸°" style="width: 100%; height: 100%; object-fit: cover;">
          <button onclick="swAdminRemovePhoto(${index})" style="position: absolute; top: 5px; right: 5px; background: rgba(225, 112, 85, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">Ã—</button>
        </div>
      `).join('');
    }
    
    /**
     * ê´€ë¦¬ì ì‚¬ì§„ ì œê±°
     */
    function swAdminRemovePhoto(index) {
      swSelectedPhotos.splice(index, 1);
      swAdminRenderPhotoPreviews();
    }
    
    /**
     * ê´€ë¦¬ì í¼ ì´ˆê¸°í™”
     */
    function swAdminResetWorkForm() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const form = container.querySelector('#swAdminWorkForm');
      if (form) form.reset();
      
      // ì‘ì—… í•­ëª© ì´ˆê¸°í™”
      const entriesContainer = container.querySelector('#swAdminWorkEntriesContainer');
      if (entriesContainer) {
        entriesContainer.innerHTML = '';
      }
      swWorkEntryCounter = 0;
      
      // ì²« ë²ˆì§¸ ì‘ì—… í•­ëª© ìë™ ì¶”ê°€
      swAdminAddWorkEntry();
      
      swSelectedPhotos = [];
      swAdminRenderPhotoPreviews();
      
      const today = new Date().toISOString().split('T')[0];
      const workDate = container.querySelector('#swAdminWorkDate');
      if (workDate) workDate.value = today;
      
      swAdminUpdateAllTotal();
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ë“±ë¡ ì²˜ë¦¬ (ì—¬ëŸ¬ ì‘ì—… í•­ëª©ì„ í•œ ë²ˆì— ì €ì¥)
     */
    async function swAdminHandleWorkSubmit(event) {
      event.preventDefault();
      console.log('[SW] swAdminHandleWorkSubmit í˜¸ì¶œ');
      
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      // í™”ì£¼ì‚¬ ì…ë ¥ê°’ ê²€ì¦ ë° hidden inputì— ì €ì¥
      const companyInput = container.querySelector('#swAdminWorkCompanyInput');
      const companyHidden = container.querySelector('#swAdminWorkCompanySelect');
      if (companyInput && companyHidden) {
        const inputValue = companyInput.value.trim();
        if (!inputValue) {
          alert('í™”ì£¼ì‚¬ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.');
          companyInput.focus();
          return;
        }
        companyHidden.value = inputValue;
      }
      
      // ì‘ì—… ì¼ì í™•ì¸
      const workDate = container.querySelector('#swAdminWorkDate')?.value;
      if (!workDate) {
        alert('ì‘ì—… ì¼ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì‘ì—… í•­ëª© ìˆ˜ì§‘
      const entries = container.querySelectorAll('.sw-work-entry');
      if (entries.length === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‘ì—… í•­ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const workEntries = [];
      let hasError = false;
      
      entries.forEach((entry, index) => {
        const workTypeSelect = entry.querySelector('.sw-work-entry-type');
        const quantityInput = entry.querySelector('.sw-work-entry-quantity');
        const unitPriceInput = entry.querySelector('.sw-work-entry-unit-price');
        
        if (!workTypeSelect || !workTypeSelect.value) {
          alert(`ì‘ì—… í•­ëª© ${index + 1}: ì‘ì—… ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.`);
          hasError = true;
          return;
        }
        
        const quantity = parseFloat(quantityInput?.value) || 0;
        const unitPrice = parseFloat(unitPriceInput?.value) || 0;
        
        if (quantity <= 0) {
          alert(`ì‘ì—… í•­ëª© ${index + 1}: ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ í° ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
          hasError = true;
          return;
        }
        
        if (unitPrice < 0) {
          alert(`ì‘ì—… í•­ëª© ${index + 1}: ë‹¨ê°€ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
          hasError = true;
          return;
        }
        
        workEntries.push({
          work_type_id: parseInt(workTypeSelect.value),
          quantity: quantity,
          unit_price: unitPrice
        });
      });
      
      if (hasError) return;
      
      // ì‚¬ì§„ ì—…ë¡œë“œ
      let photoLinks = '';
      if (swSelectedPhotos.length > 0) {
        try {
          const imageDataList = swSelectedPhotos.map(photo => photo.url);
          const trackingIdentifier = `special_${(companyHidden?.value || companyInput?.value || 'unknown')
            .replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}`;
          
          const uploadResponse = await fetch('/api/uploads/upload-images', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...swGetUserHeaders()
            },
            credentials: 'include',
            body: JSON.stringify({
              images: imageDataList,
              trackingNumber: trackingIdentifier
            })
          });
          
          // 413 ì—ëŸ¬ ì²˜ë¦¬
          if (uploadResponse.status === 413) {
            throw new Error('ì‚¬ì§„ íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ë” ì‘ì€ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          }
          
          let uploadData;
          try {
            uploadData = await uploadResponse.json();
          } catch (e) {
            // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ (413 ì—ëŸ¬ ë“±)
            throw new Error('ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í¬ê¸°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
          }
          
          console.log('[SW] ì‚¬ì§„ ì—…ë¡œë“œ ì‘ë‹µ:', uploadData);
          
          if (!uploadResponse.ok || !uploadData.success) {
            throw new Error(uploadData.message || 'ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          
          if (uploadData.photoLinks) {
            // "ì‚¬ì§„1: url\nì‚¬ì§„2: url" í˜•ì‹ì„ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ URL ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
            const lines = uploadData.photoLinks.split('\n').filter(line => line.trim());
            const urls = lines.map(line => {
              const parts = line.split(':');
              if (parts.length >= 2) {
                return parts.slice(1).join(':').trim();
              }
              return '';
            }).filter(url => url);
            photoLinks = urls.join(',');
          } else if (uploadData.urls) {
            photoLinks = uploadData.urls.join(',');
          }
        } catch (error) {
          console.error('[SW] ì‚¬ì§„ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
          alert('ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          return;
        }
      }
      
      const memo = container.querySelector('#swAdminWorkMemo')?.value || '';
      const companyName = companyHidden?.value || companyInput?.value;
      
      // ì—¬ëŸ¬ ì‘ì—… ë°ì´í„° ì „ì†¡ (ë°°ì¹˜ ë“±ë¡)
      const workData = {
        company_name: companyName,
        work_date: workDate,
        work_entries: workEntries, // ì—¬ëŸ¬ ì‘ì—… í•­ëª© ë°°ì—´
        photo_links: photoLinks,
        memo: memo
      };
      
      console.log('[SW] ì‘ì—… ë“±ë¡ ìš”ì²­ (ë°°ì¹˜):', workData);
      
      fetch('/api/special-works/works/batch', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...swGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify(workData)
      })
        .then(response => response.json())
        .then(data => {
          console.log('[SW] ì‘ì—… ë“±ë¡ ì‘ë‹µ:', data);
          if (data.success) {
            alert(`${workEntries.length}ê°œì˜ ì‘ì—…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            swAdminResetWorkForm();
            swAdminLoadWorks();
            swAdminToggleWorkRegistration(); // í¼ ë‹«ê¸°
          } else {
            alert(data.message || 'ì‘ì—… ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[SW] ì‘ì—… ë“±ë¡ ì˜¤ë¥˜:', error);
          alert('ì‘ì—… ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
    
    /**
     * ê´€ë¦¬ì ì „ë‹¬ ì¡°íšŒ
     */
    function swAdminLoadPreviousMonth() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const monthInput = container.querySelector('#swAdminFilterMonth');
      if (!monthInput) return;
      
      const today = new Date();
      let prevYear = today.getFullYear();
      let prevMonth = today.getMonth(); // 0-11 (í˜„ì¬ ì›” - 1)
      
      if (prevMonth === 0) {
        // 1ì›”ì´ë©´ ì „ë…„ë„ 12ì›”
        prevYear -= 1;
        prevMonth = 12;
      }
      
      const previousMonthStr = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
      monthInput.value = previousMonthStr;
      
      // ì¡°íšŒ ì‹¤í–‰
      swAdminLoadWorks();
    }
    window.swAdminLoadPreviousMonth = swAdminLoadPreviousMonth;
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ëª©ë¡ ë¡œë“œ
     * ê´€ë¦¬ì í•„í„° ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ì¡°íšŒ
     */
    function swAdminLoadWorks() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      // 1. ì›” í•„í„° ê°’ ìˆ˜ì§‘
      const monthValue = container.querySelector('#swAdminFilterMonth')?.value || '';
      const workTypeId = container.querySelector('#swAdminFilterWorkType')?.value || '';
      const companyName = container.querySelector('#swAdminFilterCompany')?.value || '';
      
      // 2. ì›”ì„ ë‚ ì§œ ë²”ìœ„ë¡œ ë³€í™˜
      let startDate = '';
      let endDate = '';
      if (monthValue) {
        const [yearStr, monthStr] = monthValue.split('-');
        const year = parseInt(yearStr, 10);
        const month = parseInt(monthStr, 10);
        const lastDay = new Date(year, month, 0).getDate();
        const paddedMonth = monthStr.padStart(2, '0');
        startDate = `${yearStr}-${paddedMonth}-01`;
        endDate = `${yearStr}-${paddedMonth}-${String(lastDay).padStart(2, '0')}`;
      }
      
      // 3. API URL êµ¬ì„± (ì›”ì´ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë“  ë°ì´í„° ì¡°íšŒ)
      let url = '/api/special-works/works?';
      if (startDate) url += `start_date=${startDate}&`;
      if (endDate) url += `end_date=${endDate}&`;
      if (workTypeId) url += `work_type_id=${workTypeId}&`;
      if (companyName) url += `company_name=${encodeURIComponent(companyName)}&`;
      
      // 4. ë¡œë”© í‘œì‹œ
      const tbody = container.querySelector('#swTableBody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="no-data">ë¡œë”© ì¤‘...</td></tr>';
      
      // 5. API í˜¸ì¶œ
      fetch(url, {
        credentials: 'include',
        headers: swGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            let works = data.data || [];
            // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            works.sort((a, b) => new Date(b.work_date) - new Date(a.work_date));
            // ê´€ë¦¬ì ì „ìš© ë Œë”ë§
            swAdminRenderWorks(works);
            // ê³µí†µ í†µê³„ ì—…ë°ì´íŠ¸
            swUpdateStats(works);
            // í™”ì£¼ì‚¬ë³„ í†µê³„ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ì ì „ìš©)
            swUpdateCompanyStats(works);
          } else {
            if (tbody) tbody.innerHTML = `<tr><td colspan="10" class="no-data">${data.message || 'ì‘ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</td></tr>`;
          }
        })
        .catch(error => {
          console.error('[SW] ê´€ë¦¬ì ì‘ì—… ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
          if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="no-data">ì‘ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        });
    }
    
    /**
     * ê´€ë¦¬ì ëª¨ë“œ ì‘ì—… ëª©ë¡ ë Œë”ë§
     * ê´€ë¦¬ ì»¬ëŸ¼ í¬í•¨
     * ê°™ì€ ë‚ ì§œ/í™”ì£¼ì‚¬/ë©”ëª¨/ì‚¬ì§„ì„ ê°€ì§„ ì‘ì—…ë“¤ì„ í•˜ë‚˜ì˜ í–‰ìœ¼ë¡œ ë¬¶ì–´ì„œ í‘œì‹œ
     */
    function swAdminRenderWorks(works) {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const tbody = container.querySelector('#swTableBody');
      if (!tbody) return;
      
      // ì‘ì—… ì¢…ë¥˜ í•„í„° ì ìš© (nullì´ë©´ ì „ì²´, ì•„ë‹ˆë©´ í•´ë‹¹ ì‘ì—… ì¢…ë¥˜ë§Œ)
      let filteredWorks = works;
      if (swSelectedWorkType !== null && swSelectedWorkType !== undefined) {
        filteredWorks = filteredWorks.filter(work => work.work_type_name === swSelectedWorkType);
      }
      
      // í™”ì£¼ì‚¬ í•„í„° ì ìš© (ê´€ë¦¬ì ëª¨ë“œ)
      if (swSelectedCompany) {
        filteredWorks = filteredWorks.filter(work => work.company_name === swSelectedCompany);
      }
      
      if (filteredWorks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="no-data">ë“±ë¡ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      // ì‘ì—… ê·¸ë£¹í™”: ê°™ì€ ë‚ ì§œ/í™”ì£¼ì‚¬/ë©”ëª¨/ì‚¬ì§„ì„ ê°€ì§„ ì‘ì—…ë“¤ì„ ë¬¶ìŒ
      const workGroups = {};
      filteredWorks.forEach(work => {
        // ê·¸ë£¹ í‚¤ ìƒì„± (ë‚ ì§œ + í™”ì£¼ì‚¬ + ë©”ëª¨ + ì‚¬ì§„)
        const groupKey = `${work.work_date || ''}_${work.company_name || ''}_${work.memo || ''}_${work.photo_links || ''}`;
        
        if (!workGroups[groupKey]) {
          workGroups[groupKey] = {
            work_date: work.work_date,
            company_name: work.company_name,
            memo: work.memo,
            photo_links: work.photo_links,
            works: [],
            totalAllPrice: 0,
            ids: [] // ì‚­ì œë¥¼ ìœ„í•œ ID ëª©ë¡
          };
        }
        
        workGroups[groupKey].works.push(work);
        workGroups[groupKey].totalAllPrice += work.total_price || 0;
        workGroups[groupKey].ids.push(work.id);
      });
      
      // ê·¸ë£¹ì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      const groupedArray = Object.values(workGroups);
      groupedArray.sort((a, b) => new Date(b.work_date) - new Date(a.work_date));
      
      // HTML ìƒì„± (ê´€ë¦¬ ì»¬ëŸ¼ í¬í•¨)
      // ìˆœë²ˆ: ì˜¤ë˜ëœ ì‘ì—…ì´ 1ë²ˆ, ìµœì‹  ì‘ì—…ì´ ë§ˆì§€ë§‰ ë²ˆí˜¸
      const html = groupedArray.map((group, index) => {
        const photos = group.photo_links ? group.photo_links.split(',').map(url => url.trim()).filter(url => url) : [];
        const photoThumbnails = photos.slice(0, 3).map(url => 
          `<img src="${swEscapeHtml(url)}" class="sw-photo-thumbnail" onclick="swViewPhoto('${swEscapeHtml(url)}')" alt="ì‚¬ì§„" style="cursor: pointer; margin-right: 5px;">`
        ).join('');
        const morePhotos = photos.length > 3 ? `<span style="margin-left: 5px; color: #636e72;">+${photos.length - 3}</span>` : '';
        
        // ìˆœë²ˆ ê³„ì‚°: ì˜¤ë˜ëœ ì‘ì—…ì´ 1ë²ˆì´ ë˜ë„ë¡ ì—­ìˆœ
        const rowNumber = groupedArray.length - index;
        const memoText = group.memo || '';
        const memoDisplay = memoText || '(ë©”ëª¨ ì—†ìŒ)';
        
        // ì‘ì—… ì¢…ë¥˜ë“¤ì„ ë¬¶ì–´ì„œ í‘œì‹œ (ì—¬ëŸ¬ ê°œì¸ ê²½ìš°)
        const workTypesHtml = group.works.map(w => 
          `<div style="margin: 2px 0;">${swEscapeHtml(w.work_type_name || '')}</div>`
        ).join('');
        
        // ìˆ˜ëŸ‰ë“¤ì„ ë¬¶ì–´ì„œ í‘œì‹œ
        const quantitiesHtml = group.works.map(w => 
          `<div style="margin: 2px 0;">${w.quantity || 0}</div>`
        ).join('');
        
        // ë‹¨ê°€ë“¤ì„ ë¬¶ì–´ì„œ í‘œì‹œ
        const unitPricesHtml = group.works.map(w => 
          `<div style="margin: 2px 0;">${swFormatNumber(w.unit_price || 0)}ì›</div>`
        ).join('');
        
        // ì²« ë²ˆì§¸ ì‘ì—…ì˜ IDë¥¼ ì‚¬ìš© (ìˆ˜ì •/ì‚­ì œ ì‹œ)
        const firstWorkId = group.works[0]?.id || 0;
        const allWorkIds = group.ids.join(',');
        
        return `
          <tr>
            <td>${rowNumber}</td>
            <td>${swEscapeHtml(group.work_date || '')}</td>
            <td>${swEscapeHtml(group.company_name || '')}</td>
            <td style="text-align: left; padding-left: 12px;">${workTypesHtml}</td>
            <td>${quantitiesHtml}</td>
            <td style="text-align: left; padding-left: 12px;">${unitPricesHtml}</td>
            <td style="font-weight: 600; color: #ff6b35;">${swFormatNumber(Math.round(group.totalAllPrice))}ì›</td>
            <td>${photoThumbnails || '<span style="color: #999;">ì‚¬ì§„ ì—†ìŒ</span>'}${morePhotos}</td>
            <td class="sw-memo-cell">
              <span>${swEscapeHtml(memoDisplay)}</span>
              ${memoText ? `<div class="sw-memo-tooltip">${swEscapeHtml(memoText)}</div>` : ''}
            </td>
            <td class="sw-admin-only">
              <div>
                <button class="sw-btn-action sw-btn-edit" onclick="swAdminEditWorkGroup('${allWorkIds}')" title="ê·¸ë£¹ ìˆ˜ì •">ìˆ˜ì •</button>
                <button class="sw-btn-action sw-btn-delete" onclick="swAdminDeleteWorkGroup('${allWorkIds}')" title="ê·¸ë£¹ ì‚­ì œ">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = html;
      
      // ê°€ì‹œì„± ì œì–´ (ê´€ë¦¬ ì»¬ëŸ¼ í‘œì‹œ)
      swApplyVisibility();
    }
    
    /**
     * ì‘ì—… ê·¸ë£¹ ìˆ˜ì • (ëª¨ë“  ì‘ì—… í•­ëª©ì„ ìˆ˜ì • ëª¨ë‹¬ì— í‘œì‹œ)
     */
    function swAdminEditWorkGroup(workIdsStr) {
      const workIds = workIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => id);
      if (workIds.length > 0) {
        // ëª¨ë“  ì‘ì—… IDë¥¼ ì§ì ‘ ì „ë‹¬í•˜ì—¬ ëª¨ë“  ì‘ì—… í•­ëª©ì„ ëª¨ë‹¬ì— í‘œì‹œ
        swAdminEditWorkGroupData(workIds);
      }
    }
    
    /**
     * ì‘ì—… ê·¸ë£¹ ì‚­ì œ (ëª¨ë“  ì‘ì—… ì‚­ì œ)
     */
    function swAdminDeleteWorkGroup(workIdsStr) {
      if (!confirm('ì´ ì‘ì—… ê·¸ë£¹ì˜ ëª¨ë“  ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      const workIds = workIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => id);
      if (workIds.length === 0) return;
      
      // ëª¨ë“  ì‘ì—… ì‚­ì œ (ìˆœì°¨ì ìœ¼ë¡œ)
      Promise.all(workIds.map(workId => 
        fetch(`/api/special-works/works/${workId}`, {
          method: 'DELETE',
          credentials: 'include',
          headers: swGetUserHeaders()
        }).then(response => response.json())
      )).then(results => {
        const successCount = results.filter(r => r.success).length;
        if (successCount === workIds.length) {
          alert(`${successCount}ê°œì˜ ì‘ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          swAdminLoadWorks();
        } else {
          alert(`ì¼ë¶€ ì‘ì—… ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„±ê³µ: ${successCount}/${workIds.length})`);
          swAdminLoadWorks();
        }
      }).catch(error => {
        console.error('[SW] ì‘ì—… ê·¸ë£¹ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì‘ì—… ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }
    
    /**
     * ê³µí†µ ì‘ì—… ì¢…ë¥˜ë³„ í†µê³„ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ì/í™”ì£¼ì‚¬ ëª¨ë‘ ì‚¬ìš©)
     */
    function swUpdateStats(works) {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const statsContainer = container.querySelector('#swCommonStatsContainer');
      if (!statsContainer) return;
      
      // ì‘ì—… ì¢…ë¥˜ë³„ ê·¸ë£¹í™”
      const stats = {};
      works.forEach(work => {
        const typeName = work.work_type_name || 'ê¸°íƒ€';
        if (!stats[typeName]) {
          stats[typeName] = { count: 0, total: 0 };
        }
        stats[typeName].count++;
        stats[typeName].total += work.total_price || 0;
      });
      
      if (Object.keys(stats).length === 0) {
        statsContainer.innerHTML = '';
        return;
      }
      
      // ì „ì²´ í†µê³„ ê³„ì‚°
      let totalCount = 0;
      let totalAmount = 0;
      Object.values(stats).forEach(data => {
        totalCount += data.count;
        totalAmount += data.total;
      });
      
      // HTML ìƒì„± (ë°˜í’ˆë‚´ì—­ ìŠ¤íƒ€ì¼ì²˜ëŸ¼ í° ë„¤ëª¨ ë°•ìŠ¤)
      // ì „ì²´ í†µê³„ ë°•ìŠ¤ë¥¼ ë§¨ ì•ì— ì¶”ê°€
      const allSelected = swSelectedWorkType === null;
      let html = `
        <div class="sw-stat-box ${allSelected ? 'selected' : ''}" onclick="swFilterByWorkType(null)">
          <div class="sw-stat-box-name">ì „ì²´</div>
          <div class="sw-stat-box-count">${totalCount}ê±´</div>
          <div class="sw-stat-box-total">í•©ê³„: ${swFormatNumber(totalAmount)}ì›</div>
        </div>
      `;
      
      // ì‘ì—… ì¢…ë¥˜ë³„ í†µê³„ ë°•ìŠ¤ ì¶”ê°€
      html += Object.entries(stats).map(([typeName, data]) => {
        const isSelected = swSelectedWorkType === typeName;
        return `
          <div class="sw-stat-box ${isSelected ? 'selected' : ''}" onclick="swFilterByWorkType('${swEscapeHtml(typeName)}')">
            <div class="sw-stat-box-name">${swEscapeHtml(typeName)}</div>
            <div class="sw-stat-box-count">${data.count}ê±´</div>
            <div class="sw-stat-box-total">í•©ê³„: ${swFormatNumber(data.total)}ì›</div>
          </div>
        `;
      }).join('');
      
      statsContainer.innerHTML = html;
      statsContainer.style.display = 'flex';
    }
    
    /**
     * í™”ì£¼ì‚¬ë³„ í†µê³„ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ì ì „ìš©)
     */
    function swUpdateCompanyStats(works) {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      // ê´€ë¦¬ì ëª¨ë“œê°€ ì•„ë‹ˆë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
      const roleNormalized = (swCurrentRole || '').toString().trim();
      const isAdmin = (roleNormalized === 'ê´€ë¦¬ì');
      if (!isAdmin) return;
      
      const statsContainer = container.querySelector('#swAdminCompanyStatsContainer');
      if (!statsContainer) return;
      
      // í™”ì£¼ì‚¬ë³„ ê·¸ë£¹í™”
      const stats = {};
      works.forEach(work => {
        const companyName = work.company_name || 'ê¸°íƒ€';
        if (!stats[companyName]) {
          stats[companyName] = { count: 0, total: 0 };
        }
        stats[companyName].count++;
        stats[companyName].total += work.total_price || 0;
      });
      
      if (Object.keys(stats).length === 0) {
        statsContainer.innerHTML = '';
        return;
      }
      
      // HTML ìƒì„± (ì‘ì—… ì¢…ë¥˜ í†µê³„ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
      const html = Object.entries(stats).map(([companyName, data]) => {
        const isSelected = swSelectedCompany === companyName;
        return `
          <div class="sw-stat-box ${isSelected ? 'selected' : ''}" onclick="swFilterByCompany('${swEscapeHtml(companyName)}')">
            <div class="sw-stat-box-name">${swEscapeHtml(companyName)}</div>
            <div class="sw-stat-box-count">${data.count}ê±´</div>
            <div class="sw-stat-box-total">í•©ê³„: ${swFormatNumber(data.total)}ì›</div>
          </div>
        `;
      }).join('');
      
      statsContainer.innerHTML = html;
      statsContainer.style.display = 'flex';
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
     */
    /**
     * ì‘ì—… ê·¸ë£¹ ìˆ˜ì • (ëª¨ë“  ì‘ì—… í•­ëª©ì„ ë¡œë“œ)
     */
    async function swAdminEditWorkGroupData(workIds) {
      if (!workIds || workIds.length === 0) return;
      
      try {
        // ì²« ë²ˆì§¸ ì‘ì—…ìœ¼ë¡œ ê¸°ë³¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const firstResponse = await fetch(`/api/special-works/works/${workIds[0]}`, {
          credentials: 'include',
          headers: swGetUserHeaders()
        });
        const firstData = await firstResponse.json();
        
        if (!firstData.success || !firstData.data) {
          alert('ì‘ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        const firstWork = firstData.data;
        
        // ì‘ì—… ì¢…ë¥˜ ëª©ë¡ ë¡œë“œ
        if (swWorkTypes.length === 0) {
          await swCommonLoadWorkTypes();
        }
        
        // ëª¨ë‹¬ì— ê¸°ë³¸ ë°ì´í„° ì±„ìš°ê¸°
        document.getElementById('swEditWorkId').value = workIds.join(',');
        document.getElementById('swEditWorkCompanyInput').value = firstWork.company_name || '';
        document.getElementById('swEditWorkCompanySelect').value = firstWork.company_name || '';
        document.getElementById('swEditWorkDate').value = firstWork.work_date || '';
        document.getElementById('swEditWorkMemo').value = firstWork.memo || '';
        
        // ëª¨ë“  ì‘ì—… í•­ëª© ë¡œë“œ
        const allWorks = [];
        for (const workId of workIds) {
          try {
            const response = await fetch(`/api/special-works/works/${workId}`, {
              credentials: 'include',
              headers: swGetUserHeaders()
            });
            const data = await response.json();
            if (data.success && data.data) {
              allWorks.push(data.data);
            }
          } catch (error) {
            console.error(`[SW] ì‘ì—… ${workId} ë¡œë“œ ì˜¤ë¥˜:`, error);
          }
        }
        
        // ì‘ì—… í•­ëª© ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        const entriesContainer = document.getElementById('swEditWorkEntriesContainer');
        if (entriesContainer) {
          entriesContainer.innerHTML = '';
        }
        swEditWorkEntryCounter = 0;
        
        // ê° ì‘ì—…ì„ í•­ëª©ìœ¼ë¡œ ì¶”ê°€
        for (const work of allWorks) {
          swAdminAddEditWorkEntry(work);
        }
        
        // ì‘ì—… í•­ëª©ì´ ì—†ìœ¼ë©´ í•˜ë‚˜ ì¶”ê°€
        if (allWorks.length === 0) {
          swAdminAddEditWorkEntry();
        }
        
        // ì „ì²´ ì´ì•¡ ì—…ë°ì´íŠ¸
        swAdminUpdateEditAllTotal();
        
        // ê¸°ì¡´ ì‚¬ì§„ ë¡œë“œ (ì²« ë²ˆì§¸ ì‘ì—…ì˜ ì‚¬ì§„ ì‚¬ìš©)
        swEditExistingPhotos = firstWork.photo_links ? firstWork.photo_links.split(',').map(url => url.trim()).filter(url => url) : [];
        swEditSelectedPhotos = [];
        swAdminRenderEditPhotoPreviews();
        
        // ëª¨ë‹¬ ì—´ê¸°
        document.getElementById('swEditWorkModal').style.display = 'block';
        
        // í™”ì£¼ì‚¬ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        swAdminInitEditCompanyDropdown();
      } catch (error) {
        console.error('[SW] ì‘ì—… ê·¸ë£¹ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ì‘ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    /**
     * ë ˆê±°ì‹œ í•¨ìˆ˜ í˜¸í™˜ì„± ìœ ì§€
     */
    async function swAdminEditWork(workId) {
      swAdminEditWorkGroupData([workId]);
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
     */
    function swAdminCloseEditModal() {
      document.getElementById('swEditWorkModal').style.display = 'none';
      document.getElementById('swEditWorkForm').reset();
      
      // ì‘ì—… í•­ëª© ì´ˆê¸°í™”
      const entriesContainer = document.getElementById('swEditWorkEntriesContainer');
      if (entriesContainer) {
        entriesContainer.innerHTML = '';
      }
      swEditWorkEntryCounter = 0;
      
      swEditSelectedPhotos = [];
      swEditExistingPhotos = [];
      swAdminRenderEditPhotoPreviews();
    }
    
    /**
     * ê´€ë¦¬ì ìˆ˜ì • í¼ ë‹¨ê°€ ì—…ë°ì´íŠ¸
     */
    function swAdminUpdateEditUnitPrice() {
      const select = document.getElementById('swEditWorkTypeSelect');
      if (!select) return;
      
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption && selectedOption.value) {
        const price = selectedOption.getAttribute('data-price') || '0';
        const unitPriceInput = document.getElementById('swEditWorkUnitPrice');
        if (unitPriceInput) {
          unitPriceInput.value = price;
          swAdminCalculateEditTotalPrice();
        }
      }
    }
    
    /**
     * ê´€ë¦¬ì ìˆ˜ì • í¼ ì´ì•¡ ê³„ì‚°
     */
    function swAdminCalculateEditTotalPrice() {
      const quantity = parseFloat(document.getElementById('swEditWorkQuantity')?.value) || 0;
      const unitPrice = parseFloat(document.getElementById('swEditWorkUnitPrice')?.value) || 0;
      const totalPrice = quantity * unitPrice;
      
      const totalPriceInput = document.getElementById('swEditWorkTotalPrice');
      if (totalPriceInput) {
        totalPriceInput.value = Math.round(totalPrice);
      }
    }
    
    /**
     * ê´€ë¦¬ì ìˆ˜ì • í¼ ì‚¬ì§„ ì„ íƒ ì²˜ë¦¬
     */
    async function swAdminHandleEditPhotoSelect(event) {
      const files = Array.from(event.target.files);
      for (const file of files) {
        if (file.type.startsWith('image/')) {
          try {
            // ì´ë¯¸ì§€ ì••ì¶•
            const compressedUrl = await swCompressImage(file);
            swEditSelectedPhotos.push({
              file: file,
              url: compressedUrl
            });
            swAdminRenderEditPhotoPreviews();
          } catch (error) {
            console.error('[SW] ì´ë¯¸ì§€ ì••ì¶• ì˜¤ë¥˜:', error);
            // ì••ì¶• ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš©
            const reader = new FileReader();
            reader.onload = function(e) {
              swEditSelectedPhotos.push({
                file: file,
                url: e.target.result
              });
              swAdminRenderEditPhotoPreviews();
            };
            reader.readAsDataURL(file);
          }
        }
      }
      event.target.value = '';
    }
    
    /**
     * ê´€ë¦¬ì ìˆ˜ì • í¼ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
     */
    function swAdminRenderEditPhotoPreviews() {
      const previewContainer = document.getElementById('swEditPhotoPreviewContainer');
      if (!previewContainer) return;
      
      // ê¸°ì¡´ ì‚¬ì§„ + ìƒˆë¡œ ì„ íƒí•œ ì‚¬ì§„
      const allPhotos = [
        ...swEditExistingPhotos.map(url => ({ url: url, isExisting: true })),
        ...swEditSelectedPhotos.map(photo => ({ url: photo.url, isExisting: false, file: photo.file }))
      ];
      
      previewContainer.innerHTML = allPhotos.map((photo, index) => {
        const isExisting = photo.isExisting;
        return `
          <div style="position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 2px solid #ffeaa7;">
            <img src="${swEscapeHtml(photo.url)}" alt="ë¯¸ë¦¬ë³´ê¸°" style="width: 100%; height: 100%; object-fit: cover;">
            <button onclick="swAdminRemoveEditPhoto(${index}, ${isExisting})" style="position: absolute; top: 5px; right: 5px; background: rgba(225, 112, 85, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">Ã—</button>
            ${isExisting ? '<span style="position: absolute; bottom: 5px; left: 5px; background: rgba(116, 185, 255, 0.9); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ê¸°ì¡´</span>' : ''}
          </div>
        `;
      }).join('');
    }
    
    /**
     * ê´€ë¦¬ì ìˆ˜ì • í¼ ì‚¬ì§„ ì œê±°
     */
    function swAdminRemoveEditPhoto(index, isExisting) {
      if (isExisting) {
        // ê¸°ì¡´ ì‚¬ì§„ ì œê±°
        swEditExistingPhotos.splice(index, 1);
      } else {
        // ìƒˆë¡œ ì„ íƒí•œ ì‚¬ì§„ ì œê±°
        const newIndex = index - swEditExistingPhotos.length;
        swEditSelectedPhotos.splice(newIndex, 1);
      }
      swAdminRenderEditPhotoPreviews();
    }
    
    /**
     * ê´€ë¦¬ì ìˆ˜ì • í¼ í™”ì£¼ì‚¬ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
     */
    function swAdminInitEditCompanyDropdown() {
      fetch('/api/auth/companies', {
        credentials: 'include'
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const companies = data.companies || [];
            const input = document.getElementById('swEditWorkCompanyInput');
            const hidden = document.getElementById('swEditWorkCompanySelect');
            const dropdown = document.getElementById('swEditWorkCompanyDropdown');
            
            if (input && hidden && dropdown) {
              function updateDropdown(filterText = '') {
                const filtered = companies.filter(company => 
                  company.company_name.toLowerCase().includes(filterText.toLowerCase())
                );
                
                if (filtered.length === 0) {
                  dropdown.innerHTML = '<div class="sw-dropdown-item" style="color: #999; cursor: default;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                  dropdown.innerHTML = filtered.map(company => 
                    `<div class="sw-dropdown-item" data-value="${swEscapeHtml(company.company_name)}">${swEscapeHtml(company.company_name)}</div>`
                  ).join('');
                }
              }
              
              updateDropdown();
              
              let isDropdownOpen = false;
              let dropdownTimeout = null;
              
              const openDropdown = () => {
                if (dropdownTimeout) {
                  clearTimeout(dropdownTimeout);
                  dropdownTimeout = null;
                }
                updateDropdown(input.value);
                dropdown.classList.add('show');
                isDropdownOpen = true;
              };
              
              const closeDropdown = () => {
                if (dropdownTimeout) {
                  clearTimeout(dropdownTimeout);
                  dropdownTimeout = null;
                }
                dropdown.classList.remove('show');
                isDropdownOpen = false;
              };
              
              input.addEventListener('input', (e) => {
                const value = e.target.value;
                hidden.value = value;
                updateDropdown(value);
                if (!isDropdownOpen) {
                  openDropdown();
                }
              });
              
              input.addEventListener('focus', (e) => {
                e.stopPropagation();
                if (dropdownTimeout) {
                  clearTimeout(dropdownTimeout);
                }
                dropdownTimeout = setTimeout(() => {
                  openDropdown();
                }, 100);
              });
              
              input.addEventListener('click', (e) => {
                e.stopPropagation();
                if (dropdownTimeout) {
                  clearTimeout(dropdownTimeout);
                }
                dropdownTimeout = setTimeout(() => {
                  openDropdown();
                }, 100);
              });
              
              dropdown.addEventListener('click', (e) => {
                e.stopPropagation();
                const item = e.target.closest('.sw-dropdown-item');
                if (item && item.dataset.value) {
                  input.value = item.dataset.value;
                  hidden.value = item.dataset.value;
                  closeDropdown();
                }
              });
              
              const handleDocumentClick = (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                  setTimeout(() => {
                    if (!input.contains(document.activeElement)) {
                      closeDropdown();
                    }
                  }, 150);
                }
              };
              
              document.addEventListener('mousedown', handleDocumentClick);
            }
          }
        })
        .catch(error => {
          console.error('[SW] í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        });
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ìˆ˜ì • ì²˜ë¦¬ (ë°°ì¹˜ ì—…ë°ì´íŠ¸)
     */
    async function swAdminHandleEditWorkSubmit(event) {
      event.preventDefault();
      console.log('[SW] swAdminHandleEditWorkSubmit í˜¸ì¶œ');
      
      const workIdsStr = document.getElementById('swEditWorkId').value;
      if (!workIdsStr) {
        alert('ì‘ì—… IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const workIds = workIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => id);
      if (workIds.length === 0) {
        alert('ì‘ì—… IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // í™”ì£¼ì‚¬ ì…ë ¥ê°’ ê²€ì¦
      const companyInput = document.getElementById('swEditWorkCompanyInput');
      const companyHidden = document.getElementById('swEditWorkCompanySelect');
      if (companyInput && companyHidden) {
        const inputValue = companyInput.value.trim();
        if (!inputValue) {
          alert('í™”ì£¼ì‚¬ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.');
          companyInput.focus();
          return;
        }
        companyHidden.value = inputValue;
      }
      
      // ì‘ì—… ì¼ì í™•ì¸
      const workDate = document.getElementById('swEditWorkDate')?.value;
      if (!workDate) {
        alert('ì‘ì—… ì¼ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì‘ì—… í•­ëª© ìˆ˜ì§‘
      const entriesContainer = document.getElementById('swEditWorkEntriesContainer');
      const entries = entriesContainer ? entriesContainer.querySelectorAll('.sw-work-entry') : [];
      if (entries.length === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‘ì—… í•­ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const workEntries = [];
      let hasError = false;
      
      entries.forEach((entry, index) => {
        const workTypeSelect = entry.querySelector('.sw-work-entry-type');
        const quantityInput = entry.querySelector('.sw-work-entry-quantity');
        const unitPriceInput = entry.querySelector('.sw-work-entry-unit-price');
        
        if (!workTypeSelect || !workTypeSelect.value) {
          alert(`ì‘ì—… í•­ëª© ${index + 1}: ì‘ì—… ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.`);
          hasError = true;
          return;
        }
        
        const quantity = parseFloat(quantityInput?.value) || 0;
        const unitPrice = parseFloat(unitPriceInput?.value) || 0;
        
        if (quantity <= 0) {
          alert(`ì‘ì—… í•­ëª© ${index + 1}: ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ í° ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
          hasError = true;
          return;
        }
        
        if (unitPrice < 0) {
          alert(`ì‘ì—… í•­ëª© ${index + 1}: ë‹¨ê°€ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
          hasError = true;
          return;
        }
        
        workEntries.push({
          work_type_id: parseInt(workTypeSelect.value),
          quantity: quantity,
          unit_price: unitPrice
        });
      });
      
      if (hasError) return;
      
      // ìƒˆë¡œ ì¶”ê°€í•œ ì‚¬ì§„ ì—…ë¡œë“œ
      let newPhotoLinks = '';
      if (swEditSelectedPhotos.length > 0) {
        try {
          const imageDataList = swEditSelectedPhotos.map(photo => photo.url);
          const trackingIdentifier = `special_${(companyHidden?.value || companyInput?.value || 'unknown')
            .replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}`;
          
          const uploadResponse = await fetch('/api/uploads/upload-images', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...swGetUserHeaders()
            },
            credentials: 'include',
            body: JSON.stringify({
              images: imageDataList,
              trackingNumber: trackingIdentifier
            })
          });
          
          // 413 ì—ëŸ¬ ì²˜ë¦¬
          if (uploadResponse.status === 413) {
            throw new Error('ì‚¬ì§„ íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ë” ì‘ì€ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          }
          
          let uploadData;
          try {
            uploadData = await uploadResponse.json();
          } catch (e) {
            // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ (413 ì—ëŸ¬ ë“±)
            throw new Error('ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í¬ê¸°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
          }
          
          console.log('[SW] ì‚¬ì§„ ì—…ë¡œë“œ ì‘ë‹µ:', uploadData);
          
          if (!uploadResponse.ok || !uploadData.success) {
            throw new Error(uploadData.message || 'ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          
          if (uploadData.photoLinks) {
            const lines = uploadData.photoLinks.split('\n').filter(line => line.trim());
            const urls = lines.map(line => {
              const parts = line.split(':');
              if (parts.length >= 2) {
                return parts.slice(1).join(':').trim();
              }
              return '';
            }).filter(url => url);
            newPhotoLinks = urls.join(',');
          } else if (uploadData.urls) {
            newPhotoLinks = uploadData.urls.join(',');
          }
        } catch (error) {
          console.error('[SW] ì‚¬ì§„ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
          alert('ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          return;
        }
      }
      
      // ê¸°ì¡´ ì‚¬ì§„ + ìƒˆ ì‚¬ì§„ í•©ì¹˜ê¸°
      let allPhotoLinks = [...swEditExistingPhotos];
      if (newPhotoLinks) {
        allPhotoLinks = allPhotoLinks.concat(newPhotoLinks.split(',').map(url => url.trim()).filter(url => url));
      }
      const finalPhotoLinks = allPhotoLinks.join(',');
      
      const memo = document.getElementById('swEditWorkMemo')?.value || '';
      const companyName = companyHidden?.value || companyInput?.value;
      
      // ê¸°ì¡´ ì‘ì—…ë“¤ ì‚­ì œ
      try {
        for (const workId of workIds) {
          await fetch(`/api/special-works/works/${workId}`, {
            method: 'DELETE',
            credentials: 'include',
            headers: swGetUserHeaders()
          });
        }
      } catch (error) {
        console.error('[SW] ê¸°ì¡´ ì‘ì—… ì‚­ì œ ì˜¤ë¥˜:', error);
        // ì‚­ì œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ìƒˆ ì‘ì—…ì€ ë“±ë¡ë¨)
      }
      
      // ìƒˆë¡œìš´ ì‘ì—…ë“¤ì„ ë°°ì¹˜ë¡œ ë“±ë¡
      const batchData = {
        company_name: companyName,
        work_date: workDate,
        work_entries: workEntries,
        photo_links: finalPhotoLinks,
        memo: memo
      };
      
      console.log('[SW] ì‘ì—… ë°°ì¹˜ ìˆ˜ì • ìš”ì²­:', batchData);
      
      try {
        const response = await fetch('/api/special-works/works/batch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...swGetUserHeaders()
          },
          credentials: 'include',
          body: JSON.stringify(batchData)
        });
        
        const data = await response.json();
        console.log('[SW] ì‘ì—… ë°°ì¹˜ ìˆ˜ì • ì‘ë‹µ:', data);
        
        if (data.success) {
          alert('ì‘ì—…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          swAdminCloseEditModal();
          swAdminLoadWorks();
        } else {
          alert(data.message || 'ì‘ì—… ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('[SW] ì‘ì—… ìˆ˜ì • ì˜¤ë¥˜:', error);
        alert('ì‘ì—… ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ì‚­ì œ
     */
    function swAdminDeleteWork(workId) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      fetch(`/api/special-works/works/${workId}`, {
        method: 'DELETE',
        credentials: 'include',
        headers: swGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì‘ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            swAdminLoadWorks();
          } else {
            alert(data.message || 'ì‘ì—… ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[SW] ì‘ì—… ì‚­ì œ ì˜¤ë¥˜:', error);
          alert('ì‘ì—… ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ì¢…ë¥˜ ì¶”ê°€ ëª¨ë‹¬
     */
    function swAdminShowAddWorkTypeModal() {
      const name = prompt('ì‘ì—… ì¢…ë¥˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (!name || !name.trim()) return;
      
      const priceStr = prompt('ê¸°ë³¸ ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì›):', '0');
      if (priceStr === null) return;
      const price = parseFloat(priceStr) || 0;
      
      fetch('/api/special-works/types', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...swGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify({
          name: name.trim(),
          default_unit_price: price,
          display_order: 0
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì‘ì—… ì¢…ë¥˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            swCommonLoadWorkTypes();
          } else {
            alert(data.message || 'ì‘ì—… ì¢…ë¥˜ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[SW] ì‘ì—… ì¢…ë¥˜ ì¶”ê°€ ì˜¤ë¥˜:', error);
          alert('ì‘ì—… ì¢…ë¥˜ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
    
    /**
     * ì‘ì—… ë“±ë¡ í¼ì—ì„œ ì‘ì—… ì¢…ë¥˜ ì¶”ê°€ (í¼ ë‚´ë¶€ì—ì„œ í˜¸ì¶œ)
     * ì¶”ê°€ í›„ ìë™ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ì— ì„ íƒë¨
     */
    function swAdminShowAddWorkTypeModalFromForm() {
      const name = prompt('ì‘ì—… ì¢…ë¥˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (!name || !name.trim()) return;
      
      const priceStr = prompt('ê¸°ë³¸ ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì›):', '0');
      if (priceStr === null) return;
      const price = parseFloat(priceStr) || 0;
      
      fetch('/api/special-works/types', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...swGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify({
          name: name.trim(),
          default_unit_price: price,
          display_order: 0
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì‘ì—… ì¢…ë¥˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            // ì‘ì—… ì¢…ë¥˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            swCommonLoadWorkTypes().then(() => {
              // ìƒˆë¡œ ì¶”ê°€ëœ ì‘ì—… ì¢…ë¥˜ë¥¼ ëª¨ë“  ì‘ì—… í•­ëª©ì˜ ë“œë¡­ë‹¤ìš´ì— ì—…ë°ì´íŠ¸
              const container = document.getElementById('swContainer');
              if (!container) return;
              
              // ëª¨ë“  ì‘ì—… í•­ëª©ì˜ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
              const workEntries = container.querySelectorAll('.sw-work-entry');
              workEntries.forEach(entry => {
                const workTypeSelect = entry.querySelector('.sw-work-entry-type');
                if (workTypeSelect) {
                  // ê¸°ì¡´ ì„ íƒê°’ ì €ì¥
                  const currentValue = workTypeSelect.value;
                  
                  // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì¬ìƒì„±
                  const workTypeOptions = swWorkTypes.map(type => 
                    `<option value="${type.id}" data-price="${type.default_unit_price}">${swEscapeHtml(type.name)}</option>`
                  ).join('');
                  workTypeSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + workTypeOptions;
                  
                  // ìƒˆë¡œ ì¶”ê°€ëœ ì‘ì—… ì¢…ë¥˜ ì„ íƒ
                  const newOption = Array.from(workTypeSelect.options).find(opt => opt.textContent.trim() === name.trim());
                  if (newOption) {
                    workTypeSelect.value = newOption.value;
                    const entryId = entry.id;
                    swAdminUpdateEntryPrice(entryId);
                  } else if (currentValue) {
                    // ê¸°ì¡´ ì„ íƒê°’ ë³µì›
                    workTypeSelect.value = currentValue;
                  }
                }
              });
              
              // ìˆ˜ì • ëª¨ë‹¬ì˜ ë“œë¡­ë‹¤ìš´ë„ í™•ì¸
              const editWorkTypeSelect = document.getElementById('swEditWorkTypeSelect');
              if (editWorkTypeSelect) {
                // ìˆ˜ì • ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                const editModal = document.getElementById('swEditWorkModal');
                if (editModal && editModal.style.display !== 'none') {
                  // ê¸°ì¡´ ì„ íƒê°’ ì €ì¥
                  const currentEditValue = editWorkTypeSelect.value;
                  
                  // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì¬ìƒì„±
                  const workTypeOptions = swWorkTypes.map(type => 
                    `<option value="${type.id}" data-price="${type.default_unit_price}">${swEscapeHtml(type.name)}</option>`
                  ).join('');
                  editWorkTypeSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + workTypeOptions;
                  
                  // ìƒˆë¡œ ì¶”ê°€ëœ ì‘ì—… ì¢…ë¥˜ ì„ íƒ
                  const newEditOption = Array.from(editWorkTypeSelect.options).find(opt => opt.textContent.trim() === name.trim());
                  if (newEditOption) {
                    editWorkTypeSelect.value = newEditOption.value;
                    swAdminUpdateEditUnitPrice();
                  } else if (currentEditValue) {
                    // ê¸°ì¡´ ì„ íƒê°’ ë³µì›
                    editWorkTypeSelect.value = currentEditValue;
                    swAdminUpdateEditUnitPrice();
                  }
                }
              }
            });
          } else {
            alert(data.message || 'ì‘ì—… ì¢…ë¥˜ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[SW] ì‘ì—… ì¢…ë¥˜ ì¶”ê°€ ì˜¤ë¥˜:', error);
          alert('ì‘ì—… ì¢…ë¥˜ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ì¢…ë¥˜ ìˆ˜ì •
     */
    function swAdminEditWorkType(workTypeId) {
      const workType = swWorkTypes.find(t => t.id === workTypeId);
      if (!workType) return;
      
      const name = prompt('ì‘ì—… ì¢…ë¥˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', workType.name);
      if (name === null) return;
      
      const priceStr = prompt('ê¸°ë³¸ ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì›):', workType.default_unit_price || '0');
      if (priceStr === null) return;
      const price = parseFloat(priceStr) || 0;
      
      fetch(`/api/special-works/types/${workTypeId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          ...swGetUserHeaders()
        },
        credentials: 'include',
        body: JSON.stringify({
          name: name.trim(),
          default_unit_price: price
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì‘ì—… ì¢…ë¥˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            swCommonLoadWorkTypes();
          } else {
            alert(data.message || 'ì‘ì—… ì¢…ë¥˜ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[SW] ì‘ì—… ì¢…ë¥˜ ìˆ˜ì • ì˜¤ë¥˜:', error);
          alert('ì‘ì—… ì¢…ë¥˜ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
    
    /**
     * ê´€ë¦¬ì ì‘ì—… ì¢…ë¥˜ ì‚­ì œ
     */
    function swAdminDeleteWorkType(workTypeId) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‚¬ìš© ì¤‘ì¸ ì‘ì—…ì´ ìˆìœ¼ë©´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
      
      fetch(`/api/special-works/types/${workTypeId}`, {
        method: 'DELETE',
        credentials: 'include',
        headers: swGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì‘ì—… ì¢…ë¥˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            swCommonLoadWorkTypes();
          } else {
            alert(data.message || 'ì‘ì—… ì¢…ë¥˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('[SW] ì‘ì—… ì¢…ë¥˜ ì‚­ì œ ì˜¤ë¥˜:', error);
          alert('ì‘ì—… ì¢…ë¥˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
    
    // ========== í™”ì£¼ì‚¬ í•¨ìˆ˜ ==========
    
    /**
     * í™”ì£¼ì‚¬ ëª¨ë“œ ì´ˆê¸°í™” í•¨ìˆ˜
     * í™”ì£¼ì‚¬ ì „ìš© ê¸°ëŠ¥ë§Œ ì´ˆê¸°í™”
     */
    function swConsignorInit() {
      console.log('[SW] swConsignorInit ì‹œì‘');
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      // 1. ì›” í•„í„° ì´ˆê¸°í™” (ì˜¤ëŠ˜ ì›”)
      const today = new Date().toISOString().split('T')[0];
      const monthInput = container.querySelector('#swConsignorFilterMonth');
      if (monthInput) monthInput.value = today.slice(0, 7); // YYYY-MM
      
      // 2. ì‘ì—… ì¢…ë¥˜ ëª©ë¡ ë¡œë“œ
      swCommonLoadWorkTypes();
      
      // 3. ì‘ì—… ëª©ë¡ ë¡œë“œ
      swConsignorLoadWorks();
    }
    
    /**
     * í™”ì£¼ì‚¬ ëª¨ë“œ ì‘ì—… ëª©ë¡ ë¡œë“œ
     * í™”ì£¼ì‚¬ í•„í„° ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ì¡°íšŒ
     */
    /**
     * í™”ì£¼ì‚¬ ì „ë‹¬ ì¡°íšŒ
     */
    function swConsignorLoadPreviousMonth() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const monthInput = container.querySelector('#swConsignorFilterMonth');
      if (!monthInput) return;
      
      const today = new Date();
      let prevYear = today.getFullYear();
      let prevMonth = today.getMonth(); // 0-11 (í˜„ì¬ ì›” - 1)
      
      if (prevMonth === 0) {
        // 1ì›”ì´ë©´ ì „ë…„ë„ 12ì›”
        prevYear -= 1;
        prevMonth = 12;
      }
      
      const previousMonthStr = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
      monthInput.value = previousMonthStr;
      
      // ì¡°íšŒ ì‹¤í–‰
      swConsignorLoadWorks();
    }
    window.swConsignorLoadPreviousMonth = swConsignorLoadPreviousMonth;
    
    function swConsignorLoadWorks() {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      // 1. ì›” í•„í„° ê°’ ìˆ˜ì§‘
      const monthValue = container.querySelector('#swConsignorFilterMonth')?.value || '';
      
      // 2. ì›”ì„ ë‚ ì§œ ë²”ìœ„ë¡œ ë³€í™˜
      let startDate = '';
      let endDate = '';
      if (monthValue) {
        const [yearStr, monthStr] = monthValue.split('-');
        const year = parseInt(yearStr, 10);
        const month = parseInt(monthStr, 10);
        const lastDay = new Date(year, month, 0).getDate();
        const paddedMonth = monthStr.padStart(2, '0');
        startDate = `${yearStr}-${paddedMonth}-01`;
        endDate = `${yearStr}-${paddedMonth}-${String(lastDay).padStart(2, '0')}`;
      }
      
      // 3. í™”ì£¼ì‚¬ëª… í™•ì¸ (í™”ì£¼ì‚¬ ëª¨ë“œì—ì„œë§Œ í•„ìˆ˜)
      const roleNormalized = (swCurrentRole || '').toString().trim();
      const isAdmin = (roleNormalized === 'ê´€ë¦¬ì');
      
      if (isAdmin) {
        console.error('[SW] ê´€ë¦¬ì ëª¨ë“œì—ì„œ swConsignorLoadWorks()ê°€ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. swAdminLoadWorks()ë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.');
        swAdminLoadWorks();
        return;
      }
      
      const companyName = swCurrentCompany;
      if (!companyName) {
        console.error('[SW] í™”ì£¼ì‚¬ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        alert('í™”ì£¼ì‚¬ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // 4. API URL êµ¬ì„±
      let url = '/api/special-works/works?';
      if (startDate) url += `start_date=${startDate}&`;
      if (endDate) url += `end_date=${endDate}&`;
      url += `company_name=${encodeURIComponent(companyName)}&`;
      
      // 5. ë¡œë”© í‘œì‹œ
      const tbody = container.querySelector('#swTableBody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="no-data">ë¡œë”© ì¤‘...</td></tr>';
      
      // 6. API í˜¸ì¶œ
      fetch(url, {
        credentials: 'include',
        headers: swGetUserHeaders()
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            let works = data.data || [];
            // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            works.sort((a, b) => new Date(b.work_date) - new Date(a.work_date));
            // í™”ì£¼ì‚¬ ì „ìš© ë Œë”ë§
            swConsignorRenderWorks(works);
            // ê³µí†µ í†µê³„ ì—…ë°ì´íŠ¸
            swUpdateStats(works);
          } else {
            if (tbody) tbody.innerHTML = `<tr><td colspan="9" class="no-data">${data.message || 'ì‘ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</td></tr>`;
          }
        })
        .catch(error => {
          console.error('[SW] í™”ì£¼ì‚¬ ì‘ì—… ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
          if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="no-data">ì‘ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        });
    }
    
    /**
     * í™”ì£¼ì‚¬ ëª¨ë“œ ì‘ì—… ëª©ë¡ ë Œë”ë§
     * ê´€ë¦¬ ì»¬ëŸ¼ ì œì™¸
     */
    function swConsignorRenderWorks(works) {
      const container = document.getElementById('swContainer');
      if (!container) return;
      
      const tbody = container.querySelector('#swTableBody');
      if (!tbody) return;
      
      // ì‘ì—… ì¢…ë¥˜ í•„í„° ì ìš© (nullì´ë©´ ì „ì²´, ì•„ë‹ˆë©´ í•´ë‹¹ ì‘ì—… ì¢…ë¥˜ë§Œ)
      let filteredWorks = works;
      if (swSelectedWorkType !== null && swSelectedWorkType !== undefined) {
        filteredWorks = filteredWorks.filter(work => work.work_type_name === swSelectedWorkType);
      }
      
      // í™”ì£¼ì‚¬ í•„í„°ëŠ” í™”ì£¼ì‚¬ ëª¨ë“œì—ì„œëŠ” ì ìš©í•˜ì§€ ì•ŠìŒ (ë³¸ì¸ ê²ƒë§Œ ë³´ë¯€ë¡œ)
      
      if (filteredWorks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="no-data">ë“±ë¡ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      // ì‘ì—… ê·¸ë£¹í™”: ê°™ì€ ë‚ ì§œ/ë©”ëª¨/ì‚¬ì§„ì„ ê°€ì§„ ì‘ì—…ë“¤ì„ ë¬¶ìŒ
      const workGroups = {};
      filteredWorks.forEach(work => {
        // ê·¸ë£¹ í‚¤ ìƒì„± (ë‚ ì§œ + ë©”ëª¨ + ì‚¬ì§„)
        const groupKey = `${work.work_date || ''}_${work.memo || ''}_${work.photo_links || ''}`;
        
        if (!workGroups[groupKey]) {
          workGroups[groupKey] = {
            work_date: work.work_date,
            memo: work.memo,
            photo_links: work.photo_links,
            works: [],
            totalAllPrice: 0
          };
        }
        
        workGroups[groupKey].works.push(work);
        workGroups[groupKey].totalAllPrice += work.total_price || 0;
      });
      
      // ê·¸ë£¹ì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      const groupedArray = Object.values(workGroups);
      groupedArray.sort((a, b) => new Date(b.work_date) - new Date(a.work_date));
      
      // HTML ìƒì„± (ê´€ë¦¬ ì»¬ëŸ¼ ì œì™¸)
      // ìˆœë²ˆ: ì˜¤ë˜ëœ ì‘ì—…ì´ 1ë²ˆ, ìµœì‹  ì‘ì—…ì´ ë§ˆì§€ë§‰ ë²ˆí˜¸
      const html = groupedArray.map((group, index) => {
        const photos = group.photo_links ? group.photo_links.split(',').map(url => url.trim()).filter(url => url) : [];
        const photoThumbnails = photos.slice(0, 3).map(url => 
          `<img src="${swEscapeHtml(url)}" class="sw-photo-thumbnail" onclick="swViewPhoto('${swEscapeHtml(url)}')" alt="ì‚¬ì§„" style="cursor: pointer; margin-right: 5px;">`
        ).join('');
        const morePhotos = photos.length > 3 ? `<span style="margin-left: 5px; color: #636e72;">+${photos.length - 3}</span>` : '';
        
        // ìˆœë²ˆ ê³„ì‚°: ì˜¤ë˜ëœ ì‘ì—…ì´ 1ë²ˆì´ ë˜ë„ë¡ ì—­ìˆœ
        const rowNumber = groupedArray.length - index;
        const memoText = group.memo || '';
        const memoDisplay = memoText || '(ë©”ëª¨ ì—†ìŒ)';
        
        // ì‘ì—… ì¢…ë¥˜ë“¤ì„ ë¬¶ì–´ì„œ í‘œì‹œ (ì—¬ëŸ¬ ê°œì¸ ê²½ìš°)
        const workTypesHtml = group.works.map(w => 
          `<div style="margin: 2px 0;">${swEscapeHtml(w.work_type_name || '')}</div>`
        ).join('');
        
        // ìˆ˜ëŸ‰ë“¤ì„ ë¬¶ì–´ì„œ í‘œì‹œ
        const quantitiesHtml = group.works.map(w => 
          `<div style="margin: 2px 0;">${w.quantity || 0}</div>`
        ).join('');
        
        // ë‹¨ê°€ë“¤ì„ ë¬¶ì–´ì„œ í‘œì‹œ
        const unitPricesHtml = group.works.map(w => 
          `<div style="margin: 2px 0;">${swFormatNumber(w.unit_price || 0)}ì›</div>`
        ).join('');
        
        return `
          <tr>
            <td>${rowNumber}</td>
            <td>${swEscapeHtml(group.work_date || '')}</td>
            <td style="text-align: left; padding-left: 12px;">${workTypesHtml}</td>
            <td>${quantitiesHtml}</td>
            <td style="text-align: left; padding-left: 12px;">${unitPricesHtml}</td>
            <td style="font-weight: 600; color: #ff6b35;">${swFormatNumber(Math.round(group.totalAllPrice))}ì›</td>
            <td>${photoThumbnails || '<span style="color: #999;">ì‚¬ì§„ ì—†ìŒ</span>'}${morePhotos}</td>
            <td class="sw-memo-cell">
              <span>${swEscapeHtml(memoDisplay)}</span>
              ${memoText ? `<div class="sw-memo-tooltip">${swEscapeHtml(memoText)}</div>` : ''}
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = html;
      
      // ê°€ì‹œì„± ì œì–´ (ê´€ë¦¬ ì»¬ëŸ¼ ìˆ¨ê¹€)
      swApplyVisibility();
    }
    
    
    /**
     * ì‚¬ì§„ ë³´ê¸° (ê³µí†µ)
     */
    function swViewPhoto(url) {
      window.open(url, '_blank');
    }
    
    // windowì— ë…¸ì¶œ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡)
    window.swAdminInit = swAdminInit;
    window.swConsignorInit = swConsignorInit;
    window.swAdminLoadWorks = swAdminLoadWorks;
    window.swConsignorLoadWorks = swConsignorLoadWorks;
    
    // DOMì´ ì¤€ë¹„ë˜ë©´ ì´ˆê¸°í™”
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', swCommonInit);
    } else {
      swCommonInit();
    }
    
    // windowì— ë…¸ì¶œ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡)
    window.swCommonInit = swCommonInit;
  </script>
</body>
</html>

