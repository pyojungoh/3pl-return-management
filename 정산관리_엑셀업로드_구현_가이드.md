# 정산관리 엑셀 업로드 구현 가이드

## 📋 목표

정산관리 메뉴에서 각 화주사별 작업별 엑셀 파일을 Google Drive에 업로드하는 기능 구현

## 📁 폴더 구조

```
제이제이솔루션 (메인 폴더 - SETTLEMENT_MAIN_FOLDER_ID)
  └── 정산파일 (하위 폴더)
      └── 2025년 (년도 폴더)
          └── 01월 (월 폴더)
              └── 화주사A (화주사명 폴더)
                  └── 작업비정산서.xlsx
                  └── 입출고비정산서.xlsx
                  └── 배송비정산서.xlsx
```

## 🔧 구현 단계

### 1단계: `api/uploads/oauth_drive.py`에 폴더 찾기/생성 함수 추가

#### 1-1. `find_or_create_year_folder` 함수 추가

```python
def find_or_create_year_folder(service, parent_folder_id: str, year: str) -> str:
    """
    년도 폴더 찾기 또는 생성
    
    Args:
        service: Google Drive API 서비스 객체
        parent_folder_id: 부모 폴더 ID (정산파일 폴더)
        year: 년도 (예: "2025")
    
    Returns:
        폴더 ID
    """
    folder_name = f"{year}년"
    
    # 기존 폴더 찾기
    folder_id = find_folder_in_oauth(service, folder_name, parent_folder_id)
    
    if folder_id:
        return folder_id
    
    # 폴더가 없으면 생성
    file_metadata = {
        'name': folder_name,
        'mimeType': 'application/vnd.google-apps.folder',
        'parents': [parent_folder_id]
    }
    
    folder = service.files().create(
        body=file_metadata,
        fields='id'
    ).execute()
    
    print(f"✅ 년도 폴더 생성: {folder_name} (ID: {folder.get('id')})")
    return folder.get('id')
```

#### 1-2. `find_or_create_month_folder` 함수 추가

```python
def find_or_create_month_folder(service, parent_folder_id: str, month: str) -> str:
    """
    월 폴더 찾기 또는 생성
    
    Args:
        service: Google Drive API 서비스 객체
        parent_folder_id: 부모 폴더 ID (년도 폴더)
        month: 월 (예: "01" 또는 "1")
    
    Returns:
        폴더 ID
    """
    # 월을 2자리로 변환 (예: "1" -> "01")
    month_padded = month.zfill(2)
    folder_name = f"{month_padded}월"
    
    # 기존 폴더 찾기
    folder_id = find_folder_in_oauth(service, folder_name, parent_folder_id)
    
    if folder_id:
        return folder_id
    
    # 폴더가 없으면 생성
    file_metadata = {
        'name': folder_name,
        'mimeType': 'application/vnd.google-apps.folder',
        'parents': [parent_folder_id]
    }
    
    folder = service.files().create(
        body=file_metadata,
        fields='id'
    ).execute()
    
    print(f"✅ 월 폴더 생성: {folder_name} (ID: {folder.get('id')})")
    return folder.get('id')
```

#### 1-3. `find_or_create_company_folder` 함수 추가

```python
def find_or_create_company_folder(service, parent_folder_id: str, company_name: str) -> str:
    """
    화주사 폴더 찾기 또는 생성
    
    Args:
        service: Google Drive API 서비스 객체
        parent_folder_id: 부모 폴더 ID (월 폴더)
        company_name: 화주사명
    
    Returns:
        폴더 ID
    """
    # 기존 폴더 찾기
    folder_id = find_folder_in_oauth(service, company_name, parent_folder_id)
    
    if folder_id:
        return folder_id
    
    # 폴더가 없으면 생성
    file_metadata = {
        'name': company_name,
        'mimeType': 'application/vnd.google-apps.folder',
        'parents': [parent_folder_id]
    }
    
    folder = service.files().create(
        body=file_metadata,
        fields='id'
    ).execute()
    
    print(f"✅ 화주사 폴더 생성: {company_name} (ID: {folder.get('id')})")
    return folder.get('id')
```

### 2단계: 정산용 엑셀 업로드 함수 추가

#### 2-1. `upload_settlement_excel_to_drive` 함수 추가

`api/uploads/oauth_drive.py`에 다음 함수 추가:

```python
def upload_settlement_excel_to_drive(
    file_data: bytes, 
    filename: str, 
    company_name: str, 
    settlement_year_month: str
) -> dict:
    """
    정산용 엑셀 파일을 Google Drive에 업로드
    폴더 구조: 제이제이솔루션 > 정산파일 > 년도 > 월 > 화주사명
    
    Args:
        file_data: 파일 데이터 (bytes)
        filename: 파일명 (예: "작업비정산서.xlsx")
        company_name: 화주사명
        settlement_year_month: 정산년월 (예: "2025-01")
    
    Returns:
        {
            'success': bool,
            'file_id': str,
            'file_url': str,
            'web_view_link': str,
            'message': str
        }
    """
    try:
        if not file_data:
            raise Exception("파일 데이터가 없습니다.")
        
        if not filename:
            raise Exception("파일명이 없습니다.")
        
        if not company_name:
            raise Exception("화주사명이 없습니다.")
        
        if not settlement_year_month:
            raise Exception("정산년월이 없습니다.")
        
        print(f"📄 정산 엑셀 파일 업로드 시작: {filename}")
        print(f"   화주사: {company_name}")
        print(f"   정산년월: {settlement_year_month}")
        
        # OAuth 2.0 인증 정보 가져오기
        credentials = get_credentials()
        if not credentials:
            raise Exception("OAuth 2.0 인증 실패")
        
        service = build('drive', 'v3', credentials=credentials)
        
        # 1. 메인 폴더 ID 사용
        main_folder_id = SETTLEMENT_MAIN_FOLDER_ID
        print(f"✅ 메인 폴더 ID 사용: {SETTLEMENT_MAIN_FOLDER_NAME} (ID: {main_folder_id})")
        
        # 2. 정산파일 폴더 찾기
        settlement_folder_id = find_folder_in_oauth(service, "정산파일", main_folder_id)
        if not settlement_folder_id:
            raise Exception(
                f"'정산파일' 폴더를 찾을 수 없습니다.\n"
                f"Google Drive에서 '{SETTLEMENT_MAIN_FOLDER_NAME}' 폴더 안에 '정산파일' 폴더를 만들어주세요."
            )
        print(f"✅ 정산파일 폴더 찾기 성공 (ID: {settlement_folder_id})")
        
        # 3. 정산년월에서 년도와 월 추출
        # settlement_year_month 형식: "2025-01"
        year, month = settlement_year_month.split('-')
        print(f"   년도: {year}, 월: {month}")
        
        # 4. 년도 폴더 찾기/생성
        year_folder_id = find_or_create_year_folder(service, settlement_folder_id, year)
        print(f"✅ 년도 폴더: {year}년 (ID: {year_folder_id})")
        
        # 5. 월 폴더 찾기/생성
        month_folder_id = find_or_create_month_folder(service, year_folder_id, month)
        print(f"✅ 월 폴더: {month}월 (ID: {month_folder_id})")
        
        # 6. 화주사 폴더 찾기/생성
        company_folder_id = find_or_create_company_folder(service, month_folder_id, company_name)
        print(f"✅ 화주사 폴더: {company_name} (ID: {company_folder_id})")
        
        # 7. 파일 메타데이터
        file_metadata = {
            'name': filename,
            'parents': [company_folder_id]
        }
        
        # 8. 미디어 업로드 (엑셀 파일)
        if filename.endswith('.xlsx'):
            mimetype = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        elif filename.endswith('.xls'):
            mimetype = 'application/vnd.ms-excel'
        else:
            mimetype = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        
        media = MediaIoBaseUpload(
            io.BytesIO(file_data),
            mimetype=mimetype,
            resumable=True
        )
        
        # 9. 파일 업로드
        file = service.files().create(
            body=file_metadata,
            media_body=media,
            fields='id, name, webViewLink, webContentLink'
        ).execute()
        
        file_id = file.get('id')
        web_view_link = file.get('webViewLink', '')
        web_content_link = file.get('webContentLink', '')
        
        print(f"✅ 파일 업로드 성공: {filename} (ID: {file_id})")
        print(f"🔗 웹 보기 링크: {web_view_link}")
        
        # 10. 공유 설정 (누구나 링크로 볼 수 있도록)
        try:
            permission = {
                'type': 'anyone',
                'role': 'reader'
            }
            service.permissions().create(
                fileId=file_id,
                body=permission
            ).execute()
            print(f"✅ 공유 설정 완료: {filename}")
        except HttpError as perm_error:
            print(f"⚠️ 공유 설정 실패 (무시, 파일은 업로드됨): {perm_error}")
        
        return {
            'success': True,
            'file_id': file_id,
            'file_url': web_content_link,
            'web_view_link': web_view_link,
            'message': f'파일 업로드 성공: {filename}'
        }
        
    except HttpError as error:
        print(f"💥 Google Drive API 오류: {error}")
        return {
            'success': False,
            'file_id': None,
            'file_url': None,
            'web_view_link': None,
            'message': f'Google Drive API 오류: {error}'
        }
    except Exception as e:
        print(f"💥 정산 엑셀 파일 업로드 전체 오류: {e}")
        import traceback
        traceback.print_exc()
        return {
            'success': False,
            'file_id': None,
            'file_url': None,
            'web_view_link': None,
            'message': f'정산 엑셀 파일 업로드 실패: {str(e)}'
        }
```

### 3단계: API 엔드포인트 추가

#### 3-1. `api/settlements/routes_db.py`에 엔드포인트 추가

```python
@settlements_bp.route('/upload-excel', methods=['POST'])
def upload_settlement_excel():
    """
    정산 엑셀 파일 업로드 (Google Drive)
    
    Request Body:
        {
            "settlement_id": int,  # 선택 (정산 ID)
            "company_name": str,    # 필수 (화주사명)
            "settlement_year_month": str,  # 필수 (정산년월, 예: "2025-01")
            "work_type": str,  # 선택 (작업 유형: "work_fee", "inout_fee", "shipping_fee" 등)
            "file_data": str,  # 필수 (Base64 인코딩된 파일 데이터)
            "file_name": str   # 필수 (파일명, 예: "작업비정산서.xlsx")
        }
    
    Returns:
        {
            "success": bool,
            "file_id": str,
            "file_url": str,
            "web_view_link": str,
            "message": str
        }
    """
    try:
        user_context = get_user_context()
        role = user_context['role']
        
        # 관리자만 파일 업로드 가능
        if role != '관리자':
            return jsonify({
                'success': False,
                'message': '관리자만 파일을 업로드할 수 있습니다.'
            }), 403
        
        data = request.get_json()
        company_name = data.get('company_name', '').strip()
        settlement_year_month = data.get('settlement_year_month', '').strip()
        work_type = data.get('work_type', '').strip()
        file_data = data.get('file_data', '')
        file_name = data.get('file_name', '').strip()
        settlement_id = data.get('settlement_id')
        
        # 필수 필드 확인
        if not company_name or not settlement_year_month or not file_data or not file_name:
            return jsonify({
                'success': False,
                'message': '필수 데이터가 누락되었습니다. (company_name, settlement_year_month, file_data, file_name)'
            }), 400
        
        # Base64 데이터 디코딩
        import base64
        if ',' in file_data:
            file_data = file_data.split(',')[1]
        
        try:
            file_bytes = base64.b64decode(file_data)
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'파일 데이터 디코딩 실패: {str(e)}'
            }), 400
        
        # Google Drive에 업로드
        from api.uploads.oauth_drive import upload_settlement_excel_to_drive
        
        result = upload_settlement_excel_to_drive(
            file_data=file_bytes,
            filename=file_name,
            company_name=company_name,
            settlement_year_month=settlement_year_month
        )
        
        if not result.get('success'):
            return jsonify({
                'success': False,
                'message': result.get('message', '파일 업로드 실패')
            }), 500
        
        # DB에 파일 정보 저장 (선택)
        if settlement_id:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            try:
                # settlement_files 테이블에 저장
                file_url = result.get('web_view_link', result.get('file_url', ''))
                
                if USE_POSTGRESQL:
                    cursor.execute('''
                        INSERT INTO settlement_files (
                            settlement_id, file_type, file_name, file_url, file_size, uploaded_at
                        )
                        VALUES (%s, %s, %s, %s, %s, CURRENT_TIMESTAMP)
                        RETURNING id
                    ''', (settlement_id, work_type or 'excel', file_name, file_url, len(file_bytes)))
                    file_id = cursor.fetchone()[0]
                else:
                    cursor.execute('''
                        INSERT INTO settlement_files (
                            settlement_id, file_type, file_name, file_url, file_size, uploaded_at
                        )
                        VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
                    ''', (settlement_id, work_type or 'excel', file_name, file_url, len(file_bytes)))
                    file_id = cursor.lastrowid
                
                # work_type에 따라 settlements 테이블의 해당 필드 업데이트
                if work_type == 'work_fee':
                    if USE_POSTGRESQL:
                        cursor.execute('UPDATE settlements SET work_fee_file_url = %s WHERE id = %s', 
                                     (file_url, settlement_id))
                    else:
                        cursor.execute('UPDATE settlements SET work_fee_file_url = ? WHERE id = ?', 
                                     (file_url, settlement_id))
                elif work_type == 'inout_fee':
                    if USE_POSTGRESQL:
                        cursor.execute('UPDATE settlements SET inout_fee_file_url = %s WHERE id = %s', 
                                     (file_url, settlement_id))
                    else:
                        cursor.execute('UPDATE settlements SET inout_fee_file_url = ? WHERE id = ?', 
                                     (file_url, settlement_id))
                elif work_type == 'shipping_fee':
                    if USE_POSTGRESQL:
                        cursor.execute('UPDATE settlements SET shipping_fee_file_url = %s WHERE id = %s', 
                                     (file_url, settlement_id))
                    else:
                        cursor.execute('UPDATE settlements SET shipping_fee_file_url = ? WHERE id = ?', 
                                     (file_url, settlement_id))
                
                conn.commit()
            except Exception as e:
                conn.rollback() if USE_POSTGRESQL else None
                print(f'[경고] 파일 정보 DB 저장 실패 (업로드는 성공): {e}')
            finally:
                cursor.close()
                conn.close()
        
        return jsonify({
            'success': True,
            'file_id': result.get('file_id'),
            'file_url': result.get('file_url'),
            'web_view_link': result.get('web_view_link'),
            'message': result.get('message', '파일 업로드 성공')
        })
        
    except Exception as e:
        print(f'❌ 정산 엑셀 업로드 오류: {e}')
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'message': f'정산 엑셀 업로드 중 오류: {str(e)}'
        }), 500
```

### 4단계: 프론트엔드 수정

#### 4-1. `settlements.html` 또는 정산관리 UI에 업로드 기능 추가

각 작업별(작업비, 입출고비, 배송비 등) 엑셀 업로드 버튼과 파일 선택 기능 추가:

```javascript
// 예시: 작업비 정산서 업로드 함수
async function uploadWorkFeeExcel(settlementId, companyName, settlementYearMonth) {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.xlsx,.xls';
    
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // 파일을 Base64로 변환
        const reader = new FileReader();
        reader.onload = async (event) => {
            const base64Data = event.target.result;
            
            try {
                const response = await fetch('/api/settlements/upload-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Role': encodeURIComponent(currentUserRole),
                        'X-User-Name': encodeURIComponent(currentUserName),
                        'X-Company-Name': encodeURIComponent(currentCompanyName)
                    },
                    body: JSON.stringify({
                        settlement_id: settlementId,
                        company_name: companyName,
                        settlement_year_month: settlementYearMonth,
                        work_type: 'work_fee',
                        file_data: base64Data,
                        file_name: file.name
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('파일 업로드 성공!');
                    // 정산 정보 새로고침
                    loadSettlementDetail(settlementId);
                } else {
                    alert('파일 업로드 실패: ' + result.message);
                }
            } catch (error) {
                console.error('업로드 오류:', error);
                alert('파일 업로드 중 오류가 발생했습니다.');
            }
        };
        
        reader.readAsDataURL(file);
    };
    
    fileInput.click();
}
```

## ✅ 체크리스트

### 백엔드
- [ ] `oauth_drive.py`에 `find_or_create_year_folder` 함수 추가
- [ ] `oauth_drive.py`에 `find_or_create_month_folder` 함수 추가
- [ ] `oauth_drive.py`에 `find_or_create_company_folder` 함수 추가
- [ ] `oauth_drive.py`에 `upload_settlement_excel_to_drive` 함수 추가
- [ ] `routes_db.py`에 `/api/settlements/upload-excel` 엔드포인트 추가
- [ ] 에러 처리 및 로깅 추가

### 프론트엔드
- [ ] 정산 상세 페이지에 각 작업별 업로드 버튼 추가
- [ ] 파일 선택 및 업로드 함수 구현
- [ ] 업로드 성공/실패 메시지 표시
- [ ] 업로드 후 정산 정보 새로고침

### 테스트
- [ ] 로컬 환경에서 테스트
- [ ] 폴더 구조 확인 (제이제이솔루션 > 정산파일 > 년도 > 월 > 화주사명)
- [ ] 파일 업로드 확인
- [ ] DB 저장 확인
- [ ] 배포 환경에서 테스트

## 📝 참고사항

1. **폴더명 형식**
   - 년도: "2025년" (4자리 년도 + "년")
   - 월: "01월" (2자리 월 + "월", "1" → "01"로 변환)
   - 화주사명: 그대로 사용

2. **정산년월 형식**
   - API에서 받는 형식: "2025-01"
   - 년도와 월 추출: `year, month = settlement_year_month.split('-')`

3. **파일명**
   - 사용자가 지정한 파일명 그대로 사용
   - 또는 work_type에 따라 자동 생성 가능 (예: "작업비정산서.xlsx")

4. **에러 처리**
   - 폴더가 없으면 자동 생성
   - 파일 업로드 실패 시 명확한 오류 메시지
   - DB 저장 실패해도 업로드는 성공한 것으로 처리

5. **권한**
   - 관리자만 업로드 가능 (현재 구현 기준)
   - 필요시 화주사도 자신의 정산만 업로드 가능하도록 수정

## 🔍 디버깅

업로드 시 다음 로그를 확인:
- 폴더 찾기/생성 로그
- 파일 업로드 진행 상황
- 최종 파일 링크

문제 발생 시:
- Google Drive에서 폴더 구조 확인
- OAuth 2.0 인증 상태 확인
- 환경 변수 확인 (Vercel 배포 환경)

---

**작성일**: 2026년 1월 12일
**상태**: 구현 대기

