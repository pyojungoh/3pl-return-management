<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ë°˜í’ˆêµí™˜">
  <meta name="theme-color" content="#4CAF50">
  <title>ë°˜í’ˆêµí™˜ ë“±ë¡</title>

  <!-- jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ (QR ì½”ë“œ ìŠ¤ìº”ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    /* ========= ìœ ë™ ìŠ¤ì¼€ì¼ ë³€ìˆ˜: í™”ë©´í­ì— ë”°ë¼ ìë™ ì¡°ì • =========
       - baseWidth 430px(ì¼ë°˜ í° ê¸°ì¤€) ëŒ€ë¹„ ë¹„ìœ¨ì„ ì¡ë˜ ê³¼í•˜ê²Œ í¬ê±°ë‚˜ ì‘ì•„ì§€ëŠ” ê²ƒ ë°©ì§€
       - í°íŠ¸/ì¹¸/ë²„íŠ¼/ì¸ë„¤ì¼ ëª¨ë‘ clamp()ë¡œ ë°˜ì‘í˜•
    */
:root{
  --fs-body:  16px;
  --fs-label: 18px;
  --fs-input: 18px;
  --fs-btn:   18px;
  --fs-title: 24px;

  --h-control: 48px;
  --h-button:  48px;

  --pad-v:     12px;
  --pad-h:     16px;
  --radius:    8px;
  --gap:       20px;

  --thumb:     clamp(100px, 30vw, 150px);
  --status-fs: 16px;
}

    *{ box-sizing: border-box; }
    html, body { height: 100%; -webkit-overflow-scrolling: touch; }
    body{
  margin: 0;
  padding: 10px;
  background:#f5f5f5;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  font-size: var(--fs-body);
  line-height: 1.4;
  -webkit-text-size-adjust: 100%;
}

    .container{
  max-width: 100%;
  margin: 0 auto;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}


    h2{
      margin: 0 0 var(--gap);
      text-align: center;
      color: #222;
      font-size: var(--fs-title);
      font-weight: 800;
      letter-spacing: -0.2px;
    }

    .form-group{ margin-bottom: calc(var(--gap) * 0.8); }

    label{
      display:block;
      margin-bottom: 6px;
      color:#222;
      font-weight: 600;
      font-size: var(--fs-label);
    }

    input, select, textarea{
      width:100%;
      border: 2px solid #ddd;
      border-radius: var(--radius);
      background:#fff;
      font-size: var(--fs-input);
      padding: 12px 16px;
      min-height: var(--h-control);
      transition: border-color 0.3s ease;
      -webkit-appearance: none; appearance: none;
    }
    input[type="number"]{ text-align:center; font-weight:700; }
    input[readonly]{ background:#f8f9fa; color:#555; font-size: 16px; padding: 10px 12px; min-height: 40px; }

    textarea{ min-height: calc(var(--h-control) * 1.6); resize: vertical; }

    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:#4CAF50;
      box-shadow:0 0 0 3px rgba(76,175,80,0.1);
    }

    button{
      display:inline-flex; align-items:center; justify-content:center;
      width:100%;
      border:none; border-radius: var(--radius);
      background:#4CAF50; color:#fff;
      font-size: var(--fs-btn); font-weight: 800;
      padding: calc(var(--pad-v) * 0.8) var(--pad-h);
      min-height: var(--h-button);
      margin: clamp(4px, 1.6vw, 8px) 0;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease;
      -webkit-tap-highlight-color: transparent;
      letter-spacing:-0.2px;
    }
    button:hover, button:active{ background:#45a049; transform: translateY(-1px); }
    button:disabled{ background:#bdbdbd; transform:none; cursor:not-allowed; }

    .scan-btn{ background:#2196F3; }
    .scan-btn:hover,.scan-btn:active{ background:#1976D2; }

    .photo-btn{ background:#FF9800; }
    .photo-btn:hover,.photo-btn:active{ background:#F57C00; }

    .refresh-btn{ background:#607D8B; }
    .refresh-btn:hover{ background:#455A64; }

    .test-btn{ background:#9C27B0; }
    .test-btn:hover{ background:#7B1FA2; }

    .month-selector{
      background:#e3f2fd;
      border: 1.5px solid #2196F3;
      color:#0D47A1;
      font-weight: 700;
    }
    .month-selector:focus{ border-color:#1976D2; box-shadow:0 0 0 3px rgba(33,150,243,0.12); }

    .preview{ margin-top: calc(var(--gap) * 0.6); display:none; text-align:center; }
    .preview .photo-item{ display:inline-block; margin: clamp(4px, 1.6vw, 8px); text-align:center; vertical-align:top; }
    .preview img{
      width: var(--thumb);
      height: var(--thumb);
      object-fit: cover;
      border-radius: var(--radius);
      border: 1.5px solid #ddd;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
      display:block; margin-bottom: 6px;
    }
    .photo-label{ font-size: 14px; color:#666; font-weight:600; }

    .delete-btn{
      background:#f44336; color:#fff; border:none; border-radius:50%;
      width: 24px; height: 24px;
      font-size: 14px;
      cursor:pointer; padding:0;
      display:inline-flex; align-items:center; justify-content:center;
    }

    .qr-status{
      margin-top: 10px;
      color:#0D47A1;
      font-size: 14px;
      font-weight: 600;
      background:#e3f2fd;
      border:2px solid rgba(33,150,243,0.35);
      padding: 10px;
      border-radius: var(--radius);
      text-align:center;
    }
    
    .cancel-btn{
      background:#9e9e9e;
      color:#fff;
    }
    
    .cancel-btn:hover,
    .cancel-btn:active{
      background:#757575;
    }

    .status{
      padding: 12px;
      margin: var(--gap) 0;
      border-radius: var(--radius);
      text-align:center;
      font-weight:700;
      font-size: 16px;
    }
    .success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .error{   background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .loading{ background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }

    /* ì „ì²´ í™”ë©´ ì§„í–‰ ì˜¤ë²„ë ˆì´(ì—…ë¡œë“œ/ì €ì¥ ë™ì•ˆ) */
    .overlay{
      position:fixed; inset:0; z-index:9999;
      background:rgba(0,0,0,0.45);
      display:none; align-items:center; justify-content:center;
      backdrop-filter: blur(1px);
    }
    .overlay.show{ display:flex; }
    .overlay-card{
      background:#fff;
      width: min(86vw, 420px);
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 12px 36px rgba(0,0,0,0.22);
      text-align:center;
    }
    .spinner{
      width: 40px; height: 40px;
      border: 3px solid #e0e0e0; border-top-color:#4CAF50;
      border-radius:50%; margin: 0 auto 10px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .overlay-title{ font-size: 18px; font-weight: 800; color:#222; margin-bottom: 8px; }
    .overlay-desc{  font-size: 16px; color:#555; margin-bottom: 10px; }
    .progressbar{ width:100%; height: 6px; background:#eee; border-radius:999px; overflow:hidden; }
    .progressbar>div{ width:0%; height:100%; background:#4CAF50; transition: width .25s ease; }

    /* í„°ì¹˜ ì¥ì¹˜ì—ì„œ í˜¸ë²„ ì• ë‹ˆë©”ì´ì…˜ ì¶•ì†Œ */
    @media (hover:none) and (pointer:coarse){
      button:hover{ transform:none; }
      button:active{ transform: scale(0.98); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>

    <!-- íƒ­ ë©”ë‰´ -->
    <div class="tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
      <button type="button" class="tab-btn active" onclick="switchTab('return')" style="flex: 1; padding: 12px; border: none; background: transparent; border-bottom: 2px solid #4CAF50; color: #4CAF50; font-weight: 700; font-size: 16px; cursor: pointer;">ğŸ“¦ ë°˜í’ˆ ë“±ë¡</button>
      <button type="button" class="tab-btn" onclick="switchTab('register')" style="flex: 1; padding: 12px; border: none; background: transparent; border-bottom: 2px solid transparent; color: #666; font-weight: 600; font-size: 16px; cursor: pointer;">ğŸ¢ í™”ì£¼ì‚¬ ë“±ë¡</button>
      <button type="button" class="tab-btn" onclick="switchTab('password')" style="flex: 1; padding: 12px; border: none; background: transparent; border-bottom: 2px solid transparent; color: #666; font-weight: 600; font-size: 16px; cursor: pointer;">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </div>

    <!-- ë°˜í’ˆ ë“±ë¡ íƒ­ -->
    <div id="returnTab" class="tab-content">
    <form id="returnForm">
      <!-- ì›” ì„ íƒ -->
      <div class="form-group">
        <label>ğŸ“… ê²€ìƒ‰í•  ì›”</label>
        <select id="monthSelector" class="month-selector" required>
          <option value="">ì›” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
        </select>
        <button type="button" class="refresh-btn" onclick="loadAvailableSheets()">ğŸ”„ ì›” ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <!-- QR ê²€ìƒ‰ ì•ˆë‚´ -->
      <div class="form-group">
        <label>ğŸ“· QR ì½”ë“œ ìŠ¤ìº”</label>
        <button type="button" class="scan-btn" onclick="startQRScan()" id="qrScanBtn">ğŸ“· QR ì½”ë“œ ìŠ¤ìº”</button>
        <div id="qrStatus" class="qr-status">QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜ ì†¡ì¥ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</div>
        <div id="qrScanner" style="display:none; margin-top: 10px; text-align: center;">
          <video id="qrVideo" autoplay playsinline webkit-playsinline style="width: 240px; max-width: 240px; height: 240px; border-radius: 8px; background: #000; object-fit: cover; margin: 0 auto; display: block;"></video>
          <button type="button" class="cancel-btn" onclick="stopQRScan()" style="margin-top: 10px; width: 240px; max-width: 100%;">â¹ï¸ ìŠ¤ìº” ì¤‘ë‹¨</button>
        </div>
      </div>

      <!-- ì†¡ì¥ë²ˆí˜¸ ê²€ìƒ‰ -->
      <div class="form-group">
        <label>ì†¡ì¥ë²ˆí˜¸</label>
        <input type="text" id="trackingNumber" placeholder="QR ìŠ¤ìº” ë˜ëŠ” ì†¡ì¥ë²ˆí˜¸ ì§ì ‘ ì…ë ¥" required>
        <button type="button" class="scan-btn" onclick="searchByTracking()">ğŸ” ê²€ìƒ‰</button>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ í™•ì¸ -->
      <div class="form-group">
        <label>í™”ì£¼ëª…</label>
        <input type="text" id="company" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>
      <div class="form-group">
        <label>ì œí’ˆ</label>
        <input type="text" id="product" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>
      <div class="form-group">
        <label>ê³ ê°ëª… (í™•ì¸)</label>
        <input type="text" id="customer" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>

      <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
      <div class="form-group">
        <label>ì‚¬ì§„ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</label>
        <input type="file" id="photos" accept="image/*" multiple capture="camera" style="display:none;">
        <button type="button" class="photo-btn" onclick="document.getElementById('photos').click()">ğŸ“· ì‚¬ì§„ ì°ê¸°</button>
        <div id="photoPreview" class="preview"></div>
        <div id="photoCount" style="margin-top: 10px; color:#666; text-align:center; font-size: 16px;"></div>
      </div>

      <!-- ì œì¶œ -->
      <button type="submit" id="submitBtn">ë“±ë¡í•˜ê¸°</button>
      <button type="button" onclick="testConnection()" class="test-btn">ğŸ”§ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    </form>

    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div id="statusMessage" style="display:none;"></div>
    </div>

    <!-- í™”ì£¼ì‚¬ ë“±ë¡ íƒ­ -->
    <div id="registerTab" class="tab-content" style="display:none;">
      <h3 style="margin: 0 0 20px; font-size: 20px; color: #222;">í™”ì£¼ì‚¬ ë“±ë¡</h3>
      <form id="registerForm">
        <!-- í•„ìˆ˜ ì •ë³´ -->
        <div class="form-group">
          <label>í™”ì£¼ì‚¬ëª… *</label>
          <input type="text" id="regCompanyName" placeholder="í™”ì£¼ì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
        </div>
        <div class="form-group">
          <label>ì•„ì´ë”” *</label>
          <input type="text" id="regUsername" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
        </div>
        <div class="form-group">
          <label>ë¹„ë°€ë²ˆí˜¸ *</label>
          <input type="password" id="regPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
        </div>

        <!-- ì‚¬ì—…ì ì •ë³´ (ì„ íƒ) -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
          <h4 style="margin: 0 0 15px; font-size: 16px; color: #666;">ì‚¬ì—…ì ì •ë³´ (ì„ íƒì‚¬í•­)</h4>
          <div class="form-group">
            <label>ì‚¬ì—…ìë²ˆí˜¸</label>
            <input type="text" id="regBusinessNumber" placeholder="ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="form-group">
            <label>ì‚¬ì—…ìëª…</label>
            <input type="text" id="regBusinessName" placeholder="ì‚¬ì—…ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="form-group">
            <label>ì£¼ì†Œ</label>
            <input type="text" id="regBusinessAddress" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="form-group">
            <label>ì „í™”ë²ˆí˜¸</label>
            <input type="tel" id="regBusinessTel" placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="form-group">
            <label>ì´ë©”ì¼</label>
            <input type="email" id="regBusinessEmail" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
          </div>
        </div>

        <button type="submit" id="registerBtn">ë“±ë¡í•˜ê¸°</button>
        <div id="registerStatus" style="display:none; margin-top: 10px;"></div>
      </form>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ íƒ­ -->
    <div id="passwordTab" class="tab-content" style="display:none;">
      <h3 style="margin: 0 0 20px; font-size: 20px; color: #222;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
      <form id="passwordForm">
        <div class="form-group">
          <label>ì•„ì´ë”” *</label>
          <input type="text" id="pwdUsername" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
        </div>
        <div class="form-group">
          <label>ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ *</label>
          <input type="password" id="pwdOldPassword" placeholder="ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
        </div>
        <div class="form-group">
          <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ *</label>
          <input type="password" id="pwdNewPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
        </div>
        <div class="form-group">
          <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
          <input type="password" id="pwdNewPasswordConfirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required>
        </div>

        <button type="submit" id="passwordBtn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        <div id="passwordStatus" style="display:none; margin-top: 10px;"></div>
      </form>
    </div>
  </div>

  <!-- ì—…ë¡œë“œ/ì €ì¥ ì§„í–‰ ì˜¤ë²„ë ˆì´ -->
  <div id="overlay" class="overlay" role="alert" aria-live="assertive">
    <div class="overlay-card">
      <div class="spinner"></div>
      <div id="overlayTitle" class="overlay-title">ì¤€ë¹„ ì¤‘â€¦</div>
      <div id="overlayDesc"  class="overlay-desc">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
      <div class="progressbar"><div id="overlayBar"></div></div>
    </div>
  </div>

  <script>
    let selectedImages = [];
    let availableSheets = [];
    let overlayTimer = null;
    let pseudoProgress = 0;

    document.addEventListener('DOMContentLoaded', function () {
      loadAvailableSheets();

      document.getElementById('photos').addEventListener('change', function(e){
        handleImageSelection(e.target.files);
      });

      document.getElementById('returnForm').addEventListener('submit', function(e){
        e.preventDefault();
        submitForm();
      });

      // í™”ì£¼ì‚¬ ë“±ë¡ í¼
      document.getElementById('registerForm').addEventListener('submit', function(e){
        e.preventDefault();
        registerCompany();
      });

      // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼
      document.getElementById('passwordForm').addEventListener('submit', function(e){
        e.preventDefault();
        changePassword();
      });
      
      // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
      document.getElementById('trackingNumber').addEventListener('keypress', function(e){
        if (e.key === 'Enter'){
          e.preventDefault();
          searchByTracking();
        }
      });
    });

    /* ========== íƒ­ ì „í™˜ ========== */
    function switchTab(tabName){
      // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
      document.getElementById('returnTab').style.display = 'none';
      document.getElementById('registerTab').style.display = 'none';
      document.getElementById('passwordTab').style.display = 'none';

      // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.style.borderBottom = '2px solid transparent';
        btn.style.color = '#666';
        btn.style.fontWeight = '600';
      });

      // ì„ íƒëœ íƒ­ í‘œì‹œ
      if (tabName === 'return') {
        document.getElementById('returnTab').style.display = 'block';
        tabButtons[0].style.borderBottom = '2px solid #4CAF50';
        tabButtons[0].style.color = '#4CAF50';
        tabButtons[0].style.fontWeight = '700';
      } else if (tabName === 'register') {
        document.getElementById('registerTab').style.display = 'block';
        tabButtons[1].style.borderBottom = '2px solid #4CAF50';
        tabButtons[1].style.color = '#4CAF50';
        tabButtons[1].style.fontWeight = '700';
      } else if (tabName === 'password') {
        document.getElementById('passwordTab').style.display = 'block';
        tabButtons[2].style.borderBottom = '2px solid #4CAF50';
        tabButtons[2].style.color = '#4CAF50';
        tabButtons[2].style.fontWeight = '700';
      }
    }

    /* ========== í™”ì£¼ì‚¬ ë“±ë¡ ========== */
    function registerCompany(){
      const btn = document.getElementById('registerBtn');
      const status = document.getElementById('registerStatus');
      
      const companyName = document.getElementById('regCompanyName').value.trim();
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value.trim();
      const businessNumber = document.getElementById('regBusinessNumber').value.trim();
      const businessName = document.getElementById('regBusinessName').value.trim();
      const businessAddress = document.getElementById('regBusinessAddress').value.trim();
      const businessTel = document.getElementById('regBusinessTel').value.trim();
      const businessEmail = document.getElementById('regBusinessEmail').value.trim();

      if (!companyName || !username || !password) {
        status.style.display = 'block';
        status.className = 'status error';
        status.textContent = 'í™”ì£¼ì‚¬ëª…, ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ë“±ë¡ ì¤‘...';
      status.style.display = 'block';
      status.className = 'status loading';
      status.textContent = 'í™”ì£¼ì‚¬ ë“±ë¡ ì¤‘...';

      const data = {
        company_name: companyName,
        username: username,
        password: password,
        business_number: businessNumber || null,
        business_name: businessName || null,
        business_address: businessAddress || null,
        business_tel: businessTel || null,
        business_email: businessEmail || null
      };

      fetch('/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          status.className = 'status success';
          status.textContent = data.message || 'í™”ì£¼ì‚¬ ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
          document.getElementById('registerForm').reset();
        } else {
          status.className = 'status error';
          status.textContent = data.message || 'í™”ì£¼ì‚¬ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        }
        btn.disabled = false;
        btn.textContent = 'ë“±ë¡í•˜ê¸°';
      })
      .catch(error => {
        console.error('í™”ì£¼ì‚¬ ë“±ë¡ ì˜¤ë¥˜:', error);
        status.className = 'status error';
        status.textContent = 'í™”ì£¼ì‚¬ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
        btn.disabled = false;
        btn.textContent = 'ë“±ë¡í•˜ê¸°';
      });
    }

    /* ========== ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ========== */
    function changePassword(){
      const btn = document.getElementById('passwordBtn');
      const status = document.getElementById('passwordStatus');
      
      const username = document.getElementById('pwdUsername').value.trim();
      const oldPassword = document.getElementById('pwdOldPassword').value.trim();
      const newPassword = document.getElementById('pwdNewPassword').value.trim();
      const newPasswordConfirm = document.getElementById('pwdNewPasswordConfirm').value.trim();

      if (!username || !oldPassword || !newPassword || !newPasswordConfirm) {
        status.style.display = 'block';
        status.className = 'status error';
        status.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
      }

      if (newPassword !== newPasswordConfirm) {
        status.style.display = 'block';
        status.className = 'status error';
        status.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ë³€ê²½ ì¤‘...';
      status.style.display = 'block';
      status.className = 'status loading';
      status.textContent = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘...';

      const data = {
        username: username,
        old_password: oldPassword,
        new_password: newPassword
      };

      fetch('/api/auth/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          status.className = 'status success';
          status.textContent = data.message || 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
          document.getElementById('passwordForm').reset();
        } else {
          status.className = 'status error';
          status.textContent = data.message || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        }
        btn.disabled = false;
        btn.textContent = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½';
      })
      .catch(error => {
        console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', error);
        status.className = 'status error';
        status.textContent = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
        btn.disabled = false;
        btn.textContent = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½';
      });
    }

    /* ========== ì§„í–‰ ì˜¤ë²„ë ˆì´ ========== */
    function showOverlay(titleText, descText){
      const overlay = document.getElementById('overlay');
      const title = document.getElementById('overlayTitle');
      const desc  = document.getElementById('overlayDesc');
      const bar   = document.getElementById('overlayBar');

      title.textContent = titleText || 'ì²˜ë¦¬ ì¤‘â€¦';
      desc.textContent  = descText  || 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
      pseudoProgress = 0;
      bar.style.width = '0%';
      overlay.classList.add('show');

      clearInterval(overlayTimer);
      overlayTimer = setInterval(() => {
        if (pseudoProgress < 92){
          pseudoProgress += Math.random()*6 + 2; // 2~8%
          if (pseudoProgress > 92) pseudoProgress = 92;
          bar.style.width = pseudoProgress.toFixed(0) + '%';
        }
      }, 320);
    }
    function updateOverlay(titleText, descText){
      if (titleText) document.getElementById('overlayTitle').textContent = titleText;
      if (descText)  document.getElementById('overlayDesc').textContent  = descText;
    }
    function fillOverlayBar(){ document.getElementById('overlayBar').style.width = '100%'; }
    function hideOverlay(){ clearInterval(overlayTimer); document.getElementById('overlay').classList.remove('show'); }

    /* ========== ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ ========== */
    function loadAvailableSheets(){
      showStatus('ì›” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');
      fetch('/api/returns/available-months')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            availableSheets = data.months || [];
            const sel = document.getElementById('monthSelector');
            sel.innerHTML = '';

            if (availableSheets.length === 0){
              const o = document.createElement('option');
              o.value = '';
              o.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ì›”ì´ ì—†ìŠµë‹ˆë‹¤';
              sel.appendChild(o);
              showStatus('ì‚¬ìš© ê°€ëŠ¥í•œ ì›” ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
              return;
            }

            availableSheets.forEach(name=>{
              const o = document.createElement('option');
              o.value = name; o.textContent = name;
              sel.appendChild(o);
            });

            const today = new Date();
            const current = `${today.getFullYear()}ë…„${today.getMonth()+1}ì›”`;
            let found = availableSheets.find(s=> s===current)
                || availableSheets.find(s=> s.replace(/\s/g,'').toLowerCase() === current.replace(/\s/g,'').toLowerCase());
            sel.value = found || availableSheets[0];
            showStatus(`í˜„ì¬ ì›” ${sel.value}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
          } else {
            throw new Error(data.message || 'ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
          }
        })
        .catch(error => {
          console.error('ì›” ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
          showStatus('ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
          const sel = document.getElementById('monthSelector');
          sel.innerHTML = '';
          const o = document.createElement('option');
          o.value = '';
          o.textContent = 'ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ - ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼';
          sel.appendChild(o);
        });
    }

    /* ========== ì´ë¯¸ì§€ ì„ íƒ/ë¯¸ë¦¬ë³´ê¸° ========== */
    function handleImageSelection(files){
      if (!files || files.length === 0) return;
      Array.from(files).forEach(file=>{
        if (file.type.startsWith('image/')){
          const reader = new FileReader();
          reader.onload = e=>{
            selectedImages.push(e.target.result); // base64 ì €ì¥
            updatePhotoPreview();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function updatePhotoPreview(){
      const preview = document.getElementById('photoPreview');
      const photoCount = document.getElementById('photoCount');
      preview.innerHTML = '';

      if (selectedImages.length > 0){
        preview.style.display = 'block';
        photoCount.textContent = `ì„ íƒëœ ì‚¬ì§„: ${selectedImages.length}ì¥`;
        selectedImages.forEach((imgData, idx)=>{
          const wrap = document.createElement('div');
          wrap.className = 'photo-item';

          const img = document.createElement('img');
          img.src = imgData;

          const label = document.createElement('div');
          label.className = 'photo-label';
          label.textContent = `ì‚¬ì§„ ${idx+1}`;

          const del = document.createElement('button');
          del.className = 'delete-btn'; del.type='button'; del.innerHTML='Ã—';
          del.onclick = ()=> removePhoto(idx);

          wrap.appendChild(img); wrap.appendChild(label); wrap.appendChild(del);
          preview.appendChild(wrap);
        });
      }else{
        preview.style.display = 'none';
        photoCount.textContent = '';
      }
    }

    function removePhoto(index){
      selectedImages.splice(index,1);
      updatePhotoPreview();
    }

    /* ========== ì œì¶œ ========== */
    function submitForm(){
      const btn = document.getElementById('submitBtn');
      const selectedMonth = document.getElementById('monthSelector').value;
      const trackingNumber = document.getElementById('trackingNumber').value.trim();

      if (!selectedMonth) return showStatus('ì›”ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'error');
      if (!trackingNumber) return showStatus('ë¨¼ì € QR ì½”ë“œë¡œ ì ‘ì†í•˜ê±°ë‚˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');

      // UI ì ê¸ˆ + ì§„í–‰ ì˜¤ë²„ë ˆì´
      btn.disabled = true;
      btn.textContent = 'ë“±ë¡ ì¤‘â€¦';
      if (selectedImages.length > 0){
        showOverlay('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘â€¦', `ì´ ${selectedImages.length}ì¥ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`);
      }else{
        showOverlay('ì €ì¥ ì¤‘â€¦', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
      }

      const formData = {
        trackingNumber,
        company:  document.getElementById('company').value.trim(),
        product:  document.getElementById('product').value.trim(),
        customer: document.getElementById('customer').value.trim(),
        selectedMonth
      };

      // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë¡œë“œ
      if (selectedImages.length > 0){
        console.log('ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘:', selectedImages.length, 'ì¥');
        updateOverlay('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘â€¦', `ì´ ${selectedImages.length}ì¥ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`);
        
        fetch('/api/uploads/upload-images', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            images: selectedImages,
            trackingNumber: trackingNumber
          })
        })
        .then(response => {
          console.log('ğŸ“¥ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
          
          // ì‘ë‹µì´ JSONì¸ì§€ í™•ì¸
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
              console.error('âŒ JSONì´ ì•„ë‹Œ ì‘ë‹µ:', text);
              throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${text.substring(0, 200)}`);
            });
          }
          
          return response.json().then(data => {
            console.log('ğŸ“¦ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‘ë‹µ ë°ì´í„°:', data);
            
            if (!response.ok) {
              // HTTP ì—ëŸ¬ ìƒíƒœ ì½”ë“œ
              throw new Error(data.message || `ì„œë²„ ì˜¤ë¥˜ (${response.status})`);
            }
            
            if (data.success) {
              console.log('âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', data.photoLinks);
              updateOverlay('ì‚¬ì§„ ë§í¬ ì €ì¥ ì¤‘â€¦', 'ë°ì´í„°ë² ì´ìŠ¤ì— ë§í¬ë¥¼ ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
              document.getElementById('overlayBar').style.width = '96%';
              formData.photoLinks = data.photoLinks;
              saveData(formData);
            } else {
              throw new Error(data.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
            }
          });
        })
        .catch(error => {
          console.error('âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
          hideOverlay();
          
          // ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„ 
          let errorMessage = 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ';
          if (error.message) {
            errorMessage += error.message;
          } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage += 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
          } else {
            errorMessage += 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          }
          
          showStatus(errorMessage, 'error');
          btn.disabled = false;
          btn.textContent = 'ë“±ë¡í•˜ê¸°';
        });
      }else{
        updateOverlay('ì €ì¥ ì¤‘â€¦', 'ë°ì´í„°ë² ì´ìŠ¤ì— ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
        saveData(formData);
      }
    }

    function saveData(formData){
      // ë‚ ì§œ ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œ)
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth() + 1;
      const day = today.getDate();
      const returnDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

      // ë°˜í’ˆ ë°ì´í„° ìƒì„±
      // ë¹ˆ ë¬¸ìì—´ì€ nullë¡œ ë³€í™˜í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— NULLë¡œ ì €ì¥ (ëŒ€ì‹œë³´ë“œì—ì„œ "í´ë¦­í•˜ì—¬ ì„ íƒ" í‘œì‹œ ë°©ì§€)
      const returnData = {
        return_date: returnDate,
        company_name: formData.company,
        product: formData.product,
        customer_name: formData.customer,
        tracking_number: formData.trackingNumber,
        return_type: null, // NULLë¡œ ì €ì¥ (ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹ )
        stock_status: null, // NULLë¡œ ì €ì¥ (ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹ )
        inspection: null, // NULLë¡œ ì €ì¥
        completed: null, // NULLë¡œ ì €ì¥
        memo: null, // NULLë¡œ ì €ì¥
        photo_links: formData.photoLinks || null, // ì‚¬ì§„ ë§í¬ (ì—†ìœ¼ë©´ NULL)
        other_courier: null, // NULLë¡œ ì €ì¥
        shipping_fee: null, // NULLë¡œ ì €ì¥
        client_request: null, // NULLë¡œ ì €ì¥
        client_confirmed: null, // NULLë¡œ ì €ì¥
        month: formData.selectedMonth
      };

      console.log('ğŸ’¾ ë°˜í’ˆ ë°ì´í„° ì €ì¥ ì‹œì‘:', returnData);
      updateOverlay('ì €ì¥ ì¤‘â€¦', 'ë°ì´í„°ë² ì´ìŠ¤ì— ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
      
      fetch('/api/returns/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(returnData)
      })
      .then(response => {
        console.log('ğŸ“¥ ë°˜í’ˆ ë°ì´í„° ì €ì¥ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
        
        // ì‘ë‹µì´ JSONì¸ì§€ í™•ì¸
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          return response.text().then(text => {
            console.error('âŒ JSONì´ ì•„ë‹Œ ì‘ë‹µ:', text);
            throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${text.substring(0, 200)}`);
          });
        }
        
        return response.json().then(data => {
          console.log('ğŸ“¦ ë°˜í’ˆ ë°ì´í„° ì €ì¥ ì‘ë‹µ ë°ì´í„°:', data);
          
          if (!response.ok) {
            // HTTP ì—ëŸ¬ ìƒíƒœ ì½”ë“œ
            throw new Error(data.message || `ì„œë²„ ì˜¤ë¥˜ (${response.status})`);
          }
          
          if (data.success) {
            console.log('âœ… ë°˜í’ˆ ë°ì´í„° ì €ì¥ ì„±ê³µ:', data.id);
            fillOverlayBar();
            setTimeout(hideOverlay, 240);

            showStatus(data.message || 'ë°˜í’ˆ ë‚´ì—­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            document.getElementById('returnForm').reset();
            document.getElementById('photoPreview').style.display = 'none';
            selectedImages = [];

            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.textContent = 'ë“±ë¡í•˜ê¸°';

            if (formData.selectedMonth){
              document.getElementById('monthSelector').value = formData.selectedMonth;
            }
            document.getElementById('statusMessage').scrollIntoView({behavior:'smooth', block:'center'});
          } else {
            throw new Error(data.message || 'ì €ì¥ ì‹¤íŒ¨');
          }
        });
      })
      .catch(error => {
        console.error('âŒ ì €ì¥ ì˜¤ë¥˜:', error);
        hideOverlay();
        
        // ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„ 
        let errorMessage = 'ì €ì¥ ì‹¤íŒ¨: ';
        if (error.message) {
          errorMessage += error.message;
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage += 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
        } else {
          errorMessage += 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        }
        
        showStatus(errorMessage, 'error');
        const btn = document.getElementById('submitBtn');
        btn.disabled = false;
        btn.textContent = 'ë“±ë¡í•˜ê¸°';
      });
    }

    /* ========== í…ŒìŠ¤íŠ¸ ========== */
    function testConnection(){
      fetch('/api/returns/available-months')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('ì—°ê²° ì„±ê³µ: ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            throw new Error(data.message || 'ì—°ê²° ì‹¤íŒ¨');
          }
        })
        .catch(error => {
          console.error('ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
          alert('ì—°ê²° ì‹¤íŒ¨: ' + error.message);
        });
    }

    /* ========== ìƒíƒœ ë©”ì‹œì§€ ========== */
    function showStatus(message, type){
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = 'status ' + type;
      el.style.display = 'block';
    }


    // QR ìŠ¤ìº” ê´€ë ¨ ë³€ìˆ˜
    let qrStream = null;
    let qrScanInterval = null;
    
    // QR ìŠ¤ìº” ì‹œì‘ (ê°œì„ ëœ ë²„ì „)
    async function startQRScan(){
      const qrStatus = document.getElementById('qrStatus');
      const qrScanner = document.getElementById('qrScanner');
      const qrVideo = document.getElementById('qrVideo');
      const qrScanBtn = document.getElementById('qrScanBtn');
      
      // HTTPS ì²´í¬ (ëª¨ë°”ì¼ì—ì„œ ì¹´ë©”ë¼ ì ‘ê·¼ì„ ìœ„í•´ í•„ìš”)
      if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        qrStatus.textContent = 'âš ï¸ ì¹´ë©”ë¼ ì‚¬ìš©ì„ ìœ„í•´ HTTPSê°€ í•„ìš”í•©ë‹ˆë‹¤. ngrokì„ ì‚¬ìš©í•˜ê±°ë‚˜ ì„œë²„ë¥¼ ë°°í¬í•´ì£¼ì„¸ìš”.';
        qrStatus.style.background = '#fff3cd';
        qrStatus.style.color = '#856404';
        showStatus('HTTPSê°€ í•„ìš”í•©ë‹ˆë‹¤. HTTPì—ì„œëŠ” ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      // ë¯¸ë””ì–´ ë””ë°”ì´ìŠ¤ ì§€ì› í™•ì¸
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        qrStatus.textContent = 'âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì†¡ì¥ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        qrStatus.style.background = '#f8d7da';
        qrStatus.style.color = '#721c24';
        showStatus('ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.', 'error');
        return;
      }
      
      // jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
      if (typeof jsQR === 'undefined') {
        qrStatus.textContent = 'âš ï¸ QR ìŠ¤ìº” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì†¡ì¥ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        qrStatus.style.background = '#f8d7da';
        qrStatus.style.color = '#721c24';
        showStatus('QR ìŠ¤ìº” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      try {
        // ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
        qrStatus.textContent = 'ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­í•˜ëŠ” ì¤‘...';
        qrStatus.style.background = '#d1ecf1';
        qrStatus.style.color = '#0c5460';
        
        // ëª¨ë°”ì¼ì—ì„œëŠ” í›„ë©´ ì¹´ë©”ë¼ ìš°ì„  ì‚¬ìš©
        // í•´ìƒë„ë¥¼ ë‚®ì¶°ì„œ ë” ë„“ì€ ë²”ìœ„ ìŠ¤ìº” ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        const constraints = {
          video: {
            facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼
            width: { ideal: 640, max: 1280 },
            height: { ideal: 480, max: 720 }
          }
        };
        
        qrStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // ë¹„ë””ì˜¤ ìš”ì†Œ ì„¤ì •
        qrVideo.srcObject = qrStream;
        qrVideo.setAttribute('playsinline', 'true');
        qrVideo.setAttribute('webkit-playsinline', 'true');
        
        // ìŠ¤ìºë„ˆ UI í‘œì‹œ
        qrScanner.style.display = 'block';
        qrScanBtn.style.display = 'none';
        qrStatus.textContent = 'QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”.';
        qrStatus.style.background = '#d1ecf1';
        qrStatus.style.color = '#0c5460';
        
        // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘
        await qrVideo.play();
        
        // Canvas ìƒì„±
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        // ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ í›„ Canvas í¬ê¸° ì„¤ì •
        // Canvasë¥¼ ë¹„ë””ì˜¤ë³´ë‹¤ í¬ê²Œ ì„¤ì •í•˜ì—¬ ë” ë„“ì€ ì˜ì—­ ìŠ¤ìº”
        qrVideo.addEventListener('loadedmetadata', function(){
          // ë¹„ë””ì˜¤ì˜ ì „ì²´ í•´ìƒë„ë¥¼ Canvasì— ì‚¬ìš© (ì‘ì€ í™”ë©´ì´ì§€ë§Œ ì „ì²´ ì˜ì—­ ìŠ¤ìº”)
          canvas.width = qrVideo.videoWidth;
          canvas.height = qrVideo.videoHeight;
          console.log('ë¹„ë””ì˜¤ í¬ê¸°:', canvas.width, 'x', canvas.height);
        }, { once: true });
        
        // QR ì½”ë“œ ê°ì§€ ì‹œì‘ (jsQR ì‚¬ìš©)
        let scanAttempts = 0;
        qrScanInterval = setInterval(function(){
          if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA && canvas.width > 0 && canvas.height > 0) {
            try {
              // ë¹„ë””ì˜¤ì˜ ì „ì²´ í”„ë ˆì„ì„ Canvasì— ê·¸ë¦¬ê¸° (ì‘ì€ í™”ë©´ì´ì§€ë§Œ ì „ì²´ í•´ìƒë„ ì‚¬ìš©)
              context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
              
              // ì´ë¯¸ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì „ì²´ í•´ìƒë„)
              const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
              
              // jsQRë¡œ QR ì½”ë“œ ê°ì§€ (ë” ë„“ì€ ë²”ìœ„ì—ì„œ ì¸ì‹ ê°€ëŠ¥)
              // ì‘ì€ QR ì½”ë“œë„ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: 'attemptBoth',
              });
              
              if (code) {
                console.log('QR ì½”ë“œ ê°ì§€ë¨:', code.data);
                stopQRScan();
                
                // ì†¡ì¥ë²ˆí˜¸ ì…ë ¥ë€ì— ê°’ ì„¤ì •
                document.getElementById('trackingNumber').value = code.data;
                
                // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                qrStatus.textContent = 'âœ… QR ì½”ë“œ ì¸ì‹ ì™„ë£Œ! ìë™ìœ¼ë¡œ ê²€ìƒ‰ ì¤‘...';
                qrStatus.style.background = '#d4edda';
                qrStatus.style.color = '#155724';
                showStatus('QR ì½”ë“œê°€ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.', 'success');
                
                // ìë™ ê²€ìƒ‰ ì‹¤í–‰
                setTimeout(function(){
                  autoSearchAfterQR(code.data);
                }, 500);
              }
              
              scanAttempts++;
              // 100ë²ˆ ì‹œë„ í›„ ë¡œê·¸ (ë””ë²„ê¹…ìš©)
              if (scanAttempts % 100 === 0) {
                console.log('QR ìŠ¤ìº” ì‹œë„:', scanAttempts, 'íšŒ');
              }
            } catch (err) {
              console.error('QR ìŠ¤ìº” ì˜¤ë¥˜:', err);
              // ì˜¤ë¥˜ ë°œìƒí•´ë„ ê³„ì† ì‹œë„
            }
          }
        }, 150); // 150msë§ˆë‹¤ ìŠ¤ìº” (ì ë‹¹í•œ ì£¼ê¸°ë¡œ ì¡°ì •)
        
      } catch (error) {
        console.error('ì¹´ë©”ë¼ ì˜¤ë¥˜:', error);
        stopQRScan();
        
        // ì˜¤ë¥˜ ë©”ì‹œì§€ ê°œì„ 
        let errorMessage = 'ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          errorMessage = 'ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
          errorMessage = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
          errorMessage = 'ì¹´ë©”ë¼ê°€ ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.';
        } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
          errorMessage = 'ìš”ì²­í•œ ì¹´ë©”ë¼ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        }
        
        qrStatus.textContent = 'âš ï¸ ' + errorMessage + ' ì†¡ì¥ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        qrStatus.style.background = '#f8d7da';
        qrStatus.style.color = '#721c24';
        showStatus(errorMessage, 'error');
      }
    }
    
    
    // QR ìŠ¤ìº” í›„ ìë™ ê²€ìƒ‰ (ì›” ìë™ ì„ íƒ í¬í•¨)
    function autoSearchAfterQR(trackingNumber){
      console.log('ìë™ ê²€ìƒ‰ ì‹œì‘, ì†¡ì¥ë²ˆí˜¸:', trackingNumber);
      
      // ì´ë¯¸ ì›”ì´ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ê²€ìƒ‰
      const monthSelector = document.getElementById('monthSelector');
      if (monthSelector && monthSelector.value) {
        console.log('ì›”ì´ ì´ë¯¸ ì„ íƒë¨:', monthSelector.value);
        setTimeout(function(){
          fetchDataByTracking(trackingNumber);
        }, 300);
        return;
      }
      
      // ì›” ëª©ë¡ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
      let waitCount = 0;
      const checkSheets = setInterval(function(){
        waitCount++;
        if (availableSheets.length > 0) {
          clearInterval(checkSheets);
          console.log('ì›” ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', availableSheets);
          
          // í˜„ì¬ ì›”ì„ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒ
          const today = new Date();
          const currentMonth = `${today.getFullYear()}ë…„${today.getMonth()+1}ì›”`;
          
          // í˜„ì¬ ì›”ì´ ëª©ë¡ì— ìˆìœ¼ë©´ ì„ íƒ, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í•­ëª© ì„ íƒ
          let selectedMonth = currentMonth;
          if (!availableSheets.includes(currentMonth)) {
            selectedMonth = availableSheets[0] || '';
          }
          
          if (monthSelector && selectedMonth) {
            monthSelector.value = selectedMonth;
            console.log('ì›” ìë™ ì„ íƒ:', selectedMonth);
          }
          
          // ê²€ìƒ‰ ì‹¤í–‰
          setTimeout(function(){
            console.log('ìë™ ê²€ìƒ‰ ì‹¤í–‰');
            fetchDataByTracking(trackingNumber);
          }, 300);
        } else if (waitCount > 50) {
          // 5ì´ˆ ëŒ€ê¸° í›„ì—ë„ ëª©ë¡ì´ ì—†ìœ¼ë©´ íƒ€ì„ì•„ì›ƒ
          clearInterval(checkSheets);
          console.warn('ì›” ëª©ë¡ ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
          showStatus('ì›” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'error');
        }
      }, 100);
    }
    
    // QR ìŠ¤ìº” ì¤‘ë‹¨
    function stopQRScan(){
      console.log('QR ìŠ¤ìº” ì¤‘ë‹¨');
      
      // ìŠ¤ìº” ì¸í„°ë²Œ ì •ì§€
      if (qrScanInterval) {
        clearInterval(qrScanInterval);
        qrScanInterval = null;
      }
      
      // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì •ì§€
      if (qrStream) {
        qrStream.getTracks().forEach(track => {
          track.stop();
          console.log('ì¹´ë©”ë¼ íŠ¸ë™ ì •ì§€:', track.kind);
        });
        qrStream = null;
      }
      
      // ë¹„ë””ì˜¤ ìš”ì†Œ ì •ë¦¬
      const qrVideo = document.getElementById('qrVideo');
      if (qrVideo) {
        qrVideo.srcObject = null;
        qrVideo.pause();
      }
      
      // UI ë³µì›
      const qrScanner = document.getElementById('qrScanner');
      const qrScanBtn = document.getElementById('qrScanBtn');
      if (qrScanner) {
        qrScanner.style.display = 'none';
      }
      if (qrScanBtn) {
        qrScanBtn.style.display = 'inline-block';
      }
    }
    
    // ì†¡ì¥ë²ˆí˜¸ë¡œ ê²€ìƒ‰ (ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ)
    function searchByTracking(){
      const trackingInput = document.getElementById('trackingNumber');
      const trackingNumber = trackingInput ? trackingInput.value.trim() : '';
      
      if (!trackingNumber){
        showStatus('ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      fetchDataByTracking(trackingNumber);
    }
    
    function fetchDataByTracking(trackingNumber){
      const selectedMonth = document.getElementById('monthSelector').value;
      const cleaned = trackingNumber ? trackingNumber.toString().trim() : '';

      if (!selectedMonth){
        showStatus('ë¨¼ì € ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      if (!cleaned){
        showStatus('ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      showStatus(`${selectedMonth}ì—ì„œ ë°ì´í„° ì¡°íšŒ ì¤‘...`, 'loading');

      fetch(`/api/uploads/find-by-tracking?trackingNumber=${encodeURIComponent(cleaned)}&month=${encodeURIComponent(selectedMonth)}`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.data){
            fillFormWithData(data.data);
            showStatus('QR ë°ì´í„° ì¡°íšŒ ì™„ë£Œ! ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'success');
          }else{
            clearFormData(cleaned);
            showStatus(`${selectedMonth}ì—ì„œ í•´ë‹¹ ì†¡ì¥ë²ˆí˜¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
          }
        })
        .catch(error => {
          console.error('QR ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
          showStatus('QR ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ' + error.message, 'error');
        });
    }

    function fillFormWithData(data){
      document.getElementById('company').value        = data.company || '';
      document.getElementById('product').value        = data.product || '';
      document.getElementById('customer').value       = data.customer || '';
      document.getElementById('trackingNumber').value = data.trackingNumber || '';
    }

    function clearFormData(trackingValue){
      document.getElementById('company').value = '';
      document.getElementById('product').value = '';
      document.getElementById('customer').value = '';
      document.getElementById('trackingNumber').value = trackingValue || '';
    }
  </script>
</body>
</html>
