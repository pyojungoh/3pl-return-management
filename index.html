<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ë°˜í’ˆêµí™˜">
  <meta name="theme-color" content="#4CAF50">
  <title>ë°˜í’ˆêµí™˜ ë“±ë¡</title>


  <style>
    /* ========= ìœ ë™ ìŠ¤ì¼€ì¼ ë³€ìˆ˜: í™”ë©´í­ì— ë”°ë¼ ìë™ ì¡°ì • =========
       - baseWidth 430px(ì¼ë°˜ í° ê¸°ì¤€) ëŒ€ë¹„ ë¹„ìœ¨ì„ ì¡ë˜ ê³¼í•˜ê²Œ í¬ê±°ë‚˜ ì‘ì•„ì§€ëŠ” ê²ƒ ë°©ì§€
       - í°íŠ¸/ì¹¸/ë²„íŠ¼/ì¸ë„¤ì¼ ëª¨ë‘ clamp()ë¡œ ë°˜ì‘í˜•
    */
:root{
  --fs-body:  clamp(32px, 8.4vw, 40px);
  --fs-label: clamp(32px, 9.2vw, 44px);
  --fs-input: clamp(32px, 9.6vw, 44px);
  --fs-btn:   clamp(32px, 10vw, 44px);
  --fs-title: clamp(36px, 11.2vw, 52px);

  --h-control: clamp(44px, 19vw, 88px);
  --h-button:  clamp(52px, 22vw, 100px);

  --pad-v:     clamp(8px, 2.4vh, 20px);
  --pad-h:     clamp(16px, 6.4vw, 32px);
  --radius:    clamp(12px, 4.8vw, 20px);
  --gap:       clamp(16px, 4.8vw, 32px);

  --thumb:     clamp(112px, 36vw, 200px);
  --status-fs: clamp(28px, 8vw, 36px);
}

    *{ box-sizing: border-box; }
    html, body { height: 100%; -webkit-overflow-scrolling: touch; }
    body{
  margin: 0;
  padding: 0;
  background:#fff;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  font-size: var(--fs-body);
  line-height: 1.35;
  -webkit-text-size-adjust: 100%;
}

    .container{
  width: 100vw;              /* í™”ë©´ ê°€ë¡œ ê½‰ ì°¨ê²Œ */
  max-width: 100vw;
  margin: 0;
  background: #fff;
  /* ë…¸ì¹˜/í™ˆë°” ì•ˆì „ ì—¬ë°± + ë‚´ë¶€ íŒ¨ë”© ë™ì‹œ ë°˜ì˜ */
  padding: max(env(safe-area-inset-top, 0px), clamp(8px, 2.6vw, 20px))
           max(env(safe-area-inset-right, 0px), clamp(8px, 2.6vw, 20px))
           max(env(safe-area-inset-bottom, 0px), clamp(8px, 2.6vw, 20px))
           max(env(safe-area-inset-left, 0px), clamp(8px, 2.6vw, 20px));
  border-radius: 0;          /* ê°€ì¥ìë¦¬ ë¼ìš´ë“œ ì œê±° */
  box-shadow: none;          /* ì¹´ë“œ ê·¸ë¦¼ì ì œê±° (í’€ë¸”ë¦¬ë“œ) */
  min-height: 100dvh;        /* í™”ë©´ ë†’ì´ ê½‰ ì°¨ê²Œ */
}


    h2{
      margin: 0 0 var(--gap);
      text-align: center;
      color: #222;
      font-size: var(--fs-title);
      font-weight: 800;
      letter-spacing: -0.2px;
    }

    .form-group{ margin-bottom: calc(var(--gap) * 0.8); }

    label{
      display:block;
      margin-bottom: clamp(2px, 1vw, 6px);
      color:#222;
      font-weight: 700;
      font-size: var(--fs-label);
      letter-spacing: -0.2px;
    }

    input, select, textarea{
      width:100%;
      border: 1.5px solid #ddd;
      border-radius: var(--radius);
      background:#fff;
      font-size: var(--fs-input);
      padding: calc(var(--pad-v) * 0.8) var(--pad-h);
      min-height: var(--h-control);
      transition: border-color .2s ease, box-shadow .2s ease, transform .02s ease;
      -webkit-appearance: none; appearance: none;
    }
    input[type="number"]{ text-align:center; font-weight:700; }
    input[readonly]{ background:#f8f9fa; color:#555; }

    textarea{ min-height: calc(var(--h-control) * 1.6); resize: vertical; }

    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:#4CAF50;
      box-shadow:0 0 0 3px rgba(76,175,80,0.12);
    }

    button{
      display:inline-flex; align-items:center; justify-content:center;
      width:100%;
      border:none; border-radius: var(--radius);
      background:#4CAF50; color:#fff;
      font-size: var(--fs-btn); font-weight: 800;
      padding: calc(var(--pad-v) * 0.8) var(--pad-h);
      min-height: var(--h-button);
      margin: clamp(4px, 1.6vw, 8px) 0;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease;
      -webkit-tap-highlight-color: transparent;
      letter-spacing:-0.2px;
    }
    button:hover, button:active{ background:#45a049; transform: translateY(-1px); }
    button:disabled{ background:#bdbdbd; transform:none; cursor:not-allowed; }

    .scan-btn{ background:#2196F3; }
    .scan-btn:hover,.scan-btn:active{ background:#1976D2; }

    .photo-btn{ background:#FF9800; }
    .photo-btn:hover,.photo-btn:active{ background:#F57C00; }

    .refresh-btn{ background:#607D8B; }
    .refresh-btn:hover{ background:#455A64; }

    .test-btn{ background:#9C27B0; }
    .test-btn:hover{ background:#7B1FA2; }

    .month-selector{
      background:#e3f2fd;
      border: 1.5px solid #2196F3;
      color:#0D47A1;
      font-weight: 700;
    }
    .month-selector:focus{ border-color:#1976D2; box-shadow:0 0 0 3px rgba(33,150,243,0.12); }

    .preview{ margin-top: calc(var(--gap) * 0.6); display:none; text-align:center; }
    .preview .photo-item{ display:inline-block; margin: clamp(4px, 1.6vw, 8px); text-align:center; vertical-align:top; }
    .preview img{
      width: var(--thumb);
      height: var(--thumb);
      object-fit: cover;
      border-radius: var(--radius);
      border: 1.5px solid #ddd;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
      display:block; margin-bottom: clamp(2px, 1vw, 6px);
    }
    .photo-label{ font-size: clamp(12px, 3.6vw, 16px); color:#666; font-weight:600; }

    .delete-btn{
      background:#f44336; color:#fff; border:none; border-radius:50%;
      width: clamp(18px, 5.2vw, 24px); height: clamp(18px, 5.2vw, 24px);
      font-size: clamp(11px, 3.4vw, 13px);
      cursor:pointer; padding:0;
      display:inline-flex; align-items:center; justify-content:center;
    }

    .qr-status{
      margin-top: clamp(6px, 2vw, 12px);
      color:#0D47A1;
      font-size: clamp(14px, 4vw, 18px);
      font-weight: 600;
      background:#e3f2fd;
      border:1.5px solid rgba(33,150,243,0.35);
      padding: clamp(6px, 2vw, 12px);
      border-radius: var(--radius);
      text-align:center;
    }
    
    .cancel-btn{
      background:#9e9e9e;
      color:#fff;
    }
    
    .cancel-btn:hover,
    .cancel-btn:active{
      background:#757575;
    }

    .status{
      padding: clamp(8px, 2.2vw, 14px);
      margin: var(--gap) 0;
      border-radius: var(--radius);
      text-align:center;
      font-weight:700;
      font-size: var(--status-fs);
    }
    .success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .error{   background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .loading{ background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }

    /* ì „ì²´ í™”ë©´ ì§„í–‰ ì˜¤ë²„ë ˆì´(ì—…ë¡œë“œ/ì €ì¥ ë™ì•ˆ) */
    .overlay{
      position:fixed; inset:0; z-index:9999;
      background:rgba(0,0,0,0.45);
      display:none; align-items:center; justify-content:center;
      backdrop-filter: blur(1px);
    }
    .overlay.show{ display:flex; }
    .overlay-card{
      background:#fff;
      width: min(86vw, 420px);
      padding: clamp(12px, 3.2vw, 18px);
      border-radius: calc(var(--radius) + 2px);
      box-shadow: 0 12px 36px rgba(0,0,0,0.22);
      text-align:center;
    }
    .spinner{
      width: clamp(28px, 8vw, 40px); height: clamp(28px, 8vw, 40px);
      border: 3px solid #e0e0e0; border-top-color:#4CAF50;
      border-radius:50%; margin: 0 auto clamp(6px, 2vw, 10px);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .overlay-title{ font-size: clamp(16px, 4.6vw, 20px); font-weight: 800; color:#222; margin-bottom: clamp(4px, 1.4vw, 8px); }
    .overlay-desc{  font-size: clamp(13px, 3.8vw, 16px); color:#555; margin-bottom: clamp(6px, 1.8vw, 10px); }
    .progressbar{ width:100%; height: clamp(5px, 1.2vw, 8px); background:#eee; border-radius:999px; overflow:hidden; }
    .progressbar>div{ width:0%; height:100%; background:#4CAF50; transition: width .25s ease; }

    /* í„°ì¹˜ ì¥ì¹˜ì—ì„œ í˜¸ë²„ ì• ë‹ˆë©”ì´ì…˜ ì¶•ì†Œ */
    @media (hover:none) and (pointer:coarse){
      button:hover{ transform:none; }
      button:active{ transform: scale(0.98); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ë°˜í’ˆêµí™˜ ë“±ë¡</h2>

    <form id="returnForm">
      <!-- ì›” ì„ íƒ -->
      <div class="form-group">
        <label>ğŸ“… ê²€ìƒ‰í•  ì›”</label>
        <select id="monthSelector" class="month-selector" required>
          <option value="">ì›” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
        </select>
        <button type="button" class="refresh-btn" onclick="loadAvailableSheets()">ğŸ”„ ì›” ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <!-- QR ê²€ìƒ‰ ì•ˆë‚´ -->
      <div class="form-group">
        <label>ğŸ“· QR ì½”ë“œ ìŠ¤ìº”</label>
        <button type="button" class="scan-btn" onclick="startQRScan()" id="qrScanBtn">ğŸ“· QR ì½”ë“œ ìŠ¤ìº”</button>
        <div id="qrStatus" class="qr-status">QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜ ì†¡ì¥ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</div>
        <div id="qrScanner" style="display:none; margin-top: 10px;">
          <video id="qrVideo" autoplay playsinline style="width: 100%; max-width: 400px; border-radius: 8px;"></video>
          <button type="button" class="cancel-btn" onclick="stopQRScan()" style="margin-top: 10px; width: 100%;">â¹ï¸ ìŠ¤ìº” ì¤‘ë‹¨</button>
        </div>
      </div>

      <!-- ì†¡ì¥ë²ˆí˜¸ ê²€ìƒ‰ -->
      <div class="form-group">
        <label>ì†¡ì¥ë²ˆí˜¸</label>
        <input type="text" id="trackingNumber" placeholder="QR ìŠ¤ìº” ë˜ëŠ” ì†¡ì¥ë²ˆí˜¸ ì§ì ‘ ì…ë ¥" required>
        <button type="button" class="scan-btn" onclick="searchByTracking()">ğŸ” ê²€ìƒ‰</button>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ í™•ì¸ -->
      <div class="form-group">
        <label>í™”ì£¼ëª…</label>
        <input type="text" id="company" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>
      <div class="form-group">
        <label>ì œí’ˆ</label>
        <input type="text" id="product" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>
      <div class="form-group">
        <label>ê³ ê°ëª… (í™•ì¸)</label>
        <input type="text" id="customer" placeholder="ê²€ìƒ‰ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
      </div>

      <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
      <div class="form-group">
        <label>ì‚¬ì§„ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</label>
        <input type="file" id="photos" accept="image/*" multiple capture="camera" style="display:none;">
        <button type="button" class="photo-btn" onclick="document.getElementById('photos').click()">ğŸ“· ì‚¬ì§„ ì°ê¸°</button>
        <div id="photoPreview" class="preview"></div>
        <div id="photoCount" style="margin-top: 6px; color:#666; text-align:center; font-size: clamp(13px, 3.8vw, 16px);"></div>
      </div>

      <!-- ì œì¶œ -->
      <button type="submit" id="submitBtn">ë“±ë¡í•˜ê¸°</button>
      <button type="button" onclick="testConnection()" class="test-btn">ğŸ”§ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    </form>

    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div id="statusMessage" style="display:none;"></div>
  </div>

  <!-- ì—…ë¡œë“œ/ì €ì¥ ì§„í–‰ ì˜¤ë²„ë ˆì´ -->
  <div id="overlay" class="overlay" role="alert" aria-live="assertive">
    <div class="overlay-card">
      <div class="spinner"></div>
      <div id="overlayTitle" class="overlay-title">ì¤€ë¹„ ì¤‘â€¦</div>
      <div id="overlayDesc"  class="overlay-desc">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
      <div class="progressbar"><div id="overlayBar"></div></div>
    </div>
  </div>

  <script>
    let selectedImages = [];
    let availableSheets = [];
    let overlayTimer = null;
    let pseudoProgress = 0;

    document.addEventListener('DOMContentLoaded', function () {
      loadAvailableSheets();

      document.getElementById('photos').addEventListener('change', function(e){
        handleImageSelection(e.target.files);
      });

      document.getElementById('returnForm').addEventListener('submit', function(e){
        e.preventDefault();
        submitForm();
      });
      
      // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
      document.getElementById('trackingNumber').addEventListener('keypress', function(e){
        if (e.key === 'Enter'){
          e.preventDefault();
          searchByTracking();
        }
      });
    });

    /* ========== ì§„í–‰ ì˜¤ë²„ë ˆì´ ========== */
    function showOverlay(titleText, descText){
      const overlay = document.getElementById('overlay');
      const title = document.getElementById('overlayTitle');
      const desc  = document.getElementById('overlayDesc');
      const bar   = document.getElementById('overlayBar');

      title.textContent = titleText || 'ì²˜ë¦¬ ì¤‘â€¦';
      desc.textContent  = descText  || 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
      pseudoProgress = 0;
      bar.style.width = '0%';
      overlay.classList.add('show');

      clearInterval(overlayTimer);
      overlayTimer = setInterval(() => {
        if (pseudoProgress < 92){
          pseudoProgress += Math.random()*6 + 2; // 2~8%
          if (pseudoProgress > 92) pseudoProgress = 92;
          bar.style.width = pseudoProgress.toFixed(0) + '%';
        }
      }, 320);
    }
    function updateOverlay(titleText, descText){
      if (titleText) document.getElementById('overlayTitle').textContent = titleText;
      if (descText)  document.getElementById('overlayDesc').textContent  = descText;
    }
    function fillOverlayBar(){ document.getElementById('overlayBar').style.width = '100%'; }
    function hideOverlay(){ clearInterval(overlayTimer); document.getElementById('overlay').classList.remove('show'); }

    /* ========== ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ ========== */
    function loadAvailableSheets(){
      showStatus('ì›” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');
      google.script.run
        .withSuccessHandler(function(sheets){
          availableSheets = sheets || [];
          const sel = document.getElementById('monthSelector');
          sel.innerHTML = '';

          if (availableSheets.length === 0){
            const o = document.createElement('option');
            o.value = '';
            o.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ì›”ì´ ì—†ìŠµë‹ˆë‹¤';
            sel.appendChild(o);
            showStatus('ì‚¬ìš© ê°€ëŠ¥í•œ ì›” ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
          }

          availableSheets.forEach(name=>{
            const o = document.createElement('option');
            o.value = name; o.textContent = name;
            sel.appendChild(o);
          });

          const today = new Date();
          const current = `${today.getFullYear()}ë…„${today.getMonth()+1}ì›”`;
          let found = availableSheets.find(s=> s===current)
              || availableSheets.find(s=> s.replace(/\s/g,'').toLowerCase() === current.replace(/\s/g,'').toLowerCase());
          sel.value = found || availableSheets[0];
          showStatus(`í˜„ì¬ ì›” ${sel.value}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        })
        .withFailureHandler(function(error){
          showStatus('ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
          const sel = document.getElementById('monthSelector');
          sel.innerHTML = '';
          const o = document.createElement('option');
          o.value = '';
          o.textContent = 'ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ - ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼';
          sel.appendChild(o);
        })
        .getAvailableSheets();
    }

    /* ========== ì´ë¯¸ì§€ ì„ íƒ/ë¯¸ë¦¬ë³´ê¸° ========== */
    function handleImageSelection(files){
      if (!files || files.length === 0) return;
      Array.from(files).forEach(file=>{
        if (file.type.startsWith('image/')){
          const reader = new FileReader();
          reader.onload = e=>{
            selectedImages.push(e.target.result); // base64 ì €ì¥
            updatePhotoPreview();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function updatePhotoPreview(){
      const preview = document.getElementById('photoPreview');
      const photoCount = document.getElementById('photoCount');
      preview.innerHTML = '';

      if (selectedImages.length > 0){
        preview.style.display = 'block';
        photoCount.textContent = `ì„ íƒëœ ì‚¬ì§„: ${selectedImages.length}ì¥`;
        selectedImages.forEach((imgData, idx)=>{
          const wrap = document.createElement('div');
          wrap.className = 'photo-item';

          const img = document.createElement('img');
          img.src = imgData;

          const label = document.createElement('div');
          label.className = 'photo-label';
          label.textContent = `ì‚¬ì§„ ${idx+1}`;

          const del = document.createElement('button');
          del.className = 'delete-btn'; del.type='button'; del.innerHTML='Ã—';
          del.onclick = ()=> removePhoto(idx);

          wrap.appendChild(img); wrap.appendChild(label); wrap.appendChild(del);
          preview.appendChild(wrap);
        });
      }else{
        preview.style.display = 'none';
        photoCount.textContent = '';
      }
    }

    function removePhoto(index){
      selectedImages.splice(index,1);
      updatePhotoPreview();
    }

    /* ========== ì œì¶œ ========== */
    function submitForm(){
      const btn = document.getElementById('submitBtn');
      const selectedMonth = document.getElementById('monthSelector').value;
      const trackingNumber = document.getElementById('trackingNumber').value.trim();

      if (!selectedMonth) return showStatus('ì›”ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'error');
      if (!trackingNumber) return showStatus('ë¨¼ì € QR ì½”ë“œë¡œ ì ‘ì†í•˜ê±°ë‚˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');

      // UI ì ê¸ˆ + ì§„í–‰ ì˜¤ë²„ë ˆì´
      btn.disabled = true;
      btn.textContent = 'ë“±ë¡ ì¤‘â€¦';
      if (selectedImages.length > 0){
        showOverlay('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘â€¦', `ì´ ${selectedImages.length}ì¥ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`);
      }else{
        showOverlay('ì €ì¥ ì¤‘â€¦', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
      }

      const formData = {
        trackingNumber,
        company:  document.getElementById('company').value.trim(),
        product:  document.getElementById('product').value.trim(),
        customer: document.getElementById('customer').value.trim(),
        selectedMonth
      };

      if (selectedImages.length > 0){
        google.script.run
          .withSuccessHandler(function(photoLinks){
            updateOverlay('ì‚¬ì§„ ë§í¬ ì €ì¥ ì¤‘â€¦', 'ì‹œíŠ¸ì— ë§í¬ë¥¼ ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
            document.getElementById('overlayBar').style.width = '96%';
            formData.photoLinks = photoLinks;
            saveData(formData);
          })
          .withFailureHandler(function(error){
            hideOverlay();
            showStatus('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            btn.disabled = false;
            btn.textContent = 'ë“±ë¡í•˜ê¸°';
          })
          .uploadImages(selectedImages, trackingNumber);
      }else{
        updateOverlay('ì €ì¥ ì¤‘â€¦', 'ì‹œíŠ¸ì— ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
        saveData(formData);
      }
    }

    function saveData(formData){
      google.script.run
        .withSuccessHandler(function(result){
          fillOverlayBar();
          setTimeout(hideOverlay, 240);

          showStatus(result, 'success');
          document.getElementById('returnForm').reset();
          document.getElementById('photoPreview').style.display = 'none';
          selectedImages = [];

          const btn = document.getElementById('submitBtn');
          btn.disabled = false;
          btn.textContent = 'ë“±ë¡í•˜ê¸°';

          if (formData.selectedMonth){
            document.getElementById('monthSelector').value = formData.selectedMonth;
          }
          document.getElementById('statusMessage').scrollIntoView({behavior:'smooth', block:'center'});
        })
        .withFailureHandler(function(error){
          hideOverlay();
          showStatus('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
          const btn = document.getElementById('submitBtn');
          btn.disabled = false;
          btn.textContent = 'ë“±ë¡í•˜ê¸°';
        })
        .addReturnData(formData);
    }

    /* ========== í…ŒìŠ¤íŠ¸ ========== */
    function testConnection(){
      google.script.run
        .withSuccessHandler(result=> alert('ì—°ê²° ì„±ê³µ: ' + result))
        .withFailureHandler(error=> alert('ì—°ê²° ì‹¤íŒ¨: ' + error))
        .simpleTest();
    }

    /* ========== ìƒíƒœ ë©”ì‹œì§€ ========== */
    function showStatus(message, type){
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = 'status ' + type;
      el.style.display = 'block';
    }


    // QR ìŠ¤ìº” ê´€ë ¨ ë³€ìˆ˜
    let qrStream = null;
    let qrScanInterval = null;
    let barcodeDetector = null;
    
    // QR ìŠ¤ìº” ì‹œì‘ (ë¸Œë¼ìš°ì € ë„¤ì´í‹°ë¸Œ API ì‚¬ìš©)
    async function startQRScan(){
      const qrStatus = document.getElementById('qrStatus');
      const qrScanner = document.getElementById('qrScanner');
      const qrVideo = document.getElementById('qrVideo');
      const qrScanBtn = document.getElementById('qrScanBtn');
      
      try {
        // BarcodeDetector API ì§€ì› í™•ì¸
        if ('BarcodeDetector' in window) {
          barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
        } else {
          // BarcodeDetectorê°€ ì—†ìœ¼ë©´ jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹œë„
          if (typeof jsQR === 'undefined') {
            // jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë“œ
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
            script.onload = function(){
              startQRScanWithLibrary();
            };
            script.onerror = function(){
              qrStatus.textContent = 'QR ìŠ¤ìº”ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì†¡ì¥ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
              qrStatus.style.background = '#f8d7da';
              qrStatus.style.color = '#721c24';
            };
            document.head.appendChild(script);
            return;
          } else {
            startQRScanWithLibrary();
            return;
          }
        }
        
        // ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
        qrStatus.textContent = 'ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì¤‘...';
        qrStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        
        qrVideo.srcObject = qrStream;
        qrScanner.style.display = 'block';
        qrScanBtn.style.display = 'none';
        qrStatus.textContent = 'QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”.';
        qrStatus.style.background = '#d1ecf1';
        qrStatus.style.color = '#0c5460';
        
        // QR ì½”ë“œ ê°ì§€ ì‹œì‘
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        qrVideo.addEventListener('loadedmetadata', function(){
          canvas.width = qrVideo.videoWidth;
          canvas.height = qrVideo.videoHeight;
        });
        
        qrScanInterval = setInterval(async function(){
          if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA && canvas.width > 0) {
            try {
              context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
              const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
              const barcodes = await barcodeDetector.detect(imageData);
              if (barcodes.length > 0) {
                const qrData = barcodes[0].rawValue;
                stopQRScan();
                document.getElementById('trackingNumber').value = qrData;
                qrStatus.textContent = 'QR ì½”ë“œ ì¸ì‹ ì™„ë£Œ! ìë™ìœ¼ë¡œ ê²€ìƒ‰ ì¤‘...';
                qrStatus.style.background = '#d4edda';
                qrStatus.style.color = '#155724';
                showStatus('QR ì½”ë“œê°€ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.', 'success');
                // ìë™ ê²€ìƒ‰ ì‹¤í–‰ (ì›” ìë™ ì„ íƒ í¬í•¨)
                autoSearchAfterQR(qrData);
              }
            } catch (err) {
              // ê°ì§€ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (ê³„ì† ì‹œë„)
            }
          }
        }, 200);
        
      } catch (error) {
        console.error('QR ìŠ¤ìº” ì˜¤ë¥˜:', error);
        qrStatus.textContent = 'ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì†¡ì¥ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        qrStatus.style.background = '#f8d7da';
        qrStatus.style.color = '#721c24';
        if (qrStream) {
          qrStream.getTracks().forEach(track => track.stop());
        }
      }
    }
    
    // jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
    function startQRScanWithLibrary(){
      const qrStatus = document.getElementById('qrStatus');
      const qrScanner = document.getElementById('qrScanner');
      const qrVideo = document.getElementById('qrVideo');
      const qrScanBtn = document.getElementById('qrScanBtn');
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      }).then(function(stream){
        qrStream = stream;
        qrVideo.srcObject = stream;
        qrScanner.style.display = 'block';
        qrScanBtn.style.display = 'none';
        qrStatus.textContent = 'QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”.';
        qrStatus.style.background = '#d1ecf1';
        qrStatus.style.color = '#0c5460';
        
        qrVideo.addEventListener('loadedmetadata', function(){
          canvas.width = qrVideo.videoWidth;
          canvas.height = qrVideo.videoHeight;
        });
        
        qrScanInterval = setInterval(function(){
          if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
            context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
              stopQRScan();
              document.getElementById('trackingNumber').value = code.data;
              qrStatus.textContent = 'QR ì½”ë“œ ì¸ì‹ ì™„ë£Œ! ìë™ìœ¼ë¡œ ê²€ìƒ‰ ì¤‘...';
              qrStatus.style.background = '#d4edda';
              qrStatus.style.color = '#155724';
              showStatus('QR ì½”ë“œê°€ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.', 'success');
              // ìë™ ê²€ìƒ‰ ì‹¤í–‰ (ì›” ìë™ ì„ íƒ í¬í•¨)
              autoSearchAfterQR(code.data);
            }
          }
        }, 100);
      }).catch(function(error){
        console.error('ì¹´ë©”ë¼ ì˜¤ë¥˜:', error);
        qrStatus.textContent = 'ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì†¡ì¥ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        qrStatus.style.background = '#f8d7da';
        qrStatus.style.color = '#721c24';
      });
    }
    
    // QR ìŠ¤ìº” í›„ ìë™ ê²€ìƒ‰ (ì›” ìë™ ì„ íƒ í¬í•¨)
    function autoSearchAfterQR(trackingNumber){
      console.log('ìë™ ê²€ìƒ‰ ì‹œì‘, ì†¡ì¥ë²ˆí˜¸:', trackingNumber);
      
      // ì´ë¯¸ ì›”ì´ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ê²€ìƒ‰
      const monthSelector = document.getElementById('monthSelector');
      if (monthSelector && monthSelector.value) {
        console.log('ì›”ì´ ì´ë¯¸ ì„ íƒë¨:', monthSelector.value);
        setTimeout(function(){
          fetchDataByTracking(trackingNumber);
        }, 300);
        return;
      }
      
      // ì›” ëª©ë¡ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
      let waitCount = 0;
      const checkSheets = setInterval(function(){
        waitCount++;
        if (availableSheets.length > 0) {
          clearInterval(checkSheets);
          console.log('ì›” ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', availableSheets);
          
          // í˜„ì¬ ì›”ì„ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒ
          const today = new Date();
          const currentMonth = `${today.getFullYear()}ë…„${today.getMonth()+1}ì›”`;
          
          // í˜„ì¬ ì›”ì´ ëª©ë¡ì— ìˆìœ¼ë©´ ì„ íƒ, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í•­ëª© ì„ íƒ
          let selectedMonth = currentMonth;
          if (!availableSheets.includes(currentMonth)) {
            selectedMonth = availableSheets[0] || '';
          }
          
          if (monthSelector && selectedMonth) {
            monthSelector.value = selectedMonth;
            console.log('ì›” ìë™ ì„ íƒ:', selectedMonth);
          }
          
          // ê²€ìƒ‰ ì‹¤í–‰
          setTimeout(function(){
            console.log('ìë™ ê²€ìƒ‰ ì‹¤í–‰');
            fetchDataByTracking(trackingNumber);
          }, 300);
        } else if (waitCount > 50) {
          // 5ì´ˆ ëŒ€ê¸° í›„ì—ë„ ëª©ë¡ì´ ì—†ìœ¼ë©´ íƒ€ì„ì•„ì›ƒ
          clearInterval(checkSheets);
          console.warn('ì›” ëª©ë¡ ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
          showStatus('ì›” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'error');
        }
      }, 100);
    }
    
    // QR ìŠ¤ìº” ì¤‘ë‹¨
    function stopQRScan(){
      if (qrScanInterval) {
        clearInterval(qrScanInterval);
        qrScanInterval = null;
      }
      if (qrStream) {
        qrStream.getTracks().forEach(track => track.stop());
        qrStream = null;
      }
      const qrVideo = document.getElementById('qrVideo');
      if (qrVideo) {
        qrVideo.srcObject = null;
      }
      document.getElementById('qrScanner').style.display = 'none';
      document.getElementById('qrScanBtn').style.display = 'inline-block';
    }
    
    // ì†¡ì¥ë²ˆí˜¸ë¡œ ê²€ìƒ‰ (ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ)
    function searchByTracking(){
      const trackingInput = document.getElementById('trackingNumber');
      const trackingNumber = trackingInput ? trackingInput.value.trim() : '';
      
      if (!trackingNumber){
        showStatus('ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      fetchDataByTracking(trackingNumber);
    }
    
    function fetchDataByTracking(trackingNumber){
      const selectedMonth = document.getElementById('monthSelector').value;
      const cleaned = trackingNumber ? trackingNumber.toString().trim() : '';

      if (!selectedMonth){
        showStatus('ë¨¼ì € ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      if (!cleaned){
        showStatus('ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      showStatus(`${selectedMonth}ì—ì„œ ë°ì´í„° ì¡°íšŒ ì¤‘...`, 'loading');

      google.script.run
        .withSuccessHandler(function(data){
          if (data){
            fillFormWithData(data);
            showStatus('QR ë°ì´í„° ì¡°íšŒ ì™„ë£Œ! ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'success');
          }else{
            clearFormData(cleaned);
            showStatus(`${selectedMonth}ì—ì„œ í•´ë‹¹ ì†¡ì¥ë²ˆí˜¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
          }
        })
        .withFailureHandler(function(error){
          showStatus('QR ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ' + error, 'error');
        })
        .findDataByTrackingNumber(cleaned, selectedMonth);
    }

    function fillFormWithData(data){
      document.getElementById('company').value        = data.company || '';
      document.getElementById('product').value        = data.product || '';
      document.getElementById('customer').value       = data.customer || '';
      document.getElementById('trackingNumber').value = data.trackingNumber || '';
    }

    function clearFormData(trackingValue){
      document.getElementById('company').value = '';
      document.getElementById('product').value = '';
      document.getElementById('customer').value = '';
      document.getElementById('trackingNumber').value = trackingValue || '';
    }
  </script>
</body>
</html>
