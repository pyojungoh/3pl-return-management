<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŒŒë ˆíŠ¸ ë³´ê´€ë£Œ ê´€ë¦¬</title>
  <style>
    /* body ìŠ¤íƒ€ì¼ ì œê±° (dashboard_server.htmlì— í†µí•©ë˜ë¯€ë¡œ) */
    body {
      margin: 0;
      padding: 0;
      background: transparent;
    }
    /* íŒŒë ˆíŠ¸ ê´€ë¦¬ ë©”ë‰´ ì „ìš© ìŠ¤íƒ€ì¼ */
    #palContainer {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* í•˜ìœ„ ë©”ë‰´ë°” ìŠ¤íƒ€ì¼ */
    #palSubMenuBar {
      background: linear-gradient(135deg, #ffffff 0%, #fffef9 100%);
      border-bottom: 2px solid #ffeaa7;
      padding: 0;
      display: flex;
      gap: 0;
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
      z-index: 10;
      flex-shrink: 0;
    }
    
    .pal-sub-menu-btn {
      flex: 1;
      padding: 16px 20px;
      background: transparent;
      border: none;
      border-right: 1px solid #ffeaa7;
      color: #636e72;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      text-align: center;
    }
    
    .pal-sub-menu-btn:last-child {
      border-right: none;
    }
    
    .pal-sub-menu-btn:hover {
      background: #fff9e6;
      color: #ff6b35;
    }
    
    .pal-sub-menu-btn.active {
      background: linear-gradient(135deg, #fff9e6 0%, #ffeaa7 100%);
      color: #ff6b35;
      font-weight: 700;
    }
    
    .pal-sub-menu-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: #ff6b35;
    }
    
    /* ì½˜í…ì¸  ì˜ì—­ ìŠ¤íƒ€ì¼ */
    #palContentArea {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      background: transparent;
    }
    
    /* í™”ì£¼ì‚¬ ëª¨ë“œ: í•˜ìœ„ ë©”ë‰´ë°”ê°€ ìˆ¨ê²¨ì¡Œì„ ë•Œ ìƒë‹¨ íŒ¨ë”© ì¡°ì • */
    #palContentArea.pal-consignor-mode {
      padding-top: 20px;
    }
    
    .pal-content-page {
      display: none !important;
    }
    
    .pal-content-page.active {
      display: block !important;
    }
    
    /* ê´€ë¦¬ì ì „ìš© ì„¹ì…˜ (ê¸°ë³¸ ìˆ¨ê¹€) */
    .pal-admin-only {
      display: none;
    }
    
    /* ê´€ë¦¬ìì¼ ë•Œ ê´€ë¦¬ì ì „ìš© ì„¹ì…˜ í‘œì‹œ (í•˜ì§€ë§Œ í˜ì´ì§€ëŠ” active í´ë˜ìŠ¤ë¡œë§Œ ì œì–´) */
    .pal-admin-only.pal-content-page.active {
      display: block !important;
    }
    
    /* í™”ì£¼ì‚¬ ì „ìš© ì„¹ì…˜ (ê¸°ë³¸ ìˆ¨ê¹€) */
    .pal-consignor-only {
      display: none;
    }
    
    /* ê³µí†µ ìŠ¤íƒ€ì¼ */
    .pal-section {
      margin-bottom: 20px;
    }
    
    .pal-toggle-btn {
      background: linear-gradient(135deg, #ffffff 0%, #fffef9 100%);
      width: 100%;
      text-align: left;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 14px;
      border: 2px solid #ffeaa7;
      color: #ff6b35;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.1);
    }
    
    .pal-toggle-btn:hover {
      background: linear-gradient(135deg, #fffef9 0%, #ffffff 100%);
      box-shadow: 0 6px 16px rgba(255, 152, 0, 0.15);
    }
    
    .pal-toggle-content {
      display: none;
      background: #ffffff;
      padding: 24px;
      border-radius: 0 0 14px 14px;
      border: 2px solid #ffeaa7;
      border-top: none;
      margin-top: -2px;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1);
    }
    
    .pal-filters {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .pal-filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .pal-filter-group label {
      color: #2d3436;
      font-weight: 600;
      font-size: 14px;
    }
    
    .pal-filter-group input,
    .pal-filter-group select {
      padding: 10px 14px;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      font-size: 14px;
      background: #ffffff;
      color: #2d3436;
    }
    
    .pal-filter-group input:focus,
    .pal-filter-group select:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    
    .pal-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #ff6b35 0%, #feca57 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
    }
    
    .pal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 107, 53, 0.35);
    }
    
    .pal-btn-secondary {
      background: linear-gradient(135deg, #b2bec3 0%, #95a5a6 100%);
      box-shadow: 0 4px 12px rgba(178, 190, 195, 0.25);
    }
    
    .pal-btn-secondary:hover {
      box-shadow: 0 6px 16px rgba(178, 190, 195, 0.35);
    }
    
    .pal-table-container {
      margin-top: 20px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1);
      border: 2px solid #ffeaa7;
      overflow: hidden;
    }
    
    /* í™”ì£¼ì‚¬ ëª©ë¡ ìŠ¤í¬ë¡¤ ê°•ì œ ì ìš© */
    #palCompaniesScrollArea {
      overflow-y: scroll !important;
      -webkit-overflow-scrolling: touch;
    }
    
    #palCompaniesScrollArea::-webkit-scrollbar {
      width: 6px;
    }
    
    #palCompaniesScrollArea::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    #palCompaniesScrollArea::-webkit-scrollbar-thumb {
      background: #ff6b35;
      border-radius: 3px;
    }
    
    #palCompaniesScrollArea::-webkit-scrollbar-thumb:hover {
      background: #feca57;
    }
    
    .pal-table-header {
      padding: 15px 20px 10px 20px;
      border-bottom: 2px solid #ffeaa7;
      background: linear-gradient(135deg, #fffef9 0%, #ffffff 100%);
    }
    
    .pal-table-header h3 {
      margin: 0;
      color: #ff6b35;
      font-weight: 700;
      font-size: 18px;
    }
    
    .pal-table-scroll-wrapper {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .pal-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1400px;
    }
    
    .pal-table thead {
      background: linear-gradient(135deg, #ff6b35 0%, #feca57 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .pal-table th {
      padding: 8px 6px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
    }
    
    .pal-table td {
      padding: 8px 6px;
      text-align: center;
      font-size: 12px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
      white-space: nowrap;
    }
    
    .pal-table tbody tr:hover {
      background: #fffef9;
    }
    
    .pal-table .no-data {
      text-align: center;
      padding: 40px;
      color: #636e72;
    }
    
    .pal-form-group {
      margin-bottom: 15px;
    }
    
    .pal-form-label {
      color: #2d3436;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
      font-size: 14px;
    }
    
    .pal-form-input {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      font-size: 14px;
      background: #ffffff;
      color: #2d3436;
    }
    
    .pal-form-input:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    
    .pal-searchable-select {
      position: relative;
      width: 100%;
    }
    
    .pal-searchable-select input[type="text"] {
      width: 100%;
      padding-right: 32px;
    }
    
    .pal-dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 2px solid #ffeaa7;
      border-radius: 10px;
      max-height: 220px;
      overflow-y: auto;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      z-index: 50;
      display: none;
      margin-top: 4px;
    }
    
    .pal-dropdown-list.show {
      display: block;
    }
    
    .pal-dropdown-item {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f5f5f5;
      transition: background-color 0.2s ease;
    }
    
    .pal-dropdown-item:last-child {
      border-bottom: none;
    }
    
    .pal-dropdown-item:hover {
      background: #fff9e6;
    }
    
    .pal-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      font-weight: 600;
    }
    
    .pal-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .pal-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .pal-message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* í’ˆëª© í•­ëª© ìŠ¤íƒ€ì¼ */
    .pal-product-item {
      background: #fff9e6;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }
    
    .pal-product-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pal-product-item-title {
      font-weight: 600;
      color: #ff6b35;
      font-size: 13px;
    }
    
    .pal-product-item-remove {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pal-product-item-remove:hover {
      background: #c82333;
    }
    
    .pal-product-item-content {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .pal-product-item-content input[type="text"] {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #ffeaa7;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .pal-product-quantity-control {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      border: 2px solid #ffeaa7;
      border-radius: 6px;
      padding: 4px;
    }
    
    .pal-product-quantity-btn {
      background: #ff6b35;
      color: white;
      border: none;
      border-radius: 4px;
      width: 28px;
      height: 28px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
    }
    
    .pal-product-quantity-btn:hover {
      background: #feca57;
    }
    
    .pal-product-quantity-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .pal-product-quantity-value {
      min-width: 40px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      color: #2d3436;
    }
    
    /* QR ìŠ¤ìº” ì˜ì—­ */
    .pal-qr-scanner {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .pal-qr-video {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .pal-qr-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 250px;
      border: 3px solid #ff6b35;
      border-radius: 12px;
      pointer-events: none;
    }
    
    .pal-qr-overlay::before,
    .pal-qr-overlay::after {
      content: '';
      position: absolute;
      width: 30px;
      height: 30px;
      border: 3px solid #ff6b35;
    }
    
    .pal-qr-overlay::before {
      top: -3px;
      left: -3px;
      border-right: none;
      border-bottom: none;
    }
    
    .pal-qr-overlay::after {
      bottom: -3px;
      right: -3px;
      border-left: none;
      border-top: none;
    }
    
    /* í†µê³„ ë°•ìŠ¤ */
    .pal-stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .pal-stat-box {
      flex: 1;
      min-width: 200px;
      background: linear-gradient(135deg, #fffef9 0%, #ffffff 100%);
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #ffeaa7;
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
    }
    
    .pal-stat-box-title {
      font-size: 14px;
      color: #636e72;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .pal-stat-box-value {
      font-size: 24px;
      color: #ff6b35;
      font-weight: 700;
    }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .pal-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      overflow-y: auto;
    }
    
    .pal-modal-content {
      max-width: 800px;
      margin: 50px auto;
      background: white;
      border-radius: 14px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .pal-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .pal-modal-header h2 {
      margin: 0;
      color: #ff6b35;
      font-weight: 700;
    }
    
    .pal-modal-close {
      background: #e17055;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .pal-modal-close:hover {
      background: #d63031;
    }
  </style>
</head>
<body>
  <div id="palContainer">
    <!-- í•˜ìœ„ ë©”ë‰´ë°” (ê´€ë¦¬ìë§Œ í‘œì‹œ) -->
    <div id="palSubMenuBar" class="pal-admin-only">
      <button class="pal-sub-menu-btn active" onclick="palSwitchSubMenu('list')">ğŸ“‹ ì›”ë³„ í™”ì£¼ì‚¬ë³„ ë¦¬ìŠ¤íŠ¸</button>
      <button class="pal-sub-menu-btn" onclick="palSwitchSubMenu('inbound')">ğŸ“¦ íŒŒë ˆíŠ¸ ê´€ë¦¬</button>
      <button class="pal-sub-menu-btn" onclick="palSwitchSubMenu('status')">ğŸ“Š íŒŒë ˆíŠ¸ í˜„í™©</button>
      <button class="pal-sub-menu-btn" onclick="palSwitchSubMenu('fee')">ğŸ’° ë³´ê´€ë£Œ ì„¤ì •</button>
      <button class="pal-sub-menu-btn" onclick="palSwitchSubMenu('label')">ğŸ·ï¸ ë¼ë²¨ ì¶œë ¥</button>
    </div>
    
    <!-- ì½˜í…ì¸  ì˜ì—­ -->
    <div id="palContentArea">
      <!-- ì›”ë³„ í™”ì£¼ì‚¬ë³„ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ -->
      <div id="palPageList" class="pal-content-page active">
        <h2 style="color: #ff6b35; font-weight: 700; margin-bottom: 20px;">ğŸ“‹ ì›”ë³„ í™”ì£¼ì‚¬ë³„ ë¦¬ìŠ¤íŠ¸</h2>
        
        <!-- ê¸°ê°„ ì„¤ì • (ê´€ë¦¬ìë§Œ í‘œì‹œ) -->
        <div class="pal-filters pal-admin-only" style="margin-bottom: 15px; display: flex; align-items: flex-end; gap: 8px; flex-wrap: nowrap;">
          <div class="pal-filter-group" style="margin-bottom: 0; flex: 0 0 auto;">
            <label style="font-size: 12px; margin-bottom: 4px;">ì •ì‚°ì›”</label>
            <input type="month" id="palSettlementMonth" class="pal-form-input" onchange="palLoadCompanyList()" style="padding: 6px 10px; font-size: 13px; width: 140px;">
          </div>
          <button class="pal-btn" onclick="palGenerateSettlement()" style="padding: 6px 14px; font-size: 12px; height: 32px; white-space: nowrap;">ì •ì‚° ìƒì„±</button>
        </div>
        
        <!-- í†µê³„ ë°•ìŠ¤ (í™”ì£¼ì‚¬ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ) -->
        <div class="pal-stats-container" id="palListStatsContainer" style="display: none; margin-bottom: 20px;">
          <div class="pal-stat-box">
            <div class="pal-stat-box-title">ì „ì²´ íŒŒë ˆíŠ¸</div>
            <div class="pal-stat-box-value" id="palListTotalPallets">0</div>
          </div>
          <div class="pal-stat-box">
            <div class="pal-stat-box-title">ë³´ê´€ì¤‘</div>
            <div class="pal-stat-box-value" id="palListStoragePallets">0</div>
          </div>
          <div class="pal-stat-box">
            <div class="pal-stat-box-title">ë³´ê´€ì¢…ë£Œ</div>
            <div class="pal-stat-box-value" id="palListCompletedPallets">0</div>
          </div>
          <div class="pal-stat-box">
            <div class="pal-stat-box-title">ì´ë²ˆë‹¬ ë³´ê´€ë£Œ</div>
            <div class="pal-stat-box-value" id="palListMonthlyFee">0ì›</div>
          </div>
        </div>
        
        <!-- ì™¼ìª½: í™”ì£¼ì‚¬ ëª©ë¡ (ê´€ë¦¬ìë§Œ), ì˜¤ë¥¸ìª½: ì •ì‚° ë‚´ì—­ -->
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; align-items: start;" id="palListLayout">
          <!-- ì™¼ìª½: í™”ì£¼ì‚¬ ëª©ë¡ (ê´€ë¦¬ìë§Œ í‘œì‹œ) -->
          <div class="pal-table-container pal-admin-only" id="palCompaniesContainer" style="height: calc(100vh - 300px); min-height: 500px; display: flex; flex-direction: column; overflow: hidden;">
            <div class="pal-table-header" style="flex-shrink: 0; padding: 12px 15px;">
              <h3 style="font-size: 14px; margin: 0;">í™”ì£¼ì‚¬ ëª©ë¡ <span id="palCompaniesCount" style="font-size: 11px; color: #636e72;">(0ê°œ)</span></h3>
            </div>
            <div id="palCompaniesScrollArea" style="flex: 1; overflow-y: scroll !important; overflow-x: hidden; padding: 6px; min-height: 0; max-height: 100%;">
              <div id="palCompaniesList" style="display: flex; flex-direction: column; gap: 5px;">
                <!-- í™”ì£¼ì‚¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
              </div>
            </div>
          </div>
          
          <!-- ì˜¤ë¥¸ìª½: ì •ì‚° ë‚´ì—­ -->
          <div class="pal-table-container" style="height: calc(100vh - 300px); min-height: 500px; display: flex; flex-direction: column;" id="palSettlementsContainer">
            <div class="pal-table-header" style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
              <h3>ì •ì‚° ë‚´ì—­ <span id="palSettlementsCount" style="font-size: 14px; color: #636e72;">(0ê°œ)</span></h3>
              <button class="pal-btn" onclick="palExportSettlements()" style="padding: 8px 16px; font-size: 13px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; display: none;" id="palExportSettlementsBtn">
                ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
              </button>
            </div>
            <div style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 10px;">
              <div id="palSettlementsList">
                <div style="padding: 20px; text-align: center; color: #636e72;" id="palSettlementsPlaceholder">í™”ì£¼ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- íŒŒë ˆíŠ¸ ê´€ë¦¬ í˜ì´ì§€ -->
      <div id="palPageInbound" class="pal-content-page">
        <h2 style="color: #ff6b35; font-weight: 700; margin-bottom: 20px;">ğŸ“¦ íŒŒë ˆíŠ¸ ê´€ë¦¬</h2>
        
        <!-- íŒŒë ˆíŠ¸ ì¶œê³  ì„¹ì…˜ - ì ‘ì´ì‹ -->
        <div class="pal-section">
          <button class="pal-toggle-btn" onclick="palToggleSection('palOutboundSection')">
            <span>ğŸ“¤ íŒŒë ˆíŠ¸ ì¶œê³ </span>
            <span id="palOutboundIcon">â–¼</span>
          </button>
          <div class="pal-toggle-content" id="palOutboundSection" style="display: none;">
            <!-- íŒŒë ˆíŠ¸ ê²€ìƒ‰/í•„í„° -->
            <div class="pal-filters" style="margin-bottom: 20px;">
              <div class="pal-filter-group">
                <label>íŒŒë ˆíŠ¸ ID ê²€ìƒ‰</label>
                <input type="text" id="palOutboundSearchId" class="pal-form-input" placeholder="íŒŒë ˆíŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeyup="palSearchPalletsForOutbound()">
              </div>
              <div class="pal-filter-group pal-admin-only">
                <label>í™”ì£¼ì‚¬</label>
                <div class="pal-searchable-select">
                  <input type="text" id="palOutboundCompanyInput" class="pal-form-input" placeholder="í™”ì£¼ì‚¬ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”" autocomplete="off" onchange="palSearchPalletsForOutbound()">
                  <input type="hidden" id="palOutboundCompanyName">
                  <div class="pal-dropdown-list" id="palOutboundCompanyDropdown"></div>
                </div>
              </div>
              <div class="pal-filter-group">
                <label>í’ˆëª©ëª…</label>
                <input type="text" id="palOutboundProductName" class="pal-form-input" placeholder="í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="palSearchPalletsForOutbound()">
              </div>
              <div class="pal-filter-group">
                <button class="pal-btn" onclick="palSearchPalletsForOutbound()" style="height: 40px;">ì¡°íšŒ</button>
              </div>
            </div>
            
            <!-- ë³´ê´€ì¤‘ì¸ íŒŒë ˆíŠ¸ ëª©ë¡ -->
            <div class="pal-table-container" style="margin-bottom: 20px;">
              <div class="pal-table-header">
                <h3>ë³´ê´€ì¤‘ì¸ íŒŒë ˆíŠ¸ ëª©ë¡ <span id="palOutboundPalletsCount" style="font-size: 14px; color: #636e72;">(0ê°œ)</span></h3>
              </div>
              <div class="pal-table-scroll-wrapper" style="max-height: 400px;">
                <table class="pal-table">
                  <thead>
                    <tr>
                      <th style="width: 50px;">ì„ íƒ</th>
                      <th>íŒŒë ˆíŠ¸ ID</th>
                      <th>í™”ì£¼ì‚¬</th>
                      <th>í’ˆëª©ëª…</th>
                      <th>ì…ê³ ì¼</th>
                      <th>ë³´ê´€ì¼ìˆ˜</th>
                      <th>ë³´ê´€ ìœ„ì¹˜</th>
                    </tr>
                  </thead>
                  <tbody id="palOutboundPalletsTableBody">
                    <tr>
                      <td colspan="7" class="no-data">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- ì„ íƒí•œ íŒŒë ˆíŠ¸ ì •ë³´ ë° ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬ -->
            <div id="palOutboundSelectedInfo" style="display: none; background: #fff9e6; padding: 20px; border-radius: 12px; border: 2px solid #ffeaa7; margin-bottom: 20px;">
              <h3 style="color: #ff6b35; margin-bottom: 15px;">ì„ íƒí•œ íŒŒë ˆíŠ¸ ì •ë³´</h3>
              <div id="palOutboundSelectedContent"></div>
              <div class="pal-form-group" style="margin-top: 15px;">
                <label class="pal-form-label">ë³´ê´€ì¢…ë£Œì¼ (ì„ íƒì‚¬í•­, ê¸°ë³¸ê°’: ì˜¤ëŠ˜)</label>
                <input type="date" id="palOutboundDate" class="pal-form-input">
              </div>
              <div class="pal-form-group">
                <label class="pal-form-label">ë¹„ê³ </label>
                <textarea id="palOutboundNotes" class="pal-form-input" style="min-height: 80px;" placeholder="ë¹„ê³ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
              </div>
              <button class="pal-btn" onclick="palConfirmOutbound()" style="width: 100%;">ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬</button>
              <button class="pal-btn pal-btn-secondary" onclick="palCancelOutbound()" style="width: 100%; margin-top: 10px;">ì·¨ì†Œ</button>
            </div>
            
            <div id="palOutboundMessage" style="margin-top: 15px;"></div>
          </div>
        </div>
        
        <!-- íŒŒë ˆíŠ¸ ì…ê³  ì„¹ì…˜ - ì ‘ì´ì‹ (í•­ìƒ í¼ì¹¨) -->
        <div class="pal-section" style="margin-top: 20px;">
          <button class="pal-toggle-btn" onclick="palToggleSection('palInboundSection')">
            <span>ğŸ“¥ íŒŒë ˆíŠ¸ ì…ê³ </span>
            <span id="palInboundIcon">â–²</span>
          </button>
          <div class="pal-toggle-content" id="palInboundSection" style="display: block;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- ë‹¨ì¼ ì…ê³  -->
          <div>
            <h3 style="color: #ff6b35; margin-bottom: 15px;">ë‹¨ì¼ ì…ê³ </h3>
            <form id="palInboundForm" onsubmit="event.preventDefault(); palInbound();">
              <div class="pal-form-group">
                <label class="pal-form-label">í™”ì£¼ì‚¬ *</label>
                <div class="pal-searchable-select">
                  <input type="text" id="palInboundCompanyInput" class="pal-form-input" placeholder="í™”ì£¼ì‚¬ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”" autocomplete="off">
                  <input type="hidden" id="palInboundCompanyName">
                  <div class="pal-dropdown-list" id="palInboundCompanyDropdown"></div>
                </div>
              </div>
              <div class="pal-form-group">
                <label class="pal-form-label">ì…ê³ ì¼ *</label>
                <input type="date" id="palInboundDate" class="pal-form-input" required>
              </div>
              <div class="pal-form-group">
                <label class="pal-form-label">ë³´ê´€ ìœ„ì¹˜</label>
                <input type="text" id="palInboundLocation" class="pal-form-input" placeholder="ì˜ˆ: A-01">
              </div>
              <div class="pal-form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="palInboundIsService" style="width: 18px; height: 18px;">
                  <span class="pal-form-label" style="margin: 0;">ì„œë¹„ìŠ¤ íŒŒë ˆíŠ¸ (ë³´ê´€ë£Œ ë©´ì œ)</span>
                </label>
              </div>
              <div class="pal-form-group">
                <label class="pal-form-label">ë¹„ê³ </label>
                <textarea id="palInboundNotes" class="pal-form-input" style="min-height: 80px;" placeholder="ë¹„ê³ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
              </div>
              
              <!-- í’ˆëª© ë¦¬ìŠ¤íŠ¸ -->
              <div class="pal-form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <label class="pal-form-label" style="margin: 0;">í’ˆëª© ëª©ë¡</label>
                  <button type="button" class="pal-btn" onclick="palAddProductItem()" style="padding: 6px 12px; font-size: 12px; background: #28a745; color: white;">+ í’ˆëª© ì¶”ê°€</button>
                </div>
                <div id="palProductItemsList" style="display: flex; flex-direction: column; gap: 10px;">
                  <!-- í’ˆëª© í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                </div>
              </div>
              
              <button type="submit" class="pal-btn" style="width: 100%;">ì…ê³  ì²˜ë¦¬</button>
              <div id="palInboundMessage" style="margin-top: 15px;"></div>
            </form>
          </div>
          
          <!-- ëŒ€ëŸ‰ ì…ê³  -->
          <div>
            <h3 style="color: #ff6b35; margin-bottom: 15px;">ëŒ€ëŸ‰ ì…ê³ </h3>
            <div style="background: #fff9e6; padding: 20px; border-radius: 12px; border: 2px solid #ffeaa7; margin-bottom: 15px;">
              <h4 style="margin: 0 0 10px 0; color: #ff6b35; font-size: 14px;">ğŸ“‹ íŒŒì¼ í˜•ì‹ ì•ˆë‚´</h4>
              <p style="margin: 0; font-size: 13px; color: #636e72; line-height: 1.6;">
                CSV ë˜ëŠ” Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.<br>
                í•„ìˆ˜ ì»¬ëŸ¼: í™”ì£¼ì‚¬, í’ˆëª©ëª…, ì…ê³ ì¼ (YYYY-MM-DD)<br>
                ì„ íƒ ì»¬ëŸ¼: íŒŒë ˆíŠ¸ ID, ë³´ê´€ ìœ„ì¹˜, ìˆ˜ëŸ‰, ì„œë¹„ìŠ¤ ì—¬ë¶€, ë¹„ê³ 
              </p>
            </div>
            <div class="pal-form-group">
              <label class="pal-form-label">íŒŒì¼ ì„ íƒ</label>
              <input type="file" id="palBulkFileInput" class="pal-form-input" accept=".csv,.xlsx,.xls">
            </div>
            <button type="button" class="pal-btn" onclick="palBulkInbound()" style="width: 100%;">ëŒ€ëŸ‰ ì…ê³  ì²˜ë¦¬</button>
            <div id="palBulkMessage" style="margin-top: 15px;"></div>
          </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- QR ì½”ë“œ ëª¨ë‹¬ -->
      <div id="palQRModal" class="pal-modal" style="display: none;">
        <div class="pal-modal-content" style="max-width: 400px;">
          <div class="pal-modal-header">
            <h3>QR ì½”ë“œ</h3>
            <button class="pal-modal-close" onclick="palCloseQRModal()">&times;</button>
          </div>
          <div class="pal-modal-body" id="palQRModalBody" style="text-align: center; padding: 20px;">
            <div id="palQRCodeContainer" style="margin-bottom: 20px;">
              <!-- QR ì½”ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div id="palQRInfo" style="margin-bottom: 20px;">
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;" id="palQRTitle"></div>
              <div style="font-size: 14px; color: #666;" id="palQRInDate"></div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button class="pal-btn" onclick="palPrintQRCode()" style="padding: 10px 20px; background: #28a745; color: white;">ğŸ–¨ï¸ QR ì¸ì‡„</button>
              <button class="pal-btn pal-btn-secondary" onclick="palCloseQRModal()" style="padding: 10px 20px;">ë‹«ê¸°</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- QR ì¸ì‡„ìš© ìˆ¨ê¹€ ì˜ì—­ (ì¸ì‡„ ì „ìš©, í™”ë©´ì— í‘œì‹œ ì•ˆ ë¨) -->
      <div id="palQRPrintArea" style="display: none; position: absolute; left: -9999px; top: -9999px; width: 63.5mm; height: 70mm;"></div>

      <!-- íŒŒë ˆíŠ¸ í˜„í™© í˜ì´ì§€ -->
      <div id="palPageStatus" class="pal-content-page">
        <h2 style="color: #ff6b35; font-weight: 700; margin-bottom: 20px;">ğŸ“Š íŒŒë ˆíŠ¸ í˜„í™©</h2>
        
        <!-- í†µê³„ ì„¹ì…˜ -->
        <div class="pal-stats-container">
          <div class="pal-stat-box">
            <div class="pal-stat-box-title">ì „ì²´ íŒŒë ˆíŠ¸</div>
            <div class="pal-stat-box-value" id="palTotalPallets">0</div>
          </div>
          <div class="pal-stat-box">
            <div class="pal-stat-box-title">ë³´ê´€ì¤‘</div>
            <div class="pal-stat-box-value" id="palStoragePallets">0</div>
          </div>
          <div class="pal-stat-box">
            <div class="pal-stat-box-title">ë³´ê´€ì¢…ë£Œ</div>
            <div class="pal-stat-box-value" id="palCompletedPallets">0</div>
          </div>
          <div class="pal-stat-box">
            <div class="pal-stat-box-title">ì´ë²ˆë‹¬ ë³´ê´€ë£Œ</div>
            <div class="pal-stat-box-value" id="palMonthlyFee">0ì›</div>
          </div>
        </div>
        
        <div class="pal-filters">
          <div class="pal-filter-group pal-admin-only">
            <label>í™”ì£¼ì‚¬</label>
            <div class="pal-searchable-select">
              <input type="text" id="palFilterCompanyInput" class="pal-form-input" placeholder="í™”ì£¼ì‚¬ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”" autocomplete="off">
              <input type="hidden" id="palFilterCompanyName">
              <div class="pal-dropdown-list" id="palFilterCompanyDropdown"></div>
            </div>
          </div>
          <div class="pal-filter-group">
            <label>ìƒíƒœ</label>
            <select id="palFilterStatus" class="pal-form-input">
              <option value="ì „ì²´">ì „ì²´</option>
              <option value="ì…ê³ ë¨">ì…ê³ ë¨</option>
              <option value="ë³´ê´€ì¢…ë£Œ">ë³´ê´€ì¢…ë£Œ</option>
              <option value="ì„œë¹„ìŠ¤">ì„œë¹„ìŠ¤</option>
            </select>
          </div>
          <div class="pal-filter-group">
            <label>íŒŒë ˆíŠ¸ ID ê²€ìƒ‰</label>
            <input type="text" id="palFilterPalletId" class="pal-form-input" placeholder="íŒŒë ˆíŠ¸ ID ì…ë ¥">
          </div>
          <div class="pal-filter-group">
            <label>ì›” í•„í„°</label>
            <input type="month" id="palFilterMonth" class="pal-form-input">
          </div>
          <div class="pal-filter-group">
            <button class="pal-btn" onclick="palLoadPallets()" style="height: 40px;">ì¡°íšŒ</button>
          </div>
          <div class="pal-filter-group">
            <button class="pal-btn pal-btn-secondary" onclick="palLoadPallets()" style="height: 40px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
          </div>
          <div class="pal-filter-group pal-admin-only">
            <button class="pal-btn" onclick="palDeleteSelectedPallets()" style="height: 40px; background: #dc3545; color: white;">ğŸ—‘ï¸ ì„ íƒì‚­ì œ</button>
          </div>
        </div>
        
        <div class="pal-table-container">
          <div class="pal-table-header">
            <h3>íŒŒë ˆíŠ¸ ëª©ë¡ <span id="palPalletsCount" style="font-size: 14px; color: #636e72;">(0ê°œ)</span></h3>
          </div>
          <div class="pal-table-scroll-wrapper">
            <table class="pal-table">
              <thead>
                <tr>
                  <th class="pal-admin-only" style="width: 40px;">
                    <input type="checkbox" id="palPalletsSelectAll" onchange="palToggleSelectAllPallets(this.checked)" style="width: 16px; height: 16px;">
                  </th>
                  <th style="font-size: 11px;">íŒŒë ˆíŠ¸ ID</th>
                  <th style="font-size: 11px;">í™”ì£¼ì‚¬</th>
                  <th style="font-size: 11px;">í’ˆëª©ëª…</th>
                  <th style="font-size: 11px;">ìƒíƒœ</th>
                  <th style="font-size: 11px;">ì…ê³ ì¼</th>
                  <th style="font-size: 11px;">ê°±ì‹ ì¼</th>
                  <th style="font-size: 11px;">ë³´ê´€ì¢…ë£Œì¼</th>
                  <th style="font-size: 11px;">ì´ë³´ê´€</th>
                  <th style="font-size: 11px;">ì›”ë³´ê´€</th>
                  <th style="font-size: 11px;">ë³´ê´€ë£Œ</th>
                  <th style="font-size: 11px;">QR/ê´€ë¦¬</th>
                  <th style="font-size: 11px;">ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="palPalletsTableBody">
                <tr>
                  <td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- ë¼ë²¨ ì¶œë ¥ í˜ì´ì§€ -->
      <div id="palPageLabel" class="pal-content-page">
        <h2 style="color: #ff6b35; font-weight: 700; margin-bottom: 20px;">ğŸ·ï¸ ë¼ë²¨ ì¶œë ¥</h2>
        
        <!-- í•„í„° ì„¤ì • ì˜ì—­ -->
        <div class="pal-section" style="background: #ffffff; padding: 24px; border-radius: 14px; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1); margin-bottom: 20px;">
          <h3 style="color: #ff6b35; font-weight: 600; margin-bottom: 20px; font-size: 18px;">ğŸ“‹ ë¼ë²¨ ì¶œë ¥ í•„í„° ì„¤ì •</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div class="pal-form-group">
              <label class="pal-form-label">íŒŒë ˆíŠ¸ ID ê²€ìƒ‰ì–´</label>
              <input type="text" id="palLabelFilterId" class="pal-form-input" placeholder="ì˜ˆ: 250930, 250930_001">
              <small style="color: #999; font-size: 12px;">ì½¤ë§ˆë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥</small>
            </div>
            
            <div class="pal-form-group">
              <label class="pal-form-label">í™”ì£¼ì‚¬ ì„ íƒ</label>
              <div class="pal-searchable-select" style="position: relative;">
                <input type="text" id="palLabelFilterCompanyInput" class="pal-form-input" placeholder="í™”ì£¼ì‚¬ë¥¼ ê²€ìƒ‰í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”" autocomplete="off">
                <input type="hidden" id="palLabelFilterCompanyName">
                <button type="button" id="palLabelCompanyToggle" class="company-combo-toggle" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%);">â–¼</button>
                <div id="palLabelCompanyDropdown" class="company-dropdown-list" role="listbox"></div>
              </div>
              <small style="color: #999; font-size: 12px;">ì´ˆì„± ê²€ìƒ‰ ì§€ì› (ì˜ˆ: 'ã……ã……' ì…ë ¥)</small>
            </div>
            
            <div class="pal-form-group">
              <label class="pal-form-label">í’ˆëª© í‚¤ì›Œë“œ</label>
              <input type="text" id="palLabelFilterProduct" class="pal-form-input" placeholder="í’ˆëª©ëª… í‚¤ì›Œë“œ">
            </div>
            
            <div class="pal-form-group">
              <label class="pal-form-label">ì…ê³  ì‹œì‘ì¼</label>
              <input type="date" id="palLabelFilterStartDate" class="pal-form-input">
            </div>
            
            <div class="pal-form-group">
              <label class="pal-form-label">ì…ê³  ì¢…ë£Œì¼</label>
              <input type="date" id="palLabelFilterEndDate" class="pal-form-input">
            </div>
            
            <div class="pal-form-group">
              <label class="pal-form-label">ë³´ê´€ ìƒíƒœ</label>
              <select id="palLabelFilterStatus" class="pal-form-input">
                <option value="ì „ì²´">ì „ì²´</option>
                <option value="ì…ê³ ë¨">ì…ê³ ë¨</option>
                <option value="ë³´ê´€ì¢…ë£Œ">ë³´ê´€ì¢…ë£Œ</option>
                <option value="ì„œë¹„ìŠ¤">ì„œë¹„ìŠ¤</option>
              </select>
            </div>
            
            <div class="pal-form-group" style="display: flex; align-items: center; gap: 10px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="palLabelFilterIncludePrinted" style="width: 18px; height: 18px;">
                <span>ì¶œë ¥ì™„ë£Œ í¬í•¨</span>
              </label>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button class="pal-btn" onclick="palLoadLabelPallets()" style="padding: 12px 24px;">ğŸ” ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="pal-btn pal-btn-secondary" onclick="palResetLabelFilters()" style="padding: 12px 24px;">ğŸ”„ ì´ˆê¸°í™”</button>
          </div>
        </div>
        
        <!-- ë¼ë²¨ ëª©ë¡ ì˜ì—­ -->
        <div class="pal-section" style="background: #ffffff; padding: 24px; border-radius: 14px; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #ff6b35; font-weight: 600; font-size: 18px; margin: 0;">ğŸ“¦ ë¼ë²¨ ì¶œë ¥ ëŒ€ìƒ <span id="palLabelCount" style="font-size: 14px; color: #636e72;">(0ê°œ)</span></h3>
            <div style="display: flex; gap: 10px;">
              <button class="pal-btn" onclick="palLoadNewLabels()" style="padding: 10px 20px; background: #17a2b8; color: white;">ğŸ†• ìµœì‹ ë¼ë²¨</button>
              <button class="pal-btn" onclick="palSelectAllLabels()" style="padding: 10px 20px;">âœ… ì „ì²´ ì„ íƒ</button>
              <button class="pal-btn pal-btn-secondary" onclick="palDeselectAllLabels()" style="padding: 10px 20px;">âŒ ì „ì²´ í•´ì œ</button>
              <button class="pal-btn" onclick="palPrintSelectedLabels()" style="padding: 10px 20px; background: #28a745; color: white;">ğŸ–¨ï¸ ì„ íƒ ë¼ë²¨ ì¸ì‡„</button>
              <button class="pal-btn" onclick="palMarkAsPrinted()" style="padding: 10px 20px; background: #ffc107; color: #000;">âœ… ì¶œë ¥ì™„ë£Œ</button>
            </div>
          </div>
          
          <div class="pal-table-container">
            <div class="pal-table-scroll-wrapper">
              <table class="pal-table">
                <thead>
                  <tr>
                    <th style="width: 50px;">
                      <input type="checkbox" id="palLabelSelectAll" onchange="palToggleSelectAllLabels(this.checked)">
                    </th>
                    <th>íŒŒë ˆíŠ¸ ID</th>
                    <th>í™”ì£¼ì‚¬</th>
                    <th>í’ˆëª©ëª…</th>
                    <th>ì…ê³ ì¼</th>
                    <th>ìƒíƒœ</th>
                    <th>ì¶œë ¥ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody id="palLabelTableBody">
                  <tr>
                    <td colspan="7" class="no-data">í•„í„° ì¡°ê±´ì„ ì„¤ì •í•˜ê³  'ë¶ˆëŸ¬ì˜¤ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ë³´ê´€ë£Œ ì„¤ì • í˜ì´ì§€ (ê´€ë¦¬ì ì „ìš©) -->
      <div id="palPageFee" class="pal-content-page pal-admin-only">
        <h2 style="color: #ff6b35; font-weight: 700; margin-bottom: 20px;">ğŸ’° ë³´ê´€ë£Œ ì„¤ì •</h2>
        
        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
          <!-- ì™¼ìª½: í™”ì£¼ì‚¬ ë¦¬ìŠ¤íŠ¸ -->
          <div class="pal-table-container" style="max-height: 600px; overflow-y: auto;">
            <div class="pal-table-header">
              <h3>í™”ì£¼ì‚¬ ëª©ë¡</h3>
            </div>
            <div style="padding: 10px;">
              <div id="palFeeCompanyList" style="display: flex; flex-direction: column; gap: 8px;">
                <div style="padding: 12px; background: #fff9e6; border-radius: 8px; border: 2px solid #ffeaa7; cursor: pointer; transition: all 0.2s;" 
                     class="pal-fee-company-item" 
                     onclick="palSelectFeeCompany('')"
                     data-company="">
                  <div style="font-weight: 600; color: #ff6b35;">ì „ì²´ í™”ì£¼ì‚¬</div>
                </div>
                <!-- í™”ì£¼ì‚¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
              </div>
            </div>
          </div>
          
          <!-- ì˜¤ë¥¸ìª½: ë³´ê´€ë£Œ ì„¤ì • í¼ -->
          <div>
            <form id="palFeeSettingsForm" onsubmit="event.preventDefault(); palSaveFeeSettings();">
              <div class="pal-form-group">
                <label class="pal-form-label">í™”ì£¼ì‚¬ *</label>
                <input type="text" id="palFeeCompanyDisplay" class="pal-form-input" readonly style="background: #f5f5f5;" placeholder="ì™¼ìª½ì—ì„œ í™”ì£¼ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”">
                <input type="hidden" id="palFeeCompanyName">
              </div>
              <div class="pal-form-group">
                <label class="pal-form-label">ì›” ë³´ê´€ë£Œ (ì›) *</label>
                <input type="number" id="palFeeMonthlyFee" class="pal-form-input" placeholder="ì˜ˆ: 16000" min="0" required oninput="palCalculateDailyFee()">
              </div>
              <div class="pal-form-group">
                <label class="pal-form-label">ì¼ì¼ ë³´ê´€ë£Œ (ìë™ ê³„ì‚°)</label>
                <input type="text" id="palFeeDailyFee" class="pal-form-input" readonly style="background: #f5f5f5;" placeholder="ì›” ë³´ê´€ë£Œë¥¼ ì…ë ¥í•˜ë©´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤">
              </div>
              <div class="pal-form-group">
                <label class="pal-form-label">ì ìš© ì‹œì‘ì¼</label>
                <input type="date" id="palFeeEffectiveFrom" class="pal-form-input">
              </div>
              <div class="pal-form-group">
                <label class="pal-form-label">ë¹„ê³ </label>
                <textarea id="palFeeNotes" class="pal-form-input" style="min-height: 80px;" placeholder="ë¹„ê³ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
              </div>
              <button type="submit" class="pal-btn" style="width: 100%;">ë³´ê´€ë£Œ ì„¤ì • ì €ì¥</button>
              <div id="palFeeSettingsMessage" style="margin-top: 15px;"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ì •ì‚° ìƒì„¸ ëª¨ë‹¬ -->
  <div id="palSettlementDetailModal" class="pal-modal">
    <div class="pal-modal-content">
      <div class="pal-modal-header">
        <h2>ì •ì‚° ìƒì„¸</h2>
        <button class="pal-modal-close" onclick="palCloseSettlementDetail()">Ã—</button>
      </div>
      <div id="palSettlementDetailContent"></div>
    </div>
  </div>
  
  <script>
    // API ê¸°ë³¸ URL
    const PAL_API_BASE_URL = window.location.origin;
    
    // ì „ì—­ ë³€ìˆ˜
    let palCurrentRole = '';
    let palCurrentCompany = '';
    let palCurrentUsername = '';
    let palQRStream = null;
    let palQRScanning = false;
    let palScannedPalletId = null;
    let palCompanies = [];
    
    // í—¤ë” ì¸ì½”ë”© í•¨ìˆ˜ (special_works.htmlê³¼ ë™ì¼)
    function palGetUserHeaders() {
      const encodeHeader = (value) => encodeURIComponent((value || '').toString().trim());
      return {
        'X-User-Role': encodeHeader(palCurrentRole),
        'X-User-Name': encodeHeader(palCurrentUsername),
        'X-Company-Name': encodeHeader(palCurrentCompany)
      };
    }
    
    // í•˜ìœ„ ë©”ë‰´ ì „í™˜ í•¨ìˆ˜
    function palSwitchSubMenu(menuId) {
      // í™”ì£¼ì‚¬ ëª¨ë“œì—ì„œëŠ” 'list' ë©”ë‰´ë§Œ ì ‘ê·¼ ê°€ëŠ¥
      if (palCurrentRole !== 'ê´€ë¦¬ì' && menuId !== 'list') {
        alert('â³ ì´ ê¸°ëŠ¥ì€ ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
      const pages = document.querySelectorAll('.pal-content-page');
      pages.forEach(page => page.classList.remove('active'));
      
      // ëª¨ë“  ë©”ë‰´ ë²„íŠ¼ ë¹„í™œì„±í™”
      const menuButtons = document.querySelectorAll('.pal-sub-menu-btn');
      menuButtons.forEach(btn => btn.classList.remove('active'));
      
      // ì„ íƒëœ í˜ì´ì§€ í‘œì‹œ
      const selectedPage = document.getElementById('palPage' + menuId.charAt(0).toUpperCase() + menuId.slice(1));
      if (selectedPage) {
        selectedPage.classList.add('active');
      }
      
      // ì„ íƒëœ ë©”ë‰´ ë²„íŠ¼ í™œì„±í™”
      const selectedButton = event?.target || document.querySelector(`[onclick*="palSwitchSubMenu('${menuId}')"]`);
      if (selectedButton) {
        selectedButton.classList.add('active');
      }
      
      // ê° í˜ì´ì§€ë³„ ì´ˆê¸°í™”
      if (menuId === 'list') {
        // ì›”ë³„ í™”ì£¼ì‚¬ë³„ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™”
        if (palCurrentRole === 'ê´€ë¦¬ì') {
          palLoadCompanyList();
        } else {
          // í™”ì£¼ì‚¬ ëª¨ë“œ: í†µê³„ ë°•ìŠ¤ í‘œì‹œ ë° ë ˆì´ì•„ì›ƒ ì¡°ì •
          const statsContainer = document.getElementById('palListStatsContainer');
          const listLayout = document.getElementById('palListLayout');
          const settlementsContainer = document.getElementById('palSettlementsContainer');
          
          if (statsContainer) statsContainer.style.display = 'flex';
          if (listLayout) listLayout.style.gridTemplateColumns = '1fr'; // í™”ì£¼ì‚¬ ëª©ë¡ ì œê±°
          if (settlementsContainer) {
            settlementsContainer.style.height = 'calc(100vh - 350px)'; // í†µê³„ ë°•ìŠ¤ ê³µê°„ í™•ë³´
          }
          
          // í†µê³„ ì—…ë°ì´íŠ¸ ë° ì •ì‚° ë‚´ì—­ ìë™ ë¡œë“œ
          palUpdateListStats();
          if (palCurrentCompany) {
            palLoadSettlements(palCurrentCompany);
          }
        }
      } else if (menuId === 'inbound') {
        // íŒŒë ˆíŠ¸ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™”
        const dateInput = document.getElementById('palInboundDate');
        if (dateInput && !dateInput.value) {
          const today = new Date().toISOString().split('T')[0];
          dateInput.value = today;
        }
        // ì…ê³  ì„¹ì…˜ì€ í•­ìƒ í¼ì¹¨ ìƒíƒœë¡œ ìœ ì§€
        const inboundSection = document.getElementById('palInboundSection');
        const inboundIcon = document.getElementById('palInboundIcon');
        if (inboundSection) {
          inboundSection.style.display = 'block';
        }
        if (inboundIcon) {
          inboundIcon.textContent = 'â–²';
        }
        // í’ˆëª© ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” (ê¸°ë³¸ 1ê°œ í’ˆëª©)
        const itemsList = document.getElementById('palProductItemsList');
        if (itemsList) {
          itemsList.innerHTML = '';
          palAddProductItem();
        }
      } else if (menuId === 'status') {
        // íŒŒë ˆíŠ¸ í˜„í™© í˜ì´ì§€ ì´ˆê¸°í™”
        palLoadPallets();
        palUpdateStats();
      } else if (menuId === 'label') {
        // ë¼ë²¨ ì¶œë ¥ í˜ì´ì§€ ì´ˆê¸°í™”
        palInitLabelPage();
      } else if (menuId === 'fee') {
        // ë³´ê´€ë£Œ ì„¤ì • í˜ì´ì§€ ì´ˆê¸°í™”
        const dateInput = document.getElementById('palFeeEffectiveFrom');
        if (dateInput && !dateInput.value) {
          const today = new Date().toISOString().split('T')[0];
          dateInput.value = today;
        }
        palLoadFeeCompanyList();
      }
    }
    
    // ë³´ê´€ë£Œ ì„¤ì •: í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ
    async function palLoadFeeCompanyList() {
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/auth/companies`, {
          headers: palGetUserHeaders()
        });
        const result = await response.json();
        
        if (result.success && result.companies) {
          const companyList = document.getElementById('palFeeCompanyList');
          if (companyList) {
            // "ì „ì²´ í™”ì£¼ì‚¬" í•­ëª©ì€ ìœ ì§€í•˜ê³  ë‚˜ë¨¸ì§€ ì¶”ê°€
            const existingAll = companyList.querySelector('[data-company=""]');
            companyList.innerHTML = '';
            if (existingAll) {
              companyList.appendChild(existingAll);
            } else {
              companyList.innerHTML = `
                <div style="padding: 12px; background: #fff9e6; border-radius: 8px; border: 2px solid #ffeaa7; cursor: pointer; transition: all 0.2s;" 
                     class="pal-fee-company-item" 
                     onclick="palSelectFeeCompany('')"
                     data-company="">
                  <div style="font-weight: 600; color: #ff6b35;">ì „ì²´ í™”ì£¼ì‚¬</div>
                </div>
              `;
            }
            
            // ê´€ë¦¬ì ê³„ì • ì œì™¸í•˜ê³  í™”ì£¼ì‚¬ë§Œ í•„í„°ë§
            const consignors = result.companies.filter(company => {
              const role = company.role || '';
              return role !== 'ê´€ë¦¬ì';
            });
            
            consignors.forEach(company => {
              const companyName = company.company_name || company.company || '';
              if (companyName) {
                const item = document.createElement('div');
                item.className = 'pal-fee-company-item';
                item.setAttribute('data-company', companyName);
                item.style.cssText = 'padding: 12px; background: #ffffff; border-radius: 8px; border: 2px solid #ffeaa7; cursor: pointer; transition: all 0.2s;';
                item.onclick = () => palSelectFeeCompany(companyName);
                item.innerHTML = `<div style="font-weight: 600; color: #2d3436;">${palEscapeHtml(companyName)}</div>`;
                companyList.appendChild(item);
              }
            });
          }
        }
      } catch (error) {
        console.error('í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }
    
    // ë³´ê´€ë£Œ ì„¤ì •: í™”ì£¼ì‚¬ ì„ íƒ
    async function palSelectFeeCompany(companyName) {
      // ëª¨ë“  í•­ëª© ë¹„í™œì„±í™”
      document.querySelectorAll('.pal-fee-company-item').forEach(item => {
        item.style.background = '#ffffff';
        item.style.borderColor = '#ffeaa7';
      });
      
      // ì„ íƒëœ í•­ëª© í™œì„±í™”
      const selectedItem = document.querySelector(`[data-company="${companyName}"]`);
      if (selectedItem) {
        selectedItem.style.background = '#fff9e6';
        selectedItem.style.borderColor = '#ff6b35';
      }
      
      // í¼ì— í™”ì£¼ì‚¬ëª… ì„¤ì •
      document.getElementById('palFeeCompanyDisplay').value = companyName || 'ì „ì²´ í™”ì£¼ì‚¬';
      document.getElementById('palFeeCompanyName').value = companyName;
      
      // í•´ë‹¹ í™”ì£¼ì‚¬ì˜ ê¸°ì¡´ ë³´ê´€ë£Œ ì„¤ì • ë¡œë“œ
      if (companyName) {
        await palLoadFeeSettings(companyName);
      } else {
        // í¼ ì´ˆê¸°í™” (ê¸°ë³¸ê°’ 16000ì› ì„¤ì •)
        document.getElementById('palFeeMonthlyFee').value = '16000';
        const defaultDailyFee = (16000 / 30.0).toFixed(2);
        document.getElementById('palFeeDailyFee').value = defaultDailyFee + 'ì›';
        document.getElementById('palFeeEffectiveFrom').value = new Date().toISOString().split('T')[0];
        document.getElementById('palFeeNotes').value = '';
      }
    }
    
    // ë³´ê´€ë£Œ ì„¤ì •: ê¸°ì¡´ ì„¤ì • ë¡œë“œ
    async function palLoadFeeSettings(companyName) {
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/fees?company=${encodeURIComponent(companyName)}`, {
          headers: palGetUserHeaders()
        });
        const result = await response.json();
        
        if (result.success && result.data) {
          const fee = result.data;
          document.getElementById('palFeeMonthlyFee').value = fee.monthly_fee || '';
          document.getElementById('palFeeDailyFee').value = fee.daily_fee ? fee.daily_fee.toFixed(2) + 'ì›' : '';
          document.getElementById('palFeeEffectiveFrom').value = fee.effective_from || new Date().toISOString().split('T')[0];
          document.getElementById('palFeeNotes').value = fee.notes || '';
        } else {
          // ê¸°ì¡´ ì„¤ì •ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 16000ì› ì„¤ì •
          document.getElementById('palFeeMonthlyFee').value = '16000';
          const defaultDailyFee = (16000 / 30.0).toFixed(2);
          document.getElementById('palFeeDailyFee').value = defaultDailyFee + 'ì›';
          document.getElementById('palFeeEffectiveFrom').value = new Date().toISOString().split('T')[0];
          document.getElementById('palFeeNotes').value = '';
        }
      } catch (error) {
        console.error('ë³´ê´€ë£Œ ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }
    
    // ì¼ì¼ ë³´ê´€ë£Œ ìë™ ê³„ì‚°
    function palCalculateDailyFee() {
      const monthlyFee = parseFloat(document.getElementById('palFeeMonthlyFee').value) || 0;
      const dailyFee = (monthlyFee / 30.0).toFixed(2);
      const dailyFeeEl = document.getElementById('palFeeDailyFee');
      if (dailyFeeEl) {
        dailyFeeEl.value = dailyFee > 0 ? dailyFee + 'ì›' : '';
      }
    }
    
    // ì´ˆê¸°í™” í•¨ìˆ˜
    function palInit() {
      // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (special_works.htmlê³¼ ë™ì¼í•œ ë°©ì‹)
      try {
        // 1. companyInfo ìš”ì†Œì—ì„œ ì •ë³´ ì¶”ì¶œ ì‹œë„
        const companyInfoEl = document.getElementById('companyInfo');
        if (companyInfoEl && companyInfoEl.textContent) {
          const headerText = companyInfoEl.textContent.trim();
          // "[ê´€ë¦¬ì]"ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê´€ë¦¬ì
          if (headerText.includes('[ê´€ë¦¬ì]')) {
            palCurrentRole = 'ê´€ë¦¬ì';
            // í—¤ë” í˜•ì‹: "ê´€ë¦¬ì [ê´€ë¦¬ì] (username)" ë˜ëŠ” "í™”ì£¼ì‚¬ëª… (username)"
            const usernameMatch = headerText.match(/\(([^)]+)\)/);
            if (usernameMatch) {
              palCurrentUsername = usernameMatch[1].trim();
            }
            // "[ê´€ë¦¬ì]" ì•ì˜ í…ìŠ¤íŠ¸ê°€ íšŒì‚¬ëª…
            const companyMatch = headerText.match(/^([^[]+)/);
            if (companyMatch) {
              palCurrentCompany = companyMatch[1].trim();
            }
          } else {
            // í™”ì£¼ì‚¬ ëª¨ë“œ: "í™”ì£¼ì‚¬ëª… (username)"
            const usernameMatch = headerText.match(/\(([^)]+)\)/);
            if (usernameMatch) {
              palCurrentUsername = usernameMatch[1].trim();
            }
            const companyMatch = headerText.match(/^([^(]+)/);
            if (companyMatch) {
              palCurrentCompany = companyMatch[1].trim();
            }
            palCurrentRole = 'í™”ì£¼ì‚¬';
          }
        } else {
          // 2. ì „ì—­ ë³€ìˆ˜ ë˜ëŠ” localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°
          palCurrentRole = (window.currentRole || localStorage.getItem('client_role') || '').toString().trim();
          palCurrentCompany = (window.currentCompany || localStorage.getItem('client_company') || '').toString().trim();
          palCurrentUsername = (window.currentUsername || localStorage.getItem('client_username') || '').toString().trim();
        }
      } catch (e) {
        console.warn('[PAL] ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', e);
        // ê¸°ë³¸ê°’ ì„¤ì • (í™”ì£¼ì‚¬ ëª¨ë“œ)
        palCurrentRole = 'í™”ì£¼ì‚¬';
      }
      
      console.log('[PAL] ì‚¬ìš©ì ì •ë³´:', {
        role: palCurrentRole,
        company: palCurrentCompany,
        username: palCurrentUsername
      });
      
      // ê¶Œí•œì— ë”°ë¼ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ (ë‹¨, .pal-content-pageëŠ” ì œì™¸ - active í´ë˜ìŠ¤ë¡œë§Œ ì œì–´)
      if (palCurrentRole === 'ê´€ë¦¬ì') {
        document.querySelectorAll('.pal-admin-only:not(.pal-content-page)').forEach(el => {
          el.style.display = 'block';
        });
        document.querySelectorAll('.pal-consignor-only').forEach(el => {
          el.style.display = 'none';
        });
      } else {
        // í™”ì£¼ì‚¬ ëª¨ë“œ: ê´€ë¦¬ì ì „ìš© ìš”ì†Œ ìˆ¨ê¹€
        document.querySelectorAll('.pal-admin-only').forEach(el => {
          el.style.display = 'none';
        });
        document.querySelectorAll('.pal-consignor-only').forEach(el => {
          el.style.display = 'block';
        });
        
        // í™”ì£¼ì‚¬ ëª¨ë“œ: í•˜ìœ„ ë©”ë‰´ë°” ìˆ¨ê¹€, 'list' í˜ì´ì§€ë§Œ í‘œì‹œ
        const subMenuBar = document.getElementById('palSubMenuBar');
        if (subMenuBar) {
          subMenuBar.style.display = 'none';
        }
        
        // ì½˜í…ì¸  ì˜ì—­ì— í™”ì£¼ì‚¬ ëª¨ë“œ í´ë˜ìŠ¤ ì¶”ê°€ (ìƒë‹¨ íŒ¨ë”© ì¡°ì •ìš©)
        const contentArea = document.getElementById('palContentArea');
        if (contentArea) {
          contentArea.classList.add('pal-consignor-mode');
        }
        
        // 'list' í˜ì´ì§€ë§Œ í‘œì‹œ
        document.querySelectorAll('.pal-content-page').forEach(page => {
          if (page.id === 'palPageList') {
            page.classList.add('active');
          } else {
            page.classList.remove('active');
          }
        });
        
        // í™”ì£¼ì‚¬ ëª¨ë“œ ì´ˆê¸°í™”: í†µê³„ ë°•ìŠ¤ í‘œì‹œ ë° ë ˆì´ì•„ì›ƒ ì¡°ì •
        const statsContainer = document.getElementById('palListStatsContainer');
        const listLayout = document.getElementById('palListLayout');
        const settlementsContainer = document.getElementById('palSettlementsContainer');
        
        if (statsContainer) statsContainer.style.display = 'flex';
        if (listLayout) listLayout.style.gridTemplateColumns = '1fr'; // í™”ì£¼ì‚¬ ëª©ë¡ ì œê±°
        if (settlementsContainer) {
          settlementsContainer.style.height = 'calc(100vh - 350px)'; // í†µê³„ ë°•ìŠ¤ ê³µê°„ í™•ë³´
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸ ë° ì •ì‚° ë‚´ì—­ ìë™ ë¡œë“œ
        palUpdateListStats();
        if (palCurrentCompany) {
          palLoadSettlements(palCurrentCompany);
        }
      }
      
      // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
      const today = new Date().toISOString().split('T')[0];
      const inboundDateEl = document.getElementById('palInboundDate');
      
      // í’ˆëª© ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” (ê¸°ë³¸ 1ê°œ í’ˆëª© ì¶”ê°€)
      palAddProductItem();
      const outboundDateEl = document.getElementById('palOutboundDate');
      const feeEffectiveFromEl = document.getElementById('palFeeEffectiveFrom');
      
      if (inboundDateEl) inboundDateEl.value = today;
      if (outboundDateEl) outboundDateEl.value = today;
      if (feeEffectiveFromEl) feeEffectiveFromEl.value = today;
      
      // í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ
      palLoadCompanies();
      
      // íŒŒë ˆíŠ¸ ëª©ë¡ ë¡œë“œ
      palLoadPallets();
      
      // í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ (ì •ì‚° ë‚´ì—­ì€ í™”ì£¼ì‚¬ ì„ íƒ í›„ ë¡œë“œ)
      palLoadCompanyList();
      
      // ì¶œê³ ìš© í™”ì£¼ì‚¬ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
      setTimeout(() => {
        palInitOutboundCompanyDropdown();
      }, 500);
      
      // ì›” ë³´ê´€ë£Œ ì…ë ¥ ì‹œ ì¼ì¼ ë³´ê´€ë£Œ ìë™ ê³„ì‚°
      const monthlyFeeInput = document.getElementById('palFeeMonthlyFee');
      if (monthlyFeeInput) {
        monthlyFeeInput.addEventListener('input', function() {
          const monthlyFee = parseFloat(this.value) || 0;
          const dailyFee = (monthlyFee / 30.0).toFixed(2);
          const dailyFeeEl = document.getElementById('palFeeDailyFee');
          if (dailyFeeEl) dailyFeeEl.value = dailyFee + 'ì›';
        });
      }
    }
    
    // windowì— ë…¸ì¶œ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡) - ë¨¼ì € ë…¸ì¶œ
    window.palInit = palInit;
    
    console.log('[PAL] palInit í•¨ìˆ˜ê°€ windowì— ë“±ë¡ë¨');
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” (ë™ì  ë¡œë“œì™€ ì¼ë°˜ ë¡œë“œ ëª¨ë‘ ì§€ì›)
    // ë™ì  ë¡œë“œëœ ê²½ìš°ì—ëŠ” ì™¸ë¶€ì—ì„œ í˜¸ì¶œí•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('[PAL] DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ, palInit í˜¸ì¶œ');
        palInit();
      });
    } else {
      // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° - ë™ì  ë¡œë“œê°€ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰
      // ë™ì  ë¡œë“œì¸ì§€ í™•ì¸ (palletsTab ì»¨í…Œì´ë„ˆê°€ ìˆëŠ”ì§€)
      const isDynamicLoad = document.getElementById('palletsTab') !== null;
      if (!isDynamicLoad) {
        console.log('[PAL] ì¼ë°˜ ë¡œë“œë¡œ ê°ì§€, palInit í˜¸ì¶œ');
        setTimeout(palInit, 100);
      } else {
        console.log('[PAL] ë™ì  ë¡œë“œë¡œ ê°ì§€, ì™¸ë¶€ í˜¸ì¶œ ëŒ€ê¸°');
      }
    }
    
    // ì„¹ì…˜ í† ê¸€
    function palToggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const icon = document.getElementById(sectionId.replace('Section', 'Icon'));
      
      if (section && icon) {
        // ì…ê³  ì„¹ì…˜ì€ í•­ìƒ í¼ì¹¨ ìƒíƒœ ìœ ì§€
        if (sectionId === 'palInboundSection') {
          section.style.display = 'block';
          icon.textContent = 'â–²';
          return;
        }
        
        if (section.style.display === 'none' || !section.style.display) {
          section.style.display = 'block';
          icon.textContent = 'â–²';
        } else {
          section.style.display = 'none';
          icon.textContent = 'â–¼';
        }
      }
    }
    
    // í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ
    async function palLoadCompanies() {
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/auth/companies`);
        const result = await response.json();
        
        if (result.success) {
          palCompanies = result.companies || [];
          palInitCompanyDropdowns();
        }
      } catch (error) {
        console.error('í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }
    
    // í™”ì£¼ì‚¬ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    function palInitCompanyDropdowns() {
      const dropdowns = [
        { input: 'palInboundCompanyInput', hidden: 'palInboundCompanyName', dropdown: 'palInboundCompanyDropdown' },
        { input: 'palFilterCompanyInput', hidden: 'palFilterCompanyName', dropdown: 'palFilterCompanyDropdown' },
        { input: 'palFeeCompanyInput', hidden: 'palFeeCompanyName', dropdown: 'palFeeCompanyDropdown' },
        { input: 'palSettlementCompanyInput', hidden: 'palSettlementCompanyName', dropdown: 'palSettlementCompanyDropdown' }
      ];
      
      dropdowns.forEach(config => {
        palInitSearchableDropdown(config.input, config.hidden, config.dropdown);
      });
    }
    
    // ì¶œê³ ìš© í™”ì£¼ì‚¬ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    function palInitOutboundCompanyDropdown() {
      palInitSearchableDropdown('palOutboundCompanyInput', 'palOutboundCompanyName', 'palOutboundCompanyDropdown');
    }
    
    // ê²€ìƒ‰í˜• ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    function palInitSearchableDropdown(inputId, hiddenId, dropdownId) {
      const input = document.getElementById(inputId);
      const hidden = document.getElementById(hiddenId);
      const dropdown = document.getElementById(dropdownId);
      
      if (!input || !hidden || !dropdown) return;
      
      let dropdownTimeout = null;
      let isDropdownOpen = false;
      
      // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
      function updateDropdown(filterText = '') {
        const filtered = palCompanies.filter(company => 
          company.company_name.toLowerCase().includes(filterText.toLowerCase())
        );
        
        if (filtered.length === 0) {
          dropdown.innerHTML = '<div class="pal-dropdown-item" style="color: #999; cursor: default;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        } else {
          dropdown.innerHTML = filtered.map(company => 
            `<div class="pal-dropdown-item" data-value="${palEscapeHtml(company.company_name)}">${palEscapeHtml(company.company_name)}</div>`
          ).join('');
        }
      }
      
      // ë“œë¡­ë‹¤ìš´ ì—´ê¸°
      function openDropdown() {
        if (dropdownTimeout) {
          clearTimeout(dropdownTimeout);
          dropdownTimeout = null;
        }
        updateDropdown(input.value);
        dropdown.classList.add('show');
        isDropdownOpen = true;
      }
      
      // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      function closeDropdown() {
        dropdownTimeout = setTimeout(() => {
          dropdown.classList.remove('show');
          isDropdownOpen = false;
          dropdownTimeout = null;
        }, 150);
      }
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      input.addEventListener('input', function(e) {
        e.stopPropagation();
        updateDropdown(this.value);
        if (!isDropdownOpen) {
          openDropdown();
        }
      });
      
      input.addEventListener('focus', function(e) {
        e.stopPropagation();
        openDropdown();
      });
      
      input.addEventListener('click', function(e) {
        e.stopPropagation();
        openDropdown();
      });
      
      // ë“œë¡­ë‹¤ìš´ ì•„ì´í…œ í´ë¦­
      dropdown.addEventListener('mousedown', function(e) {
        e.stopPropagation();
        const item = e.target.closest('.pal-dropdown-item');
        if (item && item.dataset.value) {
          const value = item.dataset.value;
          input.value = value;
          hidden.value = value;
          closeDropdown();
        }
      });
      
      // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('mousedown', function(e) {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          closeDropdown();
        }
      });
    }
    
    // HTML ì´ìŠ¤ì¼€ì´í”„
    function palEscapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // í’ˆëª© í•­ëª© ì¶”ê°€
    function palAddProductItem() {
      const itemsList = document.getElementById('palProductItemsList');
      if (!itemsList) return;
      
      const itemIndex = itemsList.children.length;
      const itemDiv = document.createElement('div');
      itemDiv.className = 'pal-product-item';
      itemDiv.dataset.index = itemIndex;
      itemDiv.innerHTML = `
        <div class="pal-product-item-header">
          <span class="pal-product-item-title">í’ˆëª© ${itemIndex + 1}</span>
          <button type="button" class="pal-product-item-remove" onclick="palRemoveProductItem(${itemIndex})">ì‚­ì œ</button>
        </div>
        <div class="pal-product-item-content">
          <input type="text" class="pal-product-name-input" placeholder="í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" data-index="${itemIndex}">
          <div class="pal-product-quantity-control">
            <button type="button" class="pal-product-quantity-btn" onclick="palUpdateProductQuantity(${itemIndex}, -1)">-</button>
            <span class="pal-product-quantity-value" data-index="${itemIndex}">1</span>
            <button type="button" class="pal-product-quantity-btn" onclick="palUpdateProductQuantity(${itemIndex}, 1)">+</button>
          </div>
        </div>
      `;
      itemsList.appendChild(itemDiv);
    }
    
    // í’ˆëª© í•­ëª© ì œê±°
    function palRemoveProductItem(index) {
      const itemsList = document.getElementById('palProductItemsList');
      if (!itemsList) return;
      
      const items = Array.from(itemsList.children);
      if (items.length <= 1) {
        alert('ìµœì†Œ 1ê°œì˜ í’ˆëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }
      
      const itemToRemove = items.find(item => parseInt(item.dataset.index) === index);
      if (itemToRemove) {
        itemToRemove.remove();
        // ì¸ë±ìŠ¤ ì¬ì •ë ¬
        palReorderProductItems();
      }
    }
    
    // í’ˆëª© í•­ëª© ì¸ë±ìŠ¤ ì¬ì •ë ¬
    function palReorderProductItems() {
      const itemsList = document.getElementById('palProductItemsList');
      if (!itemsList) return;
      
      const items = Array.from(itemsList.children);
      items.forEach((item, newIndex) => {
        item.dataset.index = newIndex;
        const titleSpan = item.querySelector('.pal-product-item-title');
        if (titleSpan) {
          titleSpan.textContent = `í’ˆëª© ${newIndex + 1}`;
        }
        const nameInput = item.querySelector('.pal-product-name-input');
        if (nameInput) {
          nameInput.dataset.index = newIndex;
        }
        const quantityValue = item.querySelector('.pal-product-quantity-value');
        if (quantityValue) {
          quantityValue.dataset.index = newIndex;
        }
        const removeBtn = item.querySelector('.pal-product-item-remove');
        if (removeBtn) {
          removeBtn.setAttribute('onclick', `palRemoveProductItem(${newIndex})`);
        }
        const minusBtn = item.querySelector('.pal-product-quantity-btn');
        if (minusBtn && minusBtn.textContent === '-') {
          minusBtn.setAttribute('onclick', `palUpdateProductQuantity(${newIndex}, -1)`);
        }
        const plusBtn = item.querySelectorAll('.pal-product-quantity-btn')[1];
        if (plusBtn && plusBtn.textContent === '+') {
          plusBtn.setAttribute('onclick', `palUpdateProductQuantity(${newIndex}, 1)`);
        }
      });
    }
    
    // í’ˆëª© ìˆ˜ëŸ‰ ì¡°ì ˆ
    function palUpdateProductQuantity(index, change) {
      const itemsList = document.getElementById('palProductItemsList');
      if (!itemsList) return;
      
      const item = Array.from(itemsList.children).find(item => parseInt(item.dataset.index) === index);
      if (!item) return;
      
      const quantityValue = item.querySelector('.pal-product-quantity-value');
      if (!quantityValue) return;
      
      let currentQuantity = parseInt(quantityValue.textContent) || 1;
      currentQuantity += change;
      
      if (currentQuantity < 1) {
        currentQuantity = 1;
      }
      
      quantityValue.textContent = currentQuantity;
      
      // - ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
      const minusBtn = item.querySelector('.pal-product-quantity-btn');
      if (minusBtn && minusBtn.textContent === '-') {
        minusBtn.disabled = currentQuantity <= 1;
      }
    }
    
    // íŒŒë ˆíŠ¸ ì…ê³  ì²˜ë¦¬
    async function palInbound() {
      const messageDiv = document.getElementById('palInboundMessage');
      messageDiv.innerHTML = '<div class="pal-message info">ì²˜ë¦¬ ì¤‘...</div>';
      
      try {
        // í™”ì£¼ì‚¬ëª… ê°€ì ¸ì˜¤ê¸° (hidden í•„ë“œ ìš°ì„ , ì—†ìœ¼ë©´ input í•„ë“œ)
        const hiddenCompanyName = document.getElementById('palInboundCompanyName').value;
        const inputCompanyName = document.getElementById('palInboundCompanyInput').value;
        const companyName = hiddenCompanyName || inputCompanyName;
        
        console.log('[PAL] ì…ê³  í™”ì£¼ì‚¬ëª…:', { hiddenCompanyName, inputCompanyName, companyName });
        
        if (!companyName || companyName.trim() === '') {
          messageDiv.innerHTML = '<div class="pal-message error">í™”ì£¼ì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.</div>';
          return;
        }
        
        // í’ˆëª© ë¦¬ìŠ¤íŠ¸ì—ì„œ ë°ì´í„° ìˆ˜ì§‘
        const itemsList = document.getElementById('palProductItemsList');
        if (!itemsList || itemsList.children.length === 0) {
          messageDiv.innerHTML = '<div class="pal-message error">ìµœì†Œ 1ê°œì˜ í’ˆëª©ì„ ì…ë ¥í•˜ì„¸ìš”.</div>';
          return;
        }
        
        const pallets = [];
        const items = Array.from(itemsList.children);
        
        for (const item of items) {
          const productNameInput = item.querySelector('.pal-product-name-input');
          const quantityValue = item.querySelector('.pal-product-quantity-value');
          
          if (!productNameInput || !quantityValue) continue;
          
          const productName = (productNameInput.value || '').trim();
          const quantity = parseInt(quantityValue.textContent) || 1;
          
          if (!productName) {
            messageDiv.innerHTML = '<div class="pal-message error">ëª¨ë“  í’ˆëª©ì˜ í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.</div>';
            return;
          }
          
          // ê° ìˆ˜ëŸ‰ë§Œí¼ íŒŒë ˆíŠ¸ ìƒì„± (íŒŒë ˆíŠ¸ IDëŠ” ë°±ì—”ë“œì—ì„œ ìë™ ìƒì„±)
          for (let i = 0; i < quantity; i++) {
            pallets.push({
              pallet_id: null, // ìë™ ìƒì„±
              company_name: companyName.trim(),
              product_name: productName,
              in_date: document.getElementById('palInboundDate').value,
              storage_location: document.getElementById('palInboundLocation').value || null,
              quantity: 1, // ê° íŒŒë ˆíŠ¸ëŠ” ìˆ˜ëŸ‰ 1
              is_service: document.getElementById('palInboundIsService').checked,
              notes: document.getElementById('palInboundNotes').value || null
            });
          }
        }
        
        if (pallets.length === 0) {
          messageDiv.innerHTML = '<div class="pal-message error">ë“±ë¡í•  íŒŒë ˆíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        
        console.log('[PAL] ì…ê³  ë°ì´í„°:', { pallets_count: pallets.length, pallets });
        
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/inbound`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...palGetUserHeaders()
          },
          body: JSON.stringify({ pallets })
        });
        
        const result = await response.json();
        
        if (result.success) {
          messageDiv.innerHTML = '<div class="pal-message success">âœ… ' + result.message + '</div>';
          // í¼ ì´ˆê¸°í™”
          document.getElementById('palInboundForm').reset();
          document.getElementById('palInboundDate').value = new Date().toISOString().split('T')[0];
          // í’ˆëª© ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” (1ê°œë§Œ ë‚¨ê¸°ê¸°)
          const itemsList = document.getElementById('palProductItemsList');
          if (itemsList) {
            itemsList.innerHTML = '';
            palAddProductItem();
          }
          // íŒŒë ˆíŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          palLoadPallets();
        } else {
          messageDiv.innerHTML = '<div class="pal-message error">âŒ ' + result.message + '</div>';
        }
      } catch (error) {
        console.error('íŒŒë ˆíŠ¸ ì…ê³  ì˜¤ë¥˜:', error);
        messageDiv.innerHTML = '<div class="pal-message error">âŒ íŒŒë ˆíŠ¸ ì…ê³  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
      }
    }
    
    // ëŒ€ëŸ‰ íŒŒë ˆíŠ¸ ì…ê³ 
    async function palBulkInbound() {
      const messageDiv = document.getElementById('palBulkMessage');
      const fileInput = document.getElementById('palBulkFileInput');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        messageDiv.innerHTML = '<div class="pal-message error">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>';
        return;
      }
      
      messageDiv.innerHTML = '<div class="pal-message info">íŒŒì¼ì„ ì½ëŠ” ì¤‘...</div>';
      
      // íŒŒì¼ ì½ê¸° (ê°„ë‹¨í•œ CSV íŒŒì‹±)
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        try {
          const text = e.target.result;
          const lines = text.split('\n').filter(line => line.trim());
          const headers = lines[0].split(',').map(h => h.trim());
          
          const pallets = [];
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim());
            const pallet = {};
            
            headers.forEach((header, index) => {
              pallet[header] = values[index] || null;
            });
            
            // ë°ì´í„° ë³€í™˜
            pallets.push({
              pallet_id: pallet['íŒŒë ˆíŠ¸ ID'] || pallet['pallet_id'] || null,
              company_name: pallet['í™”ì£¼ì‚¬'] || pallet['company_name'],
              product_name: pallet['í’ˆëª©ëª…'] || pallet['product_name'] || null,
              in_date: pallet['ì…ê³ ì¼'] || pallet['in_date'],
              storage_location: pallet['ë³´ê´€ ìœ„ì¹˜'] || pallet['storage_location'] || null,
              quantity: parseInt(pallet['ìˆ˜ëŸ‰'] || pallet['quantity'] || 1),
              is_service: pallet['ì„œë¹„ìŠ¤ ì—¬ë¶€'] === 'Y' || pallet['is_service'] === true,
              notes: pallet['ë¹„ê³ '] || pallet['notes'] || null
            });
          }
          
          messageDiv.innerHTML = '<div class="pal-message info">' + pallets.length + 'ê°œ íŒŒë ˆíŠ¸ ì…ê³  ì²˜ë¦¬ ì¤‘...</div>';
          
          const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/inbound/bulk`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...palGetUserHeaders()
            },
            body: JSON.stringify({ pallets })
          });
          
          const result = await response.json();
          
          if (result.success) {
            messageDiv.innerHTML = '<div class="pal-message success">âœ… ' + result.message + '</div>';
            fileInput.value = '';
            palLoadPallets();
          } else {
            messageDiv.innerHTML = '<div class="pal-message error">âŒ ' + result.message + '</div>';
          }
        } catch (error) {
          console.error('ëŒ€ëŸ‰ ì…ê³  ì˜¤ë¥˜:', error);
          messageDiv.innerHTML = '<div class="pal-message error">âŒ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
        }
      };
      
      reader.readAsText(file);
    }
    
    // QR ìŠ¤ìº” ì‹œì‘
    async function palStartQRScan() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        
        palQRStream = stream;
        palQRScanning = true;
        
        const video = document.getElementById('palQRVideo');
        const scanner = document.getElementById('palQRScanner');
        const startBtn = document.getElementById('palQRStartBtn');
        const stopBtn = document.getElementById('palQRStopBtn');
        
        video.srcObject = stream;
        scanner.style.display = 'block';
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        
        // QR ì½”ë“œ ìŠ¤ìº” (ê°„ë‹¨í•œ êµ¬í˜„, ì‹¤ì œë¡œëŠ” jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¶Œì¥)
        palScanQRCode();
      } catch (error) {
        console.error('QR ìŠ¤ìº” ì‹œì‘ ì˜¤ë¥˜:', error);
        alert('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      }
    }
    
    // QR ìŠ¤ìº” ì¤‘ì§€
    function palStopQRScan() {
      if (palQRStream) {
        palQRStream.getTracks().forEach(track => track.stop());
        palQRStream = null;
      }
      
      palQRScanning = false;
      
      const video = document.getElementById('palQRVideo');
      const scanner = document.getElementById('palQRScanner');
      const startBtn = document.getElementById('palQRStartBtn');
      const stopBtn = document.getElementById('palQRStopBtn');
      const result = document.getElementById('palQRResult');
      
      video.srcObject = null;
      scanner.style.display = 'none';
      startBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      result.style.display = 'none';
      palScannedPalletId = null;
    }
    
    // QR ì½”ë“œ ìŠ¤ìº” (ê°„ë‹¨í•œ êµ¬í˜„)
    async function palScanQRCode() {
      const video = document.getElementById('palQRVideo');
      const canvas = document.getElementById('palQRCanvas');
      const context = canvas.getContext('2d');
      
      function scan() {
        if (!palQRScanning) return;
        
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          // ì‹¤ì œë¡œëŠ” jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ QR ì½”ë“œ ë””ì½”ë”©
          // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ ì˜ˆì‹œë¡œ ìˆ˜ë™ ì…ë ¥ ì˜µì…˜ ì œê³µ
        }
        
        requestAnimationFrame(scan);
      }
      
      scan();
    }
    
    // ë³´ê´€ì¤‘ì¸ íŒŒë ˆíŠ¸ ê²€ìƒ‰ (ì¶œê³ ìš©)
    async function palSearchPalletsForOutbound() {
      const tbody = document.getElementById('palOutboundPalletsTableBody');
      const countSpan = document.getElementById('palOutboundPalletsCount');
      
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="7" class="no-data">ê²€ìƒ‰ ì¤‘...</td></tr>';
      
      try {
        const searchId = document.getElementById('palOutboundSearchId').value.trim();
        const company = palCurrentRole === 'ê´€ë¦¬ì' 
          ? (document.getElementById('palOutboundCompanyName').value || document.getElementById('palOutboundCompanyInput').value || '')
          : palCurrentCompany;
        const productName = document.getElementById('palOutboundProductName').value.trim();
        
        const params = new URLSearchParams();
        params.append('status', 'ì…ê³ ë¨'); // ë³´ê´€ì¤‘ì¸ íŒŒë ˆíŠ¸ë§Œ
        
        if (palCurrentRole === 'ê´€ë¦¬ì' && company) {
          params.append('company', company);
        } else if (palCurrentRole !== 'ê´€ë¦¬ì' && company) {
          params.append('company', company);
        }
        
        if (searchId) {
          params.append('pallet_id', searchId);
        }
        
        if (productName) {
          params.append('product_name', productName);
        }
        
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/list?${params.toString()}`, {
          headers: palGetUserHeaders()
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const pallets = result.data;
          if (countSpan) countSpan.textContent = `(${pallets.length}ê°œ)`;
          
          if (pallets.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="no-data">ë³´ê´€ì¤‘ì¸ íŒŒë ˆíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          } else {
            tbody.innerHTML = pallets.map(pallet => {
              // ë°±ì—”ë“œì—ì„œ ê³„ì‚°ëœ storage_days ì‚¬ìš©, ì—†ìœ¼ë©´ ì§ì ‘ ê³„ì‚°
              let storageDays = pallet.storage_days;
              if (!storageDays && pallet.in_date) {
                // ë‚ ì§œë§Œ ë¹„êµ (ì‹œê°„ ì œì™¸)
                const inDate = new Date(pallet.in_date + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                storageDays = Math.floor((today - inDate) / (1000 * 60 * 60 * 24)) + 1;
                storageDays = Math.max(1, storageDays); // ìµœì†Œ 1ì¼
              }
              
              return `
                <tr style="cursor: pointer;" onclick="palSelectPalletForOutbound('${pallet.pallet_id}')">
                  <td style="text-align: center;">
                    <input type="radio" name="palOutboundSelected" value="${pallet.pallet_id}" onclick="event.stopPropagation(); palSelectPalletForOutbound('${pallet.pallet_id}')">
                  </td>
                  <td>${palEscapeHtml(pallet.pallet_id)}</td>
                  <td>${palEscapeHtml(pallet.company_name)}</td>
                  <td>${palEscapeHtml(pallet.product_name || '-')}</td>
                  <td>${pallet.in_date}</td>
                  <td>${storageDays || 1}ì¼</td>
                  <td>${palEscapeHtml(pallet.storage_location || pallet.location || '-')}</td>
                </tr>
              `;
            }).join('');
          }
        } else {
          tbody.innerHTML = '<tr><td colspan="7" class="no-data">âŒ ' + (result.message || 'ê²€ìƒ‰ ì‹¤íŒ¨') + '</td></tr>';
        }
      } catch (error) {
        console.error('íŒŒë ˆíŠ¸ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }
    
    // íŒŒë ˆíŠ¸ ì„ íƒ (ì¶œê³ ìš©)
    async function palSelectPalletForOutbound(palletId) {
      // ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ
      document.querySelectorAll('input[name="palOutboundSelected"]').forEach(radio => {
        radio.checked = radio.value === palletId;
      });
      
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/${palletId}`, {
          headers: palGetUserHeaders()
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const pallet = result.data;
          // ë°±ì—”ë“œì—ì„œ ê³„ì‚°ëœ storage_days ì‚¬ìš©, ì—†ìœ¼ë©´ ì§ì ‘ ê³„ì‚°
          let storageDays = pallet.storage_days;
          if (!storageDays && pallet.in_date) {
            // ë‚ ì§œë§Œ ë¹„êµ (ì‹œê°„ ì œì™¸)
            const inDate = new Date(pallet.in_date + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            storageDays = Math.floor((today - inDate) / (1000 * 60 * 60 * 24)) + 1;
            storageDays = Math.max(1, storageDays); // ìµœì†Œ 1ì¼
          }
          
          const selectedContent = document.getElementById('palOutboundSelectedContent');
          const selectedInfo = document.getElementById('palOutboundSelectedInfo');
          
          if (selectedContent && selectedInfo) {
            selectedContent.innerHTML = `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div><strong>íŒŒë ˆíŠ¸ ID:</strong> ${palEscapeHtml(pallet.pallet_id)}</div>
                <div><strong>í™”ì£¼ì‚¬:</strong> ${palEscapeHtml(pallet.company_name)}</div>
                <div><strong>í’ˆëª©ëª…:</strong> ${palEscapeHtml(pallet.product_name || '-')}</div>
                <div><strong>ì…ê³ ì¼:</strong> ${pallet.in_date}</div>
                <div><strong>ë³´ê´€ì¼ìˆ˜:</strong> ${storageDays}ì¼</div>
                <div><strong>ë³´ê´€ ìœ„ì¹˜:</strong> ${palEscapeHtml(pallet.location || '-')}</div>
                <div><strong>ìˆ˜ëŸ‰:</strong> ${pallet.quantity || 1}</div>
                <div><strong>ì„œë¹„ìŠ¤:</strong> ${pallet.is_service ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}</div>
              </div>
              ${pallet.notes ? `<div style="margin-top: 10px;"><strong>ë¹„ê³ :</strong> ${palEscapeHtml(pallet.notes)}</div>` : ''}
            `;
            
            selectedInfo.style.display = 'block';
            palScannedPalletId = palletId;
            
            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const outboundDateEl = document.getElementById('palOutboundDate');
            if (outboundDateEl && !outboundDateEl.value) {
              outboundDateEl.value = new Date().toISOString().split('T')[0];
            }
          }
        } else {
          alert('íŒŒë ˆíŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('íŒŒë ˆíŠ¸ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
        alert('íŒŒë ˆíŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬ í™•ì¸
    async function palConfirmOutbound() {
      if (!palScannedPalletId) {
        alert('íŒŒë ˆíŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const messageDiv = document.getElementById('palOutboundMessage');
      messageDiv.innerHTML = '<div class="pal-message info">ì²˜ë¦¬ ì¤‘...</div>';
      
      try {
        const data = {
          pallet_id: palScannedPalletId,
          out_date: document.getElementById('palOutboundDate').value || null,
          notes: document.getElementById('palOutboundNotes').value || null
        };
        
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/outbound`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...palGetUserHeaders()
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          messageDiv.innerHTML = '<div class="pal-message success">âœ… ' + result.message + '</div>';
          
          // ì„ íƒ ì •ë³´ ì´ˆê¸°í™”
          palCancelOutbound();
          
          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          palSearchPalletsForOutbound();
          
          // íŒŒë ˆíŠ¸ í˜„í™©ë„ ìƒˆë¡œê³ ì¹¨ (í†µê³„ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸ë¨)
          palLoadPallets();
        } else {
          messageDiv.innerHTML = '<div class="pal-message error">âŒ ' + result.message + '</div>';
        }
      } catch (error) {
        console.error('ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        messageDiv.innerHTML = '<div class="pal-message error">âŒ ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
      }
    }
    
    // ì„ íƒ ì·¨ì†Œ
    function palCancelOutbound() {
      const selectedInfo = document.getElementById('palOutboundSelectedInfo');
      if (selectedInfo) {
        selectedInfo.style.display = 'none';
      }
      
      // ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ í•´ì œ
      document.querySelectorAll('input[name="palOutboundSelected"]').forEach(radio => {
        radio.checked = false;
      });
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      const outboundDateEl = document.getElementById('palOutboundDate');
      const outboundNotesEl = document.getElementById('palOutboundNotes');
      if (outboundDateEl) outboundDateEl.value = '';
      if (outboundNotesEl) outboundNotesEl.value = '';
      
      palScannedPalletId = null;
    }
    
    // íŒŒë ˆíŠ¸ ëª©ë¡ ë¡œë“œ
    async function palLoadPallets() {
      const tbody = document.getElementById('palPalletsTableBody');
      const countSpan = document.getElementById('palPalletsCount');
      
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
      
      try {
        const company = palCurrentRole === 'ê´€ë¦¬ì' 
          ? (document.getElementById('palFilterCompanyName').value || document.getElementById('palFilterCompanyInput').value || '')
          : palCurrentCompany;
        const status = document.getElementById('palFilterStatus').value;
        const month = document.getElementById('palFilterMonth').value;
        const palletId = document.getElementById('palFilterPalletId')?.value?.trim() || '';
        
        // URL íŒŒë¼ë¯¸í„° êµ¬ì„± (roleì€ í—¤ë”ì—ì„œë§Œ ì „ì†¡)
        const params = new URLSearchParams();
        
        // ê´€ë¦¬ìì¸ ê²½ìš°ì—ë§Œ company íŒŒë¼ë¯¸í„° ì¶”ê°€ (ë¹„ì–´ìˆì§€ ì•Šì„ ë•Œë§Œ)
        if (palCurrentRole === 'ê´€ë¦¬ì' && company) {
          params.append('company', company);
        } else if (palCurrentRole !== 'ê´€ë¦¬ì' && company) {
          // í™”ì£¼ì‚¬ì¸ ê²½ìš° í•„ìˆ˜
          params.append('company', company);
        }
        
        // statusê°€ 'ì „ì²´'ê°€ ì•„ë‹ ë•Œë§Œ ì¶”ê°€
        if (status && status !== 'ì „ì²´') {
          params.append('status', status);
        }
        
        if (month) {
          params.append('month', month);
        }
        
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/list?${params}`, {
          headers: palGetUserHeaders()
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          const pallets = result.data || [];
          
          // í†µê³„ ì—…ë°ì´íŠ¸
          const total = pallets.length;
          const storage = pallets.filter(p => p.status === 'ì…ê³ ë¨').length;
          const completed = pallets.filter(p => p.status === 'ë³´ê´€ì¢…ë£Œ').length;
          const monthlyFee = pallets.reduce((sum, p) => sum + (p.current_fee || 0), 0);
          
          document.getElementById('palTotalPallets').textContent = total;
          document.getElementById('palStoragePallets').textContent = storage;
          document.getElementById('palCompletedPallets').textContent = completed;
          document.getElementById('palMonthlyFee').textContent = monthlyFee.toLocaleString() + 'ì›';
          
          countSpan.textContent = `(${total}ê°œ)`;
          
          // íŒŒë ˆíŠ¸ ID í•„í„°ë§ (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ)
          let filteredPallets = pallets;
          if (palletId) {
            filteredPallets = pallets.filter(p => 
              p.pallet_id && p.pallet_id.toLowerCase().includes(palletId.toLowerCase())
            );
          }
          
          if (filteredPallets.length === 0) {
            tbody.innerHTML = '<tr><td colspan="13" class="no-data">íŒŒë ˆíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          } else {
            tbody.innerHTML = filteredPallets.map(pallet => {
              // ì„œë¹„ìŠ¤ íŒŒë ˆíŠ¸ëŠ” ìƒíƒœë¥¼ "ì„œë¹„ìŠ¤"ë¡œ í‘œì‹œ
              let statusText = pallet.status || 'ì…ê³ ë¨';
              if (pallet.is_service === 1 || pallet.is_service === true) {
                statusText = 'ì„œë¹„ìŠ¤';
              }
              const canOutbound = statusText === 'ì…ê³ ë¨';
              
              // ê°±ì‹ ì¼ ê³„ì‚° (ë³´ê´€ì´ 1ë‹¬ ì´ìƒì´ë©´ ë§¤ì›” 1ì¼)
              let renewalDateStr = '-';
              if (pallet.in_date) {
                const inDate = new Date(pallet.in_date + 'T00:00:00+09:00');
                if (!isNaN(inDate.getTime())) {
                  if (!pallet.out_date) {
                    // ë³´ê´€ì¤‘ì¸ ê²½ìš°
                    const today = new Date();
                    const monthsDiff = (today.getFullYear() - inDate.getFullYear()) * 12 + (today.getMonth() - inDate.getMonth());
                    if (monthsDiff >= 1) {
                      // ë§ˆì§€ë§‰ ê°±ì‹ ì¼ (í˜„ì¬ ì›”ì˜ 1ì¼)
                      const lastRenewal = new Date(today.getFullYear(), today.getMonth(), 1);
                      renewalDateStr = lastRenewal.toLocaleDateString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                      }).replace(/\. /g, '-').replace(/\./g, '');
                    }
                  } else {
                    // ë³´ê´€ì¢…ë£Œëœ ê²½ìš°
                    const outDate = new Date(pallet.out_date + 'T00:00:00+09:00');
                    if (!isNaN(outDate.getTime())) {
                      const monthsDiff = (outDate.getFullYear() - inDate.getFullYear()) * 12 + (outDate.getMonth() - inDate.getMonth());
                      if (monthsDiff >= 1) {
                        // ë§ˆì§€ë§‰ ê°±ì‹ ì¼ (ë³´ê´€ì¢…ë£Œ ì›”ì˜ 1ì¼)
                        const lastRenewal = new Date(outDate.getFullYear(), outDate.getMonth(), 1);
                        renewalDateStr = lastRenewal.toLocaleDateString('ko-KR', {
                          year: 'numeric',
                          month: '2-digit',
                          day: '2-digit'
                        }).replace(/\. /g, '-').replace(/\./g, '');
                      }
                    }
                  }
                }
              }
              
              return `
              <tr>
                ${palCurrentRole === 'ê´€ë¦¬ì' 
                  ? `<td style="text-align: center;"><input type="checkbox" class="pal-pallet-checkbox" data-pallet-id="${palEscapeHtml(pallet.pallet_id)}" onchange="palUpdatePalletSelection()" style="width: 16px; height: 16px;"></td>`
                  : ''
                }
                <td style="font-size: 11px;">${palEscapeHtml(pallet.pallet_id)}</td>
                <td style="font-size: 11px;">${palEscapeHtml(pallet.company_name || '')}</td>
                <td style="font-size: 11px; white-space: normal; word-break: break-word; max-width: 150px;">${palEscapeHtml(pallet.product_name || '')}</td>
                <td style="font-size: 11px; font-weight: 600;">${palEscapeHtml(statusText)}</td>
                <td style="font-size: 11px;">${pallet.in_date || ''}</td>
                <td style="font-size: 11px;">${renewalDateStr}</td>
                <td style="font-size: 11px;">${pallet.out_date || '-'}</td>
                <td style="font-size: 11px;">${pallet.total_storage_days || pallet.storage_days || 0}ì¼</td>
                <td style="font-size: 11px;">${pallet.monthly_storage_days || 0}ì¼</td>
                <td style="font-size: 11px; font-weight: 600;">${(pallet.current_fee || 0).toLocaleString()}ì›</td>
                <td>
                  <div style="display: flex; gap: 3px; align-items: center; justify-content: center;">
                    <button class="pal-btn" onclick="palViewQRCode('${pallet.pallet_id}', '${pallet.in_date || ''}')" style="padding: 4px 8px; font-size: 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; line-height: 1.2;">QR</button>
                  </div>
                </td>
                <td>
                  <div style="display: flex; gap: 3px; align-items: center; justify-content: center; flex-wrap: nowrap;">
                    ${canOutbound 
                      ? `<button class="pal-btn" onclick="palOutboundFromStatus('${pallet.pallet_id}')" style="padding: 4px 8px; font-size: 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; line-height: 1.2;">ë³´ê´€ì¢…ë£Œ</button>`
                      : ''
                    }
                    ${palCurrentRole === 'ê´€ë¦¬ì' 
                      ? `<button class="pal-btn" onclick="palDeletePalletFromStatus('${pallet.pallet_id}')" style="padding: 4px 8px; font-size: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; line-height: 1.2;">ì‚­ì œ</button>`
                      : ''
                    }
                    ${!canOutbound && palCurrentRole !== 'ê´€ë¦¬ì' 
                      ? '<span style="color: #999; font-size: 10px;">-</span>'
                      : ''
                    }
                  </div>
                </td>
              </tr>
            `;
            }).join('');
          }
        } else {
          tbody.innerHTML = '<tr><td colspan="13" class="no-data">âŒ ' + result.message + '</td></tr>';
        }
      } catch (error) {
        console.error('â—â–¶ íŒŒë ˆíŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        let errorMessage = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_RESET'))) {
          errorMessage = 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        tbody.innerHTML = '<tr><td colspan="13" class="no-data">âŒ ' + errorMessage + '</td></tr>';
        if (countSpan) countSpan.textContent = '(ì˜¤ë¥˜)';
      }
    }
    
    // QR ì½”ë“œ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    let palCurrentQRPalletId = null;
    let palCurrentQRInDate = null;
    
    // QR ì½”ë“œ ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
    async function palViewQRCode(palletId, inDate) {
      try {
        // íŒŒë ˆíŠ¸ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í™”ì£¼ì‚¬, í’ˆëª©ëª… í¬í•¨)
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/${palletId}`, {
          headers: palGetUserHeaders()
        });
        
        const result = await response.json();
        const palletInfo = result.success && result.data ? result.data : null;
        
        palCurrentQRPalletId = palletId;
        palCurrentQRInDate = palletInfo?.in_date || inDate || '';
        
        const modal = document.getElementById('palQRModal');
        const titleEl = document.getElementById('palQRTitle');
        const inDateEl = document.getElementById('palQRInDate');
        const qrContainer = document.getElementById('palQRCodeContainer');
        
        if (modal && titleEl && inDateEl && qrContainer) {
          titleEl.textContent = `íŒŒë ˆíŠ¸ ID: ${palletId}`;
          inDateEl.textContent = `ì…ê³ ì¼: ${palCurrentQRInDate || '-'}`;
          
          // QR ì½”ë“œ ìƒì„± (quickchart.io ì‚¬ìš©)
          // Google Apps Scriptì™€ ë™ì¼í•œ í˜•ì‹: íŒŒë ˆíŠ¸ID, ì‘ì—…ìœ í˜•(ë³´ê´€ì¢…ë£Œ), í™”ì£¼ì‚¬, í’ˆëª©ëª… í¬í•¨
          const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdDmnWcW27tfDptUvuSjEgN8K7nNNQWecdpeMMhwftTtbiyIQ/viewform";
          const vendor = palletInfo?.company_name || '';
          const product = palletInfo?.product_name || '';
          // entry.419411235 = íŒŒë ˆíŠ¸ ID
          // entry.427884801 = ì‘ì—… ìœ í˜• (ë³´ê´€ì¢…ë£Œ)
          // entry.2110345042 = í™”ì£¼ì‚¬
          // entry.306824944 = í’ˆëª©ëª…
          const qrText = `${formUrl}?usp=pp_url&entry.419411235=${encodeURIComponent(palletId)}&entry.427884801=ë³´ê´€ì¢…ë£Œ&entry.2110345042=${encodeURIComponent(vendor)}&entry.306824944=${encodeURIComponent(product)}`;
          const qrImageUrl = `https://quickchart.io/qr?text=${encodeURIComponent(qrText)}&size=300`;
          
          qrContainer.innerHTML = `<img src="${qrImageUrl}" alt="QR Code" style="max-width: 300px; width: 100%; height: auto;">`;
          
          modal.style.display = 'block';
        }
      } catch (error) {
        console.error('QR ì½”ë“œ ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
        alert('QR ì½”ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // QR ì½”ë“œ ëª¨ë‹¬ ë‹«ê¸°
    function palCloseQRModal() {
      const modal = document.getElementById('palQRModal');
      if (modal) {
        modal.style.display = 'none';
      }
      palCurrentQRPalletId = null;
      palCurrentQRInDate = null;
    }
    
    // QR ì½”ë“œ ì¸ì‡„ (63.5mm * 70mm ë¼ë²¨)
    async function palPrintQRCode() {
      if (!palCurrentQRPalletId) return;
      
      try {
        // íŒŒë ˆíŠ¸ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/${palCurrentQRPalletId}`, {
          headers: palGetUserHeaders()
        });
        
        const result = await response.json();
        const palletInfo = result.success && result.data ? result.data : null;
        
        const printArea = document.getElementById('palQRPrintArea');
        if (!printArea) return;
        
        // ì…ê³ ì¼ í¬ë§·íŒ…
        let inDateStr = '-';
        if (palCurrentQRInDate) {
          try {
            const inDate = new Date(palCurrentQRInDate);
            if (!isNaN(inDate.getTime())) {
              inDateStr = inDate.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
              }).replace(/\. /g, '-').replace(/\./g, '');
            }
          } catch (e) {
            inDateStr = palCurrentQRInDate;
          }
        }
        
        // QR ì½”ë“œ ì´ë¯¸ì§€ ìƒì„± (ì¸ì‡„ìš© í¬ê¸°, í™”ì£¼ì‚¬, í’ˆëª©ëª… í¬í•¨)
        const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdDmnWcW27tfDptUvuSjEgN8K7nNNQWecdpeMMhwftTtbiyIQ/viewform";
        const vendor = palletInfo?.company_name || '';
        const product = palletInfo?.product_name || '';
        const qrText = `${formUrl}?usp=pp_url&entry.419411235=${encodeURIComponent(palCurrentQRPalletId)}&entry.427884801=ë³´ê´€ì¢…ë£Œ&entry.2110345042=${encodeURIComponent(vendor)}&entry.306824944=${encodeURIComponent(product)}`;
        const qrImageUrl = `https://quickchart.io/qr?text=${encodeURIComponent(qrText)}&size=150`;
        
        // ì¸ì‡„ìš© HTML ìƒì„± (border ì œê±°, QR í¬ê¸° ì¡°ì •)
        printArea.innerHTML = `
          <div id="palQRPrintContent" style="width: 63.5mm; height: 70mm; padding: 3mm; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: white;">
            <div style="width: 100%; text-align: center; flex-shrink: 0; margin-bottom: 3px;">
              <div style="font-size: 11px; font-weight: 600; margin-bottom: 2px; line-height: 1.2;">íŒŒë ˆíŠ¸ ID: ${palEscapeHtml(palCurrentQRPalletId)}</div>
              <div style="font-size: 11px; font-weight: 600; margin-bottom: 3px; line-height: 1.2;">${palEscapeHtml(product || '-')}</div>
            </div>
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 3px; width: 100%; flex-shrink: 0;">
              <img src="${qrImageUrl}" alt="QR Code" style="width: 150px; height: 150px; max-width: 100%; max-height: 100%; object-fit: contain;">
            </div>
            <div style="width: 100%; text-align: center; flex-shrink: 0;">
              <div style="font-size: 11px; font-weight: 600; margin-bottom: 2px; line-height: 1.2;">í™”ì£¼ì‚¬: ${palEscapeHtml(vendor)}</div>
              <div style="font-size: 11px; font-weight: 600; line-height: 1.2;">ì…ê³ ì¼: ${inDateStr}</div>
            </div>
          </div>
        `;
        
        // ì¸ì‡„ ìŠ¤íƒ€ì¼ ì¶”ê°€
        const printStyle = document.createElement('style');
        printStyle.id = 'palQRPrintStyle';
        printStyle.textContent = `
          @media print {
            @page {
              size: 63.5mm 70mm;
              margin: 0;
            }
            * {
              margin: 0;
              padding: 0;
            }
            html, body {
              width: 63.5mm !important;
              height: 70mm !important;
              margin: 0 !important;
              padding: 0 !important;
              overflow: hidden !important;
            }
            body > *:not(#palQRPrintArea) {
              display: none !important;
            }
            #palQRPrintArea {
              display: block !important;
              position: absolute !important;
              left: 0 !important;
              top: 0 !important;
              width: 63.5mm !important;
              height: 70mm !important;
              margin: 0 !important;
              padding: 0 !important;
              page-break-after: avoid !important;
              page-break-inside: avoid !important;
            }
            #palQRPrintContent {
              display: flex !important;
              width: 63.5mm !important;
              height: 70mm !important;
              margin: 0 !important;
              padding: 3mm !important;
              box-sizing: border-box !important;
              page-break-inside: avoid !important;
              overflow: hidden !important;
            }
            #palQRPrintContent img {
              max-width: 100% !important;
              max-height: 100% !important;
              width: auto !important;
              height: auto !important;
              object-fit: contain !important;
            }
          }
        `;
        
        // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì œê±°
        const existingStyle = document.getElementById('palQRPrintStyle');
        if (existingStyle) {
          document.head.removeChild(existingStyle);
        }
        
        document.head.appendChild(printStyle);
        
        // bodyì˜ ë‹¤ë¥¸ ëª¨ë“  ìš”ì†Œ ìˆ¨ê¸°ê¸° (ì„ì‹œ)
        const bodyChildren = Array.from(document.body.children);
        const hiddenElements = [];
        bodyChildren.forEach(child => {
          if (child.id !== 'palQRPrintArea') {
            const originalDisplay = window.getComputedStyle(child).display;
            child.setAttribute('data-pal-original-display', originalDisplay);
            child.style.display = 'none';
            hiddenElements.push(child);
          }
        });
        
        // ì¸ì‡„ ì˜ì—­ì„ bodyì˜ ë§¨ ì•ìœ¼ë¡œ ì´ë™
        printArea.style.display = 'block';
        printArea.style.position = 'absolute';
        printArea.style.left = '0';
        printArea.style.top = '0';
        printArea.style.width = '63.5mm';
        printArea.style.height = '70mm';
        document.body.insertBefore(printArea, document.body.firstChild);
        
        // ì•½ê°„ì˜ ì§€ì—° í›„ ì¸ì‡„ (ì´ë¯¸ì§€ ë¡œë“œ ëŒ€ê¸°)
        setTimeout(() => {
          window.print();
          // ì¸ì‡„ í›„ ì •ë¦¬
          setTimeout(() => {
            // ìˆ¨ê¸´ ìš”ì†Œë“¤ ë³µì›
            hiddenElements.forEach(child => {
              const originalDisplay = child.getAttribute('data-pal-original-display');
              child.style.display = originalDisplay || '';
              child.removeAttribute('data-pal-original-display');
            });
            
            printArea.innerHTML = '';
            printArea.style.display = 'none';
            const styleToRemove = document.getElementById('palQRPrintStyle');
            if (styleToRemove) {
              document.head.removeChild(styleToRemove);
            }
          }, 100);
        }, 500);
      } catch (error) {
        console.error('QR ì½”ë“œ ì¸ì‡„ ì˜¤ë¥˜:', error);
        alert('QR ì½”ë“œ ì¸ì‡„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('palQRModal');
      if (event.target === modal) {
        palCloseQRModal();
      }
    });
    
    // íŒŒë ˆíŠ¸ ìƒì„¸ ì¡°íšŒ
    async function palViewPalletDetail(palletId) {
      // TODO: ìƒì„¸ ëª¨ë‹¬ êµ¬í˜„
      alert('íŒŒë ˆíŠ¸ ìƒì„¸: ' + palletId);
    }
    
    // í†µê³„ ì—…ë°ì´íŠ¸ (íŒŒë ˆíŠ¸ ëª©ë¡ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë¯€ë¡œ ë³„ë„ í•¨ìˆ˜ ë¶ˆí•„ìš”)
    function palUpdateStats() {
      // palLoadPallets í•¨ìˆ˜ì—ì„œ ì´ë¯¸ í†µê³„ë¥¼ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
      // ì´ í•¨ìˆ˜ëŠ” í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
    }
    
    // íŒŒë ˆíŠ¸ í˜„í™©ì—ì„œ ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬
    async function palOutboundFromStatus(palletId) {
      if (!confirm(`íŒŒë ˆíŠ¸ ${palletId}ë¥¼ ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/outbound`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...palGetUserHeaders()
          },
          body: JSON.stringify({
            pallet_id: palletId,
            out_date: new Date().toISOString().split('T')[0],
            notes: 'íŒŒë ˆíŠ¸ í˜„í™©ì—ì„œ ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ' + result.message);
          // íŒŒë ˆíŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì´ë¯¸ í†µê³„ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸ë¨)
          palLoadPallets();
        } else {
          alert('âŒ ' + result.message);
        }
      } catch (error) {
        console.error('ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        alert('âŒ ë³´ê´€ì¢…ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // íŒŒë ˆíŠ¸ í˜„í™©ì—ì„œ íŒŒë ˆíŠ¸ ì‚­ì œ ì²˜ë¦¬
    async function palDeletePalletFromStatus(palletId) {
      if (!confirm(`íŒŒë ˆíŠ¸ ${palletId}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }
      
      if (!confirm(`ì •ë§ë¡œ íŒŒë ˆíŠ¸ ${palletId}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/${palletId}`, {
          method: 'DELETE',
          headers: palGetUserHeaders()
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ' + result.message);
          // íŒŒë ˆíŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì´ë¯¸ í†µê³„ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸ë¨)
          palLoadPallets();
        } else {
          alert('âŒ ' + result.message);
        }
      } catch (error) {
        console.error('íŒŒë ˆíŠ¸ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('âŒ íŒŒë ˆíŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // íŒŒë ˆíŠ¸ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
    function palUpdatePalletSelection() {
      const checkboxes = document.querySelectorAll('.pal-pallet-checkbox');
      const selectAllCheckbox = document.getElementById('palPalletsSelectAll');
      if (selectAllCheckbox) {
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
      }
    }
    
    // ì „ì²´ ì„ íƒ/í•´ì œ
    function palToggleSelectAllPallets(checked) {
      document.querySelectorAll('.pal-pallet-checkbox').forEach(cb => {
        cb.checked = checked;
      });
      palUpdatePalletSelection();
    }
    
    // ì„ íƒëœ íŒŒë ˆíŠ¸ ì‚­ì œ
    async function palDeleteSelectedPallets() {
      const checkboxes = document.querySelectorAll('.pal-pallet-checkbox:checked');
      const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.palletId);
      
      if (selectedIds.length === 0) {
        alert('ì‚­ì œí•  íŒŒë ˆíŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!confirm(`ì„ íƒí•œ ${selectedIds.length}ê°œì˜ íŒŒë ˆíŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }
      
      if (!confirm(`ì •ë§ë¡œ ${selectedIds.length}ê°œì˜ íŒŒë ˆíŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      try {
        let successCount = 0;
        let failCount = 0;
        const errors = [];
        
        // ê° íŒŒë ˆíŠ¸ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‚­ì œ
        for (const palletId of selectedIds) {
          try {
            const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/${palletId}`, {
              method: 'DELETE',
              headers: palGetUserHeaders()
            });
            
            const result = await response.json();
            
            if (result.success) {
              successCount++;
            } else {
              failCount++;
              errors.push(`${palletId}: ${result.message}`);
            }
          } catch (error) {
            failCount++;
            errors.push(`${palletId}: ${error.message}`);
          }
        }
        
        // ê²°ê³¼ ë©”ì‹œì§€
        let message = `âœ… ${successCount}ê°œì˜ íŒŒë ˆíŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
        if (failCount > 0) {
          message += `\nâŒ ${failCount}ê°œì˜ íŒŒë ˆíŠ¸ ì‚­ì œ ì‹¤íŒ¨:\n${errors.join('\n')}`;
        }
        alert(message);
        
        // íŒŒë ˆíŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        palLoadPallets();
      } catch (error) {
        console.error('ì„ íƒ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // ë³´ê´€ë£Œ ì„¤ì • ì €ì¥
    async function palSaveFeeSettings() {
      const messageDiv = document.getElementById('palFeeSettingsMessage');
      messageDiv.innerHTML = '<div class="pal-message info">ì²˜ë¦¬ ì¤‘...</div>';
      
      try {
        const companyName = document.getElementById('palFeeCompanyName').value;
        
        if (!companyName) {
          messageDiv.innerHTML = '<div class="pal-message error">ì™¼ìª½ì—ì„œ í™”ì£¼ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>';
          return;
        }
        
        const monthlyFee = parseInt(document.getElementById('palFeeMonthlyFee').value);
        if (!monthlyFee || monthlyFee < 0) {
          messageDiv.innerHTML = '<div class="pal-message error">ì›” ë³´ê´€ë£Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
          return;
        }
        
        const data = {
          company_name: companyName,
          monthly_fee: monthlyFee,
          effective_from: document.getElementById('palFeeEffectiveFrom').value || null,
          notes: document.getElementById('palFeeNotes').value || null
        };
        
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/fees`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...palGetUserHeaders()
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          messageDiv.innerHTML = '<div class="pal-message success">âœ… ' + result.message + '</div>';
          // ì¼ì¼ ë³´ê´€ë£Œ ì—…ë°ì´íŠ¸
          if (result.data && result.data.daily_fee) {
            document.getElementById('palFeeDailyFee').value = result.data.daily_fee.toFixed(2) + 'ì›';
          } else {
            // ì‘ë‹µì— daily_feeê°€ ì—†ìœ¼ë©´ ì§ì ‘ ê³„ì‚°
            const monthlyFee = parseInt(document.getElementById('palFeeMonthlyFee').value) || 0;
            const dailyFee = (monthlyFee / 30.0).toFixed(2);
            document.getElementById('palFeeDailyFee').value = dailyFee + 'ì›';
          }
        } else {
          messageDiv.innerHTML = '<div class="pal-message error">âŒ ' + result.message + '</div>';
        }
      } catch (error) {
        console.error('ë³´ê´€ë£Œ ì„¤ì • ì˜¤ë¥˜:', error);
        messageDiv.innerHTML = '<div class="pal-message error">âŒ ë³´ê´€ë£Œ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
      }
    }
    
    // ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ í†µê³„ ì—…ë°ì´íŠ¸ (í™”ì£¼ì‚¬ ëª¨ë“œìš©)
    async function palUpdateListStats() {
      if (palCurrentRole === 'ê´€ë¦¬ì') return; // ê´€ë¦¬ìëŠ” íŒŒë ˆíŠ¸ í˜„í™©ì—ì„œ í†µê³„ë¥¼ ë´„
      
      if (!palCurrentCompany) return;
      
      try {
        const params = new URLSearchParams();
        params.append('company', palCurrentCompany);
        
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/list?${params}`, {
          headers: palGetUserHeaders()
        });
        
        if (!response.ok) return;
        
        const result = await response.json();
        
        if (result.success) {
          const pallets = result.data || [];
          
          // í†µê³„ ê³„ì‚°
          const total = pallets.length;
          const storage = pallets.filter(p => p.status === 'ì…ê³ ë¨').length;
          const completed = pallets.filter(p => p.status === 'ë³´ê´€ì¢…ë£Œ').length;
          const monthlyFee = pallets.reduce((sum, p) => sum + (p.current_fee || 0), 0);
          
          // í†µê³„ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
          const totalEl = document.getElementById('palListTotalPallets');
          const storageEl = document.getElementById('palListStoragePallets');
          const completedEl = document.getElementById('palListCompletedPallets');
          const feeEl = document.getElementById('palListMonthlyFee');
          
          if (totalEl) totalEl.textContent = total;
          if (storageEl) storageEl.textContent = storage;
          if (completedEl) completedEl.textContent = completed;
          if (feeEl) feeEl.textContent = monthlyFee.toLocaleString() + 'ì›';
        }
      } catch (error) {
        console.error('ë¦¬ìŠ¤íŠ¸ í†µê³„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
      }
    }
    
    // í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ
    async function palLoadCompanyList() {
      const listContainer = document.getElementById('palCompaniesList');
      const countSpan = document.getElementById('palCompaniesCount');
      
      if (!listContainer) return;
      
      // í™”ì£¼ì‚¬ ëª¨ë“œë©´ í™”ì£¼ì‚¬ ëª©ë¡ì„ ë¡œë“œí•˜ì§€ ì•ŠìŒ
      if (palCurrentRole !== 'ê´€ë¦¬ì') {
        return;
      }
      
      listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #636e72;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      
      try {
        const month = document.getElementById('palSettlementMonth').value;
        
        const params = new URLSearchParams();
        if (month) {
          params.append('month', month);
        }
        
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/companies?${params}`, {
          headers: palGetUserHeaders()
        });
        
        const result = await response.json();
        
        if (result.success) {
          const companies = result.data?.companies || [];
          countSpan.textContent = `(${companies.length}ê°œ)`;
          
          if (companies.length === 0) {
            listContainer.innerHTML = '<div style="padding: 15px; text-align: center; color: #636e72; font-size: 12px;">í™”ì£¼ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          } else {
            listContainer.innerHTML = companies.map(company => `
              <button class="pal-company-btn" onclick="palSelectCompany('${palEscapeHtml(company)}')" style="width: 100%; text-align: left; padding: 8px 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; cursor: pointer; transition: all 0.2s; font-size: 12px; line-height: 1.4; word-break: break-word; white-space: normal;">
                ${palEscapeHtml(company)}
              </button>
            `).join('');
          }
        } else {
          listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">âŒ ' + result.message + '</div>';
        }
      } catch (error) {
        console.error('í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }
    
    // í™”ì£¼ì‚¬ ì„ íƒ
    let palSelectedCompany = null;
    
    function palSelectCompany(companyName) {
      palSelectedCompany = companyName;
      
      // ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      const buttons = document.querySelectorAll('.pal-company-btn');
      buttons.forEach(btn => {
        if (btn.textContent.trim() === companyName) {
          btn.style.background = '#ff6b35';
          btn.style.color = '#fff';
          btn.style.borderColor = '#ff6b35';
        } else {
          btn.style.background = '#f8f9fa';
          btn.style.color = '#000';
          btn.style.borderColor = '#dee2e6';
        }
      });
      
      // ì •ì‚° ë‚´ì—­ ë¡œë“œ
      palLoadSettlements(companyName);
    }
    
    // ì •ì‚° ìƒì„±
    async function palGenerateSettlement() {
      if (!confirm('ì •ì‚°ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const settlementMonth = document.getElementById('palSettlementMonth').value;
        const companyName = palSelectedCompany || (palCurrentRole !== 'ê´€ë¦¬ì' ? palCurrentCompany : null);
        
        if (!settlementMonth) {
          alert('âŒ ì •ì‚°ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!companyName) {
          alert('âŒ í™”ì£¼ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        const data = {
          settlement_month: settlementMonth.replace('-', '-'),
          company_name: companyName
        };
        
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/settlements/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...palGetUserHeaders()
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ' + result.message);
          palLoadSettlements(companyName);
        } else {
          alert('âŒ ' + result.message);
        }
      } catch (error) {
        console.error('ì •ì‚° ìƒì„± ì˜¤ë¥˜:', error);
        alert('âŒ ì •ì‚° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // ì •ì‚° í™•ì •
    async function palConfirmSettlement(settlementId) {
      if (!confirm('ì •ì‚°ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/settlements/${settlementId}/confirm`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            ...palGetUserHeaders()
          },
          body: JSON.stringify({ status: 'í™•ì •' })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ' + result.message);
          // ì •ì‚° ë‚´ì—­ ìƒˆë¡œê³ ì¹¨
          const companyName = palSelectedCompany || (palCurrentRole !== 'ê´€ë¦¬ì' ? palCurrentCompany : null);
          palLoadSettlements(companyName);
        } else {
          alert('âŒ ' + result.message);
        }
      } catch (error) {
        console.error('ì •ì‚° í™•ì • ì˜¤ë¥˜:', error);
        alert('âŒ ì •ì‚° í™•ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // ì •ì‚° ìƒíƒœ ë˜ëŒë¦¬ê¸° (í™•ì • â†’ ëŒ€ê¸°)
    async function palRevertSettlement(settlementId) {
      if (!confirm('ì •ì‚° ìƒíƒœë¥¼ ëŒ€ê¸°ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/settlements/${settlementId}/confirm`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            ...palGetUserHeaders()
          },
          body: JSON.stringify({ status: 'ëŒ€ê¸°' })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ' + result.message);
          // ì •ì‚° ë‚´ì—­ ìƒˆë¡œê³ ì¹¨
          const companyName = palSelectedCompany || (palCurrentRole !== 'ê´€ë¦¬ì' ? palCurrentCompany : null);
          palLoadSettlements(companyName);
        } else {
          alert('âŒ ' + result.message);
        }
      } catch (error) {
        console.error('ì •ì‚° ìƒíƒœ ë˜ëŒë¦¬ê¸° ì˜¤ë¥˜:', error);
        alert('âŒ ì •ì‚° ìƒíƒœ ë˜ëŒë¦¬ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // ì •ì‚° ì‚­ì œ
    async function palDeleteSettlement(settlementId) {
      if (!confirm('ì •ì‚° ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }
      
      if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì •ì‚° ë‚´ì—­ê³¼ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
        return;
      }
      
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/settlements/${settlementId}`, {
          method: 'DELETE',
          headers: palGetUserHeaders()
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ' + result.message);
          // ì •ì‚° ë‚´ì—­ ìƒˆë¡œê³ ì¹¨
          const companyName = palSelectedCompany || (palCurrentRole !== 'ê´€ë¦¬ì' ? palCurrentCompany : null);
          palLoadSettlements(companyName);
        } else {
          alert('âŒ ' + result.message);
        }
      } catch (error) {
        console.error('ì •ì‚° ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('âŒ ì •ì‚° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // ì •ì‚° ë‚´ì—­ ë¡œë“œ (ì „ì²´ í•©ê³„ + ì›”ë³„ ìµœì‹ ìˆœ)
    async function palLoadSettlements(companyName = null) {
      const listContainer = document.getElementById('palSettlementsList');
      const countSpan = document.getElementById('palSettlementsCount');
      
      if (!listContainer) return;
      
      // í™”ì£¼ì‚¬ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
      const targetCompany = companyName || palSelectedCompany || (palCurrentRole !== 'ê´€ë¦¬ì' ? palCurrentCompany : null);
      
      if (!targetCompany) {
        const placeholder = document.getElementById('palSettlementsPlaceholder');
        if (placeholder) {
          placeholder.textContent = palCurrentRole === 'ê´€ë¦¬ì' ? 'í™”ì£¼ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.' : 'ì •ì‚° ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        } else {
          listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #636e72;">' + (palCurrentRole === 'ê´€ë¦¬ì' ? 'í™”ì£¼ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.' : 'ì •ì‚° ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...') + '</div>';
        }
        countSpan.textContent = '(0ê°œ)';
        
        // í™”ì£¼ì‚¬ ëª¨ë“œì¸ë° í™”ì£¼ì‚¬ ì •ë³´ê°€ ì—†ìœ¼ë©´ í†µê³„ë„ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
        if (palCurrentRole !== 'ê´€ë¦¬ì' && !palCurrentCompany) {
          return;
        }
      }
      
      listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #636e72;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      
      try {
        // 1. ì „ì²´ í•©ê³„ ì¡°íšŒ (settlement_month ì—†ì´)
        const totalParams = new URLSearchParams();
        totalParams.append('company', targetCompany);
        
        // 2. ëª¨ë“  ì›”ë³„ ì •ì‚° ë‚´ì—­ í•œ ë²ˆì— ì¡°íšŒ (all_months=true)
        const allMonthsParams = new URLSearchParams();
        allMonthsParams.append('company', targetCompany);
        allMonthsParams.append('all_months', 'true');
        
        // ë³‘ë ¬ ìš”ì²­ìœ¼ë¡œ ì „ì²´ í•©ê³„ì™€ ì›”ë³„ ëª©ë¡ ë™ì‹œ ì¡°íšŒ
        const [totalResponse, allMonthsResponse] = await Promise.all([
          fetch(`${PAL_API_BASE_URL}/api/pallets/settlements?${totalParams}`, {
            headers: palGetUserHeaders()
          }),
          fetch(`${PAL_API_BASE_URL}/api/pallets/settlements?${allMonthsParams}`, {
            headers: palGetUserHeaders()
          })
        ]);
        
        const totalResult = await totalResponse.json();
        const allMonthsResult = await allMonthsResponse.json();
        
        let totalSettlement = null;
        if (totalResult.success && totalResult.data && totalResult.data.length > 0) {
          totalSettlement = totalResult.data[0]; // ì „ì²´ í•©ê³„ëŠ” 1ê°œë§Œ ë°˜í™˜ë¨
          totalSettlement.settlement_month = null; // ì „ì²´ í‘œì‹œìš©
        }
        
        // ì›”ë³„ ì •ì‚° ë‚´ì—­ (ì´ë¯¸ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë¨)
        const monthlySettlements = allMonthsResult.success && allMonthsResult.data ? allMonthsResult.data : [];
        
        // ì „ì²´ í•©ê³„ì™€ ì›”ë³„ ëª©ë¡ ê²°í•©
        const allSettlements = [];
        if (totalSettlement) {
          allSettlements.push(totalSettlement);
        }
        allSettlements.push(...monthlySettlements);
        
        countSpan.textContent = `(${allSettlements.length}ê°œ)`;
        
        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ (í™”ì£¼ì‚¬ê°€ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ í•­ìƒ í‘œì‹œ)
        const exportBtn = document.getElementById('palExportSettlementsBtn');
        if (exportBtn && targetCompany) {
          exportBtn.style.display = 'block';
        } else if (exportBtn) {
          exportBtn.style.display = 'none';
        }
        
        // í™”ì£¼ì‚¬ ëª¨ë“œì¼ ë•Œ í†µê³„ ì—…ë°ì´íŠ¸
        if (palCurrentRole !== 'ê´€ë¦¬ì') {
          palUpdateListStats();
        }
        
        if (allSettlements.length === 0) {
          listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #636e72;">ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
          // í—¤ë” ì¶”ê°€
          const headerHTML = `
            <div style="padding: 12px 15px; background: linear-gradient(135deg, #ff6b35 0%, #feca57 100%); color: white; font-weight: 700; border-radius: 8px 8px 0 0; display: grid; grid-template-columns: 100px 120px 80px 120px 80px 80px 80px 120px; gap: 10px; align-items: center; margin-bottom: 10px;">
              <div>ì •ì‚°ì›”</div>
              <div>í™”ì£¼ì‚¬</div>
              <div style="text-align: center;">íŒŒë ˆíŠ¸ ìˆ˜</div>
              <div style="text-align: right;">ë³´ê´€ë£Œ</div>
              <div style="text-align: center;">ìƒíƒœ</div>
              <div style="text-align: center;">í¼ì¹¨</div>
              <div style="text-align: center;">ë‹¤ìš´ë¡œë“œ</div>
              <div style="text-align: center;">ê´€ë¦¬</div>
            </div>
          `;
          
          listContainer.innerHTML = headerHTML + allSettlements.map((settlement, index) => {
            const settlementId = settlement.id || `temp_${index}`;
            const isTotal = !settlement.settlement_month; // ì „ì²´ í•©ê³„ì¸ì§€ í™•ì¸
            const settlementMonth = settlement.settlement_month || null;
            
            return `
              <div class="pal-settlement-item" style="margin-bottom: 15px; border: 2px solid #ffeaa7; border-radius: 12px; overflow: hidden; background: #ffffff;">
                <!-- ì •ì‚° ë‚´ì—­ ìš”ì•½ (í´ë¦­ ê°€ëŠ¥) -->
                <div class="pal-settlement-header" onclick="palToggleSettlementDetail('${settlementId}', '${settlementMonth || ''}')" style="padding: 15px; background: ${isTotal ? 'linear-gradient(135deg, #fff3d4 0%, #fffef9 100%)' : 'linear-gradient(135deg, #fffef9 0%, #ffffff 100%)'}; cursor: pointer; display: grid; grid-template-columns: 100px 120px 80px 120px 80px 80px 80px 120px; gap: 10px; align-items: center; transition: all 0.2s;">
                  <div style="font-weight: ${isTotal ? '700' : '600'}; color: #ff6b35; font-size: ${isTotal ? '15px' : '14px'};">${isTotal ? 'ğŸ“Š ì „ì²´' : palEscapeHtml(settlement.settlement_month)}</div>
                  <div style="font-weight: 600;">${palEscapeHtml(settlement.company_name)}</div>
                  <div style="text-align: center;">${settlement.total_pallets}ê°œ</div>
                  <div style="font-weight: ${isTotal ? '700' : '600'}; color: #ff6b35; font-size: ${isTotal ? '15px' : '14px'}; text-align: right;">${settlement.total_fee.toLocaleString()}ì›</div>
                  <div>
                    <span style="padding: 4px 8px; border-radius: 4px; background: ${settlement.status === 'í™•ì •' ? '#28a745' : settlement.status === 'ì™„ë£Œ' ? '#6c757d' : '#ffc107'}; color: white; font-size: 11px; font-weight: 600;">${palEscapeHtml(settlement.status || 'ë¯¸ìƒì„±')}</span>
                  </div>
                  <div>
                    <span id="palSettlementIcon_${settlementId}" style="font-size: 12px;">â–¼</span>
                  </div>
                  <div onclick="event.stopPropagation();" style="display: flex; gap: 5px; flex-wrap: wrap;">
                    ${!isTotal ? `
                      <button class="pal-btn" onclick="event.stopPropagation(); palExportSettlementMonth('${settlementMonth || ''}')" style="padding: 4px 8px; font-size: 11px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;" title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ">ğŸ“¥ ì—‘ì…€</button>
                    ` : ''}
                  </div>
                  <div onclick="event.stopPropagation();" style="display: flex; gap: 5px; flex-wrap: wrap;">
                    ${settlement.id && palCurrentRole === 'ê´€ë¦¬ì' && !isTotal ? `
                      ${settlement.status === 'ëŒ€ê¸°' 
                        ? `<button class="pal-btn" onclick="palConfirmSettlement(${settlement.id})" style="padding: 4px 8px; font-size: 11px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">í™•ì •</button>`
                        : ''}
                      ${settlement.status === 'í™•ì •' || settlement.status === 'ì™„ë£Œ'
                        ? `<button class="pal-btn" onclick="palRevertSettlement(${settlement.id})" style="padding: 4px 8px; font-size: 11px; background: #ffc107; color: white; border: none; border-radius: 4px; cursor: pointer;">ëŒ€ê¸°ë¡œ ë³€ê²½</button>`
                        : ''}
                      <button class="pal-btn" onclick="palDeleteSettlement(${settlement.id})" style="padding: 4px 8px; font-size: 11px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">ì‚­ì œ</button>
                    ` : ''}
                  </div>
                </div>
                <!-- íŒŒë ˆíŠ¸ë³„ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ (ì ‘ì´ì‹) -->
                <div id="palSettlementDetail_${settlementId}" style="display: none; padding: 15px; background: #f8f9fa; border-top: 2px solid #ffeaa7;">
                  <div style="margin-bottom: 10px; font-weight: 600; color: #636e72; font-size: 14px;">íŒŒë ˆíŠ¸ë³„ ìƒì„¸ ë‚´ì—­</div>
                  <div id="palSettlementPallets_${settlementId}" data-settlement-month="${settlementMonth || ''}" style="background: #ffffff; border-radius: 8px; padding: 10px;">
                    <div style="padding: 20px; text-align: center; color: #999;">ë¡œë”© ì¤‘...</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('ì •ì‚° ë‚´ì—­ ë¡œë“œ ì˜¤ë¥˜:', error);
        const listContainer = document.getElementById('palSettlementsList');
        listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }
    
    // ì •ì‚° ë‚´ì—­ ìƒì„¸ í† ê¸€
    async function palToggleSettlementDetail(settlementId, settlementMonth = null) {
      const detailDiv = document.getElementById(`palSettlementDetail_${settlementId}`);
      const iconSpan = document.getElementById(`palSettlementIcon_${settlementId}`);
      const palletsDiv = document.getElementById(`palSettlementPallets_${settlementId}`);
      
      if (!detailDiv) return;
      
      const isExpanded = detailDiv.style.display !== 'none';
      
      if (isExpanded) {
        // ì ‘ê¸°
        detailDiv.style.display = 'none';
        iconSpan.textContent = 'â–¼';
      } else {
        // í¼ì¹˜ê¸°
        detailDiv.style.display = 'block';
        iconSpan.textContent = 'â–²';
        
        // íŒŒë ˆíŠ¸ ëª©ë¡ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œë“œ
        if (palletsDiv.innerHTML.includes('ë¡œë”© ì¤‘')) {
          // settlementMonthê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìœ¼ë©´ data ì†ì„±ì—ì„œ ì½ê¸°
          if (!settlementMonth && palletsDiv) {
            settlementMonth = palletsDiv.getAttribute('data-settlement-month') || null;
          }
          await palLoadSettlementPallets(settlementId, settlementMonth);
        }
      }
    }
    
    // ì •ì‚° ë‚´ì—­ì˜ íŒŒë ˆíŠ¸ ëª©ë¡ ë¡œë“œ
    async function palLoadSettlementPallets(settlementId, settlementMonth = null) {
      const palletsDiv = document.getElementById(`palSettlementPallets_${settlementId}`);
      if (!palletsDiv) return;
      
      try {
        // settlementMonthê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìœ¼ë©´ data ì†ì„±ì—ì„œ ì½ê¸°
        if (!settlementMonth) {
          settlementMonth = palletsDiv.getAttribute('data-settlement-month') || null;
          if (settlementMonth === '') settlementMonth = null; // ë¹ˆ ë¬¸ìì—´ì„ nullë¡œ ë³€í™˜
        }
        
        // settlementIdê°€ temp_ë¡œ ì‹œì‘í•˜ë©´ ì„ì‹œ ì •ì‚° ë‚´ì—­ (íŒŒë ˆíŠ¸ ëª©ë¡ ì§ì ‘ ì¡°íšŒ)
        if (settlementId.startsWith('temp_')) {
          // í˜„ì¬ ì„ íƒëœ í™”ì£¼ì‚¬ì™€ ì •ì‚°ì›”ë¡œ íŒŒë ˆíŠ¸ ëª©ë¡ ì¡°íšŒ
          const targetCompany = palSelectedCompany || (palCurrentRole !== 'ê´€ë¦¬ì' ? palCurrentCompany : null);
          
          const params = new URLSearchParams();
          params.append('company', targetCompany);
          
          // settlementMonthê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì›”ë§Œ, ì—†ìœ¼ë©´ ì „ì²´ (ì „ì²´ í•©ê³„ì¸ ê²½ìš°)
          if (settlementMonth) {
            params.append('month', settlementMonth);
          }
          
          const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/list?${params}`, {
            headers: palGetUserHeaders()
          });
          
          const result = await response.json();
          
          if (result.success) {
            const pallets = result.data || [];
            console.log('[PAL] ì„ì‹œ ì •ì‚° íŒŒë ˆíŠ¸ ëª©ë¡:', pallets, 'settlementMonth:', settlementMonth);
            palletsDiv.innerHTML = pallets.length === 0 
              ? '<div style="padding: 20px; text-align: center; color: #999;">íŒŒë ˆíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
              : `
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead>
                    <tr style="background: #f5f5f5; border-bottom: 2px solid #dee2e6;">
                      <th style="padding: 8px; text-align: left; font-weight: 600; width: 100px;">íŒŒë ˆíŠ¸ ID</th>
                      <th style="padding: 8px; text-align: left; font-weight: 600; width: 120px;">í’ˆëª©ëª…</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 140px;">ìµœì´ˆ ì…ê³ ì¼</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 120px;">ê°±ì‹ ì¼</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 140px;">ë³´ê´€ì¢…ë£Œì¼</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 80px;">ë³´ê´€ì¼ìˆ˜</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 80px;">ìƒíƒœ</th>
                      <th style="padding: 8px; text-align: right; font-weight: 600; width: 100px;">ë³´ê´€ë£Œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${pallets.map(p => {
                      // ìµœì´ˆ ì…ê³ ì¼ í¬ë§·íŒ… (í•œêµ­ ì‹œê°„)
                      // ì‹¤ì œ ì…ê³ ì¼(in_date)ì„ ì‚¬ìš© (created_atì€ ë°ì´í„° ì…ë ¥ ì‹œê°„ì´ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
                      let inDate = null;
                      let inDateStr = '-';
                      
                      // in_dateê°€ date ê°ì²´ì¸ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜
                      let inDateValue = p.in_date;
                      if (inDateValue && typeof inDateValue === 'object' && inDateValue.getFullYear) {
                        // date ê°ì²´ì¸ ê²½ìš°
                        inDateValue = inDateValue.getFullYear() + '-' + 
                                     String(inDateValue.getMonth() + 1).padStart(2, '0') + '-' + 
                                     String(inDateValue.getDate()).padStart(2, '0');
                      }
                      
                      if (inDateValue) {
                        // ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, date ê°ì²´ë©´ ë³€í™˜ëœ ë¬¸ìì—´ ì‚¬ìš©
                        const dateStr = typeof inDateValue === 'string' ? inDateValue : inDateValue;
                        inDate = new Date(dateStr + 'T00:00:00+09:00');
                      } else if (p.created_at) {
                        // in_dateê°€ ì—†ì„ ë•Œë§Œ created_at ì‚¬ìš© (fallback)
                        inDate = new Date(p.created_at);
                      }
                      
                      if (inDate && !isNaN(inDate.getTime())) {
                        inDateStr = inDate.toLocaleDateString('ko-KR', { 
                          year: 'numeric', 
                          month: '2-digit', 
                          day: '2-digit'
                        }).replace(/\. /g, '-').replace(/\./g, '');
                      }
                      
                      // ê°±ì‹ ì¼ ê³„ì‚° (ë³´ê´€ì´ 1ë‹¬ ì´ìƒì´ë©´ ë§¤ì›” 1ì¼)
                      let renewalDateStr = '-';
                      if (inDate && !isNaN(inDate.getTime())) {
                        if (!p.out_date) {
                          const today = new Date();
                          const monthsDiff = (today.getFullYear() - inDate.getFullYear()) * 12 + (today.getMonth() - inDate.getMonth());
                          if (monthsDiff >= 1) {
                            // ë§ˆì§€ë§‰ ê°±ì‹ ì¼ (í˜„ì¬ ì›”ì˜ 1ì¼)
                            const lastRenewal = new Date(today.getFullYear(), today.getMonth(), 1);
                            renewalDateStr = lastRenewal.toLocaleDateString('ko-KR', {
                              year: 'numeric',
                              month: '2-digit',
                              day: '2-digit'
                            }).replace(/\. /g, '-').replace(/\./g, '');
                          }
                        } else {
                          const outDate = new Date(p.out_date + 'T00:00:00+09:00');
                          if (!isNaN(outDate.getTime())) {
                            const monthsDiff = (outDate.getFullYear() - inDate.getFullYear()) * 12 + (outDate.getMonth() - inDate.getMonth());
                            if (monthsDiff >= 1) {
                              // ë§ˆì§€ë§‰ ê°±ì‹ ì¼ (ë³´ê´€ì¢…ë£Œ ì›”ì˜ 1ì¼)
                              const lastRenewal = new Date(outDate.getFullYear(), outDate.getMonth(), 1);
                              renewalDateStr = lastRenewal.toLocaleDateString('ko-KR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                              }).replace(/\. /g, '-').replace(/\./g, '');
                            }
                          }
                        }
                      }
                      
                      // ë³´ê´€ì¢…ë£Œì¼ í¬ë§·íŒ…
                      let outDateStr = '-';
                      if (p.out_date) {
                        const outDate = new Date(p.out_date + 'T00:00:00+09:00');
                        if (!isNaN(outDate.getTime())) {
                          outDateStr = outDate.toLocaleDateString('ko-KR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                          }).replace(/\. /g, '-').replace(/\./g, '');
                        }
                      }
                      
                      // ë³´ê´€ì¼ìˆ˜: ë°±ì—”ë“œì—ì„œ ê³„ì‚°ëœ ê°’ ì‚¬ìš© (í•´ë‹¹ ì›”ì˜ ë³´ê´€ì¼ìˆ˜)
                      // ë°±ì—”ë“œì—ì„œ month íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œ í•´ë‹¹ ì›”ì˜ ë³´ê´€ì¼ìˆ˜ë§Œ ê³„ì‚°í•˜ì—¬ ë°˜í™˜
                      let storageDays = p.storage_days || 0;
                      
                      // ìƒíƒœ í‘œì‹œ
                      let statusText = p.status || 'ì…ê³ ë¨';
                      if (p.is_service === 1 || p.is_service === true) {
                        statusText = 'ì„œë¹„ìŠ¤';
                      }
                      const statusColor = statusText === 'ì…ê³ ë¨' ? '#28a745' : statusText === 'ë³´ê´€ì¢…ë£Œ' ? '#6c757d' : '#ffc107';
                      
                      return `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                          <td style="padding: 8px; font-size: 12px;">${palEscapeHtml(p.pallet_id)}</td>
                          <td style="padding: 8px;">${palEscapeHtml(p.product_name || '-')}</td>
                          <td style="padding: 8px; text-align: center; font-size: 12px;">${inDateStr}</td>
                          <td style="padding: 8px; text-align: center; font-size: 12px;">${renewalDateStr}</td>
                          <td style="padding: 8px; text-align: center; font-size: 12px;">${outDateStr}</td>
                          <td style="padding: 8px; text-align: center; font-size: 12px;">${storageDays}ì¼</td>
                          <td style="padding: 8px; text-align: center;">
                            <span style="padding: 4px 8px; border-radius: 4px; background: ${statusColor}; color: white; font-size: 11px; font-weight: 600;">${statusText}</span>
                          </td>
                          <td style="padding: 8px; text-align: right;">${(p.current_fee || 0).toLocaleString()}ì›</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              `;
          } else {
            palletsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">âŒ ' + result.message + '</div>';
          }
        } else {
          // ì •ì‚° ë‚´ì—­ ìƒì„¸ API í˜¸ì¶œ
          const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/settlements/${settlementId}/detail`, {
            headers: palGetUserHeaders()
          });
          
          const result = await response.json();
          
          if (result.success) {
            const settlement = result.data;
            const pallets = settlement.pallets || [];
            
            palletsDiv.innerHTML = pallets.length === 0 
              ? '<div style="padding: 20px; text-align: center; color: #999;">íŒŒë ˆíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
              : `
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead>
                    <tr style="background: #f5f5f5; border-bottom: 2px solid #dee2e6;">
                      <th style="padding: 8px; text-align: left; font-weight: 600; width: 100px;">íŒŒë ˆíŠ¸ ID</th>
                      <th style="padding: 8px; text-align: left; font-weight: 600; width: 120px;">í’ˆëª©ëª…</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 140px;">ìµœì´ˆ ì…ê³ ì¼</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 120px;">ê°±ì‹ ì¼</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 140px;">ë³´ê´€ì¢…ë£Œì¼</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 80px;">ë³´ê´€ì¼ìˆ˜</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600; width: 80px;">ìƒíƒœ</th>
                      <th style="padding: 8px; text-align: right; font-weight: 600; width: 100px;">ë³´ê´€ë£Œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${pallets.map(p => {
                      // ìµœì´ˆ ì…ê³ ì¼ í¬ë§·íŒ… (í•œêµ­ ì‹œê°„)
                      // ì‹¤ì œ ì…ê³ ì¼(in_date)ì„ ì‚¬ìš© (created_atì€ ë°ì´í„° ì…ë ¥ ì‹œê°„ì´ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
                      let inDate = null;
                      let inDateStr = '-';
                      
                      if (p.in_date) {
                        inDate = new Date(p.in_date + 'T00:00:00+09:00');
                      } else if (p.created_at) {
                        // in_dateê°€ ì—†ì„ ë•Œë§Œ created_at ì‚¬ìš© (fallback)
                        inDate = new Date(p.created_at);
                      }
                      
                      if (inDate && !isNaN(inDate.getTime())) {
                        inDateStr = inDate.toLocaleDateString('ko-KR', { 
                          year: 'numeric', 
                          month: '2-digit', 
                          day: '2-digit'
                        }).replace(/\. /g, '-').replace(/\./g, '');
                      }
                      
                      // ê°±ì‹ ì¼ ê³„ì‚° (ë³´ê´€ì´ 1ë‹¬ ì´ìƒì´ë©´ ë§¤ì›” 1ì¼)
                      let renewalDateStr = '-';
                      // inDateê°€ ìœ„ì—ì„œ ì´ë¯¸ ê³„ì‚°ë˜ì—ˆìœ¼ë¯€ë¡œ ì¬ì‚¬ìš©
                      if (inDate && !isNaN(inDate.getTime())) {
                        if (!p.out_date) {
                          const today = new Date();
                          const monthsDiff = (today.getFullYear() - inDate.getFullYear()) * 12 + (today.getMonth() - inDate.getMonth());
                          if (monthsDiff >= 1) {
                            // ë§ˆì§€ë§‰ ê°±ì‹ ì¼ (í˜„ì¬ ì›”ì˜ 1ì¼)
                            const lastRenewal = new Date(today.getFullYear(), today.getMonth(), 1);
                            renewalDateStr = lastRenewal.toLocaleDateString('ko-KR', {
                              year: 'numeric',
                              month: '2-digit',
                              day: '2-digit'
                            }).replace(/\. /g, '-').replace(/\./g, '');
                          }
                        } else {
                          const outDate = new Date(p.out_date + 'T00:00:00+09:00');
                          if (!isNaN(outDate.getTime())) {
                            const monthsDiff = (outDate.getFullYear() - inDate.getFullYear()) * 12 + (outDate.getMonth() - inDate.getMonth());
                            if (monthsDiff >= 1) {
                              // ë§ˆì§€ë§‰ ê°±ì‹ ì¼ (ë³´ê´€ì¢…ë£Œ ì›”ì˜ 1ì¼)
                              const lastRenewal = new Date(outDate.getFullYear(), outDate.getMonth(), 1);
                              renewalDateStr = lastRenewal.toLocaleDateString('ko-KR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                              }).replace(/\. /g, '-').replace(/\./g, '');
                            }
                          }
                        }
                      }
                      
                      // ë³´ê´€ì¢…ë£Œì¼ í¬ë§·íŒ…
                      let outDateStr = '-';
                      if (p.out_date) {
                        const outDate = new Date(p.out_date + 'T00:00:00+09:00');
                        if (!isNaN(outDate.getTime())) {
                          outDateStr = outDate.toLocaleDateString('ko-KR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                          }).replace(/\. /g, '-').replace(/\./g, '');
                        }
                      }
                      
                      // ë³´ê´€ì¼ìˆ˜ (APIì—ì„œ ì œê³µë˜ëŠ” ê°’ ì‚¬ìš© - ì •ì‚° ìƒì„¸ APIëŠ” ì´ë¯¸ í•´ë‹¹ ì›”ì˜ ë³´ê´€ì¼ìˆ˜ë¥¼ ê³„ì‚°í•˜ì—¬ ë°˜í™˜)
                      const storageDays = p.storage_days || 0;
                      
                      // ìƒíƒœ í‘œì‹œ
                      let statusText = p.status || 'ì…ê³ ë¨';
                      if (p.is_service === 1 || p.is_service === true) {
                        statusText = 'ì„œë¹„ìŠ¤';
                      }
                      const statusColor = statusText === 'ì…ê³ ë¨' ? '#28a745' : statusText === 'ë³´ê´€ì¢…ë£Œ' ? '#6c757d' : '#ffc107';
                      
                      return `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                          <td style="padding: 8px; font-size: 12px;">${palEscapeHtml(p.pallet_id)}</td>
                          <td style="padding: 8px;">${palEscapeHtml(p.product_name || '-')}</td>
                          <td style="padding: 8px; text-align: center; font-size: 12px;">${inDateStr}</td>
                          <td style="padding: 8px; text-align: center; font-size: 12px;">${renewalDateStr}</td>
                          <td style="padding: 8px; text-align: center; font-size: 12px;">${outDateStr}</td>
                          <td style="padding: 8px; text-align: center; font-size: 12px;">${storageDays}ì¼</td>
                          <td style="padding: 8px; text-align: center;">
                            <span style="padding: 4px 8px; border-radius: 4px; background: ${statusColor}; color: white; font-size: 11px; font-weight: 600;">${statusText}</span>
                          </td>
                          <td style="padding: 8px; text-align: right;">${(p.rounded_fee || 0).toLocaleString()}ì›</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              `;
          } else {
            palletsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">âŒ ' + result.message + '</div>';
          }
        }
      } catch (error) {
        console.error('íŒŒë ˆíŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        palletsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }
    
    // ì •ì‚° ë‚´ì—­ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì „ì²´)
    async function palExportSettlements() {
      console.log('palExportSettlements í˜¸ì¶œë¨');
      const targetCompany = palSelectedCompany || (palCurrentRole !== 'ê´€ë¦¬ì' ? palCurrentCompany : null);
      
      if (!targetCompany) {
        alert('âŒ í™”ì£¼ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const params = new URLSearchParams();
        params.append('company', targetCompany);
        
        const url = `${PAL_API_BASE_URL}/api/pallets/settlements/export?${params}`;
        const response = await fetch(url, {
          headers: palGetUserHeaders()
        });
        
        if (!response.ok) {
          const error = await response.json();
          alert('âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          return;
        }
        
        // íŒŒì¼ëª… ì¶”ì¶œ (Content-Disposition í—¤ë”ì—ì„œ)
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'íŒŒë ˆíŠ¸_ë³´ê´€ë£Œ_ì •ì‚°ë‚´ì—­.csv';
        if (contentDisposition) {
          const matches = contentDisposition.match(/filename\*=UTF-8''(.+)/);
          if (matches) {
            filename = decodeURIComponent(matches[1]);
          }
        }
        
        // Blobìœ¼ë¡œ ë³€í™˜ í›„ ë‹¤ìš´ë¡œë“œ
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);
      } catch (error) {
        console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('âŒ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // ì›”ë³„ ì •ì‚° ë‚´ì—­ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    async function palExportSettlementMonth(settlementMonth) {
      console.log('palExportSettlementMonth í˜¸ì¶œë¨, settlementMonth:', settlementMonth);
      const targetCompany = palSelectedCompany || (palCurrentRole !== 'ê´€ë¦¬ì' ? palCurrentCompany : null);
      
      if (!targetCompany) {
        alert('âŒ í™”ì£¼ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!settlementMonth || settlementMonth === '') {
        alert('âŒ ì •ì‚°ì›” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        const params = new URLSearchParams();
        params.append('company', targetCompany);
        params.append('month', settlementMonth);
        
        const url = `${PAL_API_BASE_URL}/api/pallets/settlements/export?${params}`;
        const response = await fetch(url, {
          headers: palGetUserHeaders()
        });
        
        if (!response.ok) {
          const error = await response.json();
          alert('âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          return;
        }
        
        // íŒŒì¼ëª… ì¶”ì¶œ (Content-Disposition í—¤ë”ì—ì„œ)
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `íŒŒë ˆíŠ¸_ë³´ê´€ë£Œ_ì •ì‚°ë‚´ì—­_${settlementMonth}.csv`;
        if (contentDisposition) {
          const matches = contentDisposition.match(/filename\*=UTF-8''(.+)/);
          if (matches) {
            filename = decodeURIComponent(matches[1]);
          }
        }
        
        // Blobìœ¼ë¡œ ë³€í™˜ í›„ ë‹¤ìš´ë¡œë“œ
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);
      } catch (error) {
        console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('âŒ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // ì •ì‚° ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
    function palCloseSettlementDetail() {
      document.getElementById('palSettlementDetailModal').style.display = 'none';
    }
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      const modal = document.getElementById('palSettlementDetailModal');
      if (event.target === modal) {
        palCloseSettlementDetail();
      }
    }
    
    // ========================================
    // ë¼ë²¨ ì¶œë ¥ ê¸°ëŠ¥
    // ========================================
    
    // ì´ˆì„± ì¶”ì¶œ í•¨ìˆ˜ (í•œê¸€ ì´ˆì„± ê²€ìƒ‰ìš©)
    function palGetChosung(text) {
      if (!text) return '';
      const cho = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
      let result = '';
      for (let i = 0; i < text.length; i++) {
        const char = text.charCodeAt(i);
        if (char >= 0xAC00 && char <= 0xD7A3) {
          const choIndex = Math.floor((char - 0xAC00) / 588);
          result += cho[choIndex];
        } else {
          result += text[i];
        }
      }
      return result;
    }
    
    // ì´ˆì„± ê²€ìƒ‰ í•¨ìˆ˜
    function palMatchChosung(text, query) {
      if (!query) return true;
      const textLower = text.toLowerCase();
      const queryLower = query.toLowerCase();
      
      // ì¼ë°˜ ë¬¸ìì—´ ê²€ìƒ‰
      if (textLower.includes(queryLower)) return true;
      
      // ì´ˆì„± ê²€ìƒ‰
      const textChosung = palGetChosung(text);
      const queryChosung = palGetChosung(query);
      if (textChosung.includes(queryChosung)) return true;
      
      return false;
    }
    
    // ë¼ë²¨ ì¶œë ¥ í˜ì´ì§€ ì´ˆê¸°í™”
    function palInitLabelPage() {
      // í™”ì£¼ì‚¬ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
      palInitLabelCompanyDropdown();
      
      // í™”ì£¼ì‚¬ ëª©ë¡ ë¡œë“œ
      if (palCompanies.length === 0) {
        palLoadCompanyList().then(() => {
          palInitLabelCompanyDropdown();
        });
      } else {
        palInitLabelCompanyDropdown();
      }
    }
    
    // ë¼ë²¨ ì¶œë ¥ìš© í™”ì£¼ì‚¬ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    function palInitLabelCompanyDropdown() {
      const input = document.getElementById('palLabelFilterCompanyInput');
      const hidden = document.getElementById('palLabelFilterCompanyName');
      const dropdown = document.getElementById('palLabelCompanyDropdown');
      const toggle = document.getElementById('palLabelCompanyToggle');
      
      if (!input || !hidden || !dropdown || !toggle) return;
      
      let dropdownOpen = false;
      let activeIndex = -1;
      
      // ì…ë ¥ ì´ë²¤íŠ¸
      input.addEventListener('input', function() {
        const query = this.value.trim();
        palFilterLabelCompanies(query);
        dropdownOpen = true;
        dropdown.classList.add('open');
        activeIndex = -1;
      });
      
      // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸
      input.addEventListener('focus', function() {
        const query = this.value.trim();
        palFilterLabelCompanies(query);
        dropdownOpen = true;
        dropdown.classList.add('open');
      });
      
      // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
      input.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('.company-dropdown-item');
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          activeIndex = Math.min(activeIndex + 1, items.length - 1);
          palSetActiveLabelCompanyItem(activeIndex);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          activeIndex = Math.max(activeIndex - 1, -1);
          palSetActiveLabelCompanyItem(activeIndex);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (activeIndex >= 0 && items[activeIndex]) {
            palSelectLabelCompany(items[activeIndex].dataset.value);
          }
        } else if (e.key === 'Escape') {
          dropdownOpen = false;
          dropdown.classList.remove('open');
        }
      });
      
      // í† ê¸€ ë²„íŠ¼
      toggle.addEventListener('click', function() {
        if (dropdownOpen) {
          dropdownOpen = false;
          dropdown.classList.remove('open');
        } else {
          palFilterLabelCompanies(input.value.trim());
          dropdownOpen = true;
          dropdown.classList.add('open');
        }
      });
      
      // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !dropdown.contains(e.target) && !toggle.contains(e.target)) {
          dropdownOpen = false;
          dropdown.classList.remove('open');
        }
      });
    }
    
    // ë¼ë²¨ ì¶œë ¥ìš© í™”ì£¼ì‚¬ í•„í„°ë§
    function palFilterLabelCompanies(query) {
      const dropdown = document.getElementById('palLabelCompanyDropdown');
      if (!dropdown) return;
      
      if (!palCompanies || palCompanies.length === 0) {
        dropdown.innerHTML = '<div class="company-dropdown-empty">í™”ì£¼ì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        return;
      }
      
      const filtered = palCompanies.filter(company => {
        const name = company.company_name || company.company || '';
        return palMatchChosung(name, query);
      });
      
      if (filtered.length === 0) {
        dropdown.innerHTML = '<div class="company-dropdown-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        dropdown.innerHTML = filtered.map(company => {
          const name = company.company_name || company.company || '';
          return `<div class="company-dropdown-item" data-value="${palEscapeHtml(name)}">${palEscapeHtml(name)}</div>`;
        }).join('');
        
        // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        dropdown.querySelectorAll('.company-dropdown-item').forEach(item => {
          item.addEventListener('click', function() {
            palSelectLabelCompany(this.dataset.value);
          });
        });
      }
    }
    
    // ë¼ë²¨ ì¶œë ¥ìš© í™”ì£¼ì‚¬ ì„ íƒ
    function palSelectLabelCompany(companyName) {
      const input = document.getElementById('palLabelFilterCompanyInput');
      const hidden = document.getElementById('palLabelFilterCompanyName');
      const dropdown = document.getElementById('palLabelCompanyDropdown');
      
      if (input) input.value = companyName;
      if (hidden) hidden.value = companyName;
      if (dropdown) dropdown.classList.remove('open');
    }
    
    // ë¼ë²¨ ì¶œë ¥ìš© í™”ì£¼ì‚¬ í™œì„± í•­ëª© ì„¤ì •
    function palSetActiveLabelCompanyItem(index) {
      const dropdown = document.getElementById('palLabelCompanyDropdown');
      if (!dropdown) return;
      
      const items = dropdown.querySelectorAll('.company-dropdown-item');
      items.forEach((item, idx) => {
        if (idx === index) {
          item.classList.add('active');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    // ë¼ë²¨ í•„í„° ì´ˆê¸°í™”
    function palResetLabelFilters() {
      document.getElementById('palLabelFilterId').value = '';
      document.getElementById('palLabelFilterCompanyInput').value = '';
      document.getElementById('palLabelFilterCompanyName').value = '';
      document.getElementById('palLabelFilterProduct').value = '';
      document.getElementById('palLabelFilterStartDate').value = '';
      document.getElementById('palLabelFilterEndDate').value = '';
      document.getElementById('palLabelFilterStatus').value = 'ì „ì²´';
      document.getElementById('palLabelFilterIncludePrinted').checked = false;
      
      // ë¼ë²¨ ëª©ë¡ ì´ˆê¸°í™”
      const tbody = document.getElementById('palLabelTableBody');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">í•„í„° ì¡°ê±´ì„ ì„¤ì •í•˜ê³  \'ë¶ˆëŸ¬ì˜¤ê¸°\' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</td></tr>';
      }
      document.getElementById('palLabelCount').textContent = '(0ê°œ)';
    }
    
    // ìµœì‹ ë¼ë²¨ ë¶ˆëŸ¬ì˜¤ê¸° (ì¼ì£¼ì¼ ì´ë‚´ ë¯¸ì¶œë ¥ íŒŒë ˆíŠ¸ë§Œ)
    async function palLoadNewLabels() {
      const tbody = document.getElementById('palLabelTableBody');
      const countSpan = document.getElementById('palLabelCount');
      
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="7" class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
      
      try {
        // ì¼ì£¼ì¼ ì „ ë‚ ì§œ ê³„ì‚°
        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(today.getDate() - 7);
        const startDate = sevenDaysAgo.toISOString().split('T')[0];
        const endDate = today.toISOString().split('T')[0];
        
        const params = new URLSearchParams();
        params.append('start_date', startDate);
        params.append('end_date', endDate);
        params.append('include_printed', 'false'); // ë¯¸ì¶œë ¥ë§Œ
        
        const url = `${PAL_API_BASE_URL}/api/pallets/labels/filter?${params}`;
        const response = await fetch(url, {
          headers: palGetUserHeaders()
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const pallets = result.data;
          
          if (pallets.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="no-data">ìµœê·¼ ì¼ì£¼ì¼ ì´ë‚´ ë¯¸ì¶œë ¥ íŒŒë ˆíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            countSpan.textContent = '(0ê°œ)';
          } else {
            tbody.innerHTML = pallets.map((pallet, index) => {
              const inDate = pallet.in_date ? new Date(pallet.in_date).toLocaleDateString('ko-KR') : '-';
              const printStatus = pallet.print_status || 'ë¯¸ì¶œë ¥';
              const printStatusClass = printStatus === 'ì¶œë ¥ì™„ë£Œ' ? 'style="color: #28a745; font-weight: 600;"' : '';
              return `
                <tr>
                  <td style="text-align: center;">
                    <input type="checkbox" class="pal-label-checkbox" data-pallet-id="${palEscapeHtml(pallet.pallet_id)}" onchange="palUpdateLabelSelection()">
                  </td>
                  <td>${palEscapeHtml(pallet.pallet_id)}</td>
                  <td>${palEscapeHtml(pallet.company_name || '-')}</td>
                  <td>${palEscapeHtml(pallet.product_name || '-')}</td>
                  <td>${inDate}</td>
                  <td>${palEscapeHtml(pallet.status || '-')}</td>
                  <td ${printStatusClass}>${palEscapeHtml(printStatus)}</td>
                </tr>
              `;
            }).join('');
            
            countSpan.textContent = `(${pallets.length}ê°œ)`;
            alert(`âœ… ìµœê·¼ ì¼ì£¼ì¼ ì´ë‚´ ë¯¸ì¶œë ¥ íŒŒë ˆíŠ¸ ${pallets.length}ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
          }
        } else {
          tbody.innerHTML = '<tr><td colspan="7" class="no-data">âŒ ' + (result.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.') + '</td></tr>';
          countSpan.textContent = '(0ê°œ)';
        }
      } catch (error) {
        console.error('ìµœì‹ ë¼ë²¨ ë¡œë“œ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        countSpan.textContent = '(0ê°œ)';
      }
    }
    
    // ì¶œë ¥ì™„ë£Œ í‘œì‹œ
    async function palMarkAsPrinted() {
      const checkboxes = document.querySelectorAll('.pal-label-checkbox:checked');
      const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.palletId);
      
      if (selectedIds.length === 0) {
        alert('ì¶œë ¥ì™„ë£Œë¡œ í‘œì‹œí•  ë¼ë²¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!confirm(`ì„ íƒí•œ ${selectedIds.length}ê°œì˜ ë¼ë²¨ì„ ì¶œë ¥ì™„ë£Œë¡œ í‘œì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      try {
        const response = await fetch(`${PAL_API_BASE_URL}/api/pallets/labels/mark-printed`, {
          method: 'POST',
          headers: {
            ...palGetUserHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            pallet_ids: selectedIds
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… ${selectedIds.length}ê°œì˜ ë¼ë²¨ì´ ì¶œë ¥ì™„ë£Œë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          palLoadLabelPallets();
        } else {
          alert('âŒ ì¶œë ¥ì™„ë£Œ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('ì¶œë ¥ì™„ë£Œ í‘œì‹œ ì˜¤ë¥˜:', error);
        alert('âŒ ì¶œë ¥ì™„ë£Œ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    // ë¼ë²¨ ì¶œë ¥ ëŒ€ìƒ íŒŒë ˆíŠ¸ ëª©ë¡ ë¡œë“œ
    async function palLoadLabelPallets() {
      const tbody = document.getElementById('palLabelTableBody');
      const countSpan = document.getElementById('palLabelCount');
      
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="7" class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
      
      try {
        const params = new URLSearchParams();
        
        // í•„í„° ì¡°ê±´ ìˆ˜ì§‘
        const idFilter = document.getElementById('palLabelFilterId').value.trim();
        const companyFilter = document.getElementById('palLabelFilterCompanyName').value.trim();
        const productFilter = document.getElementById('palLabelFilterProduct').value.trim();
        const startDate = document.getElementById('palLabelFilterStartDate').value;
        const endDate = document.getElementById('palLabelFilterEndDate').value;
        const statusFilter = document.getElementById('palLabelFilterStatus').value;
        const includePrinted = document.getElementById('palLabelFilterIncludePrinted').checked;
        
        if (idFilter) params.append('pallet_id', idFilter);
        if (companyFilter) params.append('company', companyFilter);
        if (productFilter) params.append('product', productFilter);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (statusFilter && statusFilter !== 'ì „ì²´') params.append('status', statusFilter);
        params.append('include_printed', includePrinted);
        
        const url = `${PAL_API_BASE_URL}/api/pallets/labels/filter?${params}`;
        const response = await fetch(url, {
          headers: palGetUserHeaders()
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const pallets = result.data;
          
          if (pallets.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="no-data">ì¡°ê±´ì— ë§ëŠ” íŒŒë ˆíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            countSpan.textContent = '(0ê°œ)';
          } else {
            tbody.innerHTML = pallets.map((pallet, index) => {
              const inDate = pallet.in_date ? new Date(pallet.in_date).toLocaleDateString('ko-KR') : '-';
              const printStatus = pallet.print_status || 'ë¯¸ì¶œë ¥';
              const printStatusClass = printStatus === 'ì¶œë ¥ì™„ë£Œ' ? 'style="color: #28a745; font-weight: 600;"' : '';
              return `
                <tr>
                  <td style="text-align: center;">
                    <input type="checkbox" class="pal-label-checkbox" data-pallet-id="${palEscapeHtml(pallet.pallet_id)}" onchange="palUpdateLabelSelection()">
                  </td>
                  <td>${palEscapeHtml(pallet.pallet_id)}</td>
                  <td>${palEscapeHtml(pallet.company_name || '-')}</td>
                  <td>${palEscapeHtml(pallet.product_name || '-')}</td>
                  <td>${inDate}</td>
                  <td>${palEscapeHtml(pallet.status || '-')}</td>
                  <td ${printStatusClass}>${palEscapeHtml(printStatus)}</td>
                </tr>
              `;
            }).join('');
            
            countSpan.textContent = `(${pallets.length}ê°œ)`;
          }
        } else {
          tbody.innerHTML = '<tr><td colspan="7" class="no-data">âŒ ' + (result.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.') + '</td></tr>';
          countSpan.textContent = '(0ê°œ)';
        }
      } catch (error) {
        console.error('ë¼ë²¨ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        countSpan.textContent = '(0ê°œ)';
      }
    }
    
    // ë¼ë²¨ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
    function palUpdateLabelSelection() {
      const checkboxes = document.querySelectorAll('.pal-label-checkbox');
      const selectAllCheckbox = document.getElementById('palLabelSelectAll');
      if (selectAllCheckbox) {
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
      }
    }
    
    // ì „ì²´ ì„ íƒ/í•´ì œ
    function palToggleSelectAllLabels(checked) {
      document.querySelectorAll('.pal-label-checkbox').forEach(cb => {
        cb.checked = checked;
      });
    }
    
    function palSelectAllLabels() {
      document.querySelectorAll('.pal-label-checkbox').forEach(cb => {
        cb.checked = true;
      });
      palUpdateLabelSelection();
    }
    
    function palDeselectAllLabels() {
      document.querySelectorAll('.pal-label-checkbox').forEach(cb => {
        cb.checked = false;
      });
      palUpdateLabelSelection();
    }
    
    // ì„ íƒëœ ë¼ë²¨ ì¸ì‡„ (í”„ë¡ íŠ¸ì—”ë“œ HTML ë°©ì‹ - ë¹ ë¥¸ ì¸ì‡„)
    function palPrintSelectedLabels() {
      const checkboxes = document.querySelectorAll('.pal-label-checkbox:checked');
      
      if (checkboxes.length === 0) {
        alert('ì¸ì‡„í•  ë¼ë²¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!confirm(`ì„ íƒí•œ ${checkboxes.length}ê°œì˜ ë¼ë²¨ì„ ì¸ì‡„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      // ì„ íƒëœ ë¼ë²¨ ë°ì´í„° ìˆ˜ì§‘ (í…Œì´ë¸” í–‰ì—ì„œ ì •ë³´ ì¶”ì¶œ)
      const selectedLabels = [];
      checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (row) {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 5) {
            const palletId = checkbox.dataset.palletId || '';
            const company = cells[2]?.textContent?.trim() || '';
            const product = cells[3]?.textContent?.trim() || '';
            const inDate = cells[4]?.textContent?.trim() || '';
            
            selectedLabels.push({
              pallet_id: palletId,
              company_name: company,
              product_name: product,
              in_date: inDate
            });
          }
        }
      });
      
      if (selectedLabels.length === 0) {
        alert('ë¼ë²¨ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ì¸ì‡„ ì˜ì—­ ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸°
      let printArea = document.getElementById('palLabelsPrintArea');
      if (!printArea) {
        printArea = document.createElement('div');
        printArea.id = 'palLabelsPrintArea';
        printArea.style.cssText = 'display: none; position: absolute; left: -9999px; top: -9999px;';
        document.body.appendChild(printArea);
      }
      
      // í¼í… LS-3112 ì •í™•í•œ ì œì› (ëª¨ë“  í˜ì´ì§€ì— ë™ì¼í•˜ê²Œ ì ìš©):
      // ë¼ë²¨ í¬ê¸°: 63.5mm Ã— 70.0mm
      // ê°€ë¡œ ê°„ê²©: 2.5mm (ë¼ë²¨ ì‚¬ì´)
      // ì„¸ë¡œ ê°„ê²©: 0mm (ë¼ë²¨ì´ ë¶™ì–´ìˆìŒ)
      // ì¢Œìš° ì—¬ë°±: 7.2mm
      // ìƒí•˜ ì—¬ë°±: 8.5mm
      // A4 ìš©ì§€: 210mm Ã— 297mm
      // 
      // ê³„ì‚°:
      // ê°€ë¡œ: 7.2(ì¢Œ) + 63.5 + 2.5 + 63.5 + 2.5 + 63.5 + 7.2(ìš°) = 150.9mm (ì‹¤ì œ ì‚¬ìš©)
      // ìš°ì¸¡ ì—¬ë°±: 210 - 150.9 = 59.1mm (ì‹¤ì œ ìš°ì¸¡ ì—¬ë°±ì€ ë” í¼)
      // ì„¸ë¡œ: 8.5(ìƒ) + 70 + 0 + 70 + 0 + 70 + 0 + 70 + 8.5(í•˜) = 297mm (ì •í™•íˆ ë§ìŒ)
      //
      // CSS Grid ì„¤ì • (ëª¨ë“  í˜ì´ì§€ì— ë™ì¼):
      // - ì¢Œì¸¡ ì—¬ë°±: 7.2mm
      // - ê° ë¼ë²¨ ë„ˆë¹„: 63.5mm
      // - ê°€ë¡œ ê°„ê²©: 2.5mm
      // - ìš°ì¸¡ ì—¬ë°±: ìë™ ê³„ì‚° (210 - 7.2 - 63.5*3 - 2.5*2 = 59.1mm)
      // - ìƒë‹¨ ì—¬ë°±: 8.5mm
      // - ê° ë¼ë²¨ ë†’ì´: 70mm
      // - ì„¸ë¡œ ê°„ê²©: 0mm
      // - í•˜ë‹¨ ì—¬ë°±: 8.5mm
      const LABELS_PER_PAGE = 12;
      const LABELS_PER_ROW = 3;
      const LABEL_WIDTH = 63.5;
      const LABEL_HEIGHT = 70.0;
      const HORIZONTAL_GAP = 2.5;
      const VERTICAL_GAP = 0;
      const LEFT_MARGIN = 7.2;
      const TOP_MARGIN = 8.5;
      const RIGHT_MARGIN = 210 - LEFT_MARGIN - (LABEL_WIDTH * 3) - (HORIZONTAL_GAP * 2); // 59.1mm
      const BOTTOM_MARGIN = 8.5;
      
      // Grid í…œí”Œë¦¿ (ëª¨ë“  í˜ì´ì§€ì— ë™ì¼í•˜ê²Œ ì‚¬ìš©)
      const GRID_COLUMNS = `${LABEL_WIDTH}mm ${HORIZONTAL_GAP}mm ${LABEL_WIDTH}mm ${HORIZONTAL_GAP}mm ${LABEL_WIDTH}mm`;
      const GRID_ROWS = `${LABEL_HEIGHT}mm ${VERTICAL_GAP}mm ${LABEL_HEIGHT}mm ${VERTICAL_GAP}mm ${LABEL_HEIGHT}mm ${VERTICAL_GAP}mm ${LABEL_HEIGHT}mm`;
      const PAGE_PADDING = `${TOP_MARGIN}mm ${RIGHT_MARGIN}mm ${BOTTOM_MARGIN}mm ${LEFT_MARGIN}mm`;
      
      let html = '';
      const totalPages = Math.ceil(selectedLabels.length / LABELS_PER_PAGE);
      
      // ê° í˜ì´ì§€ ìƒì„± (ëª¨ë“  í˜ì´ì§€ê°€ ë™ì¼í•œ ë ˆì´ì•„ì›ƒ ì‚¬ìš©)
      for (let pageIdx = 0; pageIdx < totalPages; pageIdx++) {
        const pageLabels = selectedLabels.slice(pageIdx * LABELS_PER_PAGE, (pageIdx + 1) * LABELS_PER_PAGE);
        const isLastPage = (pageIdx === totalPages - 1);
        
        // ë§ˆì§€ë§‰ í˜ì´ì§€ëŠ” page-break-after ì œê±°, ë‚˜ë¨¸ì§€ëŠ” always ì ìš©
        const pageBreakStyle = isLastPage ? 'page-break-after: auto;' : 'page-break-after: always;';
        
        // ëª¨ë“  í˜ì´ì§€ì— ë™ì¼í•œ Grid ë ˆì´ì•„ì›ƒ ì ìš©
        html += `<div class="pal-label-page" data-page-index="${pageIdx}" style="width: 210mm; height: 297mm; padding: ${PAGE_PADDING}; box-sizing: border-box; ${pageBreakStyle} display: grid; grid-template-columns: ${GRID_COLUMNS}; grid-template-rows: ${GRID_ROWS}; gap: 0;">`;
        
        // ë¼ë²¨ì„ ìˆœì„œëŒ€ë¡œ ë°°ì¹˜ (12ê°œ, ë¹ˆ ê³µê°„ë„ í¬í•¨)
        for (let i = 0; i < LABELS_PER_PAGE; i++) {
          const row = Math.floor(i / LABELS_PER_ROW); // 0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3
          const col = i % LABELS_PER_ROW; // 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2
          
          // ë¼ë²¨ ìœ„ì¹˜ ê³„ì‚° (Gridì—ì„œ ì •í™•í•œ ìœ„ì¹˜ ì§€ì •)
          const gridCol = col * 2 + 1; // 1, 3, 5
          const gridRow = row * 2 + 1; // 1, 3, 5, 7
          
          if (i < pageLabels.length) {
            const label = pageLabels[i];
            
            // ì…ê³ ì¼ í¬ë§·íŒ…
            let inDateStr = label.in_date || '-';
            if (inDateStr !== '-') {
              try {
                const dateMatch = inDateStr.match(/(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})/);
                if (dateMatch) {
                  inDateStr = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
                }
              } catch (e) {
                // í¬ë§·íŒ… ì‹¤íŒ¨ ì‹œ ì›ë³¸ ìœ ì§€
              }
            }
            
            // QR ì½”ë“œ URL ìƒì„±
            const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdDmnWcW27tfDptUvuSjEgN8K7nNNQWecdpeMMhwftTtbiyIQ/viewform";
            const qrText = `${formUrl}?usp=pp_url&entry.419411235=${encodeURIComponent(label.pallet_id)}&entry.427884801=ë³´ê´€ì¢…ë£Œ&entry.2110345042=${encodeURIComponent(label.company_name)}&entry.306824944=${encodeURIComponent(label.product_name)}`;
            const qrImageUrl = `https://quickchart.io/qr?text=${encodeURIComponent(qrText)}&size=150&ecLevel=M`;
            
            html += `
              <div class="pal-label-item" style="width: ${LABEL_WIDTH}mm; height: ${LABEL_HEIGHT}mm; padding: 3mm; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: white; border: none; overflow: hidden; grid-column: ${gridCol}; grid-row: ${gridRow};">
                <div style="width: 100%; text-align: center; flex-shrink: 0; margin-bottom: 3px;">
                  <div style="font-size: 11px; font-weight: 600; margin-bottom: 2px; line-height: 1.2;">íŒŒë ˆíŠ¸ ID: ${palEscapeHtml(label.pallet_id)}</div>
                  <div style="font-size: 11px; font-weight: 600; margin-bottom: 3px; line-height: 1.2;">${palEscapeHtml(label.product_name || '-')}</div>
                </div>
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 3px; width: 100%; flex-shrink: 0;">
                  <img src="${qrImageUrl}" alt="QR Code" style="width: 150px; height: 150px; max-width: 100%; max-height: 100%; object-fit: contain;">
                </div>
                <div style="width: 100%; text-align: center; flex-shrink: 0;">
                  <div style="font-size: 11px; font-weight: 600; margin-bottom: 2px; line-height: 1.2;">í™”ì£¼ì‚¬: ${palEscapeHtml(label.company_name || '-')}</div>
                  <div style="font-size: 11px; font-weight: 600; line-height: 1.2;">ì…ê³ ì¼: ${palEscapeHtml(inDateStr)}</div>
                </div>
              </div>
            `;
          } else {
            // ë¹ˆ ë¼ë²¨ ê³µê°„ (Grid ë ˆì´ì•„ì›ƒ ìœ ì§€ë¥¼ ìœ„í•´ ë¹ˆ div ì¶”ê°€)
            html += `<div style="grid-column: ${gridCol}; grid-row: ${gridRow};"></div>`;
          }
        }
        
        html += '</div>';
      }
      
      console.log(`[ë¼ë²¨ ì¸ì‡„] ì´ ${selectedLabels.length}ê°œ ë¼ë²¨, ${totalPages}í˜ì´ì§€ ìƒì„±`);
      
      printArea.innerHTML = html;
      
      // ì¸ì‡„ ìŠ¤íƒ€ì¼ ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ ì œê±° í›„ ì¬ì¶”ê°€)
      let printStyle = document.getElementById('palLabelsPrintStyle');
      if (printStyle) {
        printStyle.remove();
      }
      printStyle = document.createElement('style');
      printStyle.id = 'palLabelsPrintStyle';
      printStyle.textContent = `
        @media print {
          @page {
            size: A4;
            margin: 0;
          }
          html, body {
            width: 210mm !important;
            height: auto !important;
            min-height: 297mm !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: visible !important;
          }
          body > *:not(#palLabelsPrintArea) {
            display: none !important;
          }
          #palLabelsPrintArea {
            display: block !important;
            position: static !important;
            left: auto !important;
            top: auto !important;
            width: 210mm !important;
            min-height: auto !important;
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: visible !important;
          }
          .pal-label-page {
            width: 210mm !important;
            height: 297mm !important;
            padding: 8.5mm 59.1mm 8.5mm 7.2mm !important;
            box-sizing: border-box !important;
            display: grid !important;
            grid-template-columns: 63.5mm 2.5mm 63.5mm 2.5mm 63.5mm auto auto !important;
            grid-template-rows: 70mm 0mm 70mm 0mm 70mm 0mm 70mm !important;
            gap: 0 !important;
            page-break-inside: avoid !important;
            break-inside: avoid !important;
          }
          .pal-label-page:not(:last-child) {
            page-break-after: always !important;
            break-after: page !important;
          }
          .pal-label-page:last-child {
            page-break-after: auto !important;
            break-after: auto !important;
          }
          .pal-label-item {
            width: 63.5mm !important;
            height: 70mm !important;
            padding: 3mm !important;
            box-sizing: border-box !important;
            page-break-inside: avoid !important;
            overflow: hidden !important;
          }
        }
      `;
      document.head.appendChild(printStyle);
      
      // bodyì˜ ë‹¤ë¥¸ ëª¨ë“  ìš”ì†Œ ìˆ¨ê¸°ê¸°
      const bodyChildren = Array.from(document.body.children);
      const hiddenElements = [];
      bodyChildren.forEach(child => {
        if (child.id !== 'palLabelsPrintArea') {
          const originalDisplay = window.getComputedStyle(child).display;
          child.setAttribute('data-pal-original-display', originalDisplay);
          child.style.display = 'none';
          hiddenElements.push(child);
        }
      });
      
      // ì¸ì‡„ ì˜ì—­ í‘œì‹œ (ëª¨ë“  í˜ì´ì§€ê°€ ë³´ì´ë„ë¡ ì„¤ì •)
      printArea.style.display = 'block';
      printArea.style.position = 'static';
      printArea.style.width = '210mm';
      printArea.style.minHeight = `${totalPages * 297}mm`; // ëª¨ë“  í˜ì´ì§€ ë†’ì´ í•©ê³„
      printArea.style.height = 'auto';
      printArea.style.overflow = 'visible';
      document.body.insertBefore(printArea, document.body.firstChild);
      
      // ë””ë²„ê¹…: ìƒì„±ëœ í˜ì´ì§€ ìˆ˜ í™•ì¸
      const createdPages = printArea.querySelectorAll('.pal-label-page');
      console.log(`[ë¼ë²¨ ì¸ì‡„] ì‹¤ì œ ìƒì„±ëœ í˜ì´ì§€ ìˆ˜: ${createdPages.length}, ì˜ˆìƒ í˜ì´ì§€ ìˆ˜: ${totalPages}`);
      createdPages.forEach((page, idx) => {
        console.log(`[ë¼ë²¨ ì¸ì‡„] í˜ì´ì§€ ${idx + 1}:`, page.querySelectorAll('.pal-label-item').length, 'ê°œ ë¼ë²¨');
      });
      
      // ì•½ê°„ì˜ ì§€ì—° í›„ ì¸ì‡„ (ì´ë¯¸ì§€ ë¡œë“œ ëŒ€ê¸°)
      setTimeout(() => {
        window.print();
        
        // ì¸ì‡„ í›„ ì •ë¦¬
        setTimeout(() => {
          // ìˆ¨ê¸´ ìš”ì†Œë“¤ ë³µì›
          hiddenElements.forEach(child => {
            const originalDisplay = child.getAttribute('data-pal-original-display');
            child.style.display = originalDisplay || '';
            child.removeAttribute('data-pal-original-display');
          });
          
          printArea.innerHTML = '';
          printArea.style.display = 'none';
          printArea.style.position = 'absolute';
          printArea.style.left = '-9999px';
          printArea.style.top = '-9999px';
          
          if (printStyle) {
            printStyle.remove();
          }
        }, 500);
      }, 500);
    }
  </script>
</body>
</html>

