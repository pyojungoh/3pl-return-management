# 배포 환경 디버깅 가이드

## 🔍 현재 상황

환경 변수는 설정되어 있지만 여전히 403 오류가 발생하고 있습니다.
오류 메시지: "Service Accounts do not have storage quota"

이는 OAuth 2.0이 작동하지 않고 서비스 계정을 사용하려고 시도하고 있다는 의미입니다.

## 📋 디버깅 로그 확인

코드에 디버깅 로그를 추가했습니다. 다음 단계를 따라 확인하세요:

### 1단계: Vercel 재배포

1. 변경 사항 커밋 및 푸시
2. Vercel 자동 배포 대기 또는 수동 배포

### 2단계: 엑셀 업로드 시도

1. 테스트 페이지에서 엑셀 파일 업로드 시도
2. Vercel 로그 확인

### 3단계: 로그에서 확인할 메시지

#### ✅ 정상 작동 시:
```
[디버깅] 엑셀 파일 업로드 시작: [파일명]
[디버깅] OAuth 2.0 모듈 import 시도...
[디버깅] OAuth 2.0 모듈 import 성공
[디버깅] upload_excel_to_drive 함수 호출 시작...
📄 엑셀 파일 업로드 시작: [파일명]
🔍 OAuth 2.0 인증 정보 확인 중...
   Vercel 환경: True
   GOOGLE_OAUTH_TOKEN_JSON 존재: True
   GOOGLE_OAUTH_CREDENTIALS_JSON 존재: True
[디버깅] get_credentials() 함수 호출 시작...
[디버깅] get_credentials() 함수 시작
[디버깅] 환경 변수 읽기 완료
✅ 환경 변수에서 OAuth 토큰 로드 성공 (Vercel 배포 환경)
[디버깅] get_credentials() 함수 종료: True
[디버깅] 최종 credentials 유효성: True
[디버깅] get_credentials() 함수 호출 완료: True
✅ Google Drive API 서비스 생성 완료 (OAuth 2.0)
```

#### ❌ 문제 발생 시:

**환경 변수가 없는 경우:**
```
[디버깅] get_credentials() 함수 시작
[디버깅] 환경 변수 읽기 완료
[디버깅] Vercel 환경 여부: True
❌ Vercel 배포 환경에서 OAuth 2.0 환경 변수가 설정되지 않았습니다.
   GOOGLE_OAUTH_TOKEN_JSON: ❌
   GOOGLE_OAUTH_CREDENTIALS_JSON: ❌
```

**JSON 파싱 오류:**
```
⚠️ 환경 변수에서 토큰 로드 실패: [오류 메시지]
   GOOGLE_OAUTH_TOKEN_JSON 존재: True
   GOOGLE_OAUTH_CREDENTIALS_JSON 존재: True
   GOOGLE_OAUTH_TOKEN_JSON 길이: [숫자] 문자
   GOOGLE_OAUTH_TOKEN_JSON 처음 100자: [내용]
```

**토큰 만료:**
```
✅ 환경 변수에서 OAuth 토큰 로드 성공
🔄 토큰 갱신 중...
❌ 토큰 갱신 실패: [오류 메시지]
```

## 🔧 문제 해결

### 환경 변수가 없다고 나오는 경우

1. **Vercel 환경 변수 재확인**
   - Settings → Environment Variables
   - 두 환경 변수가 모두 있는지 확인
   - 각각 클릭하여 내용 확인

2. **재배포**
   - 환경 변수를 추가한 후 반드시 재배포 필요
   - Deployments → 최신 배포 → "..." → Redeploy

### JSON 파싱 오류인 경우

1. **환경 변수 내용 확인**
   - JSON 형식이 올바른지 확인
   - 따옴표가 올바르게 이스케이프되었는지 확인
   - 로그의 "처음 100자"를 확인하여 형식 확인

2. **환경 변수 재설정**
   - 로컬 파일에서 다시 복사
   - Vercel에 다시 붙여넣기
   - 재배포

### 토큰 만료인 경우

1. **로컬에서 다시 인증 받기**
   - `token.pickle` 파일 삭제
   - 다시 업로드 시도하여 인증 받기

2. **토큰 추출 및 환경 변수 업데이트**
   - `python extract_oauth_token.py` 실행
   - 출력된 JSON을 Vercel 환경 변수에 업데이트
   - 재배포

## 📝 체크리스트

- [ ] 코드 변경 사항 커밋 및 푸시
- [ ] Vercel 자동 배포 완료 대기
- [ ] 엑셀 업로드 시도
- [ ] Vercel 로그에서 디버깅 메시지 확인:
  - [ ] "[디버깅] 엑셀 파일 업로드 시작" 확인
  - [ ] "[디버깅] OAuth 2.0 모듈 import 성공" 확인
  - [ ] "[디버깅] get_credentials() 함수 시작" 확인
  - [ ] "Vercel 환경: True" 확인
  - [ ] "GOOGLE_OAUTH_TOKEN_JSON 존재: True" 확인
  - [ ] "GOOGLE_OAUTH_CREDENTIALS_JSON 존재: True" 확인
  - [ ] "✅ 환경 변수에서 OAuth 토큰 로드 성공" 확인

## 💡 중요 사항

1. **로그는 실시간으로 업데이트됩니다**
   - 엑셀 업로드를 시도하면 로그에 메시지가 나타납니다

2. **로그를 복사하여 공유**
   - 문제가 지속되면 로그를 복사하여 공유하면 더 정확한 진단이 가능합니다

3. **환경 변수는 재배포 후에만 적용됩니다**
   - 환경 변수를 추가/수정한 후 반드시 재배포해야 합니다

4. **디버깅 로그 확인**
   - 모든 디버깅 메시지가 로그에 나타나는지 확인
   - 메시지가 없다면 코드가 해당 경로를 타지 않은 것입니다

