# 구글 드라이브 연동 테스트 결과 요약

**테스트 일시**: 2025-01-12  
**테스트 환경**: 로컬 (Windows)

## ✅ 성공한 테스트

### 1. 인증 정보 로드 테스트
- ✅ 환경 변수 확인: 로컬 파일 발견 (`service_account.json`)
- ✅ 인증 정보 로드: 성공
- ✅ 서비스 계정 인증 객체 생성: 성공
- ✅ `get_credentials()` 함수: 정상 작동

### 2. 폴더 접근 테스트
- ✅ 메인 폴더 접근: 성공
  - 폴더명: `제이제이솔루션`
  - 폴더 ID: `16TdQlAqyOkYIrvSTvEPH9LByLzyamsAw`
  - 공유됨: `True`
  - 권한 수: `3`
- ✅ 대상 폴더 찾기: 성공
  - 폴더명: `정산파일`
  - 폴더 ID: `18bg8nohqP6I_OZMjlAMCBJdSwaWh7jOU`
  - 부모 폴더: `제이제이솔루션`

## ❌ 실패한 테스트

### 파일 업로드 테스트
- ❌ 엑셀 파일 업로드: 실패
- **오류 메시지**:
  ```
  Service Accounts do not have storage quota. 
  Leverage shared drives or use OAuth delegation instead.
  ```
- **오류 코드**: `403 Forbidden`
- **오류 이유**: `storageQuotaExceeded`

## 🔍 문제 분석

### 원인
1. **서비스 계정의 저장 공간 제한**
   - 서비스 계정은 저장 공간 할당량이 없음
   - 공유된 폴더에만 파일을 업로드할 수 있음
   - 코드는 이미 공유된 폴더를 사용하고 있음 (`parents`에 폴더 ID 지정)

2. **폴더 공유 설정 문제 가능성**
   - 폴더 접근은 성공하지만 서비스 계정이 권한 목록에 없음
   - 로그: "⚠️ 서비스 계정이 권한 목록에 없지만, 폴더 접근은 가능합니다."
   - 이는 폴더가 간접적으로 공유되었거나, 상위 폴더가 공유되었을 가능성

3. **이미지 업로드 vs 엑셀 업로드 차이**
   - 이미지 업로드는 성공 (반품내역 폴더)
   - 엑셀 업로드는 실패 (정산파일 폴더)
   - 코드 구조는 동일하므로 폴더별 공유 설정 차이일 가능성

## 💡 해결 방안

### ⚠️ 중요: 서비스 계정 이메일 불일치 발견!

**문제 원인**:
- 공유 설정에 있는 서비스 계정: `id-pl-drive-uploader@composite-dream-477907-c5.iam.gserviceaccount.com`
- 코드에서 사용하는 서비스 계정: `id-pl-return-service@composite-dream-477907-c5.iam.gserviceaccount.com`
- **서비스 계정 이메일이 일치하지 않음!**

### 해결 방법

**Google Drive 공유 설정에서 코드에서 사용하는 서비스 계정을 추가하세요**:

1. 현재 공유 화면에서 "사용자, 그룹, 스페이스, 캘린더 일정 추가" 필드 클릭
2. 다음 서비스 계정 이메일 입력:
   ```
   id-pl-return-service@composite-dream-477907-c5.iam.gserviceaccount.com
   ```
3. 권한: "편집자" 선택 (중요!)
4. "완료" 클릭
5. "정산파일" 폴더도 동일하게 설정

**현재 상태**:
- ✅ `id-pl-drive-uploader@...` 서비스 계정은 공유되어 있음 (하지만 코드에서 사용하지 않음)
- ❌ `id-pl-return-service@...` 서비스 계정은 공유되어 있지 않음 (코드에서 사용 중)

**해결**:
- `id-pl-return-service@composite-dream-477907-c5.iam.gserviceaccount.com` 서비스 계정을 "편집자" 권한으로 추가

### 2. 코드 검증

코드는 이미 올바르게 구현되어 있습니다:
- ✅ `parents`에 공유된 폴더 ID 지정
- ✅ `supportsAllDrives=True` 사용
- ✅ `ignoreDefaultVisibility=True` 사용
- ✅ 이미지 업로드가 동일한 방식으로 성공

### 3. Vercel 환경 변수 확인

로컬에서는 `service_account.json` 파일을 사용하지만, Vercel 배포 환경에서는:
- 환경 변수 `GOOGLE_SERVICE_ACCOUNT_JSON` 확인
- JSON 형식이 올바른지 확인
- Production, Preview, Development 모두 선택되었는지 확인

## 📋 테스트 스크립트

다음 테스트 스크립트들을 사용하여 검증했습니다:
1. `test_google_drive_auth.py`: 인증 정보 로드 테스트
2. `test_google_drive_api.py`: 폴더 접근 테스트
3. `test_google_drive_upload.py`: 파일 업로드 테스트

## ✅ 다음 단계

1. **Google Drive 폴더 공유 설정 확인 및 수정**
   - 가장 가능성 높은 원인
   - 서비스 계정을 "편집자" 권한으로 추가

2. **Vercel 환경 변수 확인**
   - `GOOGLE_SERVICE_ACCOUNT_JSON` 설정 확인
   - JSON 형식 검증

3. **재테스트**
   - 폴더 공유 설정 후 업로드 테스트 재실행
   - Vercel 배포 환경에서도 테스트

## 📝 참고

- 서비스 계정 이메일: `id-pl-return-service@composite-dream-477907-c5.iam.gserviceaccount.com`
- 메인 폴더 ID: `16TdQlAqyOkYIrvSTvEPH9LByLzyamsAw`
- 정산파일 폴더 ID: `18bg8nohqP6I_OZMjlAMCBJdSwaWh7jOU`
- 코드는 정상적으로 구현되어 있음
- 문제는 폴더 공유 설정일 가능성이 높음

