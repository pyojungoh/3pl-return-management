# 구글 드라이브 업로드 문제 해결 완전 정리

## 🔴 문제의 원인

### 발생한 오류
```
HttpError 403: Service Accounts do not have storage quota. 
Leverage shared drives or use OAuth delegation instead.
```

### 왜 발생했는가?

1. **서비스 계정의 제한사항**
   - Google 서비스 계정은 기본적으로 **저장 공간 할당량이 없습니다**
   - 서비스 계정으로 직접 파일을 업로드하면 403 오류 발생
   - 공유 드라이브(Shared Drive)를 사용하거나 OAuth 위임을 사용해야 함

2. **기존 코드의 문제**
   - `api/uploads/google_drive.py`에서 서비스 계정을 사용하여 파일 업로드 시도
   - 이미지 업로드는 Cloudinary로 대체되었지만, 엑셀 파일 업로드는 여전히 서비스 계정 사용
   - 배포 환경(Vercel)에서 서비스 계정 제한에 걸림

## ✅ 해결 방법

### OAuth 2.0 사용자 계정 인증 사용

서비스 계정 대신 **실제 사용자 계정**으로 OAuth 2.0 인증을 받아 파일을 업로드합니다.

### 왜 이 방법인가?

1. **사용자 계정은 저장 공간이 있음**
   - 개인 Google 계정은 기본 15GB 저장 공간 제공
   - 추가 저장 공간 구매 가능

2. **서비스 계정 제한 우회**
   - OAuth 2.0으로 사용자 계정에 위임하여 업로드
   - 서비스 계정의 저장 공간 제한 문제 해결

3. **배포 환경에서도 작동**
   - 환경 변수로 토큰 관리 가능
   - Vercel 등 서버리스 환경에서도 사용 가능

## 📋 해결 과정

### 1단계: OAuth 2.0 클라이언트 ID 생성

1. **Google Cloud Console 접속**
   - https://console.cloud.google.com/
   - 프로젝트 선택: `composite-dream-477907-c5`

2. **OAuth 클라이언트 ID 생성**
   - APIs & Services → Credentials
   - Create Credentials → OAuth client ID
   - Application type: **Desktop app** 선택
   - Create 클릭

3. **JSON 파일 다운로드**
   - 다운로드한 파일을 `credentials.json`으로 이름 변경
   - 프로젝트 루트에 저장

### 2단계: OAuth 2.0 인증 코드 작성

**파일**: `api/uploads/oauth_drive.py`

주요 기능:
- 환경 변수에서 OAuth 토큰 읽기 (Vercel 배포 환경)
- 로컬 파일에서 토큰 읽기 (로컬 개발 환경)
- 토큰 자동 갱신
- Google Drive API 서비스 생성

### 3단계: 엑셀 업로드 코드 수정

**파일**: `api/uploads/routes.py`

변경 사항:
- `upload-excel-start` 엔드포인트: OAuth 2.0 사용
- `upload-excel-complete` 엔드포인트: OAuth 2.0 사용
- 서비스 계정 대신 `oauth_drive.upload_excel_to_drive` 함수 사용

### 4단계: 로컬에서 인증 받기

1. **로컬 서버 실행**
   ```bash
   python app.py
   ```

2. **브라우저에서 테스트**
   - `http://localhost:5000/test-excel-upload.html` 접속
   - 엑셀 파일 업로드 시도
   - Google 로그인 화면에서 로그인 및 권한 승인
   - `token.pickle` 파일 생성 확인

3. **토큰 정보 추출**
   ```bash
   python extract_oauth_token.py
   ```
   - 출력된 JSON 전체 복사

### 5단계: Vercel 환경 변수 설정

1. **Vercel 대시보드 접속**
   - https://vercel.com/
   - 프로젝트 선택

2. **환경 변수 추가**
   - Settings → Environment Variables
   - 두 개의 환경 변수 추가:

   **첫 번째 환경 변수:**
   - Key: `GOOGLE_OAUTH_TOKEN_JSON`
   - Value: `extract_oauth_token.py` 출력 결과 (전체 JSON)
   - Environment: Production, Preview, Development 모두 선택

   **두 번째 환경 변수:**
   - Key: `GOOGLE_OAUTH_CREDENTIALS_JSON`
   - Value: `credentials.json` 파일 전체 내용
   - Environment: Production, Preview, Development 모두 선택

3. **재배포**
   - Deployments → 최신 배포 → "..." → Redeploy
   - 또는 코드 변경 후 `git push`하여 자동 재배포

## 🔍 최종 확인 방법

### 1. 로컬 환경 테스트

```bash
# 서버 실행
python app.py

# 브라우저에서 테스트
# http://localhost:5000/test-excel-upload.html
```

**성공 시:**
- 파일 업로드 성공 메시지
- Google Drive에 파일 업로드 확인
- 파일 링크 받기

### 2. 배포 환경 테스트

1. **웹에서 테스트**
   - `https://www.jjaysolution.com/test-excel-upload.html` 접속
   - 엑셀 파일 업로드 시도

2. **Vercel 로그 확인**
   - Vercel 대시보드 → Deployments → 최신 배포 → Functions/Logs
   - 다음 메시지 확인:
     ```
     [디버깅] 엑셀 파일 업로드 시작: [파일명]
     [디버깅] OAuth 2.0 모듈 import 성공
     🔍 OAuth 2.0 인증 정보 확인 중...
        Vercel 환경: True
        GOOGLE_OAUTH_TOKEN_JSON 존재: True
        GOOGLE_OAUTH_CREDENTIALS_JSON 존재: True
     ✅ 환경 변수에서 OAuth 토큰 로드 성공 (Vercel 배포 환경)
     ✅ Google Drive API 서비스 생성 완료 (OAuth 2.0)
     ✅ 파일 업로드 성공: [파일명]
     ```

## 📝 핵심 정리

### 문제의 핵심
- **서비스 계정은 저장 공간 할당량이 없어서 파일 업로드 불가**
- 배포 환경에서 403 오류 발생

### 해결의 핵심
- **OAuth 2.0으로 사용자 계정 인증 사용**
- 사용자 계정은 저장 공간이 있어서 파일 업로드 가능
- 환경 변수로 토큰 관리하여 배포 환경에서도 작동

### 필요한 설정
1. ✅ OAuth 2.0 클라이언트 ID 생성 (`credentials.json`)
2. ✅ 로컬에서 인증 받기 (`token.pickle` 생성)
3. ✅ 토큰 정보 추출 (`extract_oauth_token.py` 실행)
4. ✅ Vercel 환경 변수 설정 (2개)
5. ✅ 재배포

### 사용하는 파일
- **로컬 개발**: `credentials.json`, `token.pickle`
- **배포 환경**: `GOOGLE_OAUTH_CREDENTIALS_JSON`, `GOOGLE_OAUTH_TOKEN_JSON` (환경 변수)

## ⚠️ 주의사항

1. **토큰 만료**
   - OAuth 토큰은 만료될 수 있음
   - 만료되면 로컬에서 다시 인증 받고 환경 변수 업데이트 필요

2. **환경 변수 재배포**
   - 환경 변수를 추가/수정한 후 반드시 재배포 필요
   - 자동으로 재배포되지 않을 수 있음

3. **credentials.json 보안**
   - `credentials.json` 파일은 Git에 커밋하지 않음 (`.gitignore`에 추가됨)
   - 환경 변수로만 관리

4. **OAuth 동의 화면 설정**
   - 테스트 사용자 추가 필요 (개인 Google 계정)
   - 프로덕션 배포 시 OAuth 동의 화면 검토 필요

## 🎯 최종 상태

### 작동하는 것
- ✅ 로컬 환경에서 엑셀 파일 업로드
- ✅ 배포 환경에서 엑셀 파일 업로드
- ✅ OAuth 2.0 인증 자동 처리
- ✅ 토큰 자동 갱신

### 사용하는 인증 방식
- **이미지 업로드**: Cloudinary (기존 유지)
- **엑셀 파일 업로드**: OAuth 2.0 사용자 계정 (새로 추가)

### 코드 구조
```
api/uploads/
├── google_drive.py      # 서비스 계정 (이미지용, 현재는 사용 안 함)
├── oauth_drive.py       # OAuth 2.0 (엑셀 파일용) ⭐
├── cloudinary_upload.py # Cloudinary (이미지용)
└── routes.py            # API 엔드포인트 (OAuth 2.0 사용)
```

## 💡 문제 해결 체크리스트

- [x] OAuth 2.0 클라이언트 ID 생성
- [x] `credentials.json` 파일 생성
- [x] 로컬에서 OAuth 인증 받기
- [x] `token.pickle` 파일 생성 확인
- [x] 토큰 정보 추출 스크립트 작성
- [x] Vercel 환경 변수 설정
- [x] 코드 수정 (OAuth 2.0 사용)
- [x] 재배포
- [x] 로컬 테스트 성공
- [ ] 배포 환경 테스트 성공 (확인 필요)

## 📚 참고 문서

- `OAuth_2.0_설정_가이드.md`: OAuth 2.0 설정 전체 가이드
- `Vercel_환경변수_설정_단계별_가이드.md`: Vercel 환경 변수 설정 가이드
- `배포_환경_디버깅_가이드.md`: 배포 환경 디버깅 가이드
- `extract_oauth_token.py`: 토큰 추출 스크립트

---

**최종 업데이트**: 2026년 1월 12일
**상태**: ✅ 해결 완료 (배포 환경 테스트 대기 중)

